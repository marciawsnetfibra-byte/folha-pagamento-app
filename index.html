<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Adicionais e Reflexos da Folha de Pagamento</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- SheetJS para importação de planilhas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF para geração de PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --cor-titulo: #1800AD;
            --cor-menu: #0B0B2B;
            --cor-menu-hover: #1a1a4b;
            --cor-menu-text: #ffffff;
            --cor-menu-icon: #6366f1;
            --cor-importar: #10B981;
            --cor-importar-hover: #059669;
            --cor-admin: #7C3AED;
            --cor-admin-hover: #6D28D9;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            width: 100%;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }
        
        /* MENU LATERAL */
        .side-menu {
            width: 260px;
            background: linear-gradient(180deg, #0B0B2B 0%, #1a1a4b 100%);
            color: var(--cor-menu-text);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .menu-header {
            padding: 25px 15px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .menu-header i {
            font-size: 42px;
            color: #818cf8;
            margin-bottom: 8px;
            display: block;
        }
        
        .menu-header h2 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 8px 0 3px;
            background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .menu-header p {
            font-size: 0.7rem;
            opacity: 0.7;
        }
        
        .menu-items {
            padding: 15px 0;
            flex: 1;
        }
        
        .menu-button {
            width: 100%;
            text-align: left;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid transparent;
        }
        
        .menu-button i {
            width: 22px;
            font-size: 1.1rem;
            color: var(--cor-menu-icon);
            transition: all 0.3s ease;
        }
        
        .menu-button:hover {
            background: rgba(99, 102, 241, 0.15);
            color: white;
            border-left-color: #818cf8;
        }
        
        .menu-button:hover i {
            color: #818cf8;
        }
        
        .menu-button.active {
            background: rgba(99, 102, 241, 0.2);
            color: white;
            border-left-color: #818cf8;
        }
        
        .menu-button.active i {
            color: #818cf8;
        }
        
        .menu-footer {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .user-info-side {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .user-email {
            font-size: 0.8rem;
            word-break: break-all;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }
        
        .badge-container {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .admin-badge {
            background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .offline-badge {
            background: #6B7280;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .logout-btn {
            width: 100%;
            padding: 10px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            color: white;
        }
        
        /* CONTEÚDO PRINCIPAL */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 20px;
            min-height: 100vh;
            width: calc(100% - 260px);
        }
        
        /* CONTAINERS PRINCIPAIS */
        .container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            width: 100%;
        }
        
        /* MODAL DE LOGIN */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-modal.active {
            display: flex;
        }
        
        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            z-index: 10001;
        }
        
        /* MODAL DE RECUPERAÇÃO DE SENHA */
        .forgot-password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 11000;
        }
        
        .forgot-password-modal.active {
            display: flex;
        }
        
        .forgot-password-box {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            z-index: 11001;
        }
        
        /* OUTROS MODAIS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 2001;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9fafb;
            border-radius: 10px 10px 0 0;
        }
        
        .modal-title {
            font-weight: 600;
            color: var(--cor-titulo);
            font-size: 1.25rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: #374151;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        input[type="text"], input[type="number"], select, input[type="month"], input[type="date"], input[type="file"], input[type="password"], input[type="email"] {
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
            height: 40px !important;
            line-height: normal;
        }
        
        .duplicate-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #FEF3C7;
            border-left: 4px solid #F59E0B;
            color: #92400E;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
        }
        
        .duplicate-notification i {
            font-size: 20px;
            color: #F59E0B;
        }
        
        .duplicate-notification .close-btn {
            margin-left: auto;
            cursor: pointer;
            color: #6B7280;
            background: none;
            border: none;
            font-size: 16px;
        }
        
        .duplicate-notification .close-btn:hover {
            color: #374151;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .settings-panel {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .setting-item label {
            min-width: 200px;
            font-weight: 500;
        }
        
        .setting-item input {
            max-width: 100px;
        }
        
        .printButton, #clearButton, #saveButton, #loadDataButton, #exportDataButton {
            color: var(--cor-titulo);
            border: 1px solid transparent;
            margin-left: 10px;
        }
        
        .printButton:hover, #clearButton:hover, #saveButton:hover, #loadDataButton:hover, #exportDataButton:hover {
             border: 1px solid var(--cor-titulo);
             background-color: #f0f4ff;
        }
        
        .save-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .collaborator-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            background-color: white;
            margin-top: 10px;
        }
        
        .collaborator-item {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .collaborator-item:hover {
            background-color: #f0f4ff;
        }
        
        .collaborator-item:last-child {
            border-bottom: none;
        }
        
        .collaborator-name {
            font-weight: 600;
            color: var(--cor-titulo);
        }
        
        .collaborator-details {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .delete-btn {
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .delete-btn:hover {
            background-color: #fee2e2;
        }
        
        .collaborator-table, .department-table, .history-table, .import-preview-table, .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .collaborator-table th, .department-table th, .history-table th, .import-preview-table th, .admin-table th {
            background-color: #f3f4f6;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .collaborator-table td, .department-table td, .history-table td, .import-preview-table td, .admin-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .collaborator-table tr:hover, .department-table tr:hover, .history-table tr:hover, .import-preview-table tr:hover, .admin-table tr:hover {
            background-color: #f9fafb;
        }
        
        .department-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .import-preview-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .status-toggle-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f3f4f6;
            border-radius: 8px;
        }
        
        .status-toggle-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .status-toggle-btn.active {
            background-color: var(--cor-titulo);
            color: white;
            border-color: var(--cor-titulo);
        }
        
        .status-toggle-btn:not(.active) {
            background-color: white;
            color: var(--cor-titulo);
            border-color: #d1d5db;
        }
        
        .status-toggle-btn:not(.active):hover {
            background-color: #f0f4ff;
        }
        
        .info-box {
            background-color: #e0f2fe;
            border-left: 4px solid #0369a1;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 4px;
        }
        
        .firebase-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .firebase-connected {
            background-color: #10B981;
            color: white;
        }
        
        .firebase-disconnected {
            background-color: #EF4444;
            color: white;
        }
        
        .firebase-loading {
            background-color: #F59E0B;
            color: white;
        }
        
        .firebase-offline {
            background-color: #6B7280;
            color: white;
        }
        
        .login-tabs {
            display: flex;
            gap: 1px;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        
        .login-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .login-tab.active {
            background-color: var(--cor-titulo);
            color: white;
        }
        
        .sync-badge {
            background-color: #3B82F6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .login-error {
            display: none;
            background-color: #FEE2E2;
            border: 1px solid #FECACA;
            color: #DC2626;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        
        .login-error.show {
            display: block;
        }
        
        .forgot-password-link {
            text-align: right;
            margin-top: 8px;
        }
        
        .forgot-password-link button {
            background: none;
            border: none;
            color: #3B82F6;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .forgot-password-link button:hover {
            color: #1E40AF;
        }
        
        .success-message {
            background-color: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .warning-message {
            background-color: #fffbeb;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .column-toggle-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .column-toggle-btn.active {
            background-color: var(--cor-titulo);
            color: white;
            border-color: var(--cor-titulo);
        }
        
        .column-toggle-btn:not(.active):hover {
            background-color: #f3f4f6;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 14px;
        }
        
        .report-table th {
            background-color: var(--cor-titulo);
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .report-table td {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .report-table tr:hover {
            background-color: #f0f4ff;
        }
        
        .report-table tr.total-row {
            background-color: #e0f2fe;
            font-weight: bold;
        }
        
        .report-summary {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .filter-badge {
            display: inline-flex;
            align-items: center;
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .filter-badge i {
            margin-left: 6px;
            cursor: pointer;
        }
        
        .reflexo-destaque {
            background-color: #f0f9ff;
            border-left: 4px solid #0369a1;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        
        .reflexo-total {
            font-weight: bold;
            color: #0369a1;
        }
        
        .view-mode input, .view-mode select {
            background-color: #f3f4f6 !important;
            color: #4b5563 !important;
            border: 1px solid #d1d5db !important;
            cursor: not-allowed;
        }
        
        .edit-btn {
            background-color: #3B82F6;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-btn:hover {
            background-color: #2563EB;
        }
        
        .payment-info {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .payment-info h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--cor-titulo);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .payment-info h3 i {
            color: #059669;
        }
        
        .payment-info .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .payment-info label {
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 4px;
            display: block;
        }
        
        .edit-mode input, .edit-mode select {
            background-color: white !important;
            color: #111827 !important;
            border: 1px solid #d1d5db !important;
            cursor: text !important;
        }
        
        .edit-mode input[readonly], .edit-mode select[readonly] {
            background-color: #f3f4f6 !important;
        }
        
        .periculosidade-info {
            background-color: #fef9e7;
            border-left: 4px solid #f39c12;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .periculosidade-detalhe {
            font-size: 0.8rem;
            color: #555;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed #ccc;
        }
        
        .success-message {
            background-color: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .warning-message {
            background-color: #fffbeb;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .import-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }
        
        .stat-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--cor-titulo);
        }
        
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background-color: #f9fafb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-upload-area:hover {
            border-color: var(--cor-importar);
            background-color: #f0fdf4;
        }
        
        .file-upload-area i {
            font-size: 48px;
            color: var(--cor-importar);
            margin-bottom: 12px;
        }
        
        .moeda-br {
            color: var(--cor-titulo);
            font-weight: 600;
        }
        
        .admin-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .admin-user-item:last-child {
            border-bottom: none;
        }
        
        .admin-user-email {
            font-weight: 500;
            color: var(--cor-titulo);
        }
        
        .admin-user-date {
            font-size: 12px;
            color: #6b7280;
        }
        
        .admin-actions {
            display: flex;
            gap: 8px;
        }
        
        .status-radio-group {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 8px;
        }
        
        .status-radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-radio-option input[type="radio"] {
            width: 16px;
            height: 16px;
            margin: 0;
        }
        
        .sync-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            background-color: #f59e0b;
            color: white;
            margin-left: 8px;
        }
        
        .admin-warning {
            background-color: #FEF3C7;
            border-left: 4px solid #F59E0B;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .force-sync-btn {
            background-color: #3B82F6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 12px;
        }
        
        .force-sync-btn:hover {
            background-color: #2563EB;
        }
        
        .offline-badge {
            background-color: #6B7280;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        /* RESPONSIVIDADE */
        @media (max-width: 1024px) {
            .side-menu {
                width: 70px;
            }
            
            .menu-header h2,
            .menu-header p,
            .menu-button span,
            .user-info-side .user-email,
            .badge-container {
                display: none;
            }
            
            .menu-button {
                padding: 15px;
                justify-content: center;
            }
            
            .menu-button i {
                margin: 0;
                font-size: 1.3rem;
            }
            
            .menu-footer {
                padding: 10px;
            }
            
            .logout-btn span {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
                width: calc(100% - 70px);
                padding: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            .container h1 {
                font-size: 1.5rem;
            }
            
            .grid-cols-1.lg\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- MENU LATERAL -->
        <nav class="side-menu">
            <div class="menu-header">
                <i class="fas fa-calculator"></i>
                <h2>Folha de Pagamento</h2>
                <p>Sistema de Cálculos</p>
            </div>
            
            <div class="menu-items">
                <button class="menu-button active" id="menuCalculator">
                    <i class="fas fa-calculator"></i>
                    <span>Calculadora</span>
                </button>
                <button class="menu-button" id="menuCollaborators">
                    <i class="fas fa-users"></i>
                    <span>Colaboradores</span>
                </button>
                <button class="menu-button" id="menuHistory">
                    <i class="fas fa-history"></i>
                    <span>Histórico</span>
                </button>
                <button class="menu-button" id="menuReports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Relatórios</span>
                </button>
                <button class="menu-button" id="menuSettings">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </button>
                <button class="menu-button" id="menuAdmin" style="display: none;">
                    <i class="fas fa-shield-alt"></i>
                    <span>Administração</span>
                </button>
            </div>
            
            <div class="menu-footer">
                <div id="userInfoSide" class="user-info-side">
                    <div class="user-email" id="userEmailSide"></div>
                    <div class="badge-container">
                        <span id="userRoleBadgeSide" class="admin-badge" style="display: none;">Admin</span>
                        <span id="offlineBadgeSide" class="offline-badge" style="display: none;">Offline</span>
                    </div>
                </div>
                <button class="logout-btn" id="btnLogout" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair</span>
                </button>
            </div>
        </nav>
        
        <!-- CONTEÚDO PRINCIPAL -->
        <div class="main-content">
            <!-- Status do Firebase -->
            <div id="firebaseStatus" class="firebase-status firebase-loading">
                <i class="fas fa-sync fa-spin"></i>
                <span>Conectando ao banco de dados...</span>
            </div>

            <!-- Notificação de Lançamento Duplicado -->
            <div id="duplicateNotification" class="duplicate-notification" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>Lançamento duplicado!</strong>
                    <p id="duplicateMessage">Este cálculo já foi salvo anteriormente para este colaborador no mesmo mês.</p>
                </div>
                <button class="close-btn" onclick="document.getElementById('duplicateNotification').style.display='none'">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Modal de Configurações -->
            <div class="modal" id="settingsModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-cog mr-2"></i>
                            Configurações do Sistema
                        </h3>
                        <button class="modal-close" id="closeSettingsModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="settings-panel">
                            <h4 class="font-bold text-lg titulo-cor mb-4">Porcentagem de Horas Extras</h4>
                            
                            <div class="setting-item">
                                <label for="heNormalPorcentagem">Hora Extra Normal (50%):</label>
                                <input type="number" id="heNormalPorcentagem" min="0" max="200" value="50" step="1" class="w-24">
                                <span class="ml-2">%</span>
                            </div>
                            
                            <div class="setting-item">
                                <label for="heSobreavisoPorcentagem">Sobreaviso Trabalhado (50%):</label>
                                <input type="number" id="heSobreavisoPorcentagem" min="0" max="200" value="50" step="1" class="w-24">
                                <span class="ml-2">%</span>
                            </div>
                            
                            <div class="setting-item">
                                <label for="adicionalNoturnoPorcentagem">Adicional Noturno (20%):</label>
                                <input type="number" id="adicionalNoturnoPorcentagem" min="0" max="100" value="20" step="1" class="w-24">
                                <span class="ml-2">%</span>
                            </div>
                            
                            <div class="mt-6 pt-4 border-t flex justify-end">
                                <button id="saveSettings" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                    <i class="fas fa-save mr-2"></i>Salvar Configurações
                                </button>
                            </div>
                        </div>
                        
                        <div class="info-box">
                            <i class="fas fa-info-circle mr-2"></i>
                            As alterações nas porcentagens afetarão todos os novos cálculos realizados.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Administração -->
            <div class="modal" id="adminModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-shield-alt mr-2"></i>
                            Administração de Acessos
                        </h3>
                        <button class="modal-close" id="closeAdminModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="adminWarning" class="admin-warning" style="display: none;">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <span id="adminWarningText">Modo offline - exibindo usuários locais</span>
                            <button id="forceSyncBtn" class="force-sync-btn">
                                <i class="fas fa-sync-alt"></i> Tentar sincronizar
                            </button>
                        </div>
                        
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-bold text-lg titulo-cor">Usuários do Sistema</h4>
                                <span id="userCountBadge" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-xs">0 usuários</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-4">Apenas administradores podem gerenciar outros usuários.</p>
                            
                            <div id="adminUsersList">
                                <div class="text-center py-4 text-gray-500">
                                    <i class="fas fa-sync fa-spin fa-2x mb-3"></i>
                                    <p>Carregando usuários...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 pt-4 border-t">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h5 class="font-bold">Informações de Administrador</h5>
                                    <p class="text-xs text-gray-500 mt-1">Usuários com perfil administrador podem gerenciar acessos e excluir outros usuários.</p>
                                </div>
                                <span class="admin-badge text-sm px-3 py-1">Administrador</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Login -->
            <div id="loginModal" class="login-modal">
                <div class="login-box">
                    <h2 class="text-2xl font-bold titulo-cor mb-2">Acesso ao Sistema</h2>
                    <p class="mb-6 text-gray-600 text-sm">Faça login para sincronizar seus dados na nuvem</p>
                    
                    <div class="login-tabs">
                        <button class="login-tab active" id="tabLogin">Entrar</button>
                        <button class="login-tab" id="tabSignup">Cadastrar</button>
                    </div>
                    
                    <div id="loginError" class="login-error">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        <span id="errorText">Mensagem de erro aparecerá aqui</span>
                    </div>
                    
                    <div id="forgotPasswordSuccess" class="success-message" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span id="forgotPasswordSuccessText">Email de recuperação enviado!</span>
                    </div>
                    
                    <div id="loginForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="loginEmail" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="seu@email.com" autocomplete="username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                                <input type="password" id="loginPassword" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="••••••••" autocomplete="current-password">
                            </div>
                            <div class="forgot-password-link">
                                <button type="button" id="forgotPasswordBtn">Esqueci minha senha</button>
                            </div>
                            <button id="btnLogin" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-medium transition duration-150">
                                <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                            </button>
                        </div>
                    </div>
                    
                    <div id="signupForm" style="display: none;">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="signupEmail" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="seu@email.com" autocomplete="username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Senha (mínimo 6 caracteres)</label>
                                <input type="password" id="signupPassword" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="••••••••" autocomplete="new-password">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar Senha</label>
                                <input type="password" id="signupConfirmPassword" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="••••••••" autocomplete="new-password">
                            </div>
                            <button id="btnSignup" class="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 font-medium transition duration-150">
                                <i class="fas fa-user-plus mr-2"></i>Criar Conta
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t text-center">
                        <button id="btnContinueOffline" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-laptop mr-1"></i>Continuar sem login (apenas local)
                        </button>
                    </div>
                    
                    <div class="mt-4 text-xs text-gray-500">
                        <p><i class="fas fa-info-circle mr-1"></i> Com login, seus dados serão salvos na nuvem e poderão ser acessados de qualquer dispositivo.</p>
                    </div>
                </div>
            </div>

            <!-- Modal de Recuperação de Senha -->
            <div id="forgotPasswordModal" class="forgot-password-modal">
                <div class="forgot-password-box">
                    <h2 class="text-2xl font-bold titulo-cor mb-2">Recuperar Senha</h2>
                    <p class="mb-6 text-gray-600 text-sm">Digite seu email para receber um link de recuperação</p>
                    
                    <div id="forgotPasswordError" class="login-error">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        <span id="forgotErrorText">Mensagem de erro</span>
                    </div>
                    
                    <div id="forgotPasswordSuccessModal" class="success-message" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span>Email de recuperação enviado! Verifique sua caixa de entrada.</span>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="forgotEmail" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="seu@email.com">
                        </div>
                        <button id="btnSendResetLink" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-medium transition duration-150">
                            <i class="fas fa-paper-plane mr-2"></i>Enviar Link
                        </button>
                        <div class="text-center mt-4">
                            <button id="btnBackToLogin" class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-arrow-left mr-1"></i>Voltar para o login
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL DE IMPORTAÇÃO DE PLANILHA -->
            <div class="modal" id="importSpreadsheetModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-file-excel mr-2 text-green-600"></i>
                            Importar Colaboradores de Planilha
                        </h3>
                        <button class="modal-close" id="closeImportModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="importMessages"></div>
                        
                        <div class="info-box mb-6">
                            <strong><i class="fas fa-info-circle mr-2"></i>Formato da Planilha:</strong>
                            <p class="mt-2 text-sm">Sua planilha deve conter as seguintes colunas:</p>
                            <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                                <li><span class="font-medium">Nome</span> - Nome completo do colaborador</li>
                                <li><span class="font-medium">Departamento</span> - Nome do departamento</li>
                                <li><span class="font-medium">Salário</span> - Valor em R$ (ex: R$ 2.500,00 ou 2500,00)</li>
                                <li><span class="font-medium">Periculosidade</span> - "Sim" ou "Não"</li>
                                <li><span class="font-medium">Horas Mensais</span> - 220, 180, 170, etc (opcional - padrão 220)</li>
                            </ul>
                            <p class="mt-2 text-xs text-gray-600">
                                <i class="fas fa-download mr-1"></i> 
                                <a href="#" id="downloadTemplate" class="text-blue-600 hover:underline">Baixar modelo de planilha</a>
                            </p>
                        </div>

                        <div class="file-upload-area" id="fileUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4 class="text-lg font-semibold text-gray-700 mb-2">
                                Clique para selecionar ou arraste o arquivo
                            </h4>
                            <p class="text-sm text-gray-500 mb-4">
                                Formatos aceitos: .xlsx, .xls, .csv
                            </p>
                            <input type="file" id="spreadsheetFile" accept=".xlsx,.xls,.csv" class="hidden">
                            <button id="selectFileButton" class="btn-importar mx-auto">
                                <i class="fas fa-file-excel mr-2"></i>
                                Selecionar Arquivo
                            </button>
                        </div>

                        <div id="importPreview" style="display: none;">
                            <h4 class="font-bold text-lg titulo-cor mt-6 mb-3">
                                <i class="fas fa-eye mr-2"></i>
                                Prévia dos Dados
                            </h4>
                            
                            <div id="importStats" class="import-stats"></div>
                            
                            <div class="import-preview-container">
                                <table class="import-preview-table">
                                    <thead id="previewTableHeader"></thead>
                                    <tbody id="previewTableBody"></tbody>
                                </table>
                            </div>

                            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                                <button type="button" id="cancelImport" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                                    Cancelar
                                </button>
                                <button type="button" id="confirmImport" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    Confirmar Importação
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTEÚDO PRINCIPAL (CALCULADORA) -->
            <div class="container" id="calculatorContent">
                <h1 class="text-xl md:text-2xl lg:text-3xl font-bold titulo-cor text-center mb-4 md:mb-6 border-b pb-2">
                    Calculadora de Adicionais e Reflexos da Folha de Pagamento
                    <span id="cloudStatusBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
                </h1>
                
                <!-- Seletor de Colaborador -->
                <div class="mb-4 md:mb-6 p-3 md:p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-base md:text-lg titulo-cor mb-1 md:mb-2">Selecionar Colaborador</h3>
                            <p class="text-xs md:text-sm text-gray-600">Escolha um colaborador cadastrado para preencher os dados automaticamente</p>
                        </div>
                        <button id="refreshCollaborators" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                    </div>
                    <div class="mt-2 md:mt-3">
                        <select id="collaboratorSelect" class="w-full text-sm">
                            <option value="">-- Selecione um colaborador --</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 lg:gap-8">
                    
                    <!-- Coluna de Entradas (Inputs) -->
                    <div id="input-container">
                        <h2 class="text-lg md:text-xl font-semibold mb-3 md:mb-4 titulo-cor">Entradas de Dados</h2>

                        <div class="space-y-3 md:space-y-4 mb-4 md:mb-6 p-3 md:p-4 bg-gray-50 rounded-lg border">
                            <h3 class="font-bold text-base md:text-lg border-b pb-2 titulo-cor">Salário e Divisor</h3>
                            <div class="grid grid-cols-2 gap-3 md:gap-4">
                                <div>
                                    <label for="salarioBase" class="block text-xs md:text-sm font-medium text-gray-700">Salário Base (R$)</label>
                                    <input type="text" id="salarioBase" value="" class="mt-1 text-sm" placeholder="Ex: R$ 1.518,00">
                                </div>
                                <div>
                                    <label for="divisorMensal" class="block text-xs md:text-sm font-medium text-gray-700">Horas Mensais</label>
                                    <select id="divisorMensal" class="mt-1 text-sm">
                                        <option value="220" selected>220 (Padrão)</option>
                                        <option value="180">180 horas</option>
                                        <option value="170">170 (Reduzido)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex items-center mt-3 md:mt-4 pt-2 border-t">
                                <input type="checkbox" id="usaPericulosidade" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                                <label for="usaPericulosidade" class="text-xs md:text-sm font-medium text-gray-700">Incluir Adicional de Periculosidade (30%)</label>
                                 <span id="valorPericulosidadeInputDisplay" class="ml-auto font-bold titulo-cor text-sm">R$ 0,00</span>
                            </div>
                        </div>
                        
                        <div class="space-y-3 md:space-y-4 mb-4 md:mb-6 p-3 md:p-4 bg-gray-50 rounded-lg border">
                            <h3 class="font-bold text-base md:text-lg border-b pb-2 titulo-cor">Horas de Adicionais</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                                <div>
                                    <label for="horasSobreavisoTotal" class="block text-xs md:text-sm font-medium text-gray-700">Horas de Sobreaviso</label>
                                    <input type="text" id="horasSobreavisoTotal" value="00:00" placeholder="HH:MM" class="mt-1 text-center text-sm">
                                </div>
                                <div>
                                    <label for="horasTrabalhadas50" class="block text-xs md:text-sm font-medium text-gray-700">Horas Sobr. Trabalhado</label>
                                    <input type="text" id="horasTrabalhadas50" value="00:00" placeholder="HH:MM" class="mt-1 text-center text-sm">
                                </div>
                                <div>
                                    <label for="horasTrabalhadas100" class="block text-xs md:text-sm font-medium text-gray-700">Horas Extras</label>
                                    <input type="text" id="horasTrabalhadas100" value="00:00" placeholder="HH:MM" class="mt-1 text-center text-sm">
                                </div>
                                 <div>
                                    <label for="horasNoturnas" class="block text-xs md:text-sm font-medium text-gray-700">Horas de Ad. Noturno</label>
                                    <input type="text" id="horasNoturnas" value="00:00" placeholder="HH:MM" class="mt-1 text-center text-sm">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3 md:space-y-4 p-3 md:p-4 bg-gray-50 rounded-lg border">
                            <h3 class="font-bold text-base md:text-lg border-b pb-2 titulo-cor">Fator DSR, Dias e Ausências</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                                 <div>
                                    <label for="mesReferencia" class="block text-xs md:text-sm font-medium text-gray-700">Mês Ref.</label>
                                    <input type="month" id="mesReferencia" class="mt-1 text-sm">
                                </div>
                                <div>
                                    <label for="diasTrabalhados" class="block text-xs md:text-sm font-medium text-gray-700">Dias Normais</label>
                                    <input type="number" id="diasTrabalhados" min="1" max="30" value="30" class="mt-1 text-center text-sm">
                                    <p class="text-xs text-blue-600 font-medium">30 dias</p>
                                </div>
                                 <div>
                                    <label for="diasAtestado" class="block text-xs md:text-sm font-medium text-gray-700">Dias de Atestado</label>
                                    <input type="number" id="diasAtestado" value="0" min="0" class="mt-1 text-center text-sm">
                                </div>
                                <div class="holidays-field-container">
                                    <label for="diasFeriado" class="block text-xs md:text-sm font-medium text-gray-700">Feriados</label>
                                    <input type="number" id="diasFeriado" value="0" min="0" class="mt-1 text-center w-full text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <!-- BLOCO DE INFORMAÇÕES DE PAGAMENTO -->
                        <div class="payment-info mt-4">
                            <h3>
                                <i class="fas fa-credit-card"></i>
                                Informações de Pagamento
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="pagoFolha" class="block text-xs md:text-sm font-medium text-gray-700 mb-1">Pago em Folha?</label>
                                    <div class="flex items-center h-10">
                                        <input type="checkbox" id="pagoFolha" class="h-5 w-5 text-green-600 border-gray-300 rounded mr-2">
                                        <span class="text-xs md:text-sm text-gray-700">Sim, já pago</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="competenciaPagamento" class="block text-xs md:text-sm font-medium text-gray-700 mb-1">Competência de Pagamento</label>
                                    <input type="month" id="competenciaPagamento" class="w-full text-sm">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coluna de Resultados -->
                    <div>
                        <h2 class="text-lg md:text-xl font-semibold mb-3 md:mb-4 titulo-cor">Resultados e Bases</h2>

                        <div class="space-y-3 md:space-y-4 p-3 md:p-4 bg-indigo-50 rounded-lg border border-indigo-200 mb-4 md:mb-6">
                            <h3 class="font-bold text-base md:text-lg border-b pb-2 titulo-cor">Adicionais e Periculosidade</h3>
                            
                            <div id="periculosidadeDetalhada" class="text-xs text-gray-600 mb-2" style="display: none;"></div>
                            
                            <div class="flex justify-between text-sm md:text-base font-semibold">
                                <span>Periculosidade (30%)</span>
                                <span id="valorPericulosidade" class="titulo-cor">R$ 0,00</span>
                            </div>

                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Horas de Sobreaviso (Espera):</span>
                                <span id="valorSobreavisoEspera" class="titulo-cor">R$ 0,00</span>
                            </div>

                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Horas de Sobreaviso Trabalhado (<span id="heSobreavisoPorcentagemDisplay">50</span>%):</span>
                                <span id="valorHoraExtraTrabalho50" class="titulo-cor">R$ 0,00</span>
                            </div>
                            
                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Horas Extras <span id="heNormalPorcentagemDisplay">50</span>%:</span>
                                <span id="valorHoraExtraTrabalho100" class="titulo-cor">R$ 0,00</span>
                            </div>
                            
                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Adicional Noturno (<span id="adicionalNoturnoPorcentagemDisplay">20</span>%):</span>
                                <span id="valorAdicionalNoturno" class="titulo-cor">R$ 0,00</span>
                            </div>
                        </div>

                        <div class="space-y-3 md:space-y-4 p-3 md:p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                            <h3 class="font-bold text-base md:text-lg border-b pb-2 titulo-cor">Reflexos DSR (Fator: <span id="fatorDSRDisplay" class="font-extrabold">0.0000</span>)</h3>
                            
                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Reflexo Sobreaviso DSR (Espera 1/3):</span>
                                <span id="valorReflexoSobreavisoEspera" class="text-indigo-700 font-semibold">R$ 0,00</span>
                            </div>
                            
                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Reflexo Sob. Trabalhado DSR:</span>
                                <span id="valorReflexoSobreavisoTrabalhado" class="text-indigo-700 font-semibold">R$ 0,00</span>
                            </div>
                            
                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Reflexo Horas Extras DSR:</span>
                                <span id="valorReflexoHorasExtrasNormal" class="text-indigo-700 font-semibold">R$ 0,00</span>
                            </div>
                            
                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Reflexo Adic. Noturno DSR:</span>
                                <span id="valorReflexoAdicionalNoturno" class="text-indigo-700 font-semibold">R$ 0,00</span>
                            </div>

                            <div class="flex justify-between text-base md:text-lg font-bold pt-2 border-t border-indigo-300">
                                <span>TOTAL DOS REFLEXOS:</span>
                                <span id="valorReflexoDSRTotalSum" class="titulo-cor">R$ 0,00</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 md:mt-6">
                            <button id="toggleBases" class="toggle-bases-btn w-full text-left p-3 bg-indigo-100 hover:bg-indigo-200 rounded-lg border border-indigo-300 transition duration-150 mb-4">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-bold text-base md:text-lg titulo-cor">Base de cálculo por hora</h3>
                                    <span class="text-indigo-600">
                                        <i class="fas fa-chevron-down" id="basesIcon"></i>
                                    </span>
                                </div>
                            </button>
                            
                            <div id="basesContainer" class="p-3 md:p-4 bg-indigo-50 rounded-lg border border-indigo-200 space-y-3 hidden">
                                <div class="grid grid-cols-2 gap-4 mb-4 pb-4 border-b">
                                    <div>
                                        <label for="diasDomingo" class="block text-xs font-medium text-gray-700 mb-1">Domingos</label>
                                        <input type="number" id="diasDomingo" value="4" min="0" readonly class="mt-1 bg-gray-200 text-center text-sm">
                                    </div>
                                    <div>
                                        <label for="diasUteis" class="block text-xs font-medium text-gray-700 mb-1">Dias Úteis Base</label>
                                        <input type="number" id="diasUteis" value="26" min="1" readonly data-base-value="26" class="mt-1 bg-indigo-100 font-bold text-center text-sm">
                                    </div>
                                </div>
                                
                                <div class="flex justify-between text-xs md:text-sm">
                                    <span>Hora Normal:</span>
                                    <span id="horaNormal" class="font-semibold titulo-cor">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between text-xs md:text-sm">
                                    <span>Hora Sob. (1/3):</span>
                                    <span id="horaSobreaviso" class="font-semibold titulo-cor">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between text-xs md:text-sm">
                                    <span>Base p/ HE (c/ Peric.):</span>
                                    <span id="baseHePeric" class="font-semibold titulo-cor">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between text-xs md:text-sm">
                                    <span>Hora Extra (<span id="heNormalPorcentagemBaseDisplay">50</span>%):</span>
                                    <span id="horaExtra50" class="font-semibold titulo-cor">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BOTÕES DE AÇÃO -->
                <div class="flex flex-wrap justify-end gap-3 md:gap-4 mt-8 md:mt-12 print-hide border-t pt-4 md:pt-6">
                    <button id="saveCalculation" class="bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-2 px-3 md:px-4 rounded-lg text-sm md:text-base transition duration-150">
                        <i class="fas fa-save mr-1"></i> Salvar Cálculo
                        <span id="saveCloudBadge" class="sync-badge ml-2" style="display: none;">Cloud</span>
                    </button>
                    <button id="clearButton" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-3 md:px-4 rounded-lg text-sm md:text-base transition duration-150">
                        <i class="fas fa-eraser mr-1"></i> Limpar
                    </button>
                    <button id="printButton" class="text-sm md:text-base font-semibold py-2 px-3 md:px-4 rounded-lg transition duration-150">
                        <i class="fas fa-print mr-1"></i> Salvar em PDF
                    </button>
                </div>
            </div>

            <!-- CONTEÚDO DE LISTA DE COLABORADORES -->
            <div class="container hidden" id="collaboratorsContent">
                <h1 class="text-xl md:text-2xl lg:text-3xl font-bold titulo-cor text-center mb-4 md:mb-6 border-b pb-2">
                    <i class="fas fa-users mr-2"></i> Gerenciar Colaboradores
                    <span id="cloudCollaboratorBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
                </h1>
                
                <div class="mb-4 md:mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="tabCollaborators" class="tab-button border-b-2 border-blue-500 text-blue-600 py-3 md:py-4 px-1 text-xs md:text-sm font-medium active">
                                <i class="fas fa-users mr-2"></i> Colaboradores
                            </button>
                            <button id="tabDepartments" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-3 md:py-4 px-1 text-xs md:text-sm font-medium">
                                <i class="fas fa-building mr-2"></i> Departamentos
                            </button>
                        </nav>
                    </div>
                </div>
                
                <div id="collaboratorsTabContent">
                    <div class="mb-4 md:mb-6 p-3 md:p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex flex-wrap justify-between items-center gap-3">
                            <div class="flex flex-wrap gap-2">
                                <button id="addNewCollaborator" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 md:px-4 md:py-2 rounded flex items-center text-sm">
                                    <i class="fas fa-user-plus mr-2"></i> Novo
                                </button>
                                <button id="importCollaboratorsBtn" class="btn-importar text-sm px-3 py-1.5 md:px-4 md:py-2">
                                    <i class="fas fa-file-import mr-2"></i> Importar
                                </button>
                            </div>
                            <button id="refreshCollaboratorList" class="text-blue-600 hover:text-blue-800 text-sm px-2 py-1">
                                <i class="fas fa-sync-alt mr-1"></i> Atualizar
                            </button>
                        </div>
                    </div>
                    
                    <div class="status-toggle-buttons print-hide">
                        <button class="status-toggle-btn active text-xs md:text-sm" id="showActiveCollaborators">
                            <i class="fas fa-user-check mr-1"></i> Ativos
                        </button>
                        <button class="status-toggle-btn text-xs md:text-sm" id="showInactiveCollaborators">
                            <i class="fas fa-user-slash mr-1"></i> Inativos
                        </button>
                    </div>
                    
                    <div id="collaboratorsTableContainer"></div>
                </div>
                
                <div id="departmentsTabContent" class="hidden">
                    <div class="mb-4 md:mb-6 p-3 md:p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-base md:text-lg titulo-cor">Gerenciar Departamentos</h3>
                                <p class="text-xs md:text-sm text-gray-600">Adicione, edite ou exclua departamentos</p>
                            </div>
                            <div class="flex gap-2">
                                <button id="refreshDepartments" class="text-blue-600 hover:text-blue-800 text-sm px-2 py-1">
                                    <i class="fas fa-sync-alt mr-1"></i> Atualizar
                                </button>
                                <button id="addNewDepartment" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 md:px-3 md:py-1 rounded text-sm">
                                    <i class="fas fa-plus mr-1"></i> Novo
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="departmentsTableContainer">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-building fa-3x mb-4"></i>
                            <p class="text-base md:text-lg">Nenhum departamento cadastrado ainda.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTEÚDO DE HISTÓRICO DE CÁLCULOS -->
            <div class="container hidden" id="historyContent">
                <h1 class="text-xl md:text-2xl lg:text-3xl font-bold titulo-cor text-center mb-4 md:mb-6 border-b pb-2">
                    <i class="fas fa-history mr-2"></i> Histórico de Cálculos
                    <span id="cloudHistoryBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
                </h1>
                
                <div class="mb-4 md:mb-6 p-3 md:p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3">
                        <div>
                            <h3 class="font-bold text-base md:text-lg titulo-cor">Histórico de Cálculos</h3>
                            <p class="text-xs md:text-sm text-gray-600">Visualize todos os cálculos salvos</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="refreshHistory" class="text-blue-600 hover:text-blue-800 text-sm px-2 py-1">
                                <i class="fas fa-sync-alt mr-1"></i> Atualizar
                            </button>
                            <button id="clearHistoryFilters" class="bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm px-2 py-1 rounded">
                                <i class="fas fa-filter-circle-xmark mr-1"></i> Limpar Filtros
                            </button>
                        </div>
                    </div>
                    
                    <div id="historyFilters" class="mt-3 md:mt-4 p-3 bg-white rounded border">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Colaborador</label>
                                <select id="filterCollaborator" class="w-full text-sm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Departamento</label>
                                <select id="filterDepartment" class="w-full text-sm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Período Início</label>
                                <input type="month" id="filterStartMonth" class="w-full text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Período Fim</label>
                                <input type="month" id="filterEndMonth" class="w-full text-sm">
                            </div>
                        </div>
                        <div class="flex justify-end mt-3">
                            <button id="applyFilters" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1.5 rounded">
                                Aplicar Filtros
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="history-table text-sm">
                        <thead>
                            <tr>
                                <th class="text-xs md:text-sm">Mês Ref.</th>
                                <th class="text-xs md:text-sm">Colaborador</th>
                                <th class="text-xs md:text-sm">Departamento</th>
                                <th class="text-xs md:text-sm">Data Cálculo</th>
                                <th class="text-xs md:text-sm">Pago</th>
                                <th class="text-xs md:text-sm">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ABA DE RELATÓRIOS -->
            <div class="container hidden" id="reportsContent">
                <h1 class="text-xl md:text-2xl lg:text-3xl font-bold titulo-cor text-center mb-4 md:mb-6 border-b pb-2">
                    <i class="fas fa-chart-bar mr-2"></i> Relatórios de Cálculos
                    <span id="cloudReportsBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
                </h1>
                
                <div class="mb-4 md:mb-6 p-3 md:p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h3 class="font-bold text-base md:text-lg titulo-cor">Relatórios Personalizados</h3>
                            <p class="text-xs md:text-sm text-gray-600">Gere relatórios com filtros específicos</p>
                        </div>
                        <button id="refreshReports" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-sync-alt mr-1"></i> Atualizar
                        </button>
                    </div>
                    
                    <div class="p-3 bg-white rounded border">
                        <div class="mb-3 p-2 bg-gray-50 rounded border">
                            <h5 class="font-medium text-xs mb-2">Colunas do Relatório</h5>
                            <div class="flex flex-wrap gap-1">
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="colaborador">Colaborador</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="departamento">Depto</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="salario">Salário</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="periculosidade">Peric</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="sobreaviso">Sob.</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="sobreaviso_trabalhado">Sob.Trab</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="horas_extras">HE</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="adicional_noturno">Not.</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="reflexos">Reflexos</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="total">Total</button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Colaborador</label>
                                <select id="reportCollaborator" class="w-full text-sm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Departamento</label>
                                <select id="reportDepartment" class="w-full text-sm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Mês Referência</label>
                                <input type="month" id="reportMonth" class="w-full text-sm">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Data Início</label>
                                <input type="date" id="reportStartDate" class="w-full text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Data Fim</label>
                                <input type="date" id="reportEndDate" class="w-full text-sm">
                            </div>
                        </div>
                        
                        <div class="flex justify-between">
                            <button id="clearReportFilters" class="bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm px-3 py-1.5 rounded">
                                <i class="fas fa-filter-circle-xmark mr-1"></i> Limpar
                            </button>
                            <button id="generateReport" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1.5 rounded">
                                <i class="fas fa-filter mr-1"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 md:mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-base md:text-lg titulo-cor">Relatório Detalhado</h3>
                        <div class="flex gap-2">
                            <button id="exportReportCSV" class="bg-green-100 hover:bg-green-200 text-green-800 text-xs md:text-sm px-2 py-1 rounded">
                                <i class="fas fa-file-csv mr-1"></i> CSV
                            </button>
                            <button id="exportReportPDF" class="bg-red-100 hover:bg-red-200 text-red-800 text-xs md:text-sm px-2 py-1 rounded">
                                <i class="fas fa-file-pdf mr-1"></i> PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="report-table text-xs md:text-sm" id="reportTable">
                            <thead id="reportTableHeader"></thead>
                            <tbody id="reportTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAIS -->
    <div class="modal" id="collaboratorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="collaboratorModalTitle">Cadastrar Novo Colaborador</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="collaboratorForm">
                    <input type="hidden" id="collaboratorEditId">
                    <div class="space-y-4">
                        <div>
                            <label for="collaboratorName" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo *</label>
                            <input type="text" id="collaboratorName" required class="w-full" placeholder="Ex: João da Silva">
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label for="collaboratorDepartment" class="block text-sm font-medium text-gray-700">Departamento *</label>
                                <button type="button" id="addDepartmentFromCollaborator" class="text-blue-600 hover:text-blue-800 text-xs">
                                    <i class="fas fa-plus mr-1"></i> Novo Departamento
                                </button>
                            </div>
                            <select id="collaboratorDepartment" required class="w-full">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div>
                            <label for="collaboratorBaseSalary" class="block text-sm font-medium text-gray-700 mb-1">Salário Base (R$) *</label>
                            <input type="text" id="collaboratorBaseSalary" required class="w-full" placeholder="Ex: R$ 2.500,00">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="collaboratorDivisor" class="block text-sm font-medium text-gray-700 mb-1">Horas Mensais *</label>
                                <select id="collaboratorDivisor" required class="w-full">
                                    <option value="220" selected>220 horas (Padrão)</option>
                                    <option value="180">180 horas</option>
                                    <option value="170">170 horas</option>
                                    <option value="200">200 horas</option>
                                </select>
                            </div>
                            <div>
                                <label for="collaboratorWorkHours" class="block text-sm font-medium text-gray-700 mb-1">Jornada Diária</label>
                                <select id="collaboratorWorkHours" class="w-full">
                                    <option value="8">8 horas</option>
                                    <option value="6">6 horas</option>
                                    <option value="4">4 horas</option>
                                    <option value="12">12x36</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="collaboratorPericulosidade" class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                                <label for="collaboratorPericulosidade" class="text-sm font-medium text-gray-700">Periculosidade?</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="collaboratorInsalubridade" class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                                <label for="collaboratorInsalubridade" class="text-sm font-medium text-gray-700">Insalubridade?</label>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4 mt-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status do Colaborador *</label>
                            <div class="status-radio-group">
                                <div class="status-radio-option">
                                    <input type="radio" id="collaboratorStatusActive" name="collaboratorStatus" value="active" checked>
                                    <label for="collaboratorStatusActive" class="text-sm text-gray-700 flex items-center">
                                        <span class="status-badge active mr-2 px-3 py-1">Ativo</span>
                                    </label>
                                </div>
                                <div class="status-radio-option">
                                    <input type="radio" id="collaboratorStatusInactive" name="collaboratorStatus" value="inactive">
                                    <label for="collaboratorStatusInactive" class="text-sm text-gray-700 flex items-center">
                                        <span class="status-badge inactive mr-2 px-3 py-1">Inativo</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                        <button type="button" id="cancelCollaborator" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <span id="collaboratorModalButton">Salvar Colaborador</span>
                            <span id="syncBadge" class="sync-badge ml-2" style="display: none;">Cloud</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="departmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="departmentModalTitle">Cadastrar Novo Departamento</h3>
                <button class="modal-close" id="closeDepartmentModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="departmentForm">
                    <div class="space-y-4">
                        <div>
                            <label for="departmentName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Departamento *</label>
                            <input type="text" id="departmentName" required class="w-full" placeholder="Ex: Produção">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="departmentActive" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                            <label for="departmentActive" class="text-sm font-medium text-gray-700">Departamento Ativo</label>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                        <button type="button" id="cancelDepartment" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <span id="departmentModalButton">Salvar Departamento</span>
                            <span id="syncBadgeDept" class="sync-badge ml-2" style="display: none;">Cloud</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="calculationDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="calculationDetailTitle">Detalhes do Cálculo</h3>
                <button class="modal-close" id="closeCalculationDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="calculationDetailContent" class="view-mode"></div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t" id="detailButtonsContainer">
                    <button type="button" id="closeCalculationDetail" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">Fechar</button>
                    <button type="button" id="editCalculationBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        <i class="fas fa-edit mr-1"></i> Editar
                    </button>
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t hidden" id="editButtonsContainer">
                    <button type="button" id="cancelEditBtn" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">Cancelar</button>
                    <button type="button" id="saveEditBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                        <i class="fas fa-save mr-1"></i> Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteCollaboratorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                    Confirmar Exclusão
                </h3>
                <button class="modal-close" id="closeDeleteModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4">
                    <i class="fas fa-user-slash text-red-600 text-5xl mb-4"></i>
                    <h4 class="text-xl font-bold text-gray-800 mb-2" id="deleteCollaboratorName"></h4>
                    <p class="text-gray-600 mb-6">Tem certeza que deseja excluir permanentemente este colaborador?</p>
                    <div class="flex justify-center gap-4">
                        <button id="cancelDeleteCollaborator" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button id="confirmDeleteCollaborator" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                            <i class="fas fa-trash mr-2"></i>Excluir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                    Confirmar Exclusão de Acesso
                </h3>
                <button class="modal-close" id="closeDeleteUserModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4">
                    <i class="fas fa-user-minus text-red-600 text-5xl mb-4"></i>
                    <h4 class="text-xl font-bold text-gray-800 mb-2" id="deleteUserEmail"></h4>
                    <p class="text-gray-600 mb-6">Tem certeza que deseja excluir o acesso deste usuário?</p>
                    <div class="flex justify-center gap-4">
                        <button id="cancelDeleteUser" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button id="confirmDeleteUser" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                            <i class="fas fa-trash mr-2"></i>Excluir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURAÇÃO DO FIREBASE
        // ============================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyBLgg6ICkkRMQimDU81tls9dxiNu-ubL1s",
            authDomain: "folha-pagamento-app.firebaseapp.com",
            projectId: "folha-pagamento-app",
            storageBucket: "folha-pagamento-app.firebasestorage.app",
            messagingSenderId: "482792411975",
            appId: "1:482792411975:web:c884c56ce5a38313d33262"
        };

        // Inicialização do Firebase
        let db, auth;
        let firebaseAvailable = false;
        
        try {
            if (typeof firebase !== 'undefined') {
                if (!firebase.apps || firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("✅ Firebase inicializado com sucesso!");
                }
                
                auth = firebase.auth();
                
                try {
                    db = firebase.firestore();
                    
                    try {
                        db.settings({
                            ignoreUndefinedProperties: true,
                            merge: true
                        });
                        console.log("✅ Firestore configurado");
                    } catch (settingsError) {
                        console.warn("⚠️ Erro ao configurar Firestore:", settingsError);
                    }
                    
                    firebaseAvailable = true;
                    
                } catch (firestoreError) {
                    console.error("❌ Erro ao inicializar Firestore:", firestoreError);
                    firebaseAvailable = false;
                    db = null;
                }
                
            } else {
                console.error("❌ Firebase SDK não carregado!");
            }
        } catch (error) {
            console.error("❌ Erro crítico ao inicializar Firebase:", error);
            firebaseAvailable = false;
        }

        // ============================================
        // VARIÁVEIS GLOBAIS
        // ============================================
        
        let currentUser = null;
        let isOnline = false;
        let userData = null;
        let currentCalculationDetailId = null;
        let importData = null;
        let currentCollaboratorStatus = 'active';
        let isAdmin = false;
        
        // Configurações de porcentagens
        let heNormalPorcentagem = 50;
        let heSobreavisoPorcentagem = 50;
        let adicionalNoturnoPorcentagem = 20;
        
        // Variáveis para relatórios
        let activeReportFilters = {};
        let visibleColumns = {
            colaborador: true,
            departamento: true,
            salario: true,
            periculosidade: true,
            sobreaviso: true,
            sobreaviso_trabalhado: true,
            horas_extras: true,
            adicional_noturno: true,
            reflexos: true,
            total: true
        };

        // Cache de usuários
        let userCache = [];
        const CACHE_KEY = 'folha_usuarios_cache';
        const CACHE_DURATION = 10 * 60 * 1000;

        // Listeners em tempo real - AGORA FUNCIONANDO DE VERDADE!
        let unsubscribeDepartments = null;
        let unsubscribeCollaborators = null;
        let unsubscribeCalculations = null;

        // ============================================
        // CHAVES DE ARMAZENAMENTO
        // ============================================
        
        const COLLABORATORS_STORAGE_KEY = 'folha_colaboradores_cadastrados';
        const CALCULATIONS_STORAGE_KEY = 'folha_calculos_salvos';
        const DEPARTMENTS_STORAGE_KEY = 'folha_departamentos';
        const SETTINGS_STORAGE_KEY = 'folha_configuracoes';
        
        // SEM DADOS DE TESTE
        const DEFAULT_DEPARTMENTS = [];

        // ============================================
        // FORMATAÇÃO DE MOEDA
        // ============================================
        
        const R$ = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

        // ============================================
        // FUNÇÕES DE CONFIGURAÇÕES
        // ============================================
        
        function loadSettings() {
            const savedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
            
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    heNormalPorcentagem = settings.heNormalPorcentagem || 50;
                    heSobreavisoPorcentagem = settings.heSobreavisoPorcentagem || 50;
                    adicionalNoturnoPorcentagem = settings.adicionalNoturnoPorcentagem || 20;
                } catch (e) {
                    console.error("Erro ao carregar configurações:", e);
                }
            }
            
            const heNormalInput = document.getElementById('heNormalPorcentagem');
            const heSobreavisoInput = document.getElementById('heSobreavisoPorcentagem');
            const adicionalNoturnoInput = document.getElementById('adicionalNoturnoPorcentagem');
            
            if (heNormalInput) heNormalInput.value = heNormalPorcentagem;
            if (heSobreavisoInput) heSobreavisoInput.value = heSobreavisoPorcentagem;
            if (adicionalNoturnoInput) adicionalNoturnoInput.value = adicionalNoturnoPorcentagem;
            
            updatePercentageDisplays();
        }
        
        function saveSettings() {
            const heNormalInput = document.getElementById('heNormalPorcentagem');
            const heSobreavisoInput = document.getElementById('heSobreavisoPorcentagem');
            const adicionalNoturnoInput = document.getElementById('adicionalNoturnoPorcentagem');
            
            heNormalPorcentagem = parseInt(heNormalInput.value) || 50;
            heSobreavisoPorcentagem = parseInt(heSobreavisoInput.value) || 50;
            adicionalNoturnoPorcentagem = parseInt(adicionalNoturnoInput.value) || 20;
            
            const settings = {
                heNormalPorcentagem,
                heSobreavisoPorcentagem,
                adicionalNoturnoPorcentagem,
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
            
            updatePercentageDisplays();
            calcular();
            
            alert('Configurações salvas com sucesso!');
            closeSettingsModal();
        }
        
        function updatePercentageDisplays() {
            const displays = [
                'heNormalPorcentagemDisplay',
                'heSobreavisoPorcentagemDisplay',
                'adicionalNoturnoPorcentagemDisplay',
                'heNormalPorcentagemReflexoDisplay',
                'heSobreavisoPorcentagemReflexoDisplay',
                'adicionalNoturnoPorcentagemReflexoDisplay',
                'heNormalPorcentagemBaseDisplay'
            ];
            
            displays.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (id.includes('Normal')) {
                        element.textContent = heNormalPorcentagem;
                    } else if (id.includes('Sobreaviso')) {
                        element.textContent = heSobreavisoPorcentagem;
                    } else if (id.includes('Noturno')) {
                        element.textContent = adicionalNoturnoPorcentagem;
                    }
                }
            });
        }
        
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // ============================================
        // FUNÇÕES DE ADMINISTRAÇÃO
        // ============================================
        
        const FORCED_ADMINS = [
            'marcia.wsnetfibra@gmail.com',
        ];
        
        async function checkAdminStatus(user) {
            if (!user) {
                isAdmin = false;
                document.getElementById('menuAdmin').style.display = 'none';
                document.getElementById('userRoleBadgeSide').style.display = 'none';
                document.getElementById('offlineBadgeSide').style.display = 'none';
                return;
            }
            
            if (FORCED_ADMINS.includes(user.email)) {
                console.log(`👑 Admin forçado detectado: ${user.email}`);
                isAdmin = true;
                document.getElementById('menuAdmin').style.display = 'block';
                document.getElementById('userRoleBadgeSide').style.display = 'inline-block';
                document.getElementById('offlineBadgeSide').style.display = 'none';
                
                if (db && firebaseAvailable) {
                    try {
                        await db.collection('users').doc(user.uid).set({
                            email: user.email,
                            isAdmin: true,
                            lastLogin: new Date().toISOString(),
                            isForcedAdmin: true
                        }, { merge: true });
                        console.log("✅ Admin forçado sincronizado com Firestore");
                    } catch (error) {
                        console.warn("⚠️ Não foi possível sincronizar admin forçado:", error);
                        document.getElementById('offlineBadgeSide').style.display = 'inline-block';
                    }
                } else {
                    document.getElementById('offlineBadgeSide').style.display = 'inline-block';
                }
                
                await loadAllUsers();
                return;
            }
            
            if (!db || !firebaseAvailable) {
                isAdmin = false;
                document.getElementById('menuAdmin').style.display = 'none';
                document.getElementById('userRoleBadgeSide').style.display = 'none';
                document.getElementById('offlineBadgeSide').style.display = 'inline-block';
                return;
            }
            
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    isAdmin = userData.isAdmin === true;
                    
                    if (isAdmin) {
                        document.getElementById('menuAdmin').style.display = 'block';
                        document.getElementById('userRoleBadgeSide').style.display = 'inline-block';
                    } else {
                        document.getElementById('menuAdmin').style.display = 'none';
                        document.getElementById('userRoleBadgeSide').style.display = 'none';
                    }
                    document.getElementById('offlineBadgeSide').style.display = 'none';
                    
                    await loadAllUsers();
                } else {
                    await initializeUserData();
                    checkAdminStatus(user);
                }
            } catch (error) {
                console.error("❌ Erro ao verificar status de admin:", error);
                isAdmin = false;
                document.getElementById('menuAdmin').style.display = 'none';
                document.getElementById('userRoleBadgeSide').style.display = 'none';
                document.getElementById('offlineBadgeSide').style.display = 'inline-block';
            }
        }
        
        async function loadAllUsers() {
            const warningDiv = document.getElementById('adminWarning');
            const warningText = document.getElementById('adminWarningText');
            const userCountBadge = document.getElementById('userCountBadge');
            
            let usersList = [];
            let isOffline = true;
            
            if (db && firebaseAvailable) {
                try {
                    console.log("📥 Carregando usuários do Firestore...");
                    const usersSnapshot = await db.collection('users').get();
                    
                    usersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        usersList.push({
                            uid: doc.id,
                            email: userData.email || 'Email não disponível',
                            isAdmin: userData.isAdmin === true,
                            createdAt: userData.createdAt ? new Date(userData.createdAt.seconds * 1000) : new Date(),
                            lastLogin: userData.lastLogin ? new Date(userData.lastLogin.seconds * 1000) : new Date()
                        });
                    });
                    
                    console.log(`✅ ${usersList.length} usuário(s) carregados do Firestore`);
                    isOffline = false;
                    
                    localStorage.setItem(CACHE_KEY, JSON.stringify({
                        users: usersList,
                        timestamp: Date.now()
                    }));
                    
                    warningDiv.style.display = 'none';
                    
                } catch (error) {
                    console.error("❌ Erro ao carregar usuários do Firestore:", error);
                    firebaseAvailable = false;
                    warningDiv.style.display = 'block';
                    warningText.innerHTML = 'Erro ao conectar ao banco de dados. Exibindo usuários em cache.';
                }
            }
            
            if (usersList.length === 0) {
                try {
                    const cached = localStorage.getItem(CACHE_KEY);
                    if (cached) {
                        const parsed = JSON.parse(cached);
                        usersList = parsed.users || [];
                        console.log(`📦 ${usersList.length} usuário(s) carregados do cache`);
                        warningDiv.style.display = 'block';
                        warningText.innerHTML = 'Modo offline - exibindo dados do cache local.';
                    }
                } catch (e) {
                    console.warn("⚠️ Erro ao ler cache:", e);
                }
            }
            
            FORCED_ADMINS.forEach(email => {
                const exists = usersList.some(u => u.email === email);
                if (!exists) {
                    usersList.push({
                        uid: `forced-${email}`,
                        email: email,
                        isAdmin: true,
                        createdAt: new Date(),
                        lastLogin: new Date(),
                        isForced: true
                    });
                    console.log(`➕ Usuário forçado adicionado: ${email}`);
                }
            });
            
            if (currentUser && !usersList.some(u => u.uid === currentUser.uid)) {
                usersList.push({
                    uid: currentUser.uid,
                    email: currentUser.email,
                    isAdmin: isAdmin,
                    createdAt: new Date(),
                    lastLogin: new Date()
                });
            }
            
            usersList.sort((a, b) => a.email.localeCompare(b.email));
            if (userCountBadge) {
                userCountBadge.textContent = `${usersList.length} usuário(s)`;
            }
            
            renderAdminUsersList(usersList);
            
            if (isOffline) {
                document.getElementById('offlineBadgeSide').style.display = 'inline-block';
            }
        }
        
        function renderAdminUsersList(users) {
            const container = document.getElementById('adminUsersList');
            
            if (!users || users.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-users fa-4x mb-4 text-gray-400"></i>
                        <p class="text-lg font-medium">Nenhum usuário encontrado</p>
                        <p class="text-sm mt-2">Faça login para sincronizar seus dados.</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="space-y-3">';
            
            users.forEach(user => {
                const isCurrentUser = currentUser && user.uid === currentUser.uid;
                const isForcedUser = user.uid && user.uid.startsWith('forced-');
                const createdAtStr = user.createdAt ? 
                    (user.createdAt instanceof Date ? user.createdAt.toLocaleDateString('pt-BR') : 
                    (typeof user.createdAt === 'string' ? new Date(user.createdAt).toLocaleDateString('pt-BR') : 'Data desconhecida')) 
                    : 'Data desconhecida';
                const lastLoginStr = user.lastLogin ? 
                    (user.lastLogin instanceof Date ? user.lastLogin.toLocaleDateString('pt-BR') : 
                    (typeof user.lastLogin === 'string' ? new Date(user.lastLogin).toLocaleDateString('pt-BR') : 'Nunca acessou')) 
                    : 'Nunca acessou';
                
                html += `
                    <div class="admin-user-item bg-white rounded-lg border hover:shadow-md transition-shadow">
                        <div class="flex-1">
                            <div class="flex items-center flex-wrap gap-2">
                                <span class="admin-user-email text-base">
                                    ${user.email}
                                </span>
                                ${user.isAdmin ? '<span class="admin-badge text-xs px-2 py-1">Admin</span>' : ''}
                                ${isCurrentUser ? '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Você</span>' : ''}
                                ${isForcedUser ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">Forçado</span>' : ''}
                                ${!firebaseAvailable ? '<span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">Local</span>' : ''}
                            </div>
                            <div class="admin-user-date text-xs text-gray-500 mt-1">
                                Cadastro: ${createdAtStr} | Último acesso: ${lastLoginStr}
                            </div>
                        </div>
                        <div class="admin-actions ml-4">
                            ${!user.isAdmin && !isCurrentUser && isAdmin && !isForcedUser ? `
                                <button class="make-admin-btn text-blue-600 hover:text-blue-800 text-sm px-2 py-1 rounded hover:bg-blue-50" data-uid="${user.uid}" data-email="${user.email}" title="Tornar administrador">
                                    <i class="fas fa-crown"></i>
                                </button>
                            ` : ''}
                            ${user.isAdmin && !isCurrentUser && isAdmin && !isForcedUser ? `
                                <button class="remove-admin-btn text-orange-600 hover:text-orange-800 text-sm px-2 py-1 rounded hover:bg-orange-50" data-uid="${user.uid}" data-email="${user.email}" title="Remover administrador">
                                    <i class="fas fa-ban"></i>
                                </button>
                            ` : ''}
                            ${!isCurrentUser && isAdmin && !isForcedUser ? `
                                <button class="delete-user-btn text-red-600 hover:text-red-800 text-sm px-2 py-1 rounded hover:bg-red-50" data-uid="${user.uid}" data-email="${user.email}" title="Excluir usuário">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                            ${isForcedUser ? `
                                <span class="text-gray-400 text-xs italic px-2">Usuário forçado</span>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            if (isAdmin && firebaseAvailable) {
                document.querySelectorAll('.make-admin-btn').forEach(btn => {
                    btn.addEventListener('click', () => makeUserAdmin(btn.dataset.uid, btn.dataset.email));
                });
                
                document.querySelectorAll('.remove-admin-btn').forEach(btn => {
                    btn.addEventListener('click', () => removeUserAdmin(btn.dataset.uid, btn.dataset.email));
                });
                
                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', () => showDeleteUserModal(btn.dataset.uid, btn.dataset.email));
                });
            }
        }
        
        async function makeUserAdmin(uid, email) {
            if (!db || !firebaseAvailable) {
                alert('❌ Banco de dados não disponível. Operação cancelada.');
                return;
            }
            
            if (!confirm(`Deseja tornar o usuário ${email} administrador?`)) {
                return;
            }
            
            try {
                await db.collection('users').doc(uid).update({
                    isAdmin: true,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`✅ Usuário ${email} agora é administrador!`);
                
                localStorage.removeItem(CACHE_KEY);
                await loadAllUsers();
                
            } catch (error) {
                console.error("Erro ao tornar admin:", error);
                alert('❌ Erro ao atualizar permissões. Verifique sua conexão e tente novamente.');
            }
        }
        
        async function removeUserAdmin(uid, email) {
            if (!db || !firebaseAvailable) {
                alert('❌ Banco de dados não disponível. Operação cancelada.');
                return;
            }
            
            if (!confirm(`Deseja remover os privilégios de administrador do usuário ${email}?`)) {
                return;
            }
            
            try {
                await db.collection('users').doc(uid).update({
                    isAdmin: false,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`✅ Privilégios de administrador removidos de ${email}.`);
                
                localStorage.removeItem(CACHE_KEY);
                await loadAllUsers();
                
            } catch (error) {
                console.error("Erro ao remover admin:", error);
                alert('❌ Erro ao atualizar permissões. Verifique sua conexão e tente novamente.');
            }
        }
        
        function showDeleteUserModal(uid, email) {
            document.getElementById('deleteUserEmail').textContent = email;
            document.getElementById('deleteUserModal').dataset.uid = uid;
            document.getElementById('deleteUserModal').classList.add('active');
        }
        
        async function confirmDeleteUser() {
            if (!db || !firebaseAvailable) {
                alert('❌ Banco de dados não disponível. Operação cancelada.');
                return;
            }
            
            const uid = document.getElementById('deleteUserModal').dataset.uid;
            const email = document.getElementById('deleteUserEmail').textContent;
            
            if (!uid) return;
            
            try {
                await db.collection('users').doc(uid).delete();
                
                alert(`✅ Acesso do usuário ${email} excluído com sucesso!`);
                closeDeleteUserModal();
                
                localStorage.removeItem(CACHE_KEY);
                await loadAllUsers();
                
            } catch (error) {
                console.error("Erro ao excluir usuário:", error);
                alert('❌ Erro ao excluir usuário. Verifique sua conexão e tente novamente.');
            }
        }
        
        function closeDeleteUserModal() {
            document.getElementById('deleteUserModal').classList.remove('active');
            document.getElementById('deleteUserModal').dataset.uid = '';
        }
        
        function openAdminModal() {
            document.getElementById('adminModal').classList.add('active');
            loadAllUsers();
        }
        
        function closeAdminModal() {
            document.getElementById('adminModal').classList.remove('active');
        }

        // ============================================
        // FUNÇÕES DE AUTENTICAÇÃO FIREBASE
        // ============================================
        
        if (auth) {
            auth.onAuthStateChanged(async (user) => {
                updateAuthUI(user);
                
                if (user) {
                    currentUser = user;
                    isOnline = true;
                    
                    console.log("👤 Usuário logado:", user.email);
                    document.getElementById('userEmailSide').textContent = user.email;
                    document.getElementById('btnLogout').style.display = 'flex';
                    
                    await checkAdminStatus(user);
                    
                    // Carregar dados iniciais
                    await loadUserData();
                    
                    // Configurar listeners em tempo real - AGORA FUNCIONANDO!
                    setupRealtimeListeners();
                    
                } else {
                    console.log("👤 Usuário desconectado");
                    currentUser = null;
                    isOnline = false;
                    userData = null;
                    isAdmin = false;
                    document.getElementById('menuAdmin').style.display = 'none';
                    document.getElementById('userRoleBadgeSide').style.display = 'none';
                    document.getElementById('offlineBadgeSide').style.display = 'none';
                    document.getElementById('userEmailSide').textContent = '';
                    document.getElementById('btnLogout').style.display = 'none';
                    
                    // Remover listeners
                    if (unsubscribeDepartments) unsubscribeDepartments();
                    if (unsubscribeCollaborators) unsubscribeCollaborators();
                    if (unsubscribeCalculations) unsubscribeCalculations();
                }
            });
        } else {
            console.warn("Firebase Auth não disponível - modo offline");
            updateAuthUI(null);
        }

        function updateAuthUI(user) {
            const statusElement = document.getElementById('firebaseStatus');
            const loginModal = document.getElementById('loginModal');
            
            if (user && auth) {
                if (firebaseAvailable) {
                    statusElement.className = 'firebase-status firebase-connected';
                    statusElement.innerHTML = '<i class="fas fa-cloud"></i> <span>Sincronizado com a nuvem</span>';
                } else {
                    statusElement.className = 'firebase-status firebase-disconnected';
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>Modo offline (Firestore indisponível)</span>';
                }
                
                if (loginModal && loginModal.classList.contains('active')) {
                    loginModal.classList.remove('active');
                }
                
            } else {
                statusElement.className = 'firebase-status firebase-disconnected';
                statusElement.innerHTML = '<i class="fas fa-laptop"></i> <span>Modo offline (apenas local)</span>';
                
                if (auth && !localStorage.getItem('skipLogin') && !loginModal.classList.contains('active')) {
                    loginModal.classList.add('active');
                }
            }
        }

        // ============================================
        // FUNÇÕES DE RECUPERAÇÃO DE SENHA
        // ============================================
        
        document.getElementById('forgotPasswordBtn').addEventListener('click', () => {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('forgotPasswordModal').classList.add('active');
            document.getElementById('forgotPasswordError').classList.remove('show');
            document.getElementById('forgotPasswordSuccessModal').style.display = 'none';
            document.getElementById('forgotEmail').value = '';
        });

        document.getElementById('btnBackToLogin').addEventListener('click', () => {
            document.getElementById('forgotPasswordModal').classList.remove('active');
            document.getElementById('loginModal').classList.add('active');
        });

        document.getElementById('btnSendResetLink').addEventListener('click', async () => {
            const email = document.getElementById('forgotEmail').value;
            const errorElement = document.getElementById('forgotPasswordError');
            const errorText = document.getElementById('forgotErrorText');
            const successElement = document.getElementById('forgotPasswordSuccessModal');
            
            if (!email) {
                errorText.textContent = 'Por favor, digite seu email.';
                errorElement.classList.add('show');
                successElement.style.display = 'none';
                return;
            }
            
            try {
                await auth.sendPasswordResetEmail(email);
                errorElement.classList.remove('show');
                successElement.style.display = 'flex';
                
                setTimeout(() => {
                    document.getElementById('forgotPasswordModal').classList.remove('active');
                    document.getElementById('loginModal').classList.add('active');
                }, 3000);
                
            } catch (error) {
                console.error('❌ Erro ao enviar email de recuperação:', error);
                errorText.textContent = getFirebaseErrorMessage(error.code);
                errorElement.classList.add('show');
                successElement.style.display = 'none';
            }
        });

        // ============================================
        // CONFIGURAÇÃO DO ENTER PARA LOGIN
        // ============================================
        
        document.getElementById('loginPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('btnLogin').click();
            }
        });

        document.getElementById('loginEmail').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('loginPassword').focus();
            }
        });

        document.getElementById('signupPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('signupConfirmPassword').focus();
            }
        });

        document.getElementById('signupConfirmPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('btnSignup').click();
            }
        });

        document.getElementById('forgotEmail').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('btnSendResetLink').click();
            }
        });

        // ============================================
        // FUNÇÕES DE SINCRONIZAÇÃO EM TEMPO REAL - CORRIGIDAS!
        // ============================================
        
        function setupRealtimeListeners() {
            if (!currentUser || !db || !firebaseAvailable) return;
            
            console.log("🔄 Configurando listeners em tempo real...");
            
            // Listener para departamentos - ATUALIZA EM TEMPO REAL
            unsubscribeDepartments = db.collection('users').doc(currentUser.uid)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        console.log("📦 Dados de departamentos atualizados:", data.departments);
                        
                        if (data.departments) {
                            // Atualizar localStorage
                            localStorage.setItem(DEPARTMENTS_STORAGE_KEY, JSON.stringify(data.departments));
                            
                            // Atualizar interface
                            updateDepartmentSelect();
                            renderDepartmentsTable();
                            
                            // Mostrar notificação sutil
                            showSyncNotification('Departamentos sincronizados');
                        }
                    }
                }, (error) => {
                    console.error("Erro no listener de departamentos:", error);
                });
            
            // Listener para colaboradores - ATUALIZA EM TEMPO REAL
            unsubscribeCollaborators = db.collection('users').doc(currentUser.uid)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        console.log("📦 Dados de colaboradores atualizados:", data.collaborators);
                        
                        if (data.collaborators) {
                            // Atualizar localStorage
                            localStorage.setItem(COLLABORATORS_STORAGE_KEY, JSON.stringify(data.collaborators));
                            
                            // Atualizar interface
                            updateCollaboratorSelect();
                            updateCollaboratorFilterSelect();
                            renderCollaboratorsTable(currentCollaboratorStatus);
                            
                            // Mostrar notificação sutil
                            showSyncNotification('Colaboradores sincronizados');
                        }
                    }
                }, (error) => {
                    console.error("Erro no listener de colaboradores:", error);
                });
            
            // Listener para cálculos - ATUALIZA EM TEMPO REAL
            unsubscribeCalculations = db.collection('users').doc(currentUser.uid)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        console.log("📦 Dados de cálculos atualizados:", data.calculations);
                        
                        if (data.calculations) {
                            // Atualizar localStorage
                            localStorage.setItem(CALCULATIONS_STORAGE_KEY, JSON.stringify(data.calculations));
                            
                            // Atualizar interface se estiver na aba de histórico
                            if (!document.getElementById('historyContent').classList.contains('hidden')) {
                                renderHistoryTable();
                            }
                            
                            // Mostrar notificação sutil
                            showSyncNotification('Cálculos sincronizados');
                        }
                    }
                }, (error) => {
                    console.error("Erro no listener de cálculos:", error);
                });
        }
        
        // Função para mostrar notificação de sincronização
        function showSyncNotification(message) {
            // Criar elemento de notificação se não existir
            let notification = document.getElementById('syncNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'syncNotification';
                notification.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background-color: #10B981;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 12px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    z-index: 10000;
                    display: none;
                    align-items: center;
                    gap: 8px;
                `;
                notification.innerHTML = '<i class="fas fa-check-circle"></i><span></span>';
                document.body.appendChild(notification);
            }
            
            // Mostrar notificação
            const span = notification.querySelector('span');
            span.textContent = message;
            notification.style.display = 'flex';
            
            // Esconder após 2 segundos
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        async function loadUserData() {
            if (!currentUser || !db || !firebaseAvailable) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    console.log("✅ Dados do usuário carregados do Firestore");
                    
                    // Atualizar localStorage com dados do Firestore
                    if (userData.departments) {
                        localStorage.setItem(DEPARTMENTS_STORAGE_KEY, JSON.stringify(userData.departments));
                    }
                    if (userData.collaborators) {
                        localStorage.setItem(COLLABORATORS_STORAGE_KEY, JSON.stringify(userData.collaborators));
                    }
                    if (userData.calculations) {
                        localStorage.setItem(CALCULATIONS_STORAGE_KEY, JSON.stringify(userData.calculations));
                    }
                    
                    // Atualizar interface
                    updateDepartmentSelect();
                    renderDepartmentsTable();
                    updateCollaboratorSelect();
                    updateCollaboratorFilterSelect();
                    renderCollaboratorsTable(currentCollaboratorStatus);
                    
                } else {
                    await initializeUserData();
                }
            } catch (error) {
                console.error("❌ Erro ao carregar dados do usuário:", error);
            }
        }

        async function initializeUserData() {
            if (!currentUser || !db || !firebaseAvailable) return;
            
            try {
                let isFirstUser = false;
                try {
                    const usersSnapshot = await db.collection('users').get();
                    isFirstUser = usersSnapshot.size === 0;
                } catch (error) {
                    console.warn("⚠️ Erro ao verificar primeiro usuário:", error);
                }
                
                const shouldBeAdmin = isFirstUser || FORCED_ADMINS.includes(currentUser.email);
                
                const initialData = {
                    email: currentUser.email,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    departments: [],
                    collaborators: [],
                    calculations: [],
                    isAdmin: shouldBeAdmin,
                    lastSync: new Date().toISOString()
                };
                
                await db.collection('users').doc(currentUser.uid).set(initialData, { merge: true });
                userData = initialData;
                console.log("✅ Dados iniciais criados no Firestore");
                
                if (shouldBeAdmin) {
                    isAdmin = true;
                    document.getElementById('menuAdmin').style.display = 'block';
                    document.getElementById('userRoleBadgeSide').style.display = 'inline-block';
                }
                
            } catch (error) {
                console.error("❌ Erro ao inicializar dados do usuário:", error);
            }
        }

        async function syncDataWithFirebase(field, data) {
            if (!currentUser || !db || !firebaseAvailable) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    [field]: data,
                    lastSync: new Date().toISOString()
                });
                
                if (userData) {
                    userData[field] = data;
                }
                console.log(`✅ ${field} sincronizado com Firebase`);
                
            } catch (error) {
                console.error(`❌ Erro ao sincronizar ${field}:`, error);
                throw error;
            }
        }

        // ============================================
        // FUNÇÕES DE LOGIN/CADASTRO
        // ============================================
        
        document.getElementById('tabLogin').addEventListener('click', () => {
            document.getElementById('tabLogin').classList.add('active');
            document.getElementById('tabSignup').classList.remove('active');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('forgotPasswordSuccess').style.display = 'none';
        });
        
        document.getElementById('tabSignup').addEventListener('click', () => {
            document.getElementById('tabSignup').classList.add('active');
            document.getElementById('tabLogin').classList.remove('active');
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('forgotPasswordSuccess').style.display = 'none';
        });

        document.getElementById('btnLogin').addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');
            const errorText = document.getElementById('errorText');
            
            if (!email || !password) {
                errorText.textContent = 'Por favor, preencha email e senha.';
                errorElement.classList.add('show');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                errorElement.classList.remove('show');
                
            } catch (error) {
                console.error('❌ Erro no login:', error);
                errorText.textContent = getFirebaseErrorMessage(error.code);
                errorElement.classList.add('show');
            }
        });

        document.getElementById('btnSignup').addEventListener('click', async () => {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const errorElement = document.getElementById('loginError');
            const errorText = document.getElementById('errorText');
            
            if (!email || !password || !confirmPassword) {
                errorText.textContent = 'Por favor, preencha todos os campos.';
                errorElement.classList.add('show');
                return;
            }
            
            if (password !== confirmPassword) {
                errorText.textContent = 'As senhas não coincidem.';
                errorElement.classList.add('show');
                return;
            }
            
            if (password.length < 6) {
                errorText.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                errorElement.classList.add('show');
                return;
            }
            
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                errorElement.classList.remove('show');
                
            } catch (error) {
                console.error('❌ Erro no cadastro:', error);
                errorText.textContent = getFirebaseErrorMessage(error.code);
                errorElement.classList.add('show');
            }
        });

        document.getElementById('btnContinueOffline').addEventListener('click', () => {
            localStorage.setItem('skipLogin', 'true');
            document.getElementById('loginModal').classList.remove('active');
        });

        document.getElementById('btnLogout').addEventListener('click', () => {
            auth.signOut();
            localStorage.removeItem('skipLogin');
        });

        function getFirebaseErrorMessage(errorCode) {
            const messages = {
                'auth/user-not-found': 'Usuário não encontrado.',
                'auth/wrong-password': 'Senha incorreta.',
                'auth/email-already-in-use': 'Este email já está em uso.',
                'auth/weak-password': 'A senha é muito fraca.',
                'auth/invalid-email': 'Email inválido.',
                'auth/network-request-failed': 'Erro de conexão. Verifique sua internet.',
                'auth/too-many-requests': 'Muitas tentativas. Tente novamente mais tarde.',
                'auth/user-disabled': 'Esta conta foi desativada.'
            };
            
            return messages[errorCode] || 'Ocorreu um erro. Tente novamente.';
        }

        // ============================================
        // FUNÇÕES DE ARMAZENAMENTO
        // ============================================
        
        function getDepartmentsFromStorage() {
            const savedData = localStorage.getItem(DEPARTMENTS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        function getCollaboratorsFromStorage() {
            const savedData = localStorage.getItem(COLLABORATORS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        function getCalculationsFromStorage() {
            const savedData = localStorage.getItem(CALCULATIONS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        async function saveDepartments(departments) {
            localStorage.setItem(DEPARTMENTS_STORAGE_KEY, JSON.stringify(departments));
            
            // Sincronizar com Firebase
            if (currentUser && db && firebaseAvailable) {
                await syncDataWithFirebase('departments', departments);
            }
            
            if (userData) {
                userData.departments = departments;
            }
        }
        
        async function saveCollaborators(collaborators) {
            localStorage.setItem(COLLABORATORS_STORAGE_KEY, JSON.stringify(collaborators));
            
            // Sincronizar com Firebase
            if (currentUser && db && firebaseAvailable) {
                await syncDataWithFirebase('collaborators', collaborators);
            }
            
            if (userData) {
                userData.collaborators = collaborators;
            }
        }
        
        async function saveCalculations(calculations) {
            localStorage.setItem(CALCULATIONS_STORAGE_KEY, JSON.stringify(calculations));
            
            // Sincronizar com Firebase
            if (currentUser && db && firebaseAvailable) {
                await syncDataWithFirebase('calculations', calculations);
            }
            
            if (userData) {
                userData.calculations = calculations;
            }
        }
        
        function getDepartments() {
            const savedData = localStorage.getItem(DEPARTMENTS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        function getCollaborators() {
            const savedData = localStorage.getItem(COLLABORATORS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        function getSavedCalculations() {
            const savedData = localStorage.getItem(CALCULATIONS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        function saveDepartmentsToStorage(departments) {
            localStorage.setItem(DEPARTMENTS_STORAGE_KEY, JSON.stringify(departments));
        }
        
        function saveCollaboratorsToStorage(collaborators) {
            localStorage.setItem(COLLABORATORS_STORAGE_KEY, JSON.stringify(collaborators));
        }
        
        function saveCalculationsToStorage(calculations) {
            localStorage.setItem(CALCULATIONS_STORAGE_KEY, JSON.stringify(calculations));
        }

        // ============================================
        // FUNÇÕES DE NOTIFICAÇÃO DE DUPLICIDADE
        // ============================================
        
        function showDuplicateNotification(message) {
            const notification = document.getElementById('duplicateNotification');
            const messageElement = document.getElementById('duplicateMessage');
            
            messageElement.textContent = message || 'Este cálculo já foi salvo anteriormente para este colaborador no mesmo mês.';
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        function checkDuplicateCalculation(collaboratorId, mesReferencia, currentCalculationId = null) {
            const calculations = getSavedCalculations();
            
            return calculations.some(calc => 
                calc.collaboratorId == collaboratorId && 
                calc.mesReferencia === mesReferencia &&
                (currentCalculationId === null || calc.id !== currentCalculationId)
            );
        }

        // ============================================
        // FUNÇÕES DE IMPORTAÇÃO DE PLANILHA
        // ============================================
        
        function openImportModal() {
            document.getElementById('importSpreadsheetModal').classList.add('active');
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importMessages').innerHTML = '';
            document.getElementById('spreadsheetFile').value = '';
            importData = null;
        }
        
        function closeImportModal() {
            document.getElementById('importSpreadsheetModal').classList.remove('active');
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('spreadsheetFile').value = '';
            importData = null;
        }
        
        function parseCurrencyBR(value) {
            if (typeof value !== 'string') {
                value = String(value);
            }
            
            let cleanValue = value.replace(/R\$\s*/g, '')
                                 .replace(/\./g, '')
                                 .replace(/,/g, '.')
                                 .trim();
            
            if (cleanValue.startsWith('.')) {
                cleanValue = '0' + cleanValue;
            }
            
            const parsed = parseFloat(cleanValue);
            return isNaN(parsed) ? 0 : parsed;
        }
        
        function formatCurrencyForStorage(value) {
            if (typeof value === 'number') {
                return value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }
            
            const numValue = parseCurrencyBR(value);
            return numValue.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        function parseBoolean(value) {
            if (typeof value === 'string') {
                const lower = value.toLowerCase().trim();
                return lower === 'sim' || lower === 's' || lower === 'yes' || lower === 'y' || lower === '1' || lower === 'verdadeiro' || lower === 'true';
            }
            return Boolean(value);
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheet];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    
                    processSpreadsheetData(jsonData);
                } catch (error) {
                    console.error('Erro ao processar planilha:', error);
                    showImportMessage('error', 'Erro ao processar o arquivo. Verifique se o formato é válido.');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processSpreadsheetData(rows) {
            if (rows.length < 2) {
                showImportMessage('error', 'A planilha está vazia ou não contém dados suficientes.');
                return;
            }
            
            const headers = rows[0].map(h => String(h || '').toLowerCase().trim());
            
            const nameIndex = headers.findIndex(h => h.includes('nome'));
            const deptIndex = headers.findIndex(h => h.includes('departamento') || h.includes('depto') || h.includes('setor'));
            const salaryIndex = headers.findIndex(h => h.includes('salario') || h.includes('salário') || h.includes('remunera') || h.includes('vencimento'));
            const pericIndex = headers.findIndex(h => h.includes('periculosidade') || h.includes('peric'));
            const hoursIndex = headers.findIndex(h => h.includes('horas') || h.includes('divisor') || h.includes('mensal'));
            
            if (nameIndex === -1 || deptIndex === -1 || salaryIndex === -1) {
                showImportMessage('error', 'A planilha deve conter as colunas: Nome, Departamento e Salário.');
                return;
            }
            
            const importedData = [];
            const errors = [];
            let successCount = 0;
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length === 0) continue;
                
                const name = row[nameIndex]?.toString().trim();
                if (!name) continue;
                
                const department = row[deptIndex]?.toString().trim() || 'Não especificado';
                const salaryRaw = row[salaryIndex];
                const periculosidadeRaw = pericIndex !== -1 ? row[pericIndex] : 'Não';
                const hoursRaw = hoursIndex !== -1 ? row[hoursIndex] : '220';
                
                const salaryValue = parseCurrencyBR(salaryRaw);
                if (salaryValue <= 0) {
                    errors.push(`Linha ${i + 1}: Salário inválido para ${name} (${salaryRaw})`);
                    continue;
                }
                
                const salaryFormatted = formatCurrencyForStorage(salaryValue);
                
                const hasPericulosidade = pericIndex !== -1 ? parseBoolean(periculosidadeRaw) : false;
                
                let divisor = 220;
                if (hoursIndex !== -1) {
                    const hoursStr = String(hoursRaw).replace(/[^\d]/g, '');
                    const parsedHours = parseInt(hoursStr, 10);
                    if (!isNaN(parsedHours) && parsedHours > 0) {
                        divisor = parsedHours;
                    }
                }
                
                importedData.push({
                    name: name,
                    department: department,
                    baseSalary: salaryFormatted,
                    baseSalaryValue: salaryValue,
                    divisor: divisor,
                    periculosidade: hasPericulosidade,
                    insalubridade: false,
                    workHours: '8',
                    active: true,
                    imported: true
                });
                
                successCount++;
            }
            
            if (importedData.length === 0) {
                showImportMessage('error', 'Nenhum colaborador válido encontrado na planilha.');
                return;
            }
            
            importData = importedData;
            showImportPreview(importedData, successCount, errors);
        }
        
        function showImportMessage(type, text) {
            const messagesDiv = document.getElementById('importMessages');
            const className = type === 'error' ? 'warning-message' : 'success-message';
            const icon = type === 'error' ? 'exclamation-triangle' : 'check-circle';
            
            messagesDiv.innerHTML = `
                <div class="${className}">
                    <i class="fas fa-${icon}"></i>
                    <span>${text}</span>
                </div>
            `;
        }
        
        function showImportPreview(data, successCount, errors) {
            const previewDiv = document.getElementById('importPreview');
            const statsDiv = document.getElementById('importStats');
            const tableHeader = document.getElementById('previewTableHeader');
            const tableBody = document.getElementById('previewTableBody');
            
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${successCount}</div>
                    <div class="stat-label">Colaboradores Válidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">R$ ${data.reduce((sum, item) => sum + item.baseSalaryValue, 0).toFixed(2).replace('.', ',')}</div>
                    <div class="stat-label">Total Salários</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.filter(d => d.periculosidade).length}</div>
                    <div class="stat-label">Com Periculosidade</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${errors.length}</div>
                    <div class="stat-label">Erros</div>
                </div>
            `;
            
            tableHeader.innerHTML = `
                <tr>
                    <th>Nome</th>
                    <th>Departamento</th>
                    <th>Salário</th>
                    <th>Periculosidade</th>
                    <th>Horas Mensais</th>
                </tr>
            `;
            
            let bodyHtml = '';
            const previewData = data.slice(0, 10);
            
            previewData.forEach(item => {
                bodyHtml += `
                    <tr>
                        <td class="font-medium">${item.name}</td>
                        <td>${item.department}</td>
                        <td class="moeda-br">R$ ${item.baseSalary}</td>
                        <td>
                            <span class="px-2 py-1 rounded text-xs ${item.periculosidade ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                                ${item.periculosidade ? 'Sim' : 'Não'}
                            </span>
                        </td>
                        <td>${item.divisor}h</td>
                    </tr>
                `;
            });
            
            if (data.length > 10) {
                bodyHtml += `
                    <tr>
                        <td colspan="5" class="text-center text-gray-500 py-2">
                            ... e mais ${data.length - 10} colaborador(es)
                        </td>
                    </tr>
                `;
            }
            
            if (errors.length > 0) {
                bodyHtml += `
                    <tr>
                        <td colspan="5" class="text-center text-red-600 py-2">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            ${errors.length} erro(s) encontrados. Verifique o arquivo.
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = bodyHtml;
            previewDiv.style.display = 'block';
        }
        
        async function confirmImport() {
            if (!importData || importData.length === 0) {
                alert('Nenhum dado para importar.');
                return;
            }
            
            const collaborators = getCollaborators();
            const departments = getDepartments();
            let newCollaborators = 0;
            let updatedCollaborators = 0;
            
            const departmentNames = [...new Set(importData.map(item => item.department))];
            
            departmentNames.forEach(deptName => {
                if (deptName && deptName !== 'Não especificado') {
                    const existingDept = departments.find(d => 
                        d.name.toLowerCase() === deptName.toLowerCase()
                    );
                    
                    if (!existingDept) {
                        departments.push({
                            id: Date.now() + Math.random(),
                            name: deptName,
                            active: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    }
                }
            });
            
            await saveDepartments(departments);
            
            importData.forEach(item => {
                const existingCollaborator = collaborators.find(c => 
                    c.name.toLowerCase() === item.name.toLowerCase()
                );
                
                if (existingCollaborator) {
                    existingCollaborator.department = item.department;
                    existingCollaborator.baseSalary = item.baseSalary;
                    existingCollaborator.baseSalaryValue = item.baseSalaryValue;
                    existingCollaborator.divisor = item.divisor;
                    existingCollaborator.periculosidade = item.periculosidade;
                    existingCollaborator.updatedAt = new Date().toISOString();
                    existingCollaborator.active = true;
                    updatedCollaborators++;
                } else {
                    collaborators.push({
                        id: Date.now() + Math.random(),
                        name: item.name,
                        department: item.department,
                        matricula: `COL${Date.now().toString().slice(-6)}${Math.floor(Math.random() * 100)}`,
                        baseSalary: item.baseSalary,
                        baseSalaryValue: item.baseSalaryValue,
                        divisor: item.divisor,
                        workHours: item.workHours || '8',
                        periculosidade: item.periculosidade,
                        insalubridade: false,
                        active: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    newCollaborators++;
                }
            });
            
            await saveCollaborators(collaborators);
            
            updateDepartmentSelect();
            updateCollaboratorSelect();
            updateCollaboratorFilterSelect();
            renderCollaboratorsTable(currentCollaboratorStatus);
            
            const message = `
                <div class="success-message">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>Importação concluída com sucesso!</strong><br>
                        ${newCollaborators} novo(s) colaborador(es) adicionado(s)<br>
                        ${updatedCollaborators} colaborador(es) atualizado(s)
                    </div>
                </div>
            `;
            
            document.getElementById('importMessages').innerHTML = message;
            
            setTimeout(() => {
                closeImportModal();
                alert(`✅ Importação concluída!\n\n${newCollaborators} novo(s) colaborador(es) adicionado(s)\n${updatedCollaborators} colaborador(es) atualizado(s)`);
            }, 2000);
        }
        
        function downloadTemplate() {
            const templateData = [
                ['Nome', 'Departamento', 'Salário', 'Periculosidade', 'Horas Mensais'],
                ['João Silva', 'Produção', 'R$ 2.500,00', 'Sim', '220'],
                ['Maria Santos', 'RH', 'R$ 3.200,50', 'Não', '220'],
                ['Carlos Oliveira', 'TI', 'R$ 4.000,00', 'Sim', '180'],
                ['Ana Costa', 'Financeiro', 'R$ 3.800,75', 'Não', '220'],
                ['Pedro Alves', 'Manutenção', 'R$ 2.850,00', 'Sim', '200']
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            XLSX.utils.book_append_sheet(wb, ws, 'Modelo');
            XLSX.writeFile(wb, 'modelo_importacao_colaboradores.xlsx');
        }

        // ============================================
        // FUNÇÕES GERAIS E DE CÁLCULO
        // ============================================

        function getCurrentMonthString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }
        
        function parseTime(timeString) {
            if (!timeString) return 0;
            const parts = timeString.split(':');
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);

            if (isNaN(hours) || isNaN(minutes) || minutes >= 60 || hours < 0 || minutes < 0) {
                console.error("Formato de hora inválido: " + timeString);
                return 0;
            }

            return hours + (minutes / 60);
        }
        
        function formatCurrencyInput(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length === 0) {
                input.value = '';
                return;
            }

            while (value.length < 3) {
                value = '0' + value;
            }

            let integerPart = value.slice(0, -2);
            let decimalPart = value.slice(-2);

            integerPart = parseInt(integerPart, 10).toString();
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

            input.value = integerPart + ',' + decimalPart;
        }

        function getDSRDays(year, monthIndex) {
            const date = new Date(year, monthIndex, 1);
            let totalDays = 0;
            let sundays = 0;
            
            while (date.getMonth() === monthIndex) {
                totalDays++;
                if (date.getDay() === 0) {
                    sundays++;
                }
                date.setDate(date.getDate() + 1);
            }
            
            const diasUteis = totalDays - sundays;

            return {
                diasDSR: sundays,
                diasUteis: diasUteis,
                totalDaysInMonth: totalDays 
            };
        }
        
        function handleMonthChange(isInitialLoad = false) {
            const monthInput = document.getElementById('mesReferencia').value;
            if (!monthInput) return;

            const [year, month] = monthInput.split('-').map(Number);
            
            const result = getDSRDays(year, month - 1);
            
            document.getElementById('diasTrabalhados').value = 30;
            
            document.getElementById('diasDomingo').value = result.diasDSR;
            const diasUteisInput = document.getElementById('diasUteis');
            diasUteisInput.setAttribute('data-base-value', result.diasUteis);
            diasUteisInput.value = result.diasUteis;
            
            calcular();
        }

        function calcular() {
            const salarioBaseInput = document.getElementById('salarioBase').value;
            const salarioBaseFormatted = salarioBaseInput.replace(/\./g, '').replace(',', '.'); 
            const salarioBase = parseFloat(salarioBaseFormatted) || 0;

            const divisorMensal = parseFloat(document.getElementById('divisorMensal').value) || 220;
            const usaPericulosidade = document.getElementById('usaPericulosidade').checked;
            
            const horasSobreavisoTotal = parseTime(document.getElementById('horasSobreavisoTotal').value);
            const horasTrabalhadas50 = parseTime(document.getElementById('horasTrabalhadas50').value); 
            const horasTrabalhadas100 = parseTime(document.getElementById('horasTrabalhadas100').value); 
            const horasNoturnas = parseTime(document.getElementById('horasNoturnas').value);

            const diasAtestado = parseFloat(document.getElementById('diasAtestado').value) || 0; 
            const diasTrabalhados = parseFloat(document.getElementById('diasTrabalhados').value) || 30;
            const diasFeriado = parseFloat(document.getElementById('diasFeriado').value) || 0;
            const diasUteisInput = document.getElementById('diasUteis');
            const diasUteisBase = parseFloat(diasUteisInput.getAttribute('data-base-value')) || 0;

            const diasDomingoTotal = parseFloat(document.getElementById('diasDomingo').value) || 0;
            
            if (divisorMensal <= 0 || diasUteisBase <= 0 || salarioBase <= 0) {
                 document.getElementById('horaNormal').textContent = R$.format(0);
                 document.getElementById('valorPericulosidade').textContent = R$.format(0);
                 document.getElementById('valorPericulosidadeInputDisplay').textContent = R$.format(0);
                 document.getElementById('valorSobreavisoEspera').textContent = R$.format(0);
                 document.getElementById('valorHoraExtraTrabalho50').textContent = R$.format(0);
                 document.getElementById('valorHoraExtraTrabalho100').textContent = R$.format(0);
                 document.getElementById('valorAdicionalNoturno').textContent = R$.format(0);
                 document.getElementById('fatorDSRDisplay').textContent = "0.0000";
                 document.getElementById('valorReflexoSobreavisoEspera').textContent = R$.format(0);
                 document.getElementById('valorReflexoSobreavisoTrabalhado').textContent = R$.format(0);
                 document.getElementById('valorReflexoHorasExtrasNormal').textContent = R$.format(0);
                 document.getElementById('valorReflexoAdicionalNoturno').textContent = R$.format(0);
                 document.getElementById('valorReflexoDSRTotalSum').textContent = R$.format(0);
                 document.getElementById('horaSobreaviso').textContent = R$.format(0);
                 document.getElementById('baseHePeric').textContent = R$.format(0) + " (s/ Salário)";
                 document.getElementById('horaExtra50').textContent = R$.format(0);
                 
                 document.getElementById('periculosidadeDetalhada').style.display = 'none';
                 return;
            }
            
            const periculosidadeValorMensal = salarioBase * 0.30;
            const diasBaseMensal = 30;
            const diasTrabalhadosAjustados = Math.max(0, 30 - diasAtestado);
            const periculosidadeValorProRata = usaPericulosidade ? 
                (periculosidadeValorMensal / diasBaseMensal) * diasTrabalhadosAjustados : 0;

            const periculosidadeValorDiario = usaPericulosidade ? periculosidadeValorMensal / diasBaseMensal : 0;

            const horaNormal = salarioBase / divisorMensal;
            const periculosidadeHora = periculosidadeValorMensal / divisorMensal; 
            
            let baseHE = horaNormal;
            if (usaPericulosidade) {
                baseHE += periculosidadeHora;
            }
            
            const horasEspera = horasSobreavisoTotal; 
            const horaSobreaviso = horaNormal / 3;
            const valorSobreavisoEspera = horasEspera * horaSobreaviso; 

            const baseHePericRate = baseHE;
            const horaExtra50Valor = baseHE * (1 + (heNormalPorcentagem / 100));
            
            const valorHoraExtraTrabalho50 = horasTrabalhadas50 * baseHE * (1 + (heSobreavisoPorcentagem / 100)); 
            const valorHoraExtraTrabalho100 = horasTrabalhadas100 * horaExtra50Valor; 
            
            const adicionalNoturnoHora = horaNormal * (adicionalNoturnoPorcentagem / 100);
            const valorAdicionalNoturno = horasNoturnas * adicionalNoturnoHora;

            const diasUteisAjustados = Math.max(0, diasUteisBase - diasFeriado); 
            document.getElementById('diasUteis').value = diasUteisAjustados.toFixed(0); 

            const diasDSRParaCalculo = diasDomingoTotal + diasFeriado;
            const fatorDSR = diasUteisAjustados > 0 ? diasDSRParaCalculo / diasUteisAjustados : 0;
            
            const valorReflexoSobreavisoEspera = valorSobreavisoEspera * fatorDSR;
            const valorReflexoSobreavisoTrabalhado = valorHoraExtraTrabalho50 * fatorDSR;
            const valorReflexoHorasExtrasNormal = valorHoraExtraTrabalho100 * fatorDSR;
            const valorReflexoAdicionalNoturno = valorAdicionalNoturno * fatorDSR;

            const valorReflexoDSRTotal = valorReflexoSobreavisoEspera + valorReflexoSobreavisoTrabalhado + 
                                       valorReflexoHorasExtrasNormal + valorReflexoAdicionalNoturno;

            document.getElementById('valorPericulosidade').textContent = R$.format(periculosidadeValorProRata);
            document.getElementById('valorPericulosidadeInputDisplay').textContent = R$.format(periculosidadeValorProRata);

            if (usaPericulosidade && salarioBase > 0) {
                document.getElementById('periculosidadeDetalhada').style.display = 'block';
                document.getElementById('periculosidadeDetalhada').innerHTML = 
                    `Cálculo: ${R$.format(periculosidadeValorMensal)} mensal ÷ 30 dias × ${diasTrabalhadosAjustados} dias trabalhados = ${R$.format(periculosidadeValorProRata)}`;
            } else {
                document.getElementById('periculosidadeDetalhada').style.display = 'none';
            }

            document.getElementById('valorSobreavisoEspera').textContent = R$.format(valorSobreavisoEspera);
            document.getElementById('valorHoraExtraTrabalho50').textContent = R$.format(valorHoraExtraTrabalho50);
            document.getElementById('valorHoraExtraTrabalho100').textContent = R$.format(valorHoraExtraTrabalho100); 
            document.getElementById('valorAdicionalNoturno').textContent = R$.format(valorAdicionalNoturno);
            
            document.getElementById('fatorDSRDisplay').textContent = fatorDSR.toFixed(4);
            document.getElementById('valorReflexoSobreavisoEspera').textContent = R$.format(valorReflexoSobreavisoEspera);
            document.getElementById('valorReflexoSobreavisoTrabalhado').textContent = R$.format(valorReflexoSobreavisoTrabalhado);
            document.getElementById('valorReflexoHorasExtrasNormal').textContent = R$.format(valorReflexoHorasExtrasNormal);
            document.getElementById('valorReflexoAdicionalNoturno').textContent = R$.format(valorReflexoAdicionalNoturno);
            document.getElementById('valorReflexoDSRTotalSum').textContent = R$.format(valorReflexoDSRTotal);
            
            document.getElementById('horaNormal').textContent = R$.format(horaNormal);
            document.getElementById('horaSobreaviso').textContent = R$.format(horaSobreaviso);
            document.getElementById('baseHePeric').textContent = usaPericulosidade 
                ? R$.format(baseHePericRate) + " (c/ Peric.)" 
                : R$.format(baseHePericRate) + " (s/ Peric.)";
            document.getElementById('horaExtra50').textContent = R$.format(horaExtra50Valor);
        }

        function resetInputs() {
            document.getElementById('salarioBase').value = "";
            document.getElementById('diasFeriado').value = "0";
            document.getElementById('diasAtestado').value = "0";

            document.getElementById('horasSobreavisoTotal').value = "00:00";
            document.getElementById('horasTrabalhadas50').value = "00:00";
            document.getElementById('horasTrabalhadas100').value = "00:00";
            document.getElementById('horasNoturnas').value = "00:00";

            document.getElementById('divisorMensal').value = "220";
            document.getElementById('usaPericulosidade').checked = true;
            
            document.getElementById('pagoFolha').checked = false;
            document.getElementById('competenciaPagamento').value = "";
            
            handleMonthChange(true);
        }

        // ============================================
        // SISTEMA DE DEPARTAMENTOS
        // ============================================
        
        function updateDepartmentSelect() {
            const departments = getDepartments();
            const select = document.getElementById('collaboratorDepartment');
            const filterDepartment = document.getElementById('filterDepartment');
            const reportDepartment = document.getElementById('reportDepartment');
            
            select.innerHTML = '<option value="">Selecione...</option>';
            if (filterDepartment) {
                filterDepartment.innerHTML = '<option value="">Todos os departamentos</option>';
            }
            if (reportDepartment) {
                reportDepartment.innerHTML = '<option value="">Todos os departamentos</option>';
            }
            
            const sortedDepartments = [...departments]
                .filter(dept => dept.active)
                .sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
            
            sortedDepartments.forEach(department => {
                const option = document.createElement('option');
                option.value = department.name;
                option.textContent = department.name;
                select.appendChild(option);
                
                if (filterDepartment) {
                    const filterOption = document.createElement('option');
                    filterOption.value = department.name;
                    filterOption.textContent = department.name;
                    filterDepartment.appendChild(filterOption);
                }
                
                if (reportDepartment) {
                    const reportOption = document.createElement('option');
                    reportOption.value = department.name;
                    reportOption.textContent = department.name;
                    reportDepartment.appendChild(reportOption);
                }
            });
        }
        
        function updateCollaboratorFilterSelect() {
            const collaborators = getCollaborators();
            const select = document.getElementById('filterCollaborator');
            const reportSelect = document.getElementById('reportCollaborator');
            
            if (!select) return;
            
            select.innerHTML = '<option value="">Todos os colaboradores</option>';
            if (reportSelect) {
                reportSelect.innerHTML = '<option value="">Todos os colaboradores</option>';
            }
            
            const sortedCollaborators = [...collaborators]
                .filter(collaborator => collaborator.active === true)
                .sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
            
            sortedCollaborators.forEach(collaborator => {
                const option = document.createElement('option');
                option.value = collaborator.id;
                option.textContent = `${collaborator.name} - ${collaborator.department}`;
                select.appendChild(option);
                
                if (reportSelect) {
                    const reportOption = document.createElement('option');
                    reportOption.value = collaborator.id;
                    reportOption.textContent = `${collaborator.name} - ${collaborator.department}`;
                    reportSelect.appendChild(reportOption);
                }
            });
        }
        
        function renderDepartmentsTable() {
            const departments = getDepartments();
            const container = document.getElementById('departmentsTableContainer');
            
            if (departments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-building fa-3x mb-4"></i>
                        <p class="text-lg">Nenhum departamento cadastrado ainda.</p>
                        <p class="text-sm">Clique em "Novo Departamento" para cadastrar seu primeiro departamento.</p>
                    </div>
                `;
                return;
            }
            
            const sortedDepartments = [...departments].sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
            
            let html = `
                <div class="overflow-x-auto">
                    <table class="department-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedDepartments.forEach(department => {
                html += `
                    <tr data-id="${department.id}">
                        <td class="font-medium">${department.name}</td>
                        <td>
                            <span class="px-2 py-1 rounded text-xs ${department.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${department.active ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <button class="edit-department text-green-600 hover:text-green-800 text-sm" data-id="${department.id}">
                                    <i class="fas fa-edit mr-1"></i> Editar
                                </button>
                                <button class="delete-department text-red-600 hover:text-red-800 text-sm" data-id="${department.id}">
                                    <i class="fas fa-trash mr-1"></i> Excluir
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-sm text-gray-500">
                    Total: ${departments.length} departamento(s) cadastrado(s)
                </div>
            `;
            
            container.innerHTML = html;
            
            document.querySelectorAll('.edit-department').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editDepartment(id);
                });
            });
            
            document.querySelectorAll('.delete-department').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteDepartment(id);
                });
            });
        }

        // ============================================
        // SISTEMA DE CADASTRO DE COLABORADORES - COM STATUS
        // ============================================
        
        async function saveCollaborator(event) {
            event.preventDefault();
            
            const id = document.getElementById('collaboratorEditId').value;
            const name = document.getElementById('collaboratorName').value.trim();
            const department = document.getElementById('collaboratorDepartment').value;
            const baseSalary = document.getElementById('collaboratorBaseSalary').value;
            const divisor = document.getElementById('collaboratorDivisor').value;
            const workHours = document.getElementById('collaboratorWorkHours').value;
            const periculosidade = document.getElementById('collaboratorPericulosidade').checked;
            const insalubridade = document.getElementById('collaboratorInsalubridade').checked;
            
            const statusRadios = document.getElementsByName('collaboratorStatus');
            let collaboratorStatus = 'active';
            for (let radio of statusRadios) {
                if (radio.checked) {
                    collaboratorStatus = radio.value;
                    break;
                }
            }
            const active = collaboratorStatus === 'active';
            
            if (!name || !department || !baseSalary) {
                alert('Por favor, preencha os campos obrigatórios (Nome, Departamento e Salário Base).');
                return;
            }
            
            const baseSalaryFormatted = baseSalary.replace(/\./g, '').replace(',', '.');
            const baseSalaryValue = parseFloat(baseSalaryFormatted) || 0;
            
            if (baseSalaryValue <= 0) {
                alert('O salário base deve ser maior que zero.');
                return;
            }
            
            const collaborators = getCollaborators();
            let newCollaborator;
            
            if (id) {
                const existingIndex = collaborators.findIndex(c => c.id == id);
                
                if (existingIndex === -1) {
                    alert('Colaborador não encontrado!');
                    return;
                }
                
                newCollaborator = {
                    ...collaborators[existingIndex],
                    name: name,
                    department: department,
                    baseSalary: baseSalary,
                    baseSalaryValue: baseSalaryValue,
                    divisor: divisor,
                    workHours: workHours,
                    periculosidade: periculosidade,
                    insalubridade: insalubridade,
                    active: active,
                    updatedAt: new Date().toISOString()
                };
                
                collaborators[existingIndex] = newCollaborator;
            } else {
                const matricula = `COL${Date.now().toString().slice(-6)}`;
                
                newCollaborator = {
                    id: Date.now(),
                    name: name,
                    department: department,
                    matricula: matricula,
                    baseSalary: baseSalary,
                    baseSalaryValue: baseSalaryValue,
                    divisor: divisor,
                    workHours: workHours,
                    periculosidade: periculosidade,
                    insalubridade: insalubridade,
                    active: active,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                collaborators.push(newCollaborator);
            }
            
            await saveCollaborators(collaborators);
            
            closeModal();
            updateCollaboratorSelect();
            renderCollaboratorsTable(currentCollaboratorStatus);
            updateCollaboratorFilterSelect();
            
            alert(`Colaborador ${name} salvo com sucesso! Status: ${active ? 'Ativo' : 'Inativo'} ${currentUser ? '(Sincronizado com a nuvem)' : ''}`);
            resetCollaboratorForm();
        }
        
        function resetCollaboratorForm() {
            document.getElementById('collaboratorEditId').value = '';
            document.getElementById('collaboratorName').value = '';
            document.getElementById('collaboratorDepartment').value = '';
            document.getElementById('collaboratorBaseSalary').value = '';
            document.getElementById('collaboratorDivisor').value = '220';
            document.getElementById('collaboratorWorkHours').value = '8';
            document.getElementById('collaboratorPericulosidade').checked = false;
            document.getElementById('collaboratorInsalubridade').checked = false;
            
            document.getElementById('collaboratorStatusActive').checked = true;
            
            document.getElementById('collaboratorModalTitle').textContent = "Cadastrar Novo Colaborador";
            document.getElementById('collaboratorModalButton').textContent = "Salvar Colaborador";
        }
        
        function updateCollaboratorSelect() {
            const collaborators = getCollaborators();
            const select = document.getElementById('collaboratorSelect');
            
            const currentSelection = select.value;
            select.innerHTML = '<option value="">-- Selecione um colaborador --</option>';
            
            const sortedCollaborators = [...collaborators]
                .filter(collaborator => collaborator.active === true)
                .sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
            
            sortedCollaborators.forEach(collaborator => {
                const option = document.createElement('option');
                option.value = collaborator.id;
                option.textContent = `${collaborator.name} - ${collaborator.department} (R$ ${collaborator.baseSalary})`;
                select.appendChild(option);
            });
            
            if (currentSelection && collaborators.some(c => c.id == currentSelection && c.active === true)) {
                select.value = currentSelection;
            }
        }
        
        function loadCollaboratorToCalculator(collaboratorId) {
            const collaborators = getCollaborators();
            const collaborator = collaborators.find(c => c.id == collaboratorId);
            
            if (!collaborator) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            if (collaborator.active !== true) {
                alert('Este colaborador está inativo. Selecione um colaborador ativo.');
                document.getElementById('collaboratorSelect').value = '';
                return;
            }
            
            document.getElementById('salarioBase').value = collaborator.baseSalary;
            document.getElementById('divisorMensal').value = collaborator.divisor;
            document.getElementById('usaPericulosidade').checked = collaborator.periculosidade;
            
            calcular();
        }
        
        function renderCollaboratorsTable(status = 'active') {
            const collaborators = getCollaborators();
            const container = document.getElementById('collaboratorsTableContainer');
            
            const filteredCollaborators = status === 'active' 
                ? collaborators.filter(c => c.active === true)
                : collaborators.filter(c => c.active === false);
            
            if (filteredCollaborators.length === 0) {
                const statusText = status === 'active' ? 'ativo' : 'inativo';
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-users fa-3x mb-4"></i>
                        <p class="text-lg">Nenhum colaborador ${statusText}.</p>
                        <p class="text-sm">${status === 'active' ? 'Clique em "Novo Colaborador" ou importe uma planilha para cadastrar seu primeiro colaborador.' : 'Colaboradores inativados aparecerão aqui.'}</p>
                    </div>
                `;
                return;
            }
            
            const sortedCollaborators = [...filteredCollaborators].sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
            
            let html = `
                <div class="overflow-x-auto">
                    <table class="collaborator-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Departamento</th>
                                <th>Salário Base</th>
                                <th>Periculosidade</th>
                                <th>Status</th>
                                ${status === 'inactive' ? '<th>Data Inativação</th>' : ''}
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedCollaborators.forEach(collaborator => {
                const inactivationDate = status === 'inactive' 
                    ? new Date(collaborator.updatedAt).toLocaleDateString('pt-BR')
                    : '';
                
                html += `
                    <tr data-id="${collaborator.id}">
                        <td class="font-medium">${collaborator.name}</td>
                        <td>${collaborator.department}</td>
                        <td>R$ ${collaborator.baseSalary}</td>
                        <td>
                            <span class="px-2 py-1 rounded text-xs ${collaborator.periculosidade ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                                ${collaborator.periculosidade ? 'Sim' : 'Não'}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${collaborator.active ? 'active' : 'inactive'} px-3 py-1">
                                ${collaborator.active ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        ${status === 'inactive' ? `<td class="text-sm text-gray-600">${inactivationDate}</td>` : ''}
                        <td>
                            <div class="flex gap-2">
                                <button class="edit-collaborator text-green-600 hover:text-green-800 text-sm" data-id="${collaborator.id}">
                                    <i class="fas fa-edit mr-1"></i> Editar
                                </button>
                                <button class="delete-collaborator text-red-600 hover:text-red-800 text-sm" data-id="${collaborator.id}">
                                    <i class="fas fa-trash mr-1"></i> Excluir
                                </button>
                                ${status === 'inactive' ? `
                                <button class="reactivate-collaborator text-green-600 hover:text-green-800 text-sm" data-id="${collaborator.id}">
                                    <i class="fas fa-user-check mr-1"></i> Reativar
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-sm text-gray-500">
                    Total: ${filteredCollaborators.length} colaborador(es) ${status === 'active' ? 'ativo(s)' : 'inativo(s)'}
                </div>
            `;
            
            container.innerHTML = html;
            
            updateStatusButtons(status);
            
            document.querySelectorAll('.edit-collaborator').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editCollaborator(id);
                });
            });
            
            document.querySelectorAll('.delete-collaborator').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    showDeleteCollaboratorModal(id);
                });
            });
            
            document.querySelectorAll('.reactivate-collaborator').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    reactivateCollaborator(id);
                });
            });
        }
        
        function updateStatusButtons(status) {
            const activeBtn = document.getElementById('showActiveCollaborators');
            const inactiveBtn = document.getElementById('showInactiveCollaborators');
            
            if (status === 'active') {
                activeBtn.classList.add('active');
                inactiveBtn.classList.remove('active');
            } else {
                activeBtn.classList.remove('active');
                inactiveBtn.classList.add('active');
            }
            
            currentCollaboratorStatus = status;
        }
        
        function showDeleteCollaboratorModal(id) {
            const collaborators = getCollaborators();
            const collaborator = collaborators.find(c => c.id === id);
            
            if (!collaborator) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            document.getElementById('deleteCollaboratorName').textContent = collaborator.name;
            document.getElementById('deleteCollaboratorModal').dataset.id = id;
            document.getElementById('deleteCollaboratorModal').classList.add('active');
        }
        
        async function confirmDeleteCollaborator() {
            const id = parseInt(document.getElementById('deleteCollaboratorModal').dataset.id);
            
            const collaborators = getCollaborators();
            const filteredCollaborators = collaborators.filter(c => c.id !== id);
            
            await saveCollaborators(filteredCollaborators);
            
            closeDeleteCollaboratorModal();
            updateCollaboratorSelect();
            renderCollaboratorsTable(currentCollaboratorStatus);
            updateCollaboratorFilterSelect();
            
            alert('Colaborador excluído permanentemente!');
        }
        
        function closeDeleteCollaboratorModal() {
            document.getElementById('deleteCollaboratorModal').classList.remove('active');
            document.getElementById('deleteCollaboratorModal').dataset.id = '';
        }
        
        async function reactivateCollaborator(id) {
            if (!confirm('Tem certeza que deseja reativar este colaborador?')) {
                return;
            }
            
            const collaborators = getCollaborators();
            const collaboratorIndex = collaborators.findIndex(c => c.id === id);
            
            if (collaboratorIndex === -1) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            collaborators[collaboratorIndex].active = true;
            collaborators[collaboratorIndex].updatedAt = new Date().toISOString();
            
            await saveCollaborators(collaborators);
            
            updateCollaboratorSelect();
            renderCollaboratorsTable(currentCollaboratorStatus);
            updateCollaboratorFilterSelect();
            
            alert('Colaborador reativado com sucesso!');
        }
        
        function editCollaborator(id) {
            const collaborators = getCollaborators();
            const collaborator = collaborators.find(c => c.id === id);
            
            if (!collaborator) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            document.getElementById('collaboratorEditId').value = collaborator.id;
            document.getElementById('collaboratorName').value = collaborator.name;
            document.getElementById('collaboratorDepartment').value = collaborator.department;
            document.getElementById('collaboratorBaseSalary').value = collaborator.baseSalary;
            document.getElementById('collaboratorDivisor').value = collaborator.divisor;
            document.getElementById('collaboratorWorkHours').value = collaborator.workHours || '8';
            document.getElementById('collaboratorPericulosidade').checked = collaborator.periculosidade;
            document.getElementById('collaboratorInsalubridade').checked = collaborator.insalubridade;
            
            if (collaborator.active) {
                document.getElementById('collaboratorStatusActive').checked = true;
            } else {
                document.getElementById('collaboratorStatusInactive').checked = true;
            }
            
            document.getElementById('collaboratorModalTitle').textContent = "Editar Colaborador";
            document.getElementById('collaboratorModalButton').textContent = "Atualizar Colaborador";
            
            openModal();
        }

        // ============================================
        // SISTEMA DE HISTÓRICO DE CÁLCULOS
        // ============================================
        
        async function saveCurrentCalculation() {
            const selectedCollaboratorId = document.getElementById('collaboratorSelect').value;
            
            if (!selectedCollaboratorId) {
                alert('Por favor, selecione um colaborador antes de salvar o cálculo.');
                return;
            }
            
            const collaborators = getCollaborators();
            const collaborator = collaborators.find(c => c.id == selectedCollaboratorId);
            
            if (!collaborator) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            const isEditing = currentCalculationDetailId !== null;
            const mesReferencia = document.getElementById('mesReferencia').value;
            
            if (!isEditing && checkDuplicateCalculation(selectedCollaboratorId, mesReferencia)) {
                showDuplicateNotification(`Já existe um cálculo salvo para ${collaborator.name} no mês ${mesReferencia}.`);
                
                if (!confirm('Já existe um cálculo para este colaborador neste mês. Deseja salvar mesmo assim?')) {
                    return;
                }
            }
            
            const calculationData = {
                id: isEditing ? currentCalculationDetailId : Date.now(),
                collaboratorId: selectedCollaboratorId,
                collaboratorName: collaborator.name,
                collaboratorDepartment: collaborator.department,
                collaboratorSalary: collaborator.baseSalary,
                collaboratorStatus: collaborator.active ? 'Ativo' : 'Inativo',
                timestamp: new Date().toLocaleString('pt-BR'),
                timestampISO: new Date().toISOString(),
                mesReferencia: mesReferencia,
                pagoFolha: document.getElementById('pagoFolha').checked,
                competenciaPagamento: document.getElementById('competenciaPagamento').value,
                config: {
                    heNormalPorcentagem: heNormalPorcentagem,
                    heSobreavisoPorcentagem: heSobreavisoPorcentagem,
                    adicionalNoturnoPorcentagem: adicionalNoturnoPorcentagem
                },
                data: {
                    salarioBase: document.getElementById('salarioBase').value,
                    divisorMensal: document.getElementById('divisorMensal').value,
                    usaPericulosidade: document.getElementById('usaPericulosidade').checked,
                    horasSobreavisoTotal: document.getElementById('horasSobreavisoTotal').value,
                    horasTrabalhadas50: document.getElementById('horasTrabalhadas50').value,
                    horasTrabalhadas100: document.getElementById('horasTrabalhadas100').value,
                    horasNoturnas: document.getElementById('horasNoturnas').value,
                    diasTrabalhados: document.getElementById('diasTrabalhados').value,
                    diasAtestado: document.getElementById('diasAtestado').value,
                    diasFeriado: document.getElementById('diasFeriado').value,
                    diasDomingo: document.getElementById('diasDomingo').value,
                    diasUteis: document.getElementById('diasUteis').value,
                    resultados: {
                        valorPericulosidade: document.getElementById('valorPericulosidade').textContent,
                        valorSobreavisoEspera: document.getElementById('valorSobreavisoEspera').textContent,
                        valorHoraExtraTrabalho50: document.getElementById('valorHoraExtraTrabalho50').textContent,
                        valorHoraExtraTrabalho100: document.getElementById('valorHoraExtraTrabalho100').textContent,
                        valorAdicionalNoturno: document.getElementById('valorAdicionalNoturno').textContent,
                        valorReflexoDSRTotalSum: document.getElementById('valorReflexoDSRTotalSum').textContent,
                        fatorDSR: document.getElementById('fatorDSRDisplay').textContent,
                        valorReflexoSobreavisoEspera: document.getElementById('valorReflexoSobreavisoEspera').textContent,
                        valorReflexoSobreavisoTrabalhado: document.getElementById('valorReflexoSobreavisoTrabalhado').textContent,
                        valorReflexoHorasExtrasNormal: document.getElementById('valorReflexoHorasExtrasNormal').textContent,
                        valorReflexoAdicionalNoturno: document.getElementById('valorReflexoAdicionalNoturno').textContent
                    }
                }
            };
            
            const calculations = getSavedCalculations();
            
            if (isEditing) {
                const calculationIndex = calculations.findIndex(c => c.id === currentCalculationDetailId);
                
                if (calculationIndex === -1) {
                    alert('Erro: Cálculo não encontrado para edição!');
                    return;
                }
                
                calculations[calculationIndex] = calculationData;
                alert(`Cálculo atualizado com sucesso! ${currentUser ? '(Sincronizado com a nuvem)' : ''}`);
                
                currentCalculationDetailId = null;
            } else {
                calculations.push(calculationData);
                alert(`Cálculo para ${collaborator.name} salvo com sucesso! ${currentUser ? '(Sincronizado com a nuvem)' : ''}`);
            }
            
            await saveCalculations(calculations);
            
            if (document.getElementById('historyContent').classList.contains('hidden') === false) {
                renderHistoryTable();
            }
            
            currentCalculationDetailId = null;
        }
        
        function renderHistoryTable(filters = {}) {
            const calculations = getSavedCalculations();
            const container = document.getElementById('historyTableBody');
            
            let filteredCalculations = [...calculations];
            
            if (filters.collaboratorId) {
                filteredCalculations = filteredCalculations.filter(c => c.collaboratorId == filters.collaboratorId);
            }
            
            if (filters.department) {
                filteredCalculations = filteredCalculations.filter(c => c.collaboratorDepartment === filters.department);
            }
            
            if (filters.startMonth) {
                filteredCalculations = filteredCalculations.filter(c => c.mesReferencia >= filters.startMonth);
            }
            
            if (filters.endMonth) {
                filteredCalculations = filteredCalculations.filter(c => c.mesReferencia <= filters.endMonth);
            }
            
            filteredCalculations.sort((a, b) => new Date(b.timestampISO) - new Date(a.timestampISO));
            
            if (filteredCalculations.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-history fa-3x mb-4"></i>
                            <p class="text-lg">Nenhum cálculo encontrado.</p>
                            <p class="text-sm">${calculations.length === 0 ? 'Faça cálculos na aba "Calculadora" e salve-os para ver o histórico aqui.' : 'Tente ajustar os filtros.'}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            filteredCalculations.forEach(calculation => {
                const pagoEmFolha = calculation.pagoFolha ? 'Sim' : 'Não';
                const competencia = calculation.competenciaPagamento || '-';
                
                html += `
                    <tr>
                        <td>${calculation.mesReferencia}</td>
                        <td class="font-medium">${calculation.collaboratorName}</td>
                        <td>${calculation.collaboratorDepartment}</td>
                        <td class="text-sm text-gray-600">${calculation.timestamp}</td>
                        <td class="text-sm ${calculation.pagoFolha ? 'text-green-600 font-medium' : 'text-gray-600'}">
                            ${pagoEmFolha}${competencia !== '-' ? ` (${competencia})` : ''}
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <button class="view-calculation-detail text-blue-600 hover:text-blue-800 text-sm" data-id="${calculation.id}" title="Ver detalhes">
                                    <i class="fas fa-eye"></i> Ver detalhes
                                </button>
                                <button class="delete-calculation text-red-600 hover:text-red-800 text-sm" data-id="${calculation.id}" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
            
            addCalculationActionListeners();
        }
        
        function addCalculationActionListeners() {
            document.querySelectorAll('.view-calculation-detail').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    viewCalculationDetail(id);
                });
            });
            
            document.querySelectorAll('.delete-calculation').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteCalculation(id);
                });
            });
        }
        
        async function deleteCalculation(id) {
            if (!confirm('Tem certeza que deseja excluir este cálculo do histórico?')) {
                return;
            }
            
            const calculations = getSavedCalculations();
            const filteredCalculations = calculations.filter(c => c.id !== id);
            
            await saveCalculations(filteredCalculations);
            renderHistoryTable();
            alert('Cálculo excluído do histórico com sucesso!');
        }

        // ============================================
        // FUNÇÕES DE DETALHES DO CÁLCULO
        // ============================================
        
        function viewCalculationDetail(id) {
            const calculations = getSavedCalculations();
            const calculation = calculations.find(c => c.id === id);
            
            if (!calculation) {
                alert('Cálculo não encontrado!');
                return;
            }
            
            currentCalculationDetailId = id;
            
            const detailContent = document.getElementById('calculationDetailContent');
            
            detailContent.innerHTML = `
                <div class="space-y-4 view-mode" id="detailViewMode">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-bold text-lg titulo-cor mb-2">${calculation.collaboratorName}</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <span class="text-sm text-gray-600">Departamento:</span>
                                <p class="font-medium">${calculation.collaboratorDepartment}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Mês Referência:</span>
                                <p class="font-medium">${calculation.mesReferencia}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Data do Cálculo:</span>
                                <p class="font-medium">${calculation.timestamp}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Status:</span>
                                <p class="font-medium">${currentUser ? 'Sincronizado com a nuvem' : 'Salvo localmente'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="payment-info">
                        <h5 class="font-bold text-md titulo-cor mb-2">Informações de Pagamento</h5>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-sm text-gray-600">Pago em Folha:</span>
                                <p class="font-medium ${calculation.pagoFolha ? 'text-blue-600' : 'text-gray-600'}">
                                    ${calculation.pagoFolha ? 'Sim' : 'Não'}
                                </p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Competência:</span>
                                <p class="font-medium">${calculation.competenciaPagamento || 'Não informada'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h2 class="text-xl font-semibold mb-4 titulo-cor">Entradas de Dados</h2>
                            
                            <div class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                                <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Salário e Divisor</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Salário Base (R$)</label>
                                        <input type="text" value="${calculation.data.salarioBase}" readonly class="mt-1" id="detailSalarioBase">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Horas Mensais</label>
                                        <select readonly class="mt-1" id="detailDivisorMensal">
                                            <option ${calculation.data.divisorMensal === '220' ? 'selected' : ''}>220 (Padrão)</option>
                                            <option ${calculation.data.divisorMensal === '180' ? 'selected' : ''}>180 horas</option>
                                            <option ${calculation.data.divisorMensal === '170' ? 'selected' : ''}>170 (Reduzido)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex items-center mt-4 pt-2 border-t">
                                    <input type="checkbox" ${calculation.data.usaPericulosidade ? 'checked' : ''} disabled class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2" id="detailUsaPericulosidade">
                                    <label class="text-sm font-medium text-gray-700">Incluir Adicional de Periculosidade (30%)</label>
                                </div>
                            </div>
                            
                            <div class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                                <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Horas de Adicionais</h3>
                                <div class="grid grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Horas de Sobreaviso</label>
                                        <input type="text" value="${calculation.data.horasSobreavisoTotal}" readonly class="mt-1 text-center" id="detailHorasSobreavisoTotal">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Horas de Sobreaviso Trabalhado</label>
                                        <input type="text" value="${calculation.data.horasTrabalhadas50}" readonly class="mt-1 text-center" id="detailHorasTrabalhadas50">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Horas Extras 50% (Normal)</label>
                                        <input type="text" value="${calculation.data.horasTrabalhadas100}" readonly class="mt-1 text-center" id="detailHorasTrabalhadas100">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Horas de Adicional Noturno</label>
                                        <input type="text" value="${calculation.data.horasNoturnas}" readonly class="mt-1 text-center" id="detailHorasNoturnas">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4 p-4 bg-gray-50 rounded-lg border">
                                <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Fator DSR, Dias e Ausências</h3>
                                <div class="grid grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Mês Ref.</label>
                                        <input type="text" value="${calculation.mesReferencia}" readonly class="mt-1" id="detailMesReferencia">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Dias Normais</label>
                                        <input type="number" value="${calculation.data.diasTrabalhados}" readonly class="mt-1 text-center" id="detailDiasTrabalhados">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Dias de Atestado</label>
                                        <input type="number" value="${calculation.data.diasAtestado}" readonly class="mt-1 text-center" id="detailDiasAtestado">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Feriados</label>
                                        <input type="number" value="${calculation.data.diasFeriado}" readonly class="mt-1 text-center" id="detailDiasFeriado">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h2 class="text-xl font-semibold mb-4 titulo-cor">Resultados e Bases</h2>
                            
                            <div class="space-y-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200 mb-6">
                                <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Adicionais e Periculosidade</h3>
                                
                                <div class="flex justify-between text-base font-semibold">
                                    <span>Periculosidade (30%)</span>
                                    <span class="titulo-cor">${calculation.data.resultados.valorPericulosidade}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Horas de Sobreaviso (Espera):</span>
                                    <span class="titulo-cor">${calculation.data.resultados.valorSobreavisoEspera}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Horas de Sobreaviso Trabalhado (50%):</span>
                                    <span class="titulo-cor">${calculation.data.resultados.valorHoraExtraTrabalho50}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Horas Extras 50% (Normal):</span>
                                    <span class="titulo-cor">${calculation.data.resultados.valorHoraExtraTrabalho100}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Horas de Adicional Noturno:</span>
                                    <span class="titulo-cor">${calculation.data.resultados.valorAdicionalNoturno}</span>
                                </div>
                            </div>
                            
                            <div class="space-y-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                                <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Reflexos DSR (Fator: <span class="font-extrabold">${calculation.data.resultados.fatorDSR}</span>)</h3>
                                
                                <div class="flex justify-between text-sm">
                                    <span>Reflexo Sobreaviso DSR (Espera 1/3):</span>
                                    <span class="text-indigo-700 font-semibold">${calculation.data.resultados.valorReflexoSobreavisoEspera}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Reflexo Sob. Trabalhado DSR (HE 50%):</span>
                                    <span class="text-indigo-700 font-semibold">${calculation.data.resultados.valorReflexoSobreavisoTrabalhado}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Reflexo Horas Extras DSR (Normal 50%):</span>
                                    <span class="text-indigo-700 font-semibold">${calculation.data.resultados.valorReflexoHorasExtrasNormal}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Reflexo Adic. Noturno DSR:</span>
                                    <span class="text-indigo-700 font-semibold">${calculation.data.resultados.valorReflexoAdicionalNoturno}</span>
                                </div>
                                
                                <div class="flex justify-between text-lg font-bold pt-2 border-t border-indigo-300">
                                    <span>TOTAL DOS REFLEXOS:</span>
                                    <span class="titulo-cor">${calculation.data.resultados.valorReflexoDSRTotalSum}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('calculationDetailTitle').textContent = `Detalhes do Cálculo - ${calculation.collaboratorName}`;
            
            document.getElementById('detailButtonsContainer').classList.remove('hidden');
            document.getElementById('editButtonsContainer').classList.add('hidden');
            
            openCalculationDetailModal();
        }
        
        function enableDetailEditMode() {
            const detailView = document.getElementById('detailViewMode');
            if (!detailView) return;
            
            detailView.classList.remove('view-mode');
            detailView.classList.add('edit-mode');
            
            const editFields = [
                'detailSalarioBase',
                'detailDivisorMensal',
                'detailUsaPericulosidade',
                'detailHorasSobreavisoTotal',
                'detailHorasTrabalhadas50',
                'detailHorasTrabalhadas100',
                'detailHorasNoturnas',
                'detailMesReferencia',
                'detailDiasTrabalhados',
                'detailDiasAtestado',
                'detailDiasFeriado',
                'detailPagoFolha',
                'detailCompetenciaPagamento'
            ];
            
            editFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.removeAttribute('readonly');
                    field.removeAttribute('disabled');
                    
                    if (field.type === 'select-one') {
                        field.disabled = false;
                    } else if (field.type === 'checkbox') {
                        field.disabled = false;
                    }
                }
            });
            
            const salarioField = document.getElementById('detailSalarioBase');
            if (salarioField) {
                salarioField.addEventListener('input', function() {
                    formatCurrencyInput(this);
                });
            }
            
            document.getElementById('detailButtonsContainer').classList.add('hidden');
            document.getElementById('editButtonsContainer').classList.remove('hidden');
        }
        
        async function saveDetailEdit() {
            if (!currentCalculationDetailId) {
                alert('Erro: Nenhum cálculo selecionado para edição.');
                return;
            }
            
            const updatedData = {
                salarioBase: document.getElementById('detailSalarioBase').value,
                divisorMensal: document.getElementById('detailDivisorMensal').value,
                usaPericulosidade: document.getElementById('detailUsaPericulosidade').checked,
                horasSobreavisoTotal: document.getElementById('detailHorasSobreavisoTotal').value,
                horasTrabalhadas50: document.getElementById('detailHorasTrabalhadas50').value,
                horasTrabalhadas100: document.getElementById('detailHorasTrabalhadas100').value,
                horasNoturnas: document.getElementById('detailHorasNoturnas').value,
                diasTrabalhados: document.getElementById('detailDiasTrabalhados').value,
                diasAtestado: document.getElementById('detailDiasAtestado').value,
                diasFeriado: document.getElementById('detailDiasFeriado').value,
                mesReferencia: document.getElementById('detailMesReferencia').value,
                pagoFolha: document.getElementById('detailPagoFolha').checked,
                competenciaPagamento: document.getElementById('detailCompetenciaPagamento').value
            };
            
            if (!updatedData.salarioBase || !updatedData.mesReferencia) {
                alert('Por favor, preencha o salário base e o mês de referência.');
                return;
            }
            
            const calculations = getSavedCalculations();
            const calculationIndex = calculations.findIndex(c => c.id === currentCalculationDetailId);
            
            if (calculationIndex === -1) {
                alert('Erro: Cálculo não encontrado!');
                return;
            }
            
            const originalCalculation = calculations[calculationIndex];
            
            const updatedCalculation = {
                ...originalCalculation,
                timestamp: new Date().toLocaleString('pt-BR'),
                timestampISO: new Date().toISOString(),
                mesReferencia: updatedData.mesReferencia,
                pagoFolha: updatedData.pagoFolha,
                competenciaPagamento: updatedData.competenciaPagamento,
                data: {
                    ...originalCalculation.data,
                    salarioBase: updatedData.salarioBase,
                    divisorMensal: updatedData.divisorMensal,
                    usaPericulosidade: updatedData.usaPericulosidade,
                    horasSobreavisoTotal: updatedData.horasSobreavisoTotal,
                    horasTrabalhadas50: updatedData.horasTrabalhadas50,
                    horasTrabalhadas100: updatedData.horasTrabalhadas100,
                    horasNoturnas: updatedData.horasNoturnas,
                    diasTrabalhados: updatedData.diasTrabalhados,
                    diasAtestado: updatedData.diasAtestado,
                    diasFeriado: updatedData.diasFeriado
                }
            };
            
            const salarioBaseFloat = parseFloat(updatedData.salarioBase.replace(/\./g, '').replace(',', '.'));
            const diasAtestadoInt = parseInt(updatedData.diasAtestado) || 0;
            const diasTrabalhadosAjustados = Math.max(0, 30 - diasAtestadoInt);
            
            if (salarioBaseFloat > 0 && updatedData.usaPericulosidade) {
                const periculosidadeMensal = salarioBaseFloat * 0.30;
                const periculosidadeProRata = (periculosidadeMensal / 30) * diasTrabalhadosAjustados;
                
                updatedCalculation.data.resultados = {
                    ...updatedCalculation.data.resultados,
                    valorPericulosidade: R$.format(periculosidadeProRata)
                };
            }
            
            if (checkDuplicateCalculation(originalCalculation.collaboratorId, updatedData.mesReferencia, currentCalculationDetailId)) {
                if (!confirm('Já existe outro cálculo para este colaborador neste mês. Deseja salvar mesmo assim?')) {
                    return;
                }
            }
            
            calculations[calculationIndex] = updatedCalculation;
            await saveCalculations(calculations);
            
            alert(`Cálculo atualizado com sucesso! ${currentUser ? '(Sincronizado com a nuvem)' : ''}`);
            
            closeCalculationDetailModal();
            
            if (document.getElementById('historyContent').classList.contains('hidden') === false) {
                renderHistoryTable();
            }
        }
        
        function cancelDetailEdit() {
            if (currentCalculationDetailId) {
                viewCalculationDetail(currentCalculationDetailId);
            }
        }

        // ============================================
        // FUNÇÕES DE DEPARTAMENTOS
        // ============================================
        
        async function saveNewDepartment(event) {
            event.preventDefault();
            
            const name = document.getElementById('departmentName').value.trim();
            const active = document.getElementById('departmentActive').checked;
            
            if (!name) {
                alert('Por favor, preencha o nome do departamento.');
                return;
            }
            
            const departments = getDepartments();
            const existingDepartment = departments.find(dept => 
                dept.name.toLowerCase() === name.toLowerCase()
            );
            
            if (existingDepartment && !window.editingDepartmentId) {
                alert(`Já existe um departamento com o nome "${name}".`);
                return;
            }
            
            let newDepartment;
            
            if (window.editingDepartmentId) {
                newDepartment = {
                    id: window.editingDepartmentId,
                    name: name,
                    active: active,
                    updatedAt: new Date().toISOString()
                };
                
                const originalDepartment = departments.find(dept => dept.id === window.editingDepartmentId);
                if (originalDepartment) {
                    newDepartment.createdAt = originalDepartment.createdAt;
                }
                
                const updatedDepartments = departments.map(dept => 
                    dept.id === window.editingDepartmentId ? newDepartment : dept
                );
                
                await saveDepartments(updatedDepartments);
                window.editingDepartmentId = null;
            } else {
                newDepartment = {
                    id: Date.now(),
                    name: name,
                    active: active,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                departments.push(newDepartment);
                await saveDepartments(departments);
            }
            
            closeDepartmentModal();
            updateDepartmentSelect();
            renderDepartmentsTable();
            
            alert(`Departamento ${name} salvo com sucesso! ${currentUser ? '(Sincronizado com a nuvem)' : ''}`);
            
            document.getElementById('departmentForm').reset();
            document.getElementById('departmentModalTitle').textContent = "Cadastrar Novo Departamento";
            document.getElementById('departmentModalButton').textContent = "Salvar Departamento";
        }
        
        function editDepartment(id) {
            const departments = getDepartments();
            const department = departments.find(dept => dept.id === id);
            
            if (!department) {
                alert('Departamento não encontrado!');
                return;
            }
            
            document.getElementById('departmentName').value = department.name;
            document.getElementById('departmentActive').checked = department.active;
            
            document.getElementById('departmentModalTitle').textContent = "Editar Departamento";
            document.getElementById('departmentModalButton').textContent = "Atualizar Departamento";
            
            window.editingDepartmentId = id;
            
            openDepartmentModal();
        }
        
        async function deleteDepartment(id) {
            const departments = getDepartments();
            const department = departments.find(dept => dept.id === id);
            
            if (!department) {
                alert('Departamento não encontrado!');
                return;
            }
            
            const collaborators = getCollaborators();
            const collaboratorsInDepartment = collaborators.filter(collaborator => 
                collaborator.department === department.name && collaborator.active === true
            );
            
            let message = `Tem certeza que deseja excluir o departamento "${department.name}"?`;
            
            if (collaboratorsInDepartment.length > 0) {
                message += `\n\nATENÇÃO: Existem ${collaboratorsInDepartment.length} colaborador(es) ativo(s) vinculados a este departamento. Eles ficarão sem departamento atribuído.`;
            }
            
            if (!confirm(message)) {
                return;
            }
            
            const filteredDepartments = departments.filter(dept => dept.id !== id);
            
            if (collaboratorsInDepartment.length > 0) {
                const updatedCollaborators = collaborators.map(collaborator => {
                    if (collaborator.department === department.name) {
                        return { ...collaborator, department: '' };
                    }
                    return collaborator;
                });
                await saveCollaborators(updatedCollaborators);
            }
            
            await saveDepartments(filteredDepartments);
            
            updateDepartmentSelect();
            renderDepartmentsTable();
            updateCollaboratorFilterSelect();
            
            alert('Departamento excluído com sucesso!');
        }

        // ============================================
        // FUNÇÕES DE INTERFACE
        // ============================================
        
        function showCalculator() {
            document.getElementById('calculatorContent').classList.remove('hidden');
            document.getElementById('collaboratorsContent').classList.add('hidden');
            document.getElementById('historyContent').classList.add('hidden');
            document.getElementById('reportsContent').classList.add('hidden');
            
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('menuCalculator').classList.add('active');
        }
        
        function showCollaborators() {
            document.getElementById('calculatorContent').classList.add('hidden');
            document.getElementById('collaboratorsContent').classList.remove('hidden');
            document.getElementById('historyContent').classList.add('hidden');
            document.getElementById('reportsContent').classList.add('hidden');
            
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('menuCollaborators').classList.add('active');
            
            showCollaboratorsTab();
        }
        
        function showHistory() {
            document.getElementById('calculatorContent').classList.add('hidden');
            document.getElementById('collaboratorsContent').classList.add('hidden');
            document.getElementById('historyContent').classList.remove('hidden');
            document.getElementById('reportsContent').classList.add('hidden');
            
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('menuHistory').classList.add('active');
            
            renderHistoryTable();
            updateCollaboratorFilterSelect();
        }
        
        function showReports() {
            document.getElementById('calculatorContent').classList.add('hidden');
            document.getElementById('collaboratorsContent').classList.add('hidden');
            document.getElementById('historyContent').classList.add('hidden');
            document.getElementById('reportsContent').classList.remove('hidden');
            
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('menuReports').classList.add('active');
            
            initializeColumnControls();
            updateCollaboratorFilterSelect();
            updateDepartmentSelect();
        }
        
        function showCollaboratorsTab() {
            document.getElementById('collaboratorsTabContent').classList.remove('hidden');
            document.getElementById('departmentsTabContent').classList.add('hidden');
            
            document.getElementById('tabCollaborators').classList.add('active');
            document.getElementById('tabDepartments').classList.remove('active');
            
            renderCollaboratorsTable('active');
        }
        
        function showDepartmentsTab() {
            document.getElementById('collaboratorsTabContent').classList.add('hidden');
            document.getElementById('departmentsTabContent').classList.remove('hidden');
            
            document.getElementById('tabCollaborators').classList.remove('active');
            document.getElementById('tabDepartments').classList.add('active');
            
            renderDepartmentsTable();
        }
        
        function openModal() {
            document.getElementById('collaboratorModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('collaboratorModal').classList.remove('active');
            resetCollaboratorForm();
        }
        
        function openDepartmentModal() {
            document.getElementById('departmentModal').classList.add('active');
        }
        
        function closeDepartmentModal() {
            document.getElementById('departmentModal').classList.remove('active');
            document.getElementById('departmentForm').reset();
            document.getElementById('departmentModalTitle').textContent = "Cadastrar Novo Departamento";
            document.getElementById('departmentModalButton').textContent = "Salvar Departamento";
            
            window.editingDepartmentId = null;
        }
        
        function openCalculationDetailModal() {
            document.getElementById('calculationDetailModal').classList.add('active');
        }
        
        function closeCalculationDetailModal() {
            document.getElementById('calculationDetailModal').classList.remove('active');
            currentCalculationDetailId = null;
        }
        
        function applyHistoryFilters() {
            const filters = {
                collaboratorId: document.getElementById('filterCollaborator').value,
                department: document.getElementById('filterDepartment').value,
                startMonth: document.getElementById('filterStartMonth').value,
                endMonth: document.getElementById('filterEndMonth').value
            };
            
            renderHistoryTable(filters);
        }
        
        function clearHistoryFilters() {
            document.getElementById('filterCollaborator').value = '';
            document.getElementById('filterDepartment').value = '';
            document.getElementById('filterStartMonth').value = '';
            document.getElementById('filterEndMonth').value = '';
            
            renderHistoryTable();
        }
        
        function toggleBasesVisibility() {
            const basesContainer = document.getElementById('basesContainer');
            const basesIcon = document.getElementById('basesIcon');
            
            if (basesContainer.classList.contains('hidden')) {
                basesContainer.classList.remove('hidden');
                basesIcon.classList.remove('fa-chevron-down');
                basesIcon.classList.add('fa-chevron-up');
            } else {
                basesContainer.classList.add('hidden');
                basesIcon.classList.remove('fa-chevron-up');
                basesIcon.classList.add('fa-chevron-down');
            }
        }

        // ============================================
        // FUNÇÕES DE RELATÓRIOS
        // ============================================
        
        function initializeColumnControls() {
            document.querySelectorAll('.column-toggle-btn').forEach(button => {
                button.removeEventListener('click', handleColumnToggle);
                button.addEventListener('click', handleColumnToggle);
            });
        }
        
        function handleColumnToggle() {
            const column = this.getAttribute('data-column');
            const isActive = this.classList.contains('active');
            
            if (isActive) {
                this.classList.remove('active');
                visibleColumns[column] = false;
            } else {
                this.classList.add('active');
                visibleColumns[column] = true;
            }
            
            if (document.getElementById('reportTableBody').children.length > 0 &&
                !document.getElementById('reportTableBody').children[0].classList.contains('no-results')) {
                updateReportTable();
            }
        }
        
        function generateReport() {
            const calculations = getSavedCalculations();
            
            if (calculations.length === 0) {
                alert('Não há cálculos salvos para gerar relatório.');
                return;
            }
            
            const collaboratorId = document.getElementById('reportCollaborator').value;
            const department = document.getElementById('reportDepartment').value;
            const month = document.getElementById('reportMonth').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            let filteredCalculations = [...calculations];
            activeReportFilters = {};
            
            if (collaboratorId) {
                filteredCalculations = filteredCalculations.filter(c => c.collaboratorId == collaboratorId);
                activeReportFilters.colaborador = collaboratorId;
            }
            
            if (department) {
                filteredCalculations = filteredCalculations.filter(c => c.collaboratorDepartment === department);
                activeReportFilters.departamento = department;
            }
            
            if (month) {
                filteredCalculations = filteredCalculations.filter(c => c.mesReferencia === month);
                activeReportFilters.mes = month;
            }
            
            if (startDate) {
                const start = new Date(startDate);
                filteredCalculations = filteredCalculations.filter(c => new Date(c.timestampISO) >= start);
                activeReportFilters.dataInicio = startDate;
            }
            
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filteredCalculations = filteredCalculations.filter(c => new Date(c.timestampISO) <= end);
                activeReportFilters.dataFim = endDate;
            }
            
            if (filteredCalculations.length === 0) {
                alert('Nenhum cálculo encontrado com os filtros aplicados.');
                return;
            }
            
            updateActiveFilters();
            
            const reportData = consolidateReportData(filteredCalculations);
            
            updateReportTable(reportData);
        }
        
        function consolidateReportData(calculations) {
            const consolidated = {};
            
            calculations.forEach(calc => {
                const key = `${calc.collaboratorId}-${calc.mesReferencia}`;
                
                if (!consolidated[key]) {
                    consolidated[key] = {
                        colaboradorId: calc.collaboratorId,
                        colaborador: calc.collaboratorName,
                        departamento: calc.collaboratorDepartment,
                        salario: calc.collaboratorSalary,
                        mesReferencia: calc.mesReferencia,
                        periculosidadeValor: parseFloat(calc.data.resultados.valorPericulosidade.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
                        sobreaviso: parseTime(calc.data.horasSobreavisoTotal),
                        sobreavisoDisplay: formatTimeForDisplay(calc.data.horasSobreavisoTotal),
                        sobreavisoValor: parseFloat(calc.data.resultados.valorSobreavisoEspera.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
                        sobreavisoTrabalhado: parseTime(calc.data.horasTrabalhadas50),
                        sobreavisoTrabalhadoDisplay: formatTimeForDisplay(calc.data.horasTrabalhadas50),
                        sobreavisoTrabalhadoValor: parseFloat(calc.data.resultados.valorHoraExtraTrabalho50.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
                        horasExtras: parseTime(calc.data.horasTrabalhadas100),
                        horasExtrasDisplay: formatTimeForDisplay(calc.data.horasTrabalhadas100),
                        horasExtrasValor: parseFloat(calc.data.resultados.valorHoraExtraTrabalho100.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
                        adicionalNoturno: parseTime(calc.data.horasNoturnas),
                        adicionalNoturnoDisplay: formatTimeForDisplay(calc.data.horasNoturnas),
                        adicionalNoturnoValor: parseFloat(calc.data.resultados.valorAdicionalNoturno.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
                        reflexosValor: parseFloat(calc.data.resultados.valorReflexoDSRTotalSum.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
                        reflexoSobreavisoValor: parseFloat(calc.data.resultados.valorReflexoSobreavisoEspera.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
                        reflexoSobreavisoTrabalhadoValor: parseFloat(calc.data.resultados.valorReflexoSobreavisoTrabalhado.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
                        reflexoHorasExtrasValor: parseFloat(calc.data.resultados.valorReflexoHorasExtrasNormal.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
                        reflexoAdicionalNoturnoValor: parseFloat(calc.data.resultados.valorReflexoAdicionalNoturno.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
                        total: 0
                    };
                } else {
                    consolidated[key].periculosidadeValor += parseFloat(calc.data.resultados.valorPericulosidade.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
                    consolidated[key].sobreaviso += parseTime(calc.data.horasSobreavisoTotal);
                    consolidated[key].sobreavisoValor += parseFloat(calc.data.resultados.valorSobreavisoEspera.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
                    consolidated[key].sobreavisoTrabalhado += parseTime(calc.data.horasTrabalhadas50);
                    consolidated[key].sobreavisoTrabalhadoValor += parseFloat(calc.data.resultados.valorHoraExtraTrabalho50.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
                    consolidated[key].horasExtras += parseTime(calc.data.horasTrabalhadas100);
                    consolidated[key].horasExtrasValor += parseFloat(calc.data.resultados.valorHoraExtraTrabalho100.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
                    consolidated[key].adicionalNoturno += parseTime(calc.data.horasNoturnas);
                    consolidated[key].adicionalNoturnoValor += parseFloat(calc.data.resultados.valorAdicionalNoturno.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
                    consolidated[key].reflexosValor += parseFloat(calc.data.resultados.valorReflexoDSRTotalSum.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
                    
                    consolidated[key].reflexoSobreavisoValor += parseFloat(calc.data.resultados.valorReflexoSobreavisoEspera.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
                    consolidated[key].reflexoSobreavisoTrabalhadoValor += parseFloat(calc.data.resultados.valorReflexoSobreavisoTrabalhado.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
                    consolidated[key].reflexoHorasExtrasValor += parseFloat(calc.data.resultados.valorReflexoHorasExtrasNormal.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
                    consolidated[key].reflexoAdicionalNoturnoValor += parseFloat(calc.data.resultados.valorReflexoAdicionalNoturno.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
                }
            });
            
            return Object.values(consolidated);
        }
        
        function formatTimeForDisplay(timeString) {
            if (!timeString) return "00:00";
            
            if (timeString.includes(':')) {
                const parts = timeString.split(':');
                const hours = parts[0].padStart(2, '0');
                const minutes = parts[1] ? parts[1].padStart(2, '0') : '00';
                return `${hours}:${minutes}`;
            }
            
            if (!isNaN(parseFloat(timeString))) {
                const hours = Math.floor(parseFloat(timeString));
                const minutes = Math.round((parseFloat(timeString) - hours) * 60);
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }
            
            return "00:00";
        }
        
        function updateReportTable(reportData = []) {
            const tableBody = document.getElementById('reportTableBody');
            const tableHeader = document.getElementById('reportTableHeader');
            
            if (reportData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="14" class="no-results">
                            <i class="fas fa-chart-bar fa-3x mb-4"></i>
                            <p class="text-lg">Nenhum relatório gerado ainda.</p>
                            <p class="text-sm">Configure os filtros acima e clique em "Filtrar".</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            updateTableHeader(tableHeader);
            
            let html = '';
            let totalGeral = 0;
            
            reportData.forEach((row) => {
                let totalFiltrado = 0;
                
                if (visibleColumns.periculosidade) totalFiltrado += row.periculosidadeValor;
                if (visibleColumns.sobreaviso) totalFiltrado += row.sobreavisoValor;
                if (visibleColumns.sobreaviso_trabalhado) totalFiltrado += row.sobreavisoTrabalhadoValor;
                if (visibleColumns.horas_extras) totalFiltrado += row.horasExtrasValor;
                if (visibleColumns.adicional_noturno) totalFiltrado += row.adicionalNoturnoValor;
                
                let reflexosFiltrados = 0;
                if (visibleColumns.sobreaviso) reflexosFiltrados += row.reflexoSobreavisoValor;
                if (visibleColumns.sobreaviso_trabalhado) reflexosFiltrados += row.reflexoSobreavisoTrabalhadoValor;
                if (visibleColumns.horas_extras) reflexosFiltrados += row.reflexoHorasExtrasValor;
                if (visibleColumns.adicional_noturno) reflexosFiltrados += row.reflexoAdicionalNoturnoValor;
                
                if (visibleColumns.reflexos) totalFiltrado += reflexosFiltrados;
                
                totalGeral += totalFiltrado;
                
                html += `
                    <tr>
                        ${visibleColumns.colaborador ? `<td class="font-medium">${row.colaborador}</td>` : ''}
                        ${visibleColumns.departamento ? `<td>${row.departamento}</td>` : ''}
                        ${visibleColumns.salario ? `<td>R$ ${row.salario}</td>` : ''}
                        ${visibleColumns.periculosidade ? `<td>${R$.format(row.periculosidadeValor)}</td>` : ''}
                        ${visibleColumns.sobreaviso ? `<td>${row.sobreavisoDisplay}</td>` : ''}
                        ${visibleColumns.sobreaviso ? `<td>${R$.format(row.sobreavisoValor)}</td>` : ''}
                        ${visibleColumns.sobreaviso_trabalhado ? `<td>${row.sobreavisoTrabalhadoDisplay}</td>` : ''}
                        ${visibleColumns.sobreaviso_trabalhado ? `<td>${R$.format(row.sobreavisoTrabalhadoValor)}</td>` : ''}
                        ${visibleColumns.horas_extras ? `<td>${row.horasExtrasDisplay}</td>` : ''}
                        ${visibleColumns.horas_extras ? `<td>${R$.format(row.horasExtrasValor)}</td>` : ''}
                        ${visibleColumns.adicional_noturno ? `<td>${row.adicionalNoturnoDisplay}</td>` : ''}
                        ${visibleColumns.adicional_noturno ? `<td>${R$.format(row.adicionalNoturnoValor)}</td>` : ''}
                        ${visibleColumns.reflexos ? `<td class="reflexo-total">${R$.format(reflexosFiltrados)}</td>` : ''}
                        ${visibleColumns.total ? `<td class="font-bold titulo-cor">${R$.format(totalFiltrado)}</td>` : ''}
                    </tr>
                `;
            });
            
            if (visibleColumns.total) {
                const colspan = getVisibleColumnCount() - 1;
                html += `
                    <tr class="total-row">
                        <td colspan="${colspan}" class="text-right font-bold">TOTAL GERAL (APENAS COLUNAS SELECIONADAS):</td>
                        <td class="font-bold titulo-cor">${R$.format(totalGeral)}</td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = html;
        }
        
        function updateTableHeader(header) {
            let headerHtml = '';
            
            if (visibleColumns.colaborador) headerHtml += '<th>COLABORADOR</th>';
            if (visibleColumns.departamento) headerHtml += '<th>DEPARTAMENTO</th>';
            if (visibleColumns.salario) headerHtml += '<th>SALÁRIO</th>';
            if (visibleColumns.periculosidade) headerHtml += '<th>PERICULOSIDADE</th>';
            if (visibleColumns.sobreaviso) headerHtml += '<th>HORAS DE SOBREAVISO</th>';
            if (visibleColumns.sobreaviso) headerHtml += '<th>VALOR</th>';
            if (visibleColumns.sobreaviso_trabalhado) headerHtml += '<th>HORAS DE SOBREAVISO TRABALHADO</th>';
            if (visibleColumns.sobreaviso_trabalhado) headerHtml += '<th>VALOR</th>';
            if (visibleColumns.horas_extras) headerHtml += '<th>HORAS EXTRAS</th>';
            if (visibleColumns.horas_extras) headerHtml += '<th>VALOR</th>';
            if (visibleColumns.adicional_noturno) headerHtml += '<th>HORAS DE ADCIONAL NOTURNO</th>';
            if (visibleColumns.adicional_noturno) headerHtml += '<th>VALOR</th>';
            if (visibleColumns.reflexos) headerHtml += '<th>REFLEXOS DSR</th>';
            if (visibleColumns.total) headerHtml += '<th>VALOR TOTAL</th>';
            
            header.innerHTML = headerHtml;
        }
        
        function getVisibleColumnCount() {
            let count = 0;
            Object.values(visibleColumns).forEach(isVisible => {
                if (isVisible) count++;
            });
            return count;
        }
        
        function updateActiveFilters() {
            const activeFiltersDiv = document.getElementById('activeFilters');
            const filterBadgesDiv = document.getElementById('filterBadges');
            
            if (Object.keys(activeReportFilters).length === 0) {
                activeFiltersDiv.classList.add('hidden');
                return;
            }
            
            activeFiltersDiv.classList.remove('hidden');
            
            let badgesHtml = '';
            
            if (activeReportFilters.colaborador) {
                const collaborator = getCollaborators().find(c => c.id == activeReportFilters.colaborador);
                if (collaborator) {
                    badgesHtml += `
                        <span class="filter-badge">
                            Colaborador: ${collaborator.name}
                            <i class="fas fa-times remove-filter" data-filter="colaborador"></i>
                        </span>
                    `;
                }
            }
            
            if (activeReportFilters.departamento) {
                badgesHtml += `
                    <span class="filter-badge">
                        Departamento: ${activeReportFilters.departamento}
                        <i class="fas fa-times remove-filter" data-filter="departamento"></i>
                    </span>
                `;
            }
            
            if (activeReportFilters.mes) {
                badgesHtml += `
                    <span class="filter-badge">
                        Mês: ${activeReportFilters.mes}
                        <i class="fas fa-times remove-filter" data-filter="mes"></i>
                    </span>
                `;
            }
            
            if (activeReportFilters.dataInicio) {
                badgesHtml += `
                    <span class="filter-badge">
                        De: ${activeReportFilters.dataInicio}
                        <i class="fas fa-times remove-filter" data-filter="dataInicio"></i>
                    </span>
                `;
            }
            
            if (activeReportFilters.dataFim) {
                badgesHtml += `
                    <span class="filter-badge">
                        Até: ${activeReportFilters.dataFim}
                        <i class="fas fa-times remove-filter" data-filter="dataFim"></i>
                    </span>
                `;
            }
            
            filterBadgesDiv.innerHTML = badgesHtml;
            
            document.querySelectorAll('.remove-filter').forEach(button => {
                button.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    removeFilter(filter);
                });
            });
        }
        
        function removeFilter(filter) {
            switch(filter) {
                case 'colaborador':
                    document.getElementById('reportCollaborator').value = '';
                    break;
                case 'departamento':
                    document.getElementById('reportDepartment').value = '';
                    break;
                case 'mes':
                    document.getElementById('reportMonth').value = '';
                    break;
                case 'dataInicio':
                    document.getElementById('reportStartDate').value = '';
                    break;
                case 'dataFim':
                    document.getElementById('reportEndDate').value = '';
                    break;
            }
            
            generateReport();
        }
        
        function clearReportFilters() {
            document.getElementById('reportCollaborator').value = '';
            document.getElementById('reportDepartment').value = '';
            document.getElementById('reportMonth').value = '';
            document.getElementById('reportStartDate').value = '';
            document.getElementById('reportEndDate').value = '';
            
            activeReportFilters = {};
            document.getElementById('activeFilters').classList.add('hidden');
            
            document.getElementById('reportTableBody').innerHTML = `
                <tr>
                    <td colspan="14" class="no-results">
                        <i class="fas fa-chart-bar fa-3x mb-4"></i>
                        <p class="text-lg">Nenhum relatório gerado ainda.</p>
                        <p class="text-sm">Configure os filtros acima e clique em "Filtrar".</p>
                    </td>
                </tr>
            `;
        }
        
        function exportReportCSV() {
            const tableBody = document.getElementById('reportTableBody');
            
            if (tableBody.children.length === 0 || tableBody.children[0].classList.contains('no-results')) {
                alert('Não há dados para exportar. Gere um relatório primeiro.');
                return;
            }
            
            let csv = '';
            
            const headers = [];
            if (visibleColumns.colaborador) headers.push('COLABORADOR');
            if (visibleColumns.departamento) headers.push('DEPARTAMENTO');
            if (visibleColumns.salario) headers.push('SALÁRIO');
            if (visibleColumns.periculosidade) headers.push('PERICULOSIDADE');
            if (visibleColumns.sobreaviso) headers.push('HORAS DE SOBREAVISO');
            if (visibleColumns.sobreaviso) headers.push('VALOR SOBREAVISO');
            if (visibleColumns.sobreaviso_trabalhado) headers.push('HORAS DE SOBREAVISO TRABALHADO');
            if (visibleColumns.sobreaviso_trabalhado) headers.push('VALOR SOBREAVISO TRABALHADO');
            if (visibleColumns.horas_extras) headers.push('HORAS EXTRAS');
            if (visibleColumns.horas_extras) headers.push('VALOR HORAS EXTRAS');
            if (visibleColumns.adicional_noturno) headers.push('HORAS DE ADCIONAL NOTURNO');
            if (visibleColumns.adicional_noturno) headers.push('VALOR ADCIONAL NOTURNO');
            if (visibleColumns.reflexos) headers.push('REFLEXOS DSR');
            if (visibleColumns.total) headers.push('VALOR TOTAL');
            
            csv += headers.join(';') + '\n';
            
            const rows = tableBody.querySelectorAll('tr:not(.total-row)');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                
                cells.forEach(cell => {
                    rowData.push(`"${cell.textContent.trim()}"`);
                });
                
                csv += rowData.join(';') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `relatorio_folha_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            alert('Relatório exportado como CSV com sucesso!');
        }
        
        function exportReportPDF() {
            const tableBody = document.getElementById('reportTableBody');
            
            if (tableBody.children.length === 0 || tableBody.children[0].classList.contains('no-results')) {
                alert('Não há dados para exportar. Gere um relatório primeiro.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            doc.setFontSize(20);
            doc.setTextColor(24, 0, 173);
            doc.text('Relatório de Cálculos - Folha de Pagamento', 148, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Data de emissão: ${new Date().toLocaleDateString('pt-BR')}`, 20, 25);
            
            if (Object.keys(activeReportFilters).length > 0) {
                let filterText = 'Filtros: ';
                const filters = [];
                
                if (activeReportFilters.colaborador) {
                    const collaborator = getCollaborators().find(c => c.id == activeReportFilters.colaborador);
                    if (collaborator) filters.push(`Colaborador: ${collaborator.name}`);
                }
                
                if (activeReportFilters.departamento) filters.push(`Departamento: ${activeReportFilters.departamento}`);
                if (activeReportFilters.mes) filters.push(`Mês: ${activeReportFilters.mes}`);
                if (activeReportFilters.dataInicio) filters.push(`De: ${activeReportFilters.dataInicio}`);
                if (activeReportFilters.dataFim) filters.push(`Até: ${activeReportFilters.dataFim}`);
                
                filterText += filters.join(', ');
                doc.text(filterText, 20, 30);
            }
            
            const headers = [];
            const rows = [];
            
            if (visibleColumns.colaborador) headers.push('Colaborador');
            if (visibleColumns.departamento) headers.push('Departamento');
            if (visibleColumns.salario) headers.push('Salário');
            if (visibleColumns.periculosidade) headers.push('Periculosidade');
            if (visibleColumns.sobreaviso) headers.push('Hrs Sob.');
            if (visibleColumns.sobreaviso) headers.push('Valor Sob.');
            if (visibleColumns.sobreaviso_trabalhado) headers.push('Hrs Sob. Trab.');
            if (visibleColumns.sobreaviso_trabalhado) headers.push('Valor Sob. Trab.');
            if (visibleColumns.horas_extras) headers.push('Hrs Extras');
            if (visibleColumns.horas_extras) headers.push('Valor Extras');
            if (visibleColumns.adicional_noturno) headers.push('Hrs Not.');
            if (visibleColumns.adicional_noturno) headers.push('Valor Not.');
            if (visibleColumns.reflexos) headers.push('Reflexos');
            if (visibleColumns.total) headers.push('Total');
            
            const tableRows = tableBody.querySelectorAll('tr:not(.total-row)');
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                
                cells.forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                
                rows.push(rowData);
            });
            
            const totalRow = tableBody.querySelector('.total-row');
            if (totalRow) {
                const totalCells = totalRow.querySelectorAll('td');
                const totalData = [];
                
                const numColunas = headers.length;
                
                for (let i = 0; i < numColunas - 1; i++) {
                    totalData.push('');
                }
                
                const totalGeralValor = totalCells[totalCells.length - 1].textContent.trim();
                totalData.push(totalGeralValor);
                
                rows.push(totalData);
            }
            
            doc.autoTable({
                startY: 40,
                head: [headers],
                body: rows,
                theme: 'striped',
                headStyles: { fillColor: [24, 0, 173] },
                margin: { left: 20, right: 20 },
                styles: { fontSize: 7 },
                didParseCell: function(data) {
                    if (data.row.index === rows.length - 1 && totalRow) {
                        if (data.column.index === headers.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fillColor = [224, 242, 254];
                            data.cell.styles.textColor = [24, 0, 173];
                            data.cell.styles.halign = 'right';
                        }
                        
                        if (data.column.index === headers.length - 2) {
                            data.cell.text = 'TOTAL GERAL:';
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.halign = 'right';
                        }
                    }
                },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Página ${data.pageNumber} de ${data.pageCount}`, 148, 200, { align: 'center' });
                    doc.text('Sistema de Cálculos de Folha de Pagamento', 148, 205, { align: 'center' });
                }
            });
            
            const fileName = `relatorio_folha_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(fileName);
            
            alert('Relatório exportado como PDF com sucesso! O TOTAL GERAL considera APENAS as colunas selecionadas, incluindo os REFLEXOS correspondentes.');
        }

        // ============================================
        // FUNÇÕES AUXILIARES
        // ============================================
        
        function updateDiasTrabalhados() {
            const diasAtestado = parseFloat(document.getElementById('diasAtestado').value) || 0;
            const diasTrabalhadosInput = document.getElementById('diasTrabalhados');
            
            const diasTrabalhadosBase = 30;
            const diasTrabalhadosAjustados = Math.max(0, diasTrabalhadosBase - diasAtestado);
            
            diasTrabalhadosInput.value = diasTrabalhadosAjustados;
            calcular();
        }

        // ============================================
        // INICIALIZAÇÃO
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log("🚀 Aplicação inicializada com sincronização em tempo real");
            
            loadSettings();
            
            const monthInput = document.getElementById('mesReferencia');
            const salarioBaseInput = document.getElementById('salarioBase');
            
            monthInput.value = getCurrentMonthString();
            
            handleMonthChange(true);
            
            getDepartments();
            
            updateDepartmentSelect();
            updateCollaboratorSelect();
            updateCollaboratorFilterSelect();
            
            const inputsAndSelects = document.querySelectorAll('#calculatorContent input:not([readonly]):not(#mesReferencia):not(#salarioBase), #calculatorContent select');
            inputsAndSelects.forEach(element => element.addEventListener('input', calcular));
            inputsAndSelects.forEach(element => element.addEventListener('change', calcular));
            
            salarioBaseInput.addEventListener('input', () => {
                formatCurrencyInput(salarioBaseInput);
                calcular();
            });

            monthInput.addEventListener('change', () => handleMonthChange(false));
            
            document.getElementById('diasFeriado').addEventListener('input', calcular);
            document.getElementById('diasTrabalhados').addEventListener('input', calcular);
            
            document.getElementById('diasAtestado').addEventListener('input', () => {
                updateDiasTrabalhados();
            });
            
            document.getElementById('usaPericulosidade').addEventListener('change', calcular);
            
            document.getElementById('pagoFolha').addEventListener('change', calcular);
            document.getElementById('competenciaPagamento').addEventListener('change', calcular);
            
            document.getElementById('clearButton').addEventListener('click', resetInputs);
            
            document.getElementById('saveCalculation').addEventListener('click', saveCurrentCalculation);
            
            document.getElementById('refreshCollaborators').addEventListener('click', () => {
                updateCollaboratorSelect();
                updateCollaboratorFilterSelect();
            });
            
            document.getElementById('collaboratorSelect').addEventListener('change', function() {
                if (this.value) {
                    loadCollaboratorToCalculator(this.value);
                }
            });
            
            document.getElementById('refreshCollaboratorList').addEventListener('click', () => {
                renderCollaboratorsTable(currentCollaboratorStatus);
            });
            
            document.getElementById('showActiveCollaborators').addEventListener('click', () => {
                renderCollaboratorsTable('active');
            });
            
            document.getElementById('showInactiveCollaborators').addEventListener('click', () => {
                renderCollaboratorsTable('inactive');
            });
            
            document.getElementById('refreshDepartments').addEventListener('click', renderDepartmentsTable);
            
            document.getElementById('refreshHistory').addEventListener('click', () => {
                renderHistoryTable();
                updateCollaboratorFilterSelect();
            });
            
            document.getElementById('clearHistoryFilters').addEventListener('click', clearHistoryFilters);
            
            document.getElementById('applyFilters').addEventListener('click', applyHistoryFilters);
            
            document.getElementById('toggleBases').addEventListener('click', toggleBasesVisibility);
            
            document.getElementById('menuCalculator').addEventListener('click', showCalculator);
            document.getElementById('menuCollaborators').addEventListener('click', showCollaborators);
            document.getElementById('menuHistory').addEventListener('click', showHistory);
            document.getElementById('menuReports').addEventListener('click', showReports);
            document.getElementById('menuSettings').addEventListener('click', openSettingsModal);
            document.getElementById('menuAdmin').addEventListener('click', openAdminModal);
            
            document.getElementById('tabCollaborators').addEventListener('click', showCollaboratorsTab);
            document.getElementById('tabDepartments').addEventListener('click', showDepartmentsTab);
            
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelCollaborator').addEventListener('click', closeModal);
            document.getElementById('collaboratorForm').addEventListener('submit', saveCollaborator);
            document.getElementById('addNewCollaborator').addEventListener('click', () => {
                resetCollaboratorForm();
                openModal();
            });
            
            document.getElementById('addDepartmentFromCollaborator').addEventListener('click', (e) => {
                e.preventDefault();
                closeModal();
                openDepartmentModal();
            });
            
            document.getElementById('closeDepartmentModal').addEventListener('click', closeDepartmentModal);
            document.getElementById('cancelDepartment').addEventListener('click', closeDepartmentModal);
            document.getElementById('departmentForm').addEventListener('submit', saveNewDepartment);
            document.getElementById('addNewDepartment').addEventListener('click', openDepartmentModal);
            
            document.getElementById('closeCalculationDetailModal').addEventListener('click', closeCalculationDetailModal);
            document.getElementById('closeCalculationDetail').addEventListener('click', closeCalculationDetailModal);
            document.getElementById('editCalculationBtn').addEventListener('click', enableDetailEditMode);
            document.getElementById('saveEditBtn').addEventListener('click', saveDetailEdit);
            document.getElementById('cancelEditBtn').addEventListener('click', cancelDetailEdit);
            
            document.getElementById('closeDeleteModal').addEventListener('click', closeDeleteCollaboratorModal);
            document.getElementById('cancelDeleteCollaborator').addEventListener('click', closeDeleteCollaboratorModal);
            document.getElementById('confirmDeleteCollaborator').addEventListener('click', confirmDeleteCollaborator);
            
            document.getElementById('closeDeleteUserModal').addEventListener('click', closeDeleteUserModal);
            document.getElementById('cancelDeleteUser').addEventListener('click', closeDeleteUserModal);
            document.getElementById('confirmDeleteUser').addEventListener('click', confirmDeleteUser);
            
            document.getElementById('refreshReports').addEventListener('click', () => {
                updateCollaboratorFilterSelect();
                updateDepartmentSelect();
            });
            document.getElementById('generateReport').addEventListener('click', generateReport);
            document.getElementById('clearReportFilters').addEventListener('click', clearReportFilters);
            document.getElementById('exportReportCSV').addEventListener('click', exportReportCSV);
            document.getElementById('exportReportPDF').addEventListener('click', exportReportPDF);
            
            document.getElementById('closeSettingsModal').addEventListener('click', closeSettingsModal);
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            
            document.getElementById('closeAdminModal').addEventListener('click', closeAdminModal);
            
            document.getElementById('forceSyncBtn')?.addEventListener('click', () => {
                localStorage.removeItem(CACHE_KEY);
                loadAllUsers();
            });
            
            document.getElementById('collaboratorBaseSalary').addEventListener('input', function() {
                formatCurrencyInput(this);
            });
            
            document.getElementById('printButton').addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                doc.setFontSize(20);
                doc.setTextColor(24, 0, 173);
                doc.text('Cálculo de Adicionais e Reflexos da Folha', 105, 15, { align: 'center' });
                
                const collaboratorSelect = document.getElementById('collaboratorSelect');
                const collaboratorName = collaboratorSelect.options[collaboratorSelect.selectedIndex]?.text || 'Não selecionado';
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Colaborador: ${collaboratorName}`, 20, 25);
                doc.text(`Mês Referência: ${document.getElementById('mesReferencia').value || 'Não informado'}`, 20, 32);
                
                doc.setFontSize(10);
                doc.text(`Data de emissão: ${new Date().toLocaleDateString('pt-BR')}`, 20, 39);
                
                const usaPericulosidade = document.getElementById('usaPericulosidade').checked;
                const valorPericulosidade = document.getElementById('valorPericulosidade').textContent;
                
                doc.setFillColor(240, 249, 255);
                doc.rect(20, 45, 170, 8, 'F');
                doc.setFontSize(11);
                doc.setTextColor(24, 0, 173);
                doc.text(`Periculosidade do Colaborador: ${usaPericulosidade ? 'SIM' : 'NÃO'}`, 22, 51);
                if (usaPericulosidade) {
                    doc.text(`Valor da Periculosidade: ${valorPericulosidade}`, 120, 51);
                }
                
                const startY = 60;
                
                doc.setFontSize(14);
                doc.setTextColor(24, 0, 173);
                doc.text('ADICIONAIS E PERICULOSIDADE', 20, startY);
                
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                let y = startY + 8;
                
                if (usaPericulosidade) {
                    doc.text(`Periculosidade (30%): ${valorPericulosidade}`, 25, y);
                    y += 7;
                }
                
                doc.text(`Horas de Sobreaviso (Espera): ${document.getElementById('valorSobreavisoEspera').textContent}`, 25, y);
                y += 7;
                doc.text(`Horas de Sobreaviso Trabalhado (${heSobreavisoPorcentagem}%): ${document.getElementById('valorHoraExtraTrabalho50').textContent}`, 25, y);
                y += 7;
                doc.text(`Horas Extras ${heNormalPorcentagem}% (Normal): ${document.getElementById('valorHoraExtraTrabalho100').textContent}`, 25, y);
                y += 7;
                doc.text(`Horas de Adicional Noturno (${adicionalNoturnoPorcentagem}%): ${document.getElementById('valorAdicionalNoturno').textContent}`, 25, y);
                y += 10;
                
                doc.setFontSize(14);
                doc.setTextColor(24, 0, 173);
                doc.text(`REFLEXOS DSR (Fator: ${document.getElementById('fatorDSRDisplay').textContent})`, 20, y);
                
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                y += 8;
                
                doc.text(`Reflexo Sobreaviso DSR (Espera 1/3): ${document.getElementById('valorReflexoSobreavisoEspera').textContent}`, 25, y);
                y += 7;
                doc.text(`Reflexo Sob. Trabalhado DSR (HE ${heSobreavisoPorcentagem}%): ${document.getElementById('valorReflexoSobreavisoTrabalhado').textContent}`, 25, y);
                y += 7;
                doc.text(`Reflexo Horas Extras DSR (Normal ${heNormalPorcentagem}%): ${document.getElementById('valorReflexoHorasExtrasNormal').textContent}`, 25, y);
                y += 7;
                doc.text(`Reflexo Adic. Noturno DSR (${adicionalNoturnoPorcentagem}%): ${document.getElementById('valorReflexoAdicionalNoturno').textContent}`, 25, y);
                y += 10;
                
                doc.setFontSize(12);
                doc.setTextColor(24, 0, 173);
                doc.text(`TOTAL DOS REFLEXOS: ${document.getElementById('valorReflexoDSRTotalSum').textContent}`, 20, y);
                y += 10;
                
                doc.setFontSize(14);
                doc.setTextColor(24, 0, 173);
                doc.text('INFORMAÇÕES DE ENTRADA', 20, y);
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                y += 8;
                
                doc.text(`Salário Base: R$ ${document.getElementById('salarioBase').value || '0,00'}`, 25, y);
                doc.text(`Horas Mensais: ${document.getElementById('divisorMensal').value}`, 120, y);
                y += 6;
                
                doc.text(`Dias Normais: ${document.getElementById('diasTrabalhados').value}`, 25, y);
                doc.text(`Dias Atestado: ${document.getElementById('diasAtestado').value}`, 120, y);
                y += 6;
                
                doc.text(`Feriados: ${document.getElementById('diasFeriado').value}`, 25, y);
                y += 6;
                
                doc.text(`Horas Sobreaviso: ${document.getElementById('horasSobreavisoTotal').value}`, 25, y);
                doc.text(`Horas Sob. Trabalhado: ${document.getElementById('horasTrabalhadas50').value}`, 120, y);
                y += 6;
                
                doc.text(`Horas Extras: ${document.getElementById('horasTrabalhadas100').value}`, 25, y);
                doc.text(`Horas Noturnas: ${document.getElementById('horasNoturnas').value}`, 120, y);
                y += 10;
                
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text('Sistema de Cálculos de Folha de Pagamento', 105, 280, { align: 'center' });
                doc.text('Este documento foi gerado automaticamente pelo sistema.', 105, 285, { align: 'center' });
                
                const fileName = `calculo_folha_${collaboratorName.split(' - ')[0] || 'colaborador'}_${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(fileName);
                
                alert('PDF gerado com sucesso!');
            });
            
            document.getElementById('importCollaboratorsBtn').addEventListener('click', openImportModal);
            document.getElementById('closeImportModal').addEventListener('click', closeImportModal);
            document.getElementById('cancelImport').addEventListener('click', closeImportModal);
            document.getElementById('confirmImport').addEventListener('click', confirmImport);
            document.getElementById('downloadTemplate').addEventListener('click', downloadTemplate);
            
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('spreadsheetFile');
            const selectFileButton = document.getElementById('selectFileButton');
            
            fileUploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('border-green-500', 'bg-green-50');
            });
            
            fileUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('border-green-500', 'bg-green-50');
            });
            
            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('border-green-500', 'bg-green-50');
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect({ target: { files: e.dataTransfer.files } });
                }
            });
            
            selectFileButton.addEventListener('click', (e) => {
                e.stopPropagation();
                fileInput.click();
            });
            
            fileInput.addEventListener('change', handleFileSelect);
            
            document.getElementById('importSpreadsheetModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeImportModal();
                }
            });
            
            document.getElementById('collaboratorModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeModal();
                }
            });
            
            document.getElementById('departmentModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeDepartmentModal();
                }
            });
            
            document.getElementById('calculationDetailModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeCalculationDetailModal();
                }
            });
            
            document.getElementById('deleteCollaboratorModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeDeleteCollaboratorModal();
                }
            });
            
            document.getElementById('deleteUserModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeDeleteUserModal();
                }
            });
            
            document.getElementById('settingsModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeSettingsModal();
                }
            });
            
            document.getElementById('adminModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeAdminModal();
                }
            });
            
            calcular();
            
            document.getElementById('diasTrabalhados').value = 30;
            
            document.getElementById('basesContainer').classList.add('hidden');
            document.getElementById('basesIcon').classList.remove('fa-chevron-up');
            document.getElementById('basesIcon').classList.add('fa-chevron-down');
            
            setTimeout(() => {
                if (!currentUser) {
                    updateAuthUI(null);
                }
            }, 2000);
        });
    </script>
</body>
</html>
