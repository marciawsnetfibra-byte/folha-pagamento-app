<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Adicionais e Reflexos da Folha de Pagamento</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- SheetJS para importação de planilhas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF para geração de PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --cor-titulo: #1800AD;
            --cor-menu: #0B0B2B;
            --cor-menu-hover: #1a1a4b;
            --cor-menu-text: #ffffff;
            --cor-menu-icon: #6366f1;
            --cor-importar: #10B981;
            --cor-importar-hover: #059669;
            --cor-admin: #7C3AED;
            --cor-admin-hover: #6D28D9;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            width: 100%;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }
        
        /* MENU LATERAL */
        .side-menu {
            width: 260px;
            background: linear-gradient(180deg, #0B0B2B 0%, #1a1a4b 100%);
            color: var(--cor-menu-text);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .menu-header {
            padding: 25px 15px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .menu-header i {
            font-size: 42px;
            color: #818cf8;
            margin-bottom: 8px;
            display: block;
        }
        
        .menu-header h2 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 8px 0 3px;
            background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .menu-header p {
            font-size: 0.7rem;
            opacity: 0.7;
        }
        
        .menu-items {
            padding: 15px 0;
            flex: 1;
        }
        
        .menu-button {
            width: 100%;
            text-align: left;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid transparent;
        }
        
        .menu-button i {
            width: 22px;
            font-size: 1.1rem;
            color: var(--cor-menu-icon);
            transition: all 0.3s ease;
        }
        
        .menu-button:hover {
            background: rgba(99, 102, 241, 0.15);
            color: white;
            border-left-color: #818cf8;
        }
        
        .menu-button:hover i {
            color: #818cf8;
        }
        
        .menu-button.active {
            background: rgba(99, 102, 241, 0.2);
            color: white;
            border-left-color: #818cf8;
        }
        
        .menu-button.active i {
            color: #818cf8;
        }
        
        .menu-footer {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .user-info-side {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .user-email {
            font-size: 0.8rem;
            word-break: break-all;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }
        
        .badge-container {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .admin-badge {
            background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .offline-badge {
            background: #6B7280;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .logout-btn {
            width: 100%;
            padding: 10px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            color: white;
        }
        
        /* CONTEÚDO PRINCIPAL */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 20px;
            min-height: 100vh;
            width: calc(100% - 260px);
        }
        
        /* CONTAINERS PRINCIPAIS */
        .container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            width: 100%;
        }
        
        /* MODAL DE LOGIN */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-modal.active {
            display: flex;
        }
        
        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            z-index: 10001;
        }
        
        /* MODAL DE RECUPERAÇÃO DE SENHA */
        .forgot-password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 11000;
        }
        
        .forgot-password-modal.active {
            display: flex;
        }
        
        .forgot-password-box {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            z-index: 11001;
        }
        
        /* SELETOR DE USUÁRIO */
        .user-selector {
            background-color: #f0f4ff;
            border: 1px solid #818cf8;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 10px 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-selector i {
            color: var(--cor-titulo);
            font-size: 1.2rem;
        }
        
        .user-selector select {
            flex: 1;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px;
            font-size: 14px;
            background-color: white;
        }
        
        .user-selector button {
            background-color: var(--cor-titulo);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .user-selector button:hover {
            background-color: #0f0080;
        }
        
        .current-user-badge {
            background-color: #10B981;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-management {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-name {
            font-weight: 500;
            color: var(--cor-titulo);
        }
        
        .user-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .edit-user-btn {
            color: #3B82F6;
        }
        
        .edit-user-btn:hover {
            background-color: #DBEAFE;
        }
        
        .delete-user-btn {
            color: #EF4444;
        }
        
        .delete-user-btn:hover {
            background-color: #FEE2E2;
        }
        
        .add-user-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .add-user-form input {
            flex: 1;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        
        .add-user-form button {
            background-color: #10B981;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .add-user-form button:hover {
            background-color: #059669;
        }
        
        /* OUTROS MODAIS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 2001;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9fafb;
            border-radius: 10px 10px 0 0;
        }
        
        .modal-title {
            font-weight: 600;
            color: var(--cor-titulo);
            font-size: 1.25rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: #374151;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        input[type="text"], input[type="number"], select, input[type="month"], input[type="date"], input[type="file"], input[type="password"], input[type="email"] {
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
            height: 40px !important;
            line-height: normal;
        }
        
        .duplicate-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #FEF3C7;
            border-left: 4px solid #F59E0B;
            color: #92400E;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
        }
        
        .duplicate-notification i {
            font-size: 20px;
            color: #F59E0B;
        }
        
        .duplicate-notification .close-btn {
            margin-left: auto;
            cursor: pointer;
            color: #6B7280;
            background: none;
            border: none;
            font-size: 16px;
        }
        
        .duplicate-notification .close-btn:hover {
            color: #374151;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .settings-panel {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .setting-item label {
            min-width: 200px;
            font-weight: 500;
        }
        
        .setting-item input {
            max-width: 100px;
        }
        
        .printButton, #clearButton, #saveButton, #loadDataButton, #exportDataButton {
            color: var(--cor-titulo);
            border: 1px solid transparent;
            margin-left: 10px;
        }
        
        .printButton:hover, #clearButton:hover, #saveButton:hover, #loadDataButton:hover, #exportDataButton:hover {
             border: 1px solid var(--cor-titulo);
             background-color: #f0f4ff;
        }
        
        .save-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .collaborator-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            background-color: white;
            margin-top: 10px;
        }
        
        .collaborator-item {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .collaborator-item:hover {
            background-color: #f0f4ff;
        }
        
        .collaborator-item:last-child {
            border-bottom: none;
        }
        
        .collaborator-name {
            font-weight: 600;
            color: var(--cor-titulo);
        }
        
        .collaborator-details {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .delete-btn {
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .delete-btn:hover {
            background-color: #fee2e2;
        }
        
        .collaborator-table, .department-table, .history-table, .import-preview-table, .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .collaborator-table th, .department-table th, .history-table th, .import-preview-table th, .admin-table th {
            background-color: #f3f4f6;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .collaborator-table td, .department-table td, .history-table td, .import-preview-table td, .admin-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .collaborator-table tr:hover, .department-table tr:hover, .history-table tr:hover, .import-preview-table tr:hover, .admin-table tr:hover {
            background-color: #f9fafb;
        }
        
        .department-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .import-preview-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .status-toggle-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f3f4f6;
            border-radius: 8px;
        }
        
        .status-toggle-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .status-toggle-btn.active {
            background-color: var(--cor-titulo);
            color: white;
            border-color: var(--cor-titulo);
        }
        
        .status-toggle-btn:not(.active) {
            background-color: white;
            color: var(--cor-titulo);
            border-color: #d1d5db;
        }
        
        .status-toggle-btn:not(.active):hover {
            background-color: #f0f4ff;
        }
        
        .info-box {
            background-color: #e0f2fe;
            border-left: 4px solid #0369a1;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 4px;
        }
        
        .firebase-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .firebase-connected {
            background-color: #10B981;
            color: white;
        }
        
        .firebase-disconnected {
            background-color: #EF4444;
            color: white;
        }
        
        .firebase-loading {
            background-color: #F59E0B;
            color: white;
        }
        
        .firebase-offline {
            background-color: #6B7280;
            color: white;
        }
        
        .login-tabs {
            display: flex;
            gap: 1px;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        
        .login-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .login-tab.active {
            background-color: var(--cor-titulo);
            color: white;
        }
        
        .sync-badge {
            background-color: #3B82F6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .login-error {
            display: none;
            background-color: #FEE2E2;
            border: 1px solid #FECACA;
            color: #DC2626;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        
        .login-error.show {
            display: block;
        }
        
        .forgot-password-link {
            text-align: right;
            margin-top: 8px;
        }
        
        .forgot-password-link button {
            background: none;
            border: none;
            color: #3B82F6;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .forgot-password-link button:hover {
            color: #1E40AF;
        }
        
        .success-message {
            background-color: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .warning-message {
            background-color: #fffbeb;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .column-toggle-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .column-toggle-btn.active {
            background-color: var(--cor-titulo);
            color: white;
            border-color: var(--cor-titulo);
        }
        
        .column-toggle-btn:not(.active):hover {
            background-color: #f3f4f6;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 14px;
        }
        
        .report-table th {
            background-color: var(--cor-titulo);
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .report-table td {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .report-table tr:hover {
            background-color: #f0f4ff;
        }
        
        .report-table tr.total-row {
            background-color: #e0f2fe;
            font-weight: bold;
        }
        
        .report-summary {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .filter-badge {
            display: inline-flex;
            align-items: center;
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .filter-badge i {
            margin-left: 6px;
            cursor: pointer;
        }
        
        .reflexo-destaque {
            background-color: #f0f9ff;
            border-left: 4px solid #0369a1;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        
        .reflexo-total {
            font-weight: bold;
            color: #0369a1;
        }
        
        .view-mode input, .view-mode select {
            background-color: #f3f4f6 !important;
            color: #4b5563 !important;
            border: 1px solid #d1d5db !important;
            cursor: not-allowed;
        }
        
        .edit-btn {
            background-color: #3B82F6;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-btn:hover {
            background-color: #2563EB;
        }
        
        .payment-info {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .payment-info h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--cor-titulo);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .payment-info h3 i {
            color: #059669;
        }
        
        .payment-info .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .payment-info label {
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 4px;
            display: block;
        }
        
        .edit-mode input, .edit-mode select {
            background-color: white !important;
            color: #111827 !important;
            border: 1px solid #d1d5db !important;
            cursor: text !important;
        }
        
        .edit-mode input[readonly], .edit-mode select[readonly] {
            background-color: #f3f4f6 !important;
        }
        
        .periculosidade-info {
            background-color: #fef9e7;
            border-left: 4px solid #f39c12;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .periculosidade-detalhe {
            font-size: 0.8rem;
            color: #555;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed #ccc;
        }
        
        .import-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }
        
        .stat-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--cor-titulo);
        }
        
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background-color: #f9fafb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-upload-area:hover {
            border-color: var(--cor-importar);
            background-color: #f0fdf4;
        }
        
        .file-upload-area i {
            font-size: 48px;
            color: var(--cor-importar);
            margin-bottom: 12px;
        }
        
        .moeda-br {
            color: var(--cor-titulo);
            font-weight: 600;
        }
        
        .admin-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .admin-user-item:last-child {
            border-bottom: none;
        }
        
        .admin-user-email {
            font-weight: 500;
            color: var(--cor-titulo);
        }
        
        .admin-user-date {
            font-size: 12px;
            color: #6b7280;
        }
        
        .admin-actions {
            display: flex;
            gap: 8px;
        }
        
        .status-radio-group {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 8px;
        }
        
        .status-radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-radio-option input[type="radio"] {
            width: 16px;
            height: 16px;
            margin: 0;
        }
        
        .sync-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            background-color: #f59e0b;
            color: white;
            margin-left: 8px;
        }
        
        .admin-warning {
            background-color: #FEF3C7;
            border-left: 4px solid #F59E0B;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .force-sync-btn {
            background-color: #3B82F6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 12px;
        }
        
        .force-sync-btn:hover {
            background-color: #2563EB;
        }
        
        .offline-badge {
            background-color: #6B7280;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        /* RESPONSIVIDADE */
        @media (max-width: 1024px) {
            .side-menu {
                width: 70px;
            }
            
            .menu-header h2,
            .menu-header p,
            .menu-button span,
            .user-info-side .user-email,
            .badge-container {
                display: none;
            }
            
            .menu-button {
                padding: 15px;
                justify-content: center;
            }
            
            .menu-button i {
                margin: 0;
                font-size: 1.3rem;
            }
            
            .menu-footer {
                padding: 10px;
            }
            
            .logout-btn span {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
                width: calc(100% - 70px);
                padding: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            .container h1 {
                font-size: 1.5rem;
            }
            
            .grid-cols-1.lg\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- MENU LATERAL -->
        <nav class="side-menu">
            <div class="menu-header">
                <i class="fas fa-calculator"></i>
                <h2>Folha de Pagamento</h2>
                <p>Sistema de Cálculos</p>
            </div>
            
            <div class="menu-items">
                <button class="menu-button active" id="menuCalculator">
                    <i class="fas fa-calculator"></i>
                    <span>Calculadora</span>
                </button>
                <button class="menu-button" id="menuCollaborators">
                    <i class="fas fa-users"></i>
                    <span>Colaboradores</span>
                </button>
                <button class="menu-button" id="menuHistory">
                    <i class="fas fa-history"></i>
                    <span>Histórico</span>
                </button>
                <button class="menu-button" id="menuReports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Relatórios</span>
                </button>
                <button class="menu-button" id="menuSettings">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </button>
                <button class="menu-button" id="menuAdmin" style="display: block;">
                    <i class="fas fa-users-cog"></i>
                    <span>Gerenciar Usuários</span>
                </button>
            </div>
            
            <div class="menu-footer">
                <div id="userInfoSide" class="user-info-side">
                    <div class="user-email" id="userEmailSide"></div>
                    <div class="badge-container">
                        <span id="currentUserBadge" class="current-user-badge" style="display: none;">
                            <i class="fas fa-user"></i> <span id="currentUserName"></span>
                        </span>
                        <span id="offlineBadgeSide" class="offline-badge" style="display: none;">Offline</span>
                    </div>
                </div>
                <button class="logout-btn" id="btnLogout" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair</span>
                </button>
            </div>
        </nav>
        
        <!-- CONTEÚDO PRINCIPAL -->
        <div class="main-content">
            <!-- Status do Firebase -->
            <div id="firebaseStatus" class="firebase-status firebase-loading">
                <i class="fas fa-sync fa-spin"></i>
                <span>Conectando ao banco de dados...</span>
            </div>

            <!-- Notificação de Lançamento Duplicado -->
            <div id="duplicateNotification" class="duplicate-notification" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>Lançamento duplicado!</strong>
                    <p id="duplicateMessage">Este cálculo já foi salvo anteriormente para este colaborador no mesmo mês.</p>
                </div>
                <button class="close-btn" onclick="document.getElementById('duplicateNotification').style.display='none'">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- SELETOR DE USUÁRIO (aparece após o login) -->
            <div id="userSelectorContainer" class="user-selector" style="display: none;">
                <i class="fas fa-user-circle"></i>
                <select id="userSelector" style="flex: 1;">
                    <option value="">-- Selecione seu nome --</option>
                </select>
                <button id="setCurrentUserBtn">
                    <i class="fas fa-check mr-1"></i> Confirmar
                </button>
            </div>

            <!-- Modal de Configurações -->
            <div class="modal" id="settingsModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-cog mr-2"></i>
                            Configurações do Sistema
                        </h3>
                        <button class="modal-close" id="closeSettingsModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="settings-panel">
                            <h4 class="font-bold text-lg titulo-cor mb-4">Porcentagem de Horas Extras</h4>
                            
                            <div class="setting-item">
                                <label for="heNormalPorcentagem">Hora Extra Normal (50%):</label>
                                <input type="number" id="heNormalPorcentagem" min="0" max="200" value="50" step="1" class="w-24">
                                <span class="ml-2">%</span>
                            </div>
                            
                            <div class="setting-item">
                                <label for="heSobreavisoPorcentagem">Sobreaviso Trabalhado (50%):</label>
                                <input type="number" id="heSobreavisoPorcentagem" min="0" max="200" value="50" step="1" class="w-24">
                                <span class="ml-2">%</span>
                            </div>
                            
                            <div class="setting-item">
                                <label for="adicionalNoturnoPorcentagem">Adicional Noturno (20%):</label>
                                <input type="number" id="adicionalNoturnoPorcentagem" min="0" max="100" value="20" step="1" class="w-24">
                                <span class="ml-2">%</span>
                            </div>
                            
                            <div class="mt-6 pt-4 border-t flex justify-end">
                                <button id="saveSettings" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                    <i class="fas fa-save mr-2"></i>Salvar Configurações
                                </button>
                            </div>
                        </div>
                        
                        <div class="info-box">
                            <i class="fas fa-info-circle mr-2"></i>
                            As alterações nas porcentagens afetarão todos os novos cálculos realizados.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Gerenciamento de Usuários -->
            <div class="modal" id="adminModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-users-cog mr-2"></i>
                            Gerenciar Usuários da Equipe
                        </h3>
                        <button class="modal-close" id="closeAdminModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="user-management">
                            <h4 class="font-bold text-lg titulo-cor mb-4">Usuários Cadastrados</h4>
                            
                            <div id="usersList" class="mb-4">
                                <!-- Lista de usuários será renderizada aqui -->
                            </div>
                            
                            <div class="add-user-form">
                                <input type="text" id="newUserName" placeholder="Nome do novo usuário (ex: Márcia, Ana, João)">
                                <button id="addUserBtn">
                                    <i class="fas fa-plus mr-1"></i> Adicionar
                                </button>
                            </div>
                            
                            <div class="info-box mt-4">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>Como funciona:</strong>
                                <ul class="list-disc list-inside mt-2 text-sm">
                                    <li>Os usuários cadastrados aqui são as pessoas da sua equipe</li>
                                    <li>Cada pessoa deve selecionar seu nome no seletor após fazer login</li>
                                    <li>O histórico registra quem fez cada cálculo</li>
                                    <li>Todos compartilham os mesmos dados (colaboradores, departamentos)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Login -->
            <div id="loginModal" class="login-modal">
                <div class="login-box">
                    <h2 class="text-2xl font-bold titulo-cor mb-2">Acesso da Equipe</h2>
                    <p class="mb-6 text-gray-600 text-sm">Login único para toda a equipe</p>
                    
                    <div id="loginError" class="login-error">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        <span id="errorText">Mensagem de erro aparecerá aqui</span>
                    </div>
                    
                    <div id="loginForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="loginEmail" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="email da equipe">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                                <input type="password" id="loginPassword" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="••••••••">
                            </div>
                            <div class="forgot-password-link">
                                <button type="button" id="forgotPasswordBtn">Esqueci a senha</button>
                            </div>
                            <button id="btnLogin" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-medium transition duration-150">
                                <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-xs text-gray-500">
                        <p><i class="fas fa-info-circle mr-1"></i> Esta é uma conta compartilhada pela equipe. Após o login, cada pessoa deve selecionar seu nome.</p>
                    </div>
                </div>
            </div>

            <!-- Modal de Recuperação de Senha -->
            <div id="forgotPasswordModal" class="forgot-password-modal">
                <div class="forgot-password-box">
                    <h2 class="text-2xl font-bold titulo-cor mb-2">Recuperar Senha</h2>
                    <p class="mb-6 text-gray-600 text-sm">Digite o email da equipe para receber o link de recuperação</p>
                    
                    <div id="forgotPasswordError" class="login-error">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        <span id="forgotErrorText">Mensagem de erro</span>
                    </div>
                    
                    <div id="forgotPasswordSuccessModal" class="success-message" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span>Email de recuperação enviado!</span>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="forgotEmail" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="email da equipe">
                        </div>
                        <button id="btnSendResetLink" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-medium transition duration-150">
                            <i class="fas fa-paper-plane mr-2"></i>Enviar Link
                        </button>
                        <div class="text-center mt-4">
                            <button id="btnBackToLogin" class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-arrow-left mr-1"></i>Voltar para o login
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL DE IMPORTAÇÃO DE PLANILHA -->
            <div class="modal" id="importSpreadsheetModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-file-excel mr-2 text-green-600"></i>
                            Importar Colaboradores de Planilha
                        </h3>
                        <button class="modal-close" id="closeImportModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="importMessages"></div>
                        
                        <div class="info-box mb-6">
                            <strong><i class="fas fa-info-circle mr-2"></i>Formato da Planilha:</strong>
                            <p class="mt-2 text-sm">Sua planilha deve conter as seguintes colunas:</p>
                            <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                                <li><span class="font-medium">Nome</span> - Nome completo do colaborador</li>
                                <li><span class="font-medium">Departamento</span> - Nome do departamento</li>
                                <li><span class="font-medium">Salário</span> - Valor em R$ (ex: R$ 2.500,00 ou 2500,00)</li>
                                <li><span class="font-medium">Periculosidade</span> - "Sim" ou "Não"</li>
                                <li><span class="font-medium">Horas Mensais</span> - 220, 180, 170, etc (opcional - padrão 220)</li>
                            </ul>
                            <p class="mt-2 text-xs text-gray-600">
                                <i class="fas fa-download mr-1"></i> 
                                <a href="#" id="downloadTemplate" class="text-blue-600 hover:underline">Baixar modelo de planilha</a>
                            </p>
                        </div>

                        <div class="file-upload-area" id="fileUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4 class="text-lg font-semibold text-gray-700 mb-2">
                                Clique para selecionar ou arraste o arquivo
                            </h4>
                            <p class="text-sm text-gray-500 mb-4">
                                Formatos aceitos: .xlsx, .xls, .csv
                            </p>
                            <input type="file" id="spreadsheetFile" accept=".xlsx,.xls,.csv" class="hidden">
                            <button id="selectFileButton" class="btn-importar mx-auto">
                                <i class="fas fa-file-excel mr-2"></i>
                                Selecionar Arquivo
                            </button>
                        </div>

                        <div id="importPreview" style="display: none;">
                            <h4 class="font-bold text-lg titulo-cor mt-6 mb-3">
                                <i class="fas fa-eye mr-2"></i>
                                Prévia dos Dados
                            </h4>
                            
                            <div id="importStats" class="import-stats"></div>
                            
                            <div class="import-preview-container">
                                <table class="import-preview-table">
                                    <thead id="previewTableHeader"></thead>
                                    <tbody id="previewTableBody"></tbody>
                                </table>
                            </div>

                            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                                <button type="button" id="cancelImport" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                                    Cancelar
                                </button>
                                <button type="button" id="confirmImport" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    Confirmar Importação
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTEÚDO PRINCIPAL (CALCULADORA) -->
            <div class="container" id="calculatorContent">
                <h1 class="text-xl md:text-2xl lg:text-3xl font-bold titulo-cor text-center mb-4 md:mb-6 border-b pb-2">
                    Calculadora de Adicionais e Reflexos da Folha de Pagamento
                    <span id="cloudStatusBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
                </h1>
                
                <!-- Seletor de Colaborador -->
                <div class="mb-4 md:mb-6 p-3 md:p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-base md:text-lg titulo-cor mb-1 md:mb-2">Selecionar Colaborador</h3>
                            <p class="text-xs md:text-sm text-gray-600">Escolha um colaborador cadastrado para preencher os dados automaticamente</p>
                        </div>
                        <button id="refreshCollaborators" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                    </div>
                    <div class="mt-2 md:mt-3">
                        <select id="collaboratorSelect" class="w-full text-sm">
                            <option value="">-- Selecione um colaborador --</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 lg:gap-8">
                    
                    <!-- Coluna de Entradas (Inputs) -->
                    <div id="input-container">
                        <h2 class="text-lg md:text-xl font-semibold mb-3 md:mb-4 titulo-cor">Entradas de Dados</h2>

                        <div class="space-y-3 md:space-y-4 mb-4 md:mb-6 p-3 md:p-4 bg-gray-50 rounded-lg border">
                            <h3 class="font-bold text-base md:text-lg border-b pb-2 titulo-cor">Salário e Divisor</h3>
                            <div class="grid grid-cols-2 gap-3 md:gap-4">
                                <div>
                                    <label for="salarioBase" class="block text-xs md:text-sm font-medium text-gray-700">Salário Base (R$)</label>
                                    <input type="text" id="salarioBase" value="" class="mt-1 text-sm" placeholder="Ex: R$ 1.518,00">
                                </div>
                                <div>
                                    <label for="divisorMensal" class="block text-xs md:text-sm font-medium text-gray-700">Horas Mensais</label>
                                    <select id="divisorMensal" class="mt-1 text-sm">
                                        <option value="220" selected>220 (Padrão)</option>
                                        <option value="180">180 horas</option>
                                        <option value="170">170 (Reduzido)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex items-center mt-3 md:mt-4 pt-2 border-t">
                                <input type="checkbox" id="usaPericulosidade" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                                <label for="usaPericulosidade" class="text-xs md:text-sm font-medium text-gray-700">Incluir Adicional de Periculosidade (30%)</label>
                                 <span id="valorPericulosidadeInputDisplay" class="ml-auto font-bold titulo-cor text-sm">R$ 0,00</span>
                            </div>
                        </div>
                        
                        <div class="space-y-3 md:space-y-4 mb-4 md:mb-6 p-3 md:p-4 bg-gray-50 rounded-lg border">
                            <h3 class="font-bold text-base md:text-lg border-b pb-2 titulo-cor">Horas de Adicionais</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                                <div>
                                    <label for="horasSobreavisoTotal" class="block text-xs md:text-sm font-medium text-gray-700">Horas de Sobreaviso</label>
                                    <input type="text" id="horasSobreavisoTotal" value="00:00" placeholder="HH:MM" class="mt-1 text-center text-sm">
                                </div>
                                <div>
                                    <label for="horasTrabalhadas50" class="block text-xs md:text-sm font-medium text-gray-700">Horas Sobr. Trabalhado</label>
                                    <input type="text" id="horasTrabalhadas50" value="00:00" placeholder="HH:MM" class="mt-1 text-center text-sm">
                                </div>
                                <div>
                                    <label for="horasTrabalhadas100" class="block text-xs md:text-sm font-medium text-gray-700">Horas Extras</label>
                                    <input type="text" id="horasTrabalhadas100" value="00:00" placeholder="HH:MM" class="mt-1 text-center text-sm">
                                </div>
                                 <div>
                                    <label for="horasNoturnas" class="block text-xs md:text-sm font-medium text-gray-700">Horas de Ad. Noturno</label>
                                    <input type="text" id="horasNoturnas" value="00:00" placeholder="HH:MM" class="mt-1 text-center text-sm">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3 md:space-y-4 p-3 md:p-4 bg-gray-50 rounded-lg border">
                            <h3 class="font-bold text-base md:text-lg border-b pb-2 titulo-cor">Fator DSR, Dias e Ausências</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                                 <div>
                                    <label for="mesReferencia" class="block text-xs md:text-sm font-medium text-gray-700">Mês Ref.</label>
                                    <input type="month" id="mesReferencia" class="mt-1 text-sm">
                                </div>
                                <div>
                                    <label for="diasTrabalhados" class="block text-xs md:text-sm font-medium text-gray-700">Dias Normais</label>
                                    <input type="number" id="diasTrabalhados" min="1" max="30" value="30" class="mt-1 text-center text-sm">
                                    <p class="text-xs text-blue-600 font-medium">30 dias</p>
                                </div>
                                 <div>
                                    <label for="diasAtestado" class="block text-xs md:text-sm font-medium text-gray-700">Dias de Atestado</label>
                                    <input type="number" id="diasAtestado" value="0" min="0" class="mt-1 text-center text-sm">
                                </div>
                                <div class="holidays-field-container">
                                    <label for="diasFeriado" class="block text-xs md:text-sm font-medium text-gray-700">Feriados</label>
                                    <input type="number" id="diasFeriado" value="0" min="0" class="mt-1 text-center w-full text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <!-- BLOCO DE INFORMAÇÕES DE PAGAMENTO -->
                        <div class="payment-info mt-4">
                            <h3>
                                <i class="fas fa-credit-card"></i>
                                Informações de Pagamento
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="pagoFolha" class="block text-xs md:text-sm font-medium text-gray-700 mb-1">Pago em Folha?</label>
                                    <div class="flex items-center h-10">
                                        <input type="checkbox" id="pagoFolha" class="h-5 w-5 text-green-600 border-gray-300 rounded mr-2">
                                        <span class="text-xs md:text-sm text-gray-700">Sim, já pago</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="competenciaPagamento" class="block text-xs md:text-sm font-medium text-gray-700 mb-1">Competência de Pagamento</label>
                                    <input type="month" id="competenciaPagamento" class="w-full text-sm">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coluna de Resultados -->
                    <div>
                        <h2 class="text-lg md:text-xl font-semibold mb-3 md:mb-4 titulo-cor">Resultados e Bases</h2>

                        <div class="space-y-3 md:space-y-4 p-3 md:p-4 bg-indigo-50 rounded-lg border border-indigo-200 mb-4 md:mb-6">
                            <h3 class="font-bold text-base md:text-lg border-b pb-2 titulo-cor">Adicionais e Periculosidade</h3>
                            
                            <div id="periculosidadeDetalhada" class="text-xs text-gray-600 mb-2" style="display: none;"></div>
                            
                            <div class="flex justify-between text-sm md:text-base font-semibold">
                                <span>Periculosidade (30%)</span>
                                <span id="valorPericulosidade" class="titulo-cor">R$ 0,00</span>
                            </div>

                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Horas de Sobreaviso (Espera):</span>
                                <span id="valorSobreavisoEspera" class="titulo-cor">R$ 0,00</span>
                            </div>

                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Horas de Sobreaviso Trabalhado (<span id="heSobreavisoPorcentagemDisplay">50</span>%):</span>
                                <span id="valorHoraExtraTrabalho50" class="titulo-cor">R$ 0,00</span>
                            </div>
                            
                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Horas Extras <span id="heNormalPorcentagemDisplay">50</span>%:</span>
                                <span id="valorHoraExtraTrabalho100" class="titulo-cor">R$ 0,00</span>
                            </div>
                            
                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Adicional Noturno (<span id="adicionalNoturnoPorcentagemDisplay">20</span>%):</span>
                                <span id="valorAdicionalNoturno" class="titulo-cor">R$ 0,00</span>
                            </div>
                        </div>

                        <div class="space-y-3 md:space-y-4 p-3 md:p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                            <h3 class="font-bold text-base md:text-lg border-b pb-2 titulo-cor">Reflexos DSR (Fator: <span id="fatorDSRDisplay" class="font-extrabold">0.0000</span>)</h3>
                            
                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Reflexo Sobreaviso DSR (Espera 1/3):</span>
                                <span id="valorReflexoSobreavisoEspera" class="text-indigo-700 font-semibold">R$ 0,00</span>
                            </div>
                            
                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Reflexo Sob. Trabalhado DSR:</span>
                                <span id="valorReflexoSobreavisoTrabalhado" class="text-indigo-700 font-semibold">R$ 0,00</span>
                            </div>
                            
                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Reflexo Horas Extras DSR:</span>
                                <span id="valorReflexoHorasExtrasNormal" class="text-indigo-700 font-semibold">R$ 0,00</span>
                            </div>
                            
                            <div class="flex justify-between text-xs md:text-sm">
                                <span>Reflexo Adic. Noturno DSR:</span>
                                <span id="valorReflexoAdicionalNoturno" class="text-indigo-700 font-semibold">R$ 0,00</span>
                            </div>

                            <div class="flex justify-between text-base md:text-lg font-bold pt-2 border-t border-indigo-300">
                                <span>TOTAL DOS REFLEXOS:</span>
                                <span id="valorReflexoDSRTotalSum" class="titulo-cor">R$ 0,00</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 md:mt-6">
                            <button id="toggleBases" class="toggle-bases-btn w-full text-left p-3 bg-indigo-100 hover:bg-indigo-200 rounded-lg border border-indigo-300 transition duration-150 mb-4">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-bold text-base md:text-lg titulo-cor">Base de cálculo por hora</h3>
                                    <span class="text-indigo-600">
                                        <i class="fas fa-chevron-down" id="basesIcon"></i>
                                    </span>
                                </div>
                            </button>
                            
                            <div id="basesContainer" class="p-3 md:p-4 bg-indigo-50 rounded-lg border border-indigo-200 space-y-3 hidden">
                                <div class="grid grid-cols-2 gap-4 mb-4 pb-4 border-b">
                                    <div>
                                        <label for="diasDomingo" class="block text-xs font-medium text-gray-700 mb-1">Domingos</label>
                                        <input type="number" id="diasDomingo" value="4" min="0" readonly class="mt-1 bg-gray-200 text-center text-sm">
                                    </div>
                                    <div>
                                        <label for="diasUteis" class="block text-xs font-medium text-gray-700 mb-1">Dias Úteis Base</label>
                                        <input type="number" id="diasUteis" value="26" min="1" readonly data-base-value="26" class="mt-1 bg-indigo-100 font-bold text-center text-sm">
                                    </div>
                                </div>
                                
                                <div class="flex justify-between text-xs md:text-sm">
                                    <span>Hora Normal:</span>
                                    <span id="horaNormal" class="font-semibold titulo-cor">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between text-xs md:text-sm">
                                    <span>Hora Sob. (1/3):</span>
                                    <span id="horaSobreaviso" class="font-semibold titulo-cor">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between text-xs md:text-sm">
                                    <span>Base p/ HE (c/ Peric.):</span>
                                    <span id="baseHePeric" class="font-semibold titulo-cor">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between text-xs md:text-sm">
                                    <span>Hora Extra (<span id="heNormalPorcentagemBaseDisplay">50</span>%):</span>
                                    <span id="horaExtra50" class="font-semibold titulo-cor">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BOTÕES DE AÇÃO -->
                <div class="flex flex-wrap justify-end gap-3 md:gap-4 mt-8 md:mt-12 print-hide border-t pt-4 md:pt-6">
                    <button id="saveCalculation" class="bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-2 px-3 md:px-4 rounded-lg text-sm md:text-base transition duration-150">
                        <i class="fas fa-save mr-1"></i> Salvar Cálculo
                        <span id="saveCloudBadge" class="sync-badge ml-2" style="display: none;">Cloud</span>
                    </button>
                    <button id="clearButton" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-3 md:px-4 rounded-lg text-sm md:text-base transition duration-150">
                        <i class="fas fa-eraser mr-1"></i> Limpar
                    </button>
                    <button id="printButton" class="text-sm md:text-base font-semibold py-2 px-3 md:px-4 rounded-lg transition duration-150">
                        <i class="fas fa-print mr-1"></i> Salvar em PDF
                    </button>
                </div>
            </div>

            <!-- CONTEÚDO DE LISTA DE COLABORADORES -->
            <div class="container hidden" id="collaboratorsContent">
                <h1 class="text-xl md:text-2xl lg:text-3xl font-bold titulo-cor text-center mb-4 md:mb-6 border-b pb-2">
                    <i class="fas fa-users mr-2"></i> Gerenciar Colaboradores
                    <span id="cloudCollaboratorBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
                </h1>
                
                <div class="mb-4 md:mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="tabCollaborators" class="tab-button border-b-2 border-blue-500 text-blue-600 py-3 md:py-4 px-1 text-xs md:text-sm font-medium active">
                                <i class="fas fa-users mr-2"></i> Colaboradores
                            </button>
                            <button id="tabDepartments" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-3 md:py-4 px-1 text-xs md:text-sm font-medium">
                                <i class="fas fa-building mr-2"></i> Departamentos
                            </button>
                        </nav>
                    </div>
                </div>
                
                <div id="collaboratorsTabContent">
                    <div class="mb-4 md:mb-6 p-3 md:p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex flex-wrap justify-between items-center gap-3">
                            <div class="flex flex-wrap gap-2">
                                <button id="addNewCollaborator" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 md:px-4 md:py-2 rounded flex items-center text-sm">
                                    <i class="fas fa-user-plus mr-2"></i> Novo
                                </button>
                                <button id="importCollaboratorsBtn" class="btn-importar text-sm px-3 py-1.5 md:px-4 md:py-2">
                                    <i class="fas fa-file-import mr-2"></i> Importar
                                </button>
                            </div>
                            <button id="refreshCollaboratorList" class="text-blue-600 hover:text-blue-800 text-sm px-2 py-1">
                                <i class="fas fa-sync-alt mr-1"></i> Atualizar
                            </button>
                        </div>
                    </div>
                    
                    <div class="status-toggle-buttons print-hide">
                        <button class="status-toggle-btn active text-xs md:text-sm" id="showActiveCollaborators">
                            <i class="fas fa-user-check mr-1"></i> Ativos
                        </button>
                        <button class="status-toggle-btn text-xs md:text-sm" id="showInactiveCollaborators">
                            <i class="fas fa-user-slash mr-1"></i> Inativos
                        </button>
                    </div>
                    
                    <div id="collaboratorsTableContainer"></div>
                </div>
                
                <div id="departmentsTabContent" class="hidden">
                    <div class="mb-4 md:mb-6 p-3 md:p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-base md:text-lg titulo-cor">Gerenciar Departamentos</h3>
                                <p class="text-xs md:text-sm text-gray-600">Adicione, edite ou exclua departamentos</p>
                            </div>
                            <div class="flex gap-2">
                                <button id="refreshDepartments" class="text-blue-600 hover:text-blue-800 text-sm px-2 py-1">
                                    <i class="fas fa-sync-alt mr-1"></i> Atualizar
                                </button>
                                <button id="addNewDepartment" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 md:px-3 md:py-1 rounded text-sm">
                                    <i class="fas fa-plus mr-1"></i> Novo
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="departmentsTableContainer">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-building fa-3x mb-4"></i>
                            <p class="text-base md:text-lg">Nenhum departamento cadastrado ainda.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTEÚDO DE HISTÓRICO DE CÁLCULOS -->
            <div class="container hidden" id="historyContent">
                <h1 class="text-xl md:text-2xl lg:text-3xl font-bold titulo-cor text-center mb-4 md:mb-6 border-b pb-2">
                    <i class="fas fa-history mr-2"></i> Histórico de Cálculos
                    <span id="cloudHistoryBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
                </h1>
                
                <div class="mb-4 md:mb-6 p-3 md:p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3">
                        <div>
                            <h3 class="font-bold text-base md:text-lg titulo-cor">Histórico de Cálculos</h3>
                            <p class="text-xs md:text-sm text-gray-600">Visualize todos os cálculos salvos</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="refreshHistory" class="text-blue-600 hover:text-blue-800 text-sm px-2 py-1">
                                <i class="fas fa-sync-alt mr-1"></i> Atualizar
                            </button>
                            <button id="clearHistoryFilters" class="bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm px-2 py-1 rounded">
                                <i class="fas fa-filter-circle-xmark mr-1"></i> Limpar Filtros
                            </button>
                        </div>
                    </div>
                    
                    <div id="historyFilters" class="mt-3 md:mt-4 p-3 bg-white rounded border">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Colaborador</label>
                                <select id="filterCollaborator" class="w-full text-sm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Departamento</label>
                                <select id="filterDepartment" class="w-full text-sm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Período Início</label>
                                <input type="month" id="filterStartMonth" class="w-full text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Período Fim</label>
                                <input type="month" id="filterEndMonth" class="w-full text-sm">
                            </div>
                        </div>
                        <div class="flex justify-end mt-3">
                            <button id="applyFilters" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1.5 rounded">
                                Aplicar Filtros
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="history-table text-sm">
                        <thead>
                            <tr>
                                <th class="text-xs md:text-sm">Mês Ref.</th>
                                <th class="text-xs md:text-sm">Colaborador</th>
                                <th class="text-xs md:text-sm">Departamento</th>
                                <th class="text-xs md:text-sm">Data Cálculo</th>
                                <th class="text-xs md:text-sm">Responsável</th>
                                <th class="text-xs md:text-sm">Pago</th>
                                <th class="text-xs md:text-sm">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ABA DE RELATÓRIOS -->
            <div class="container hidden" id="reportsContent">
                <h1 class="text-xl md:text-2xl lg:text-3xl font-bold titulo-cor text-center mb-4 md:mb-6 border-b pb-2">
                    <i class="fas fa-chart-bar mr-2"></i> Relatórios de Cálculos
                    <span id="cloudReportsBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
                </h1>
                
                <div class="mb-4 md:mb-6 p-3 md:p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h3 class="font-bold text-base md:text-lg titulo-cor">Relatórios Personalizados</h3>
                            <p class="text-xs md:text-sm text-gray-600">Gere relatórios com filtros específicos</p>
                        </div>
                        <button id="refreshReports" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-sync-alt mr-1"></i> Atualizar
                        </button>
                    </div>
                    
                    <div class="p-3 bg-white rounded border">
                        <div class="mb-3 p-2 bg-gray-50 rounded border">
                            <h5 class="font-medium text-xs mb-2">Colunas do Relatório</h5>
                            <div class="flex flex-wrap gap-1">
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="colaborador">Colaborador</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="departamento">Depto</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="salario">Salário</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="periculosidade">Peric</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="sobreaviso">Sob.</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="sobreaviso_trabalhado">Sob.Trab</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="horas_extras">HE</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="adicional_noturno">Not.</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="reflexos">Reflexos</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="total">Total</button>
                                <button class="column-toggle-btn active text-xs px-2 py-1" data-column="responsavel">Responsável</button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Colaborador</label>
                                <select id="reportCollaborator" class="w-full text-sm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Departamento</label>
                                <select id="reportDepartment" class="w-full text-sm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Mês Referência</label>
                                <input type="month" id="reportMonth" class="w-full text-sm">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Data Início</label>
                                <input type="date" id="reportStartDate" class="w-full text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Data Fim</label>
                                <input type="date" id="reportEndDate" class="w-full text-sm">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-1 gap-3 mb-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Responsável</label>
                                <select id="reportResponsavel" class="w-full text-sm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-between">
                            <button id="clearReportFilters" class="bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm px-3 py-1.5 rounded">
                                <i class="fas fa-filter-circle-xmark mr-1"></i> Limpar
                            </button>
                            <button id="generateReport" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1.5 rounded">
                                <i class="fas fa-filter mr-1"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 md:mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-base md:text-lg titulo-cor">Relatório Detalhado</h3>
                        <div class="flex gap-2">
                            <button id="exportReportCSV" class="bg-green-100 hover:bg-green-200 text-green-800 text-xs md:text-sm px-2 py-1 rounded">
                                <i class="fas fa-file-csv mr-1"></i> CSV
                            </button>
                            <button id="exportReportPDF" class="bg-red-100 hover:bg-red-200 text-red-800 text-xs md:text-sm px-2 py-1 rounded">
                                <i class="fas fa-file-pdf mr-1"></i> PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="report-table text-xs md:text-sm" id="reportTable">
                            <thead id="reportTableHeader"></thead>
                            <tbody id="reportTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAIS -->
    <div class="modal" id="collaboratorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="collaboratorModalTitle">Cadastrar Novo Colaborador</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="collaboratorForm">
                    <input type="hidden" id="collaboratorEditId">
                    <div class="space-y-4">
                        <div>
                            <label for="collaboratorName" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo *</label>
                            <input type="text" id="collaboratorName" required class="w-full" placeholder="Ex: João da Silva">
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label for="collaboratorDepartment" class="block text-sm font-medium text-gray-700">Departamento *</label>
                                <button type="button" id="addDepartmentFromCollaborator" class="text-blue-600 hover:text-blue-800 text-xs">
                                    <i class="fas fa-plus mr-1"></i> Novo Departamento
                                </button>
                            </div>
                            <select id="collaboratorDepartment" required class="w-full">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div>
                            <label for="collaboratorBaseSalary" class="block text-sm font-medium text-gray-700 mb-1">Salário Base (R$) *</label>
                            <input type="text" id="collaboratorBaseSalary" required class="w-full" placeholder="Ex: R$ 2.500,00">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="collaboratorDivisor" class="block text-sm font-medium text-gray-700 mb-1">Horas Mensais *</label>
                                <select id="collaboratorDivisor" required class="w-full">
                                    <option value="220" selected>220 horas (Padrão)</option>
                                    <option value="180">180 horas</option>
                                    <option value="170">170 horas</option>
                                    <option value="200">200 horas</option>
                                </select>
                            </div>
                            <div>
                                <label for="collaboratorWorkHours" class="block text-sm font-medium text-gray-700 mb-1">Jornada Diária</label>
                                <select id="collaboratorWorkHours" class="w-full">
                                    <option value="8">8 horas</option>
                                    <option value="6">6 horas</option>
                                    <option value="4">4 horas</option>
                                    <option value="12">12x36</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="collaboratorPericulosidade" class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                                <label for="collaboratorPericulosidade" class="text-sm font-medium text-gray-700">Periculosidade?</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="collaboratorInsalubridade" class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                                <label for="collaboratorInsalubridade" class="text-sm font-medium text-gray-700">Insalubridade?</label>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4 mt-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status do Colaborador *</label>
                            <div class="status-radio-group">
                                <div class="status-radio-option">
                                    <input type="radio" id="collaboratorStatusActive" name="collaboratorStatus" value="active" checked>
                                    <label for="collaboratorStatusActive" class="text-sm text-gray-700 flex items-center">
                                        <span class="status-badge active mr-2 px-3 py-1">Ativo</span>
                                    </label>
                                </div>
                                <div class="status-radio-option">
                                    <input type="radio" id="collaboratorStatusInactive" name="collaboratorStatus" value="inactive">
                                    <label for="collaboratorStatusInactive" class="text-sm text-gray-700 flex items-center">
                                        <span class="status-badge inactive mr-2 px-3 py-1">Inativo</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                        <button type="button" id="cancelCollaborator" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <span id="collaboratorModalButton">Salvar Colaborador</span>
                            <span id="syncBadge" class="sync-badge ml-2" style="display: none;">Cloud</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="departmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="departmentModalTitle">Cadastrar Novo Departamento</h3>
                <button class="modal-close" id="closeDepartmentModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="departmentForm">
                    <div class="space-y-4">
                        <div>
                            <label for="departmentName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Departamento *</label>
                            <input type="text" id="departmentName" required class="w-full" placeholder="Ex: Produção">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="departmentActive" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                            <label for="departmentActive" class="text-sm font-medium text-gray-700">Departamento Ativo</label>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                        <button type="button" id="cancelDepartment" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <span id="departmentModalButton">Salvar Departamento</span>
                            <span id="syncBadgeDept" class="sync-badge ml-2" style="display: none;">Cloud</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="calculationDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="calculationDetailTitle">Detalhes do Cálculo</h3>
                <button class="modal-close" id="closeCalculationDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="calculationDetailContent" class="view-mode"></div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t" id="detailButtonsContainer">
                    <button type="button" id="closeCalculationDetail" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">Fechar</button>
                    <button type="button" id="editCalculationBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        <i class="fas fa-edit mr-1"></i> Editar
                    </button>
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t hidden" id="editButtonsContainer">
                    <button type="button" id="cancelEditBtn" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">Cancelar</button>
                    <button type="button" id="saveEditBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                        <i class="fas fa-save mr-1"></i> Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteCollaboratorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                    Confirmar Exclusão
                </h3>
                <button class="modal-close" id="closeDeleteModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4">
                    <i class="fas fa-user-slash text-red-600 text-5xl mb-4"></i>
                    <h4 class="text-xl font-bold text-gray-800 mb-2" id="deleteCollaboratorName"></h4>
                    <p class="text-gray-600 mb-6">Tem certeza que deseja excluir permanentemente este colaborador?</p>
                    <div class="flex justify-center gap-4">
                        <button id="cancelDeleteCollaborator" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button id="confirmDeleteCollaborator" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                            <i class="fas fa-trash mr-2"></i>Excluir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                    Confirmar Exclusão de Usuário
                </h3>
                <button class="modal-close" id="closeDeleteUserModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4">
                    <i class="fas fa-user-minus text-red-600 text-5xl mb-4"></i>
                    <h4 class="text-xl font-bold text-gray-800 mb-2" id="deleteUserName"></h4>
                    <p class="text-gray-600 mb-6">Tem certeza que deseja excluir este usuário da equipe?</p>
                    <div class="flex justify-center gap-4">
                        <button id="cancelDeleteUser" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button id="confirmDeleteUser" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                            <i class="fas fa-trash mr-2"></i>Excluir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURAÇÃO DO FIREBASE
        // ============================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyBLgg6ICkkRMQimDU81tls9dxiNu-ubL1s",
            authDomain: "folha-pagamento-app.firebaseapp.com",
            projectId: "folha-pagamento-app",
            storageBucket: "folha-pagamento-app.firebasestorage.app",
            messagingSenderId: "482792411975",
            appId: "1:482792411975:web:c884c56ce5a38313d33262"
        };

        // Inicialização do Firebase
        let db, auth;
        let firebaseAvailable = false;
        
        try {
            if (typeof firebase !== 'undefined') {
                if (!firebase.apps || firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("✅ Firebase inicializado com sucesso!");
                }
                
                auth = firebase.auth();
                
                try {
                    db = firebase.firestore();
                    
                    try {
                        db.settings({
                            ignoreUndefinedProperties: true,
                            merge: true
                        });
                        console.log("✅ Firestore configurado");
                    } catch (settingsError) {
                        console.warn("⚠️ Erro ao configurar Firestore:", settingsError);
                    }
                    
                    firebaseAvailable = true;
                    
                } catch (firestoreError) {
                    console.error("❌ Erro ao inicializar Firestore:", firestoreError);
                    firebaseAvailable = false;
                    db = null;
                }
                
            } else {
                console.error("❌ Firebase SDK não carregado!");
            }
        } catch (error) {
            console.error("❌ Erro crítico ao inicializar Firebase:", error);
            firebaseAvailable = false;
        }

        // ============================================
        // VARIÁVEIS GLOBAIS
        // ============================================
        
        let currentUser = null;
        let currentUserName = null;
        let isOnline = false;
        let userData = null;
        let currentCalculationDetailId = null;
        let importData = null;
        let currentCollaboratorStatus = 'active';
        
        // Configurações de porcentagens
        let heNormalPorcentagem = 50;
        let heSobreavisoPorcentagem = 50;
        let adicionalNoturnoPorcentagem = 20;
        
        // Variáveis para relatórios
        let activeReportFilters = {};
        let visibleColumns = {
            colaborador: true,
            departamento: true,
            salario: true,
            periculosidade: true,
            sobreaviso: true,
            sobreaviso_trabalhado: true,
            horas_extras: true,
            adicional_noturno: true,
            reflexos: true,
            total: true,
            responsavel: true
        };

        // Listeners em tempo real
        let unsubscribeData = null;

        // ============================================
        // CHAVES DE ARMAZENAMENTO
        // ============================================
        
        const COLLABORATORS_STORAGE_KEY = 'folha_colaboradores_cadastrados';
        const CALCULATIONS_STORAGE_KEY = 'folha_calculos_salvos';
        const DEPARTMENTS_STORAGE_KEY = 'folha_departamentos';
        const SETTINGS_STORAGE_KEY = 'folha_configuracoes';
        const TEAM_USERS_KEY = 'folha_usuarios_equipe';
        
        // Usuários padrão da equipe
        const DEFAULT_TEAM_USERS = [
            { id: 1, name: 'Márcia' },
            { id: 2, name: 'Ana' },
            { id: 3, name: 'João' },
            { id: 4, name: 'Maria' }
        ];

        // ============================================
        // FORMATAÇÃO DE MOEDA
        // ============================================
        
        const R$ = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

        // ============================================
        // FUNÇÕES DE CONFIGURAÇÕES
        // ============================================
        
        function loadSettings() {
            const savedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
            
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    heNormalPorcentagem = settings.heNormalPorcentagem || 50;
                    heSobreavisoPorcentagem = settings.heSobreavisoPorcentagem || 50;
                    adicionalNoturnoPorcentagem = settings.adicionalNoturnoPorcentagem || 20;
                } catch (e) {
                    console.error("Erro ao carregar configurações:", e);
                }
            }
            
            const heNormalInput = document.getElementById('heNormalPorcentagem');
            const heSobreavisoInput = document.getElementById('heSobreavisoPorcentagem');
            const adicionalNoturnoInput = document.getElementById('adicionalNoturnoPorcentagem');
            
            if (heNormalInput) heNormalInput.value = heNormalPorcentagem;
            if (heSobreavisoInput) heSobreavisoInput.value = heSobreavisoPorcentagem;
            if (adicionalNoturnoInput) adicionalNoturnoInput.value = adicionalNoturnoPorcentagem;
            
            updatePercentageDisplays();
        }
        
        function saveSettings() {
            const heNormalInput = document.getElementById('heNormalPorcentagem');
            const heSobreavisoInput = document.getElementById('heSobreavisoPorcentagem');
            const adicionalNoturnoInput = document.getElementById('adicionalNoturnoPorcentagem');
            
            heNormalPorcentagem = parseInt(heNormalInput.value) || 50;
            heSobreavisoPorcentagem = parseInt(heSobreavisoInput.value) || 50;
            adicionalNoturnoPorcentagem = parseInt(adicionalNoturnoInput.value) || 20;
            
            const settings = {
                heNormalPorcentagem,
                heSobreavisoPorcentagem,
                adicionalNoturnoPorcentagem,
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
            
            updatePercentageDisplays();
            calcular();
            
            alert('Configurações salvas com sucesso!');
            closeSettingsModal();
        }
        
        function updatePercentageDisplays() {
            const displays = [
                'heNormalPorcentagemDisplay',
                'heSobreavisoPorcentagemDisplay',
                'adicionalNoturnoPorcentagemDisplay',
                'heNormalPorcentagemReflexoDisplay',
                'heSobreavisoPorcentagemReflexoDisplay',
                'adicionalNoturnoPorcentagemReflexoDisplay',
                'heNormalPorcentagemBaseDisplay'
            ];
            
            displays.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (id.includes('Normal')) {
                        element.textContent = heNormalPorcentagem;
                    } else if (id.includes('Sobreaviso')) {
                        element.textContent = heSobreavisoPorcentagem;
                    } else if (id.includes('Noturno')) {
                        element.textContent = adicionalNoturnoPorcentagem;
                    }
                }
            });
        }
        
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // ============================================
        // FUNÇÕES DE GERENCIAMENTO DE USUÁRIOS DA EQUIPE
        // ============================================
        
        function getTeamUsers() {
            const saved = localStorage.getItem(TEAM_USERS_KEY);
            if (saved) {
                return JSON.parse(saved);
            }
            // Inicializar com usuários padrão
            localStorage.setItem(TEAM_USERS_KEY, JSON.stringify(DEFAULT_TEAM_USERS));
            return DEFAULT_TEAM_USERS;
        }
        
        function saveTeamUsers(users) {
            localStorage.setItem(TEAM_USERS_KEY, JSON.stringify(users));
            
            // Sincronizar com Firebase se disponível
            if (currentUser && db && firebaseAvailable) {
                db.collection('team_config').doc('users').set({
                    users: users,
                    updatedAt: new Date().toISOString()
                }).catch(error => {
                    console.warn("⚠️ Erro ao sincronizar usuários:", error);
                });
            }
        }
        
        function renderUsersList() {
            const users = getTeamUsers();
            const container = document.getElementById('usersList');
            
            if (users.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum usuário cadastrado.</p>';
                return;
            }
            
            let html = '';
            users.forEach(user => {
                html += `
                    <div class="user-item">
                        <div class="user-info">
                            <i class="fas fa-user-circle text-blue-600"></i>
                            <span class="user-name">${user.name}</span>
                        </div>
                        <div class="user-actions">
                            <button class="edit-user-btn" onclick="editUserName(${user.id}, '${user.name}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-user-btn" onclick="deleteUser(${user.id}, '${user.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Atualizar seletor de usuários
            updateUserSelector();
            updateResponsavelFilter();
        }
        
        function updateUserSelector() {
            const users = getTeamUsers();
            const selector = document.getElementById('userSelector');
            
            selector.innerHTML = '<option value="">-- Selecione seu nome --</option>';
            
            users.sort((a, b) => a.name.localeCompare(b.name, 'pt-BR')).forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                selector.appendChild(option);
            });
        }
        
        function updateResponsavelFilter() {
            const users = getTeamUsers();
            const filter = document.getElementById('reportResponsavel');
            
            if (filter) {
                filter.innerHTML = '<option value="">Todos os responsáveis</option>';
                
                users.sort((a, b) => a.name.localeCompare(b.name, 'pt-BR')).forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.name;
                    option.textContent = user.name;
                    filter.appendChild(option);
                });
            }
        }
        
        function addUser() {
            const nameInput = document.getElementById('newUserName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Digite um nome para o usuário.');
                return;
            }
            
            const users = getTeamUsers();
            
            // Verificar se já existe
            if (users.some(u => u.name.toLowerCase() === name.toLowerCase())) {
                alert(`Já existe um usuário com o nome "${name}".`);
                return;
            }
            
            const newUser = {
                id: Date.now(),
                name: name
            };
            
            users.push(newUser);
            saveTeamUsers(users);
            
            renderUsersList();
            nameInput.value = '';
            
            alert(`Usuário "${name}" adicionado com sucesso!`);
        }
        
        function editUserName(id, currentName) {
            const newName = prompt('Editar nome do usuário:', currentName);
            
            if (!newName || newName.trim() === '') return;
            
            const users = getTeamUsers();
            const userIndex = users.findIndex(u => u.id === id);
            
            if (userIndex === -1) return;
            
            // Verificar se nome já existe
            if (users.some(u => u.name.toLowerCase() === newName.trim().toLowerCase() && u.id !== id)) {
                alert(`Já existe um usuário com o nome "${newName}".`);
                return;
            }
            
            users[userIndex].name = newName.trim();
            saveTeamUsers(users);
            
            renderUsersList();
            
            // Se o usuário atual foi renomeado, atualizar
            if (currentUserName === currentName) {
                setCurrentUser(id, newName.trim());
            }
        }
        
        function deleteUser(id, name) {
            if (id === 1) {
                alert('Não é possível excluir o usuário Márcia (usuário padrão).');
                return;
            }
            
            document.getElementById('deleteUserName').textContent = name;
            document.getElementById('deleteUserModal').dataset.id = id;
            document.getElementById('deleteUserModal').dataset.name = name;
            document.getElementById('deleteUserModal').classList.add('active');
        }
        
        function confirmDeleteUser() {
            const id = parseInt(document.getElementById('deleteUserModal').dataset.id);
            const name = document.getElementById('deleteUserModal').dataset.name;
            
            const users = getTeamUsers();
            const filteredUsers = users.filter(u => u.id !== id);
            
            saveTeamUsers(filteredUsers);
            
            closeDeleteUserModal();
            renderUsersList();
            
            // Se o usuário atual foi excluído, limpar seleção
            if (currentUserName === name) {
                currentUserName = null;
                localStorage.removeItem('current_team_user');
                updateUserInterface();
            }
            
            alert(`Usuário "${name}" excluído com sucesso!`);
        }
        
        function setCurrentUser(userId, userName) {
            currentUserName = userName;
            localStorage.setItem('current_team_user', JSON.stringify({ id: userId, name: userName }));
            
            // Atualizar interface
            document.getElementById('currentUserName').textContent = userName;
            document.getElementById('currentUserBadge').style.display = 'inline-flex';
            
            // Esconder seletor
            document.getElementById('userSelectorContainer').style.display = 'none';
            
            // Atualizar seleção no seletor
            const selector = document.getElementById('userSelector');
            selector.value = userId;
        }
        
        function clearCurrentUser() {
            currentUserName = null;
            localStorage.removeItem('current_team_user');
            
            document.getElementById('currentUserBadge').style.display = 'none';
            
            // Mostrar seletor novamente
            document.getElementById('userSelectorContainer').style.display = 'flex';
        }
        
        function updateUserInterface() {
            const savedUser = localStorage.getItem('current_team_user');
            
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    currentUserName = user.name;
                    
                    document.getElementById('currentUserName').textContent = user.name;
                    document.getElementById('currentUserBadge').style.display = 'inline-flex';
                    document.getElementById('userSelectorContainer').style.display = 'none';
                    
                    // Atualizar seleção no seletor
                    const selector = document.getElementById('userSelector');
                    selector.value = user.id;
                } catch (e) {
                    clearCurrentUser();
                }
            } else {
                document.getElementById('currentUserBadge').style.display = 'none';
                
                // Mostrar seletor apenas se estiver logado
                if (currentUser) {
                    document.getElementById('userSelectorContainer').style.display = 'flex';
                }
            }
        }

        // ============================================
        // FUNÇÕES DE AUTENTICAÇÃO FIREBASE
        // ============================================
        
        if (auth) {
            auth.onAuthStateChanged(async (user) => {
                updateAuthUI(user);
                
                if (user) {
                    currentUser = user;
                    isOnline = true;
                    
                    console.log("👤 Login efetuado com conta:", user.email);
                    document.getElementById('userEmailSide').textContent = user.email;
                    document.getElementById('btnLogout').style.display = 'flex';
                    
                    // Carregar dados do Firestore
                    await loadSharedData();
                    
                    // Configurar listener em tempo real
                    setupRealtimeListener();
                    
                    // Atualizar interface do usuário
                    updateUserInterface();
                    
                } else {
                    console.log("👤 Desconectado");
                    currentUser = null;
                    isOnline = false;
                    userData = null;
                    document.getElementById('userEmailSide').textContent = '';
                    document.getElementById('btnLogout').style.display = 'none';
                    
                    if (unsubscribeData) unsubscribeData();
                    
                    // Mostrar modal de login
                    document.getElementById('loginModal').classList.add('active');
                }
            });
        }

        function updateAuthUI(user) {
            const statusElement = document.getElementById('firebaseStatus');
            
            if (user) {
                if (firebaseAvailable) {
                    statusElement.className = 'firebase-status firebase-connected';
                    statusElement.innerHTML = '<i class="fas fa-cloud"></i> <span>Sincronizado com a nuvem</span>';
                } else {
                    statusElement.className = 'firebase-status firebase-disconnected';
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>Modo offline</span>';
                }
            } else {
                statusElement.className = 'firebase-status firebase-disconnected';
                statusElement.innerHTML = '<i class="fas fa-laptop"></i> <span>Aguardando login</span>';
                document.getElementById('loginModal').classList.add('active');
            }
        }

        // ============================================
        // FUNÇÕES DE SINCRONIZAÇÃO
        // ============================================
        
        function setupRealtimeListener() {
            if (!currentUser || !db || !firebaseAvailable) return;
            
            console.log("🔄 Configurando listener em tempo real...");
            
            unsubscribeData = db.collection('team_data').doc('shared')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        console.log("📦 Dados compartilhados atualizados");
                        
                        if (data.departments) {
                            localStorage.setItem(DEPARTMENTS_STORAGE_KEY, JSON.stringify(data.departments));
                            updateDepartmentSelect();
                            renderDepartmentsTable();
                        }
                        
                        if (data.collaborators) {
                            localStorage.setItem(COLLABORATORS_STORAGE_KEY, JSON.stringify(data.collaborators));
                            updateCollaboratorSelect();
                            updateCollaboratorFilterSelect();
                            renderCollaboratorsTable(currentCollaboratorStatus);
                        }
                        
                        if (data.calculations) {
                            localStorage.setItem(CALCULATIONS_STORAGE_KEY, JSON.stringify(data.calculations));
                            if (!document.getElementById('historyContent').classList.contains('hidden')) {
                                renderHistoryTable();
                            }
                        }
                        
                        if (data.teamUsers) {
                            localStorage.setItem(TEAM_USERS_KEY, JSON.stringify(data.teamUsers));
                            renderUsersList();
                        }
                        
                        showSyncNotification('Dados sincronizados');
                    }
                }, (error) => {
                    console.error("Erro no listener:", error);
                });
        }
        
        function showSyncNotification(message) {
            let notification = document.getElementById('syncNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'syncNotification';
                notification.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background-color: #10B981;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 12px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    z-index: 10000;
                    display: none;
                    align-items: center;
                    gap: 8px;
                `;
                notification.innerHTML = '<i class="fas fa-check-circle"></i><span></span>';
                document.body.appendChild(notification);
            }
            
            const span = notification.querySelector('span');
            span.textContent = message;
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        async function loadSharedData() {
            if (!currentUser || !db || !firebaseAvailable) return;
            
            try {
                const docRef = db.collection('team_data').doc('shared');
                const docSnap = await docRef.get();
                
                if (docSnap.exists) {
                    const data = docSnap.data();
                    console.log("✅ Dados compartilhados carregados do Firestore");
                    
                    if (data.departments) {
                        localStorage.setItem(DEPARTMENTS_STORAGE_KEY, JSON.stringify(data.departments));
                    }
                    if (data.collaborators) {
                        localStorage.setItem(COLLABORATORS_STORAGE_KEY, JSON.stringify(data.collaborators));
                    }
                    if (data.calculations) {
                        localStorage.setItem(CALCULATIONS_STORAGE_KEY, JSON.stringify(data.calculations));
                    }
                    if (data.teamUsers) {
                        localStorage.setItem(TEAM_USERS_KEY, JSON.stringify(data.teamUsers));
                    }
                } else {
                    // Inicializar com dados locais
                    await syncAllToFirebase();
                }
                
                // Atualizar interface
                updateDepartmentSelect();
                renderDepartmentsTable();
                updateCollaboratorSelect();
                updateCollaboratorFilterSelect();
                renderCollaboratorsTable(currentCollaboratorStatus);
                renderUsersList();
                
            } catch (error) {
                console.error("❌ Erro ao carregar dados compartilhados:", error);
            }
        }

        async function syncAllToFirebase() {
            if (!currentUser || !db || !firebaseAvailable) return;
            
            const departments = getDepartments();
            const collaborators = getCollaborators();
            const calculations = getSavedCalculations();
            const teamUsers = getTeamUsers();
            
            const data = {
                departments: departments,
                collaborators: collaborators,
                calculations: calculations,
                teamUsers: teamUsers,
                updatedAt: new Date().toISOString()
            };
            
            try {
                await db.collection('team_data').doc('shared').set(data, { merge: true });
                console.log("✅ Dados sincronizados com Firebase");
            } catch (error) {
                console.error("❌ Erro ao sincronizar dados:", error);
            }
        }

        async function syncDataToFirebase(field, data) {
            if (!currentUser || !db || !firebaseAvailable) return;
            
            try {
                await db.collection('team_data').doc('shared').update({
                    [field]: data,
                    updatedAt: new Date().toISOString()
                });
                console.log(`✅ ${field} sincronizado`);
            } catch (error) {
                console.error(`❌ Erro ao sincronizar ${field}:`, error);
            }
        }

        // ============================================
        // FUNÇÕES DE ARMAZENAMENTO
        // ============================================
        
        function getDepartments() {
            const savedData = localStorage.getItem(DEPARTMENTS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        function getCollaborators() {
            const savedData = localStorage.getItem(COLLABORATORS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        function getSavedCalculations() {
            const savedData = localStorage.getItem(CALCULATIONS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        async function saveDepartments(departments) {
            localStorage.setItem(DEPARTMENTS_STORAGE_KEY, JSON.stringify(departments));
            await syncDataToFirebase('departments', departments);
        }
        
        async function saveCollaborators(collaborators) {
            localStorage.setItem(COLLABORATORS_STORAGE_KEY, JSON.stringify(collaborators));
            await syncDataToFirebase('collaborators', collaborators);
        }
        
        async function saveCalculations(calculations) {
            localStorage.setItem(CALCULATIONS_STORAGE_KEY, JSON.stringify(calculations));
            await syncDataToFirebase('calculations', calculations);
        }

        // ============================================
        // FUNÇÕES DE LOGIN
        // ============================================
        
        document.getElementById('btnLogin').addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');
            const errorText = document.getElementById('errorText');
            
            if (!email || !password) {
                errorText.textContent = 'Por favor, preencha email e senha.';
                errorElement.classList.add('show');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                errorElement.classList.remove('show');
                
            } catch (error) {
                console.error('❌ Erro no login:', error);
                errorText.textContent = getFirebaseErrorMessage(error.code);
                errorElement.classList.add('show');
            }
        });

        document.getElementById('btnLogout').addEventListener('click', () => {
            auth.signOut();
            clearCurrentUser();
        });

        document.getElementById('forgotPasswordBtn').addEventListener('click', () => {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('forgotPasswordModal').classList.add('active');
        });

        document.getElementById('btnBackToLogin').addEventListener('click', () => {
            document.getElementById('forgotPasswordModal').classList.remove('active');
            document.getElementById('loginModal').classList.add('active');
        });

        document.getElementById('btnSendResetLink').addEventListener('click', async () => {
            const email = document.getElementById('forgotEmail').value;
            const errorElement = document.getElementById('forgotPasswordError');
            const errorText = document.getElementById('forgotErrorText');
            
            if (!email) {
                errorText.textContent = 'Digite o email.';
                errorElement.classList.add('show');
                return;
            }
            
            try {
                await auth.sendPasswordResetEmail(email);
                errorElement.classList.remove('show');
                document.getElementById('forgotPasswordSuccessModal').style.display = 'flex';
                
                setTimeout(() => {
                    document.getElementById('forgotPasswordModal').classList.remove('active');
                    document.getElementById('loginModal').classList.add('active');
                }, 3000);
                
            } catch (error) {
                errorText.textContent = getFirebaseErrorMessage(error.code);
                errorElement.classList.add('show');
            }
        });

        document.getElementById('setCurrentUserBtn').addEventListener('click', () => {
            const selector = document.getElementById('userSelector');
            const userId = parseInt(selector.value);
            
            if (!userId) {
                alert('Selecione seu nome na lista.');
                return;
            }
            
            const users = getTeamUsers();
            const user = users.find(u => u.id === userId);
            
            if (user) {
                setCurrentUser(user.id, user.name);
            }
        });

        function getFirebaseErrorMessage(errorCode) {
            const messages = {
                'auth/user-not-found': 'Usuário não encontrado.',
                'auth/wrong-password': 'Senha incorreta.',
                'auth/invalid-email': 'Email inválido.',
                'auth/network-request-failed': 'Erro de conexão.'
            };
            return messages[errorCode] || 'Erro ao fazer login.';
        }

        // ============================================
        // FUNÇÕES DE IMPORTAÇÃO DE PLANILHA
        // ============================================
        
        function openImportModal() {
            document.getElementById('importSpreadsheetModal').classList.add('active');
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('spreadsheetFile').value = '';
            importData = null;
        }
        
        function closeImportModal() {
            document.getElementById('importSpreadsheetModal').classList.remove('active');
        }
        
        function parseCurrencyBR(value) {
            if (typeof value !== 'string') value = String(value);
            let cleanValue = value.replace(/R\$\s*/g, '').replace(/\./g, '').replace(/,/g, '.').trim();
            if (cleanValue.startsWith('.')) cleanValue = '0' + cleanValue;
            return parseFloat(cleanValue) || 0;
        }
        
        function formatCurrencyForStorage(value) {
            return value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        function parseBoolean(value) {
            if (typeof value === 'string') {
                return value.toLowerCase().trim() === 'sim';
            }
            return Boolean(value);
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheet];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    processSpreadsheetData(jsonData);
                } catch (error) {
                    showImportMessage('error', 'Erro ao processar o arquivo.');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processSpreadsheetData(rows) {
            if (rows.length < 2) {
                showImportMessage('error', 'Planilha vazia.');
                return;
            }
            
            const headers = rows[0].map(h => String(h || '').toLowerCase().trim());
            
            const nameIndex = headers.findIndex(h => h.includes('nome'));
            const deptIndex = headers.findIndex(h => h.includes('departamento') || h.includes('depto'));
            const salaryIndex = headers.findIndex(h => h.includes('salario') || h.includes('salário'));
            const pericIndex = headers.findIndex(h => h.includes('periculosidade') || h.includes('peric'));
            const hoursIndex = headers.findIndex(h => h.includes('horas') || h.includes('divisor'));
            
            if (nameIndex === -1 || deptIndex === -1 || salaryIndex === -1) {
                showImportMessage('error', 'Colunas obrigatórias: Nome, Departamento e Salário.');
                return;
            }
            
            const importedData = [];
            const errors = [];
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length === 0) continue;
                
                const name = row[nameIndex]?.toString().trim();
                if (!name) continue;
                
                const department = row[deptIndex]?.toString().trim() || 'Não especificado';
                const salaryRaw = row[salaryIndex];
                const periculosidadeRaw = pericIndex !== -1 ? row[pericIndex] : 'Não';
                const hoursRaw = hoursIndex !== -1 ? row[hoursIndex] : '220';
                
                const salaryValue = parseCurrencyBR(salaryRaw);
                if (salaryValue <= 0) {
                    errors.push(`Linha ${i + 1}: Salário inválido`);
                    continue;
                }
                
                const salaryFormatted = formatCurrencyForStorage(salaryValue);
                const hasPericulosidade = pericIndex !== -1 ? parseBoolean(periculosidadeRaw) : false;
                
                let divisor = 220;
                if (hoursIndex !== -1) {
                    const parsedHours = parseInt(String(hoursRaw).replace(/[^\d]/g, ''), 10);
                    if (!isNaN(parsedHours) && parsedHours > 0) divisor = parsedHours;
                }
                
                importedData.push({
                    name: name,
                    department: department,
                    baseSalary: salaryFormatted,
                    baseSalaryValue: salaryValue,
                    divisor: divisor,
                    periculosidade: hasPericulosidade,
                    insalubridade: false,
                    workHours: '8',
                    active: true,
                    imported: true
                });
            }
            
            if (importedData.length === 0) {
                showImportMessage('error', 'Nenhum colaborador válido.');
                return;
            }
            
            importData = importedData;
            showImportPreview(importedData, importedData.length, errors);
        }
        
        function showImportMessage(type, text) {
            const messagesDiv = document.getElementById('importMessages');
            const className = type === 'error' ? 'warning-message' : 'success-message';
            const icon = type === 'error' ? 'exclamation-triangle' : 'check-circle';
            
            messagesDiv.innerHTML = `
                <div class="${className}">
                    <i class="fas fa-${icon}"></i>
                    <span>${text}</span>
                </div>
            `;
        }
        
        function showImportPreview(data, successCount, errors) {
            const previewDiv = document.getElementById('importPreview');
            const statsDiv = document.getElementById('importStats');
            const tableHeader = document.getElementById('previewTableHeader');
            const tableBody = document.getElementById('previewTableBody');
            
            statsDiv.innerHTML = `
                <div class="stat-card"><div class="stat-number">${successCount}</div><div class="stat-label">Válidos</div></div>
                <div class="stat-card"><div class="stat-number">R$ ${data.reduce((sum, item) => sum + item.baseSalaryValue, 0).toFixed(2).replace('.', ',')}</div><div class="stat-label">Total</div></div>
                <div class="stat-card"><div class="stat-number">${data.filter(d => d.periculosidade).length}</div><div class="stat-label">Periculosidade</div></div>
                <div class="stat-card"><div class="stat-number">${errors.length}</div><div class="stat-label">Erros</div></div>
            `;
            
            tableHeader.innerHTML = '<tr><th>Nome</th><th>Departamento</th><th>Salário</th><th>Periculosidade</th><th>Horas</th></tr>';
            
            let bodyHtml = '';
            const previewData = data.slice(0, 10);
            
            previewData.forEach(item => {
                bodyHtml += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.department}</td>
                        <td>R$ ${item.baseSalary}</td>
                        <td><span class="px-2 py-1 rounded text-xs ${item.periculosidade ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">${item.periculosidade ? 'Sim' : 'Não'}</span></td>
                        <td>${item.divisor}h</td>
                    </tr>
                `;
            });
            
            if (data.length > 10) {
                bodyHtml += `<tr><td colspan="5" class="text-center text-gray-500">... e mais ${data.length - 10}</td></tr>`;
            }
            
            tableBody.innerHTML = bodyHtml;
            previewDiv.style.display = 'block';
        }
        
        async function confirmImport() {
            if (!importData || importData.length === 0) {
                alert('Nenhum dado para importar.');
                return;
            }
            
            const collaborators = getCollaborators();
            const departments = getDepartments();
            let newCollaborators = 0;
            let updatedCollaborators = 0;
            
            const departmentNames = [...new Set(importData.map(item => item.department))];
            
            departmentNames.forEach(deptName => {
                if (deptName && deptName !== 'Não especificado') {
                    if (!departments.find(d => d.name.toLowerCase() === deptName.toLowerCase())) {
                        departments.push({
                            id: Date.now() + Math.random(),
                            name: deptName,
                            active: true,
                            createdAt: new Date().toISOString()
                        });
                    }
                }
            });
            
            await saveDepartments(departments);
            
            importData.forEach(item => {
                const existing = collaborators.find(c => c.name.toLowerCase() === item.name.toLowerCase());
                
                if (existing) {
                    Object.assign(existing, {
                        department: item.department,
                        baseSalary: item.baseSalary,
                        baseSalaryValue: item.baseSalaryValue,
                        divisor: item.divisor,
                        periculosidade: item.periculosidade,
                        updatedAt: new Date().toISOString(),
                        active: true
                    });
                    updatedCollaborators++;
                } else {
                    collaborators.push({
                        id: Date.now() + Math.random(),
                        name: item.name,
                        department: item.department,
                        matricula: `COL${Date.now().toString().slice(-6)}${Math.floor(Math.random() * 100)}`,
                        baseSalary: item.baseSalary,
                        baseSalaryValue: item.baseSalaryValue,
                        divisor: item.divisor,
                        workHours: '8',
                        periculosidade: item.periculosidade,
                        insalubridade: false,
                        active: true,
                        createdAt: new Date().toISOString()
                    });
                    newCollaborators++;
                }
            });
            
            await saveCollaborators(collaborators);
            
            updateDepartmentSelect();
            updateCollaboratorSelect();
            updateCollaboratorFilterSelect();
            renderCollaboratorsTable(currentCollaboratorStatus);
            
            alert(`✅ Importação concluída!\n\n${newCollaborators} novo(s)\n${updatedCollaborators} atualizado(s)`);
            closeImportModal();
        }
        
        function downloadTemplate() {
            const data = [
                ['Nome', 'Departamento', 'Salário', 'Periculosidade', 'Horas Mensais'],
                ['João Silva', 'Produção', 'R$ 2.500,00', 'Sim', '220'],
                ['Maria Santos', 'RH', 'R$ 3.200,50', 'Não', '220']
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Modelo');
            XLSX.writeFile(wb, 'modelo_importacao.xlsx');
        }

        // ============================================
        // FUNÇÕES DE CÁLCULO
        // ============================================

        function getCurrentMonthString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }
        
        function parseTime(timeString) {
            if (!timeString) return 0;
            const parts = timeString.split(':');
            return (parseInt(parts[0]) || 0) + ((parseInt(parts[1]) || 0) / 60);
        }
        
        function formatCurrencyInput(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length === 0) {
                input.value = '';
                return;
            }
            
            while (value.length < 3) value = '0' + value;
            
            let integerPart = value.slice(0, -2);
            let decimalPart = value.slice(-2);
            
            integerPart = parseInt(integerPart, 10).toString();
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            
            input.value = integerPart + ',' + decimalPart;
        }

        function getDSRDays(year, monthIndex) {
            const date = new Date(year, monthIndex, 1);
            let sundays = 0;
            let totalDays = 0;
            
            while (date.getMonth() === monthIndex) {
                totalDays++;
                if (date.getDay() === 0) sundays++;
                date.setDate(date.getDate() + 1);
            }
            
            return { diasDSR: sundays, diasUteis: totalDays - sundays };
        }
        
        function handleMonthChange() {
            const monthInput = document.getElementById('mesReferencia').value;
            if (!monthInput) return;
            
            const [year, month] = monthInput.split('-').map(Number);
            const result = getDSRDays(year, month - 1);
            
            document.getElementById('diasDomingo').value = result.diasDSR;
            const diasUteisInput = document.getElementById('diasUteis');
            diasUteisInput.setAttribute('data-base-value', result.diasUteis);
            diasUteisInput.value = result.diasUteis;
            
            calcular();
        }

        function calcular() {
            const salarioBaseInput = document.getElementById('salarioBase').value;
            const salarioBaseFormatted = salarioBaseInput.replace(/\./g, '').replace(',', '.'); 
            const salarioBase = parseFloat(salarioBaseFormatted) || 0;

            const divisorMensal = parseFloat(document.getElementById('divisorMensal').value) || 220;
            const usaPericulosidade = document.getElementById('usaPericulosidade').checked;
            
            const horasSobreavisoTotal = parseTime(document.getElementById('horasSobreavisoTotal').value);
            const horasTrabalhadas50 = parseTime(document.getElementById('horasTrabalhadas50').value); 
            const horasTrabalhadas100 = parseTime(document.getElementById('horasTrabalhadas100').value); 
            const horasNoturnas = parseTime(document.getElementById('horasNoturnas').value);

            const diasAtestado = parseFloat(document.getElementById('diasAtestado').value) || 0; 
            const diasTrabalhados = parseFloat(document.getElementById('diasTrabalhados').value) || 30;
            const diasFeriado = parseFloat(document.getElementById('diasFeriado').value) || 0;
            const diasUteisInput = document.getElementById('diasUteis');
            const diasUteisBase = parseFloat(diasUteisInput.getAttribute('data-base-value')) || 0;

            const diasDomingoTotal = parseFloat(document.getElementById('diasDomingo').value) || 0;
            
            if (divisorMensal <= 0 || diasUteisBase <= 0 || salarioBase <= 0) {
                 document.getElementById('horaNormal').textContent = R$.format(0);
                 document.getElementById('valorPericulosidade').textContent = R$.format(0);
                 document.getElementById('valorPericulosidadeInputDisplay').textContent = R$.format(0);
                 document.getElementById('valorSobreavisoEspera').textContent = R$.format(0);
                 document.getElementById('valorHoraExtraTrabalho50').textContent = R$.format(0);
                 document.getElementById('valorHoraExtraTrabalho100').textContent = R$.format(0);
                 document.getElementById('valorAdicionalNoturno').textContent = R$.format(0);
                 document.getElementById('fatorDSRDisplay').textContent = "0.0000";
                 document.getElementById('valorReflexoSobreavisoEspera').textContent = R$.format(0);
                 document.getElementById('valorReflexoSobreavisoTrabalhado').textContent = R$.format(0);
                 document.getElementById('valorReflexoHorasExtrasNormal').textContent = R$.format(0);
                 document.getElementById('valorReflexoAdicionalNoturno').textContent = R$.format(0);
                 document.getElementById('valorReflexoDSRTotalSum').textContent = R$.format(0);
                 document.getElementById('horaSobreaviso').textContent = R$.format(0);
                 document.getElementById('baseHePeric').textContent = R$.format(0) + " (s/ Salário)";
                 document.getElementById('horaExtra50').textContent = R$.format(0);
                 
                 document.getElementById('periculosidadeDetalhada').style.display = 'none';
                 return;
            }
            
            const periculosidadeValorMensal = salarioBase * 0.30;
            const diasBaseMensal = 30;
            const diasTrabalhadosAjustados = Math.max(0, 30 - diasAtestado);
            const periculosidadeValorProRata = usaPericulosidade ? 
                (periculosidadeValorMensal / diasBaseMensal) * diasTrabalhadosAjustados : 0;

            const periculosidadeValorDiario = usaPericulosidade ? periculosidadeValorMensal / diasBaseMensal : 0;

            const horaNormal = salarioBase / divisorMensal;
            const periculosidadeHora = periculosidadeValorMensal / divisorMensal; 
            
            let baseHE = horaNormal;
            if (usaPericulosidade) {
                baseHE += periculosidadeHora;
            }
            
            const horasEspera = horasSobreavisoTotal; 
            const horaSobreaviso = horaNormal / 3;
            const valorSobreavisoEspera = horasEspera * horaSobreaviso; 

            const baseHePericRate = baseHE;
            const horaExtra50Valor = baseHE * (1 + (heNormalPorcentagem / 100));
            
            const valorHoraExtraTrabalho50 = horasTrabalhadas50 * baseHE * (1 + (heSobreavisoPorcentagem / 100)); 
            const valorHoraExtraTrabalho100 = horasTrabalhadas100 * horaExtra50Valor; 
            
            const adicionalNoturnoHora = horaNormal * (adicionalNoturnoPorcentagem / 100);
            const valorAdicionalNoturno = horasNoturnas * adicionalNoturnoHora;

            const diasUteisAjustados = Math.max(0, diasUteisBase - diasFeriado); 
            document.getElementById('diasUteis').value = diasUteisAjustados.toFixed(0); 

            const diasDSRParaCalculo = diasDomingoTotal + diasFeriado;
            const fatorDSR = diasUteisAjustados > 0 ? diasDSRParaCalculo / diasUteisAjustados : 0;
            
            const valorReflexoSobreavisoEspera = valorSobreavisoEspera * fatorDSR;
            const valorReflexoSobreavisoTrabalhado = valorHoraExtraTrabalho50 * fatorDSR;
            const valorReflexoHorasExtrasNormal = valorHoraExtraTrabalho100 * fatorDSR;
            const valorReflexoAdicionalNoturno = valorAdicionalNoturno * fatorDSR;

            const valorReflexoDSRTotal = valorReflexoSobreavisoEspera + valorReflexoSobreavisoTrabalhado + 
                                       valorReflexoHorasExtrasNormal + valorReflexoAdicionalNoturno;

            document.getElementById('valorPericulosidade').textContent = R$.format(periculosidadeValorProRata);
            document.getElementById('valorPericulosidadeInputDisplay').textContent = R$.format(periculosidadeValorProRata);

            if (usaPericulosidade && salarioBase > 0) {
                document.getElementById('periculosidadeDetalhada').style.display = 'block';
                document.getElementById('periculosidadeDetalhada').innerHTML = 
                    `Cálculo: ${R$.format(periculosidadeValorMensal)} ÷ 30 × ${diasTrabalhadosAjustados} = ${R$.format(periculosidadeValorProRata)}`;
            } else {
                document.getElementById('periculosidadeDetalhada').style.display = 'none';
            }

            document.getElementById('valorSobreavisoEspera').textContent = R$.format(valorSobreavisoEspera);
            document.getElementById('valorHoraExtraTrabalho50').textContent = R$.format(valorHoraExtraTrabalho50);
            document.getElementById('valorHoraExtraTrabalho100').textContent = R$.format(valorHoraExtraTrabalho100); 
            document.getElementById('valorAdicionalNoturno').textContent = R$.format(valorAdicionalNoturno);
            
            document.getElementById('fatorDSRDisplay').textContent = fatorDSR.toFixed(4);
            document.getElementById('valorReflexoSobreavisoEspera').textContent = R$.format(valorReflexoSobreavisoEspera);
            document.getElementById('valorReflexoSobreavisoTrabalhado').textContent = R$.format(valorReflexoSobreavisoTrabalhado);
            document.getElementById('valorReflexoHorasExtrasNormal').textContent = R$.format(valorReflexoHorasExtrasNormal);
            document.getElementById('valorReflexoAdicionalNoturno').textContent = R$.format(valorReflexoAdicionalNoturno);
            document.getElementById('valorReflexoDSRTotalSum').textContent = R$.format(valorReflexoDSRTotal);
            
            document.getElementById('horaNormal').textContent = R$.format(horaNormal);
            document.getElementById('horaSobreaviso').textContent = R$.format(horaSobreaviso);
            document.getElementById('baseHePeric').textContent = usaPericulosidade 
                ? R$.format(baseHePericRate) + " (c/ Peric.)" 
                : R$.format(baseHePericRate) + " (s/ Peric.)";
            document.getElementById('horaExtra50').textContent = R$.format(horaExtra50Valor);
        }

        function resetInputs() {
            document.getElementById('salarioBase').value = "";
            document.getElementById('diasFeriado').value = "0";
            document.getElementById('diasAtestado').value = "0";
            document.getElementById('horasSobreavisoTotal').value = "00:00";
            document.getElementById('horasTrabalhadas50').value = "00:00";
            document.getElementById('horasTrabalhadas100').value = "00:00";
            document.getElementById('horasNoturnas').value = "00:00";
            document.getElementById('divisorMensal').value = "220";
            document.getElementById('usaPericulosidade').checked = true;
            document.getElementById('pagoFolha').checked = false;
            document.getElementById('competenciaPagamento').value = "";
            handleMonthChange();
        }

        function updateDiasTrabalhados() {
            const diasAtestado = parseFloat(document.getElementById('diasAtestado').value) || 0;
            document.getElementById('diasTrabalhados').value = Math.max(0, 30 - diasAtestado);
            calcular();
        }

        // ============================================
        // FUNÇÕES DE DEPARTAMENTOS
        // ============================================
        
        function updateDepartmentSelect() {
            const departments = getDepartments();
            const select = document.getElementById('collaboratorDepartment');
            const filterDepartment = document.getElementById('filterDepartment');
            const reportDepartment = document.getElementById('reportDepartment');
            
            select.innerHTML = '<option value="">Selecione...</option>';
            if (filterDepartment) filterDepartment.innerHTML = '<option value="">Todos</option>';
            if (reportDepartment) reportDepartment.innerHTML = '<option value="">Todos</option>';
            
            departments.filter(d => d.active).sort((a, b) => a.name.localeCompare(b.name)).forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.name;
                option.textContent = dept.name;
                select.appendChild(option);
                
                if (filterDepartment) {
                    const filterOption = document.createElement('option');
                    filterOption.value = dept.name;
                    filterOption.textContent = dept.name;
                    filterDepartment.appendChild(filterOption);
                }
                
                if (reportDepartment) {
                    const reportOption = document.createElement('option');
                    reportOption.value = dept.name;
                    reportOption.textContent = dept.name;
                    reportDepartment.appendChild(reportOption);
                }
            });
        }
        
        function renderDepartmentsTable() {
            const departments = getDepartments();
            const container = document.getElementById('departmentsTableContainer');
            
            if (departments.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum departamento cadastrado.</div>';
                return;
            }
            
            let html = '<table class="department-table"><thead><tr><th>Nome</th><th>Status</th><th>Ações</th></tr></thead><tbody>';
            
            departments.sort((a, b) => a.name.localeCompare(b.name)).forEach(dept => {
                html += `
                    <tr data-id="${dept.id}">
                        <td>${dept.name}</td>
                        <td><span class="px-2 py-1 rounded text-xs ${dept.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${dept.active ? 'Ativo' : 'Inativo'}</span></td>
                        <td>
                            <button class="edit-department text-green-600 hover:text-green-800 text-sm mr-2" data-id="${dept.id}"><i class="fas fa-edit"></i> Editar</button>
                            <button class="delete-department text-red-600 hover:text-red-800 text-sm" data-id="${dept.id}"><i class="fas fa-trash"></i> Excluir</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table><div class="mt-4 text-sm text-gray-500">Total: ' + departments.length + ' departamento(s)</div>';
            container.innerHTML = html;
            
            document.querySelectorAll('.edit-department').forEach(btn => {
                btn.addEventListener('click', () => editDepartment(parseInt(btn.dataset.id)));
            });
            
            document.querySelectorAll('.delete-department').forEach(btn => {
                btn.addEventListener('click', () => deleteDepartment(parseInt(btn.dataset.id)));
            });
        }
        
        function editDepartment(id) {
            const dept = getDepartments().find(d => d.id === id);
            if (!dept) return;
            
            document.getElementById('departmentName').value = dept.name;
            document.getElementById('departmentActive').checked = dept.active;
            document.getElementById('departmentModalTitle').textContent = "Editar Departamento";
            document.getElementById('departmentModalButton').textContent = "Atualizar";
            window.editingDepartmentId = id;
            openDepartmentModal();
        }
        
        async function deleteDepartment(id) {
            const dept = getDepartments().find(d => d.id === id);
            if (!dept) return;
            
            const collaborators = getCollaborators().filter(c => c.department === dept.name && c.active);
            
            if (!confirm(`Excluir "${dept.name}"? ${collaborators.length} colaborador(es) ativo(s) serão afetados.`)) return;
            
            const filtered = getDepartments().filter(d => d.id !== id);
            await saveDepartments(filtered);
            
            if (collaborators.length > 0) {
                const updated = getCollaborators().map(c => {
                    if (c.department === dept.name) return { ...c, department: '' };
                    return c;
                });
                await saveCollaborators(updated);
            }
            
            renderDepartmentsTable();
            updateDepartmentSelect();
        }
        
        async function saveNewDepartment(e) {
            e.preventDefault();
            
            const name = document.getElementById('departmentName').value.trim();
            const active = document.getElementById('departmentActive').checked;
            
            if (!name) {
                alert('Digite o nome do departamento.');
                return;
            }
            
            const departments = getDepartments();
            
            if (window.editingDepartmentId) {
                const index = departments.findIndex(d => d.id === window.editingDepartmentId);
                if (index !== -1) {
                    departments[index] = { ...departments[index], name, active, updatedAt: new Date().toISOString() };
                }
                window.editingDepartmentId = null;
            } else {
                if (departments.some(d => d.name.toLowerCase() === name.toLowerCase())) {
                    alert('Departamento já existe.');
                    return;
                }
                departments.push({
                    id: Date.now(),
                    name,
                    active,
                    createdAt: new Date().toISOString()
                });
            }
            
            await saveDepartments(departments);
            
            closeDepartmentModal();
            renderDepartmentsTable();
            updateDepartmentSelect();
        }

        // ============================================
        // FUNÇÕES DE COLABORADORES
        // ============================================
        
        function updateCollaboratorSelect() {
            const collaborators = getCollaborators();
            const select = document.getElementById('collaboratorSelect');
            
            const current = select.value;
            select.innerHTML = '<option value="">-- Selecione --</option>';
            
            collaborators.filter(c => c.active).sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                select.appendChild(new Option(`${c.name} - ${c.department} (R$ ${c.baseSalary})`, c.id));
            });
            
            if (current && collaborators.some(c => c.id == current && c.active)) {
                select.value = current;
            }
        }
        
        function updateCollaboratorFilterSelect() {
            const collaborators = getCollaborators();
            const filter = document.getElementById('filterCollaborator');
            const report = document.getElementById('reportCollaborator');
            
            if (filter) {
                filter.innerHTML = '<option value="">Todos</option>';
                collaborators.filter(c => c.active).sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                    filter.appendChild(new Option(`${c.name} - ${c.department}`, c.id));
                });
            }
            
            if (report) {
                report.innerHTML = '<option value="">Todos</option>';
                collaborators.filter(c => c.active).sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                    report.appendChild(new Option(`${c.name} - ${c.department}`, c.id));
                });
            }
        }
        
        function loadCollaboratorToCalculator(id) {
            const c = getCollaborators().find(c => c.id == id);
            if (!c) return;
            if (!c.active) {
                alert('Colaborador inativo.');
                document.getElementById('collaboratorSelect').value = '';
                return;
            }
            document.getElementById('salarioBase').value = c.baseSalary;
            document.getElementById('divisorMensal').value = c.divisor;
            document.getElementById('usaPericulosidade').checked = c.periculosidade;
            calcular();
        }
        
        function renderCollaboratorsTable(status = 'active') {
            const collaborators = getCollaborators();
            const filtered = status === 'active' ? collaborators.filter(c => c.active) : collaborators.filter(c => !c.active);
            const container = document.getElementById('collaboratorsTableContainer');
            
            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-500">Nenhum colaborador ${status === 'active' ? 'ativo' : 'inativo'}.</div>`;
                return;
            }
            
            let html = '<table class="collaborator-table"><thead><tr><th>Nome</th><th>Departamento</th><th>Salário</th><th>Peric</th><th>Status</th>' + (status === 'inactive' ? '<th>Data</th>' : '') + '<th>Ações</th></tr></thead><tbody>';
            
            filtered.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                html += `
                    <tr data-id="${c.id}">
                        <td>${c.name}</td>
                        <td>${c.department}</td>
                        <td>R$ ${c.baseSalary}</td>
                        <td><span class="px-2 py-1 rounded text-xs ${c.periculosidade ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">${c.periculosidade ? 'Sim' : 'Não'}</span></td>
                        <td><span class="status-badge ${c.active ? 'active' : 'inactive'} px-3 py-1">${c.active ? 'Ativo' : 'Inativo'}</span></td>
                        ${status === 'inactive' ? `<td>${new Date(c.updatedAt || c.createdAt).toLocaleDateString()}</td>` : ''}
                        <td>
                            <button class="edit-collaborator text-green-600 hover:text-green-800 text-sm mr-2" data-id="${c.id}"><i class="fas fa-edit"></i> Editar</button>
                            <button class="delete-collaborator text-red-600 hover:text-red-800 text-sm" data-id="${c.id}"><i class="fas fa-trash"></i> Excluir</button>
                            ${status === 'inactive' ? `<button class="reactivate-collaborator text-blue-600 hover:text-blue-800 text-sm ml-2" data-id="${c.id}"><i class="fas fa-user-check"></i> Reativar</button>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table><div class="mt-4 text-sm text-gray-500">Total: ' + filtered.length + '</div>';
            container.innerHTML = html;
            
            document.querySelectorAll('.edit-collaborator').forEach(btn => {
                btn.addEventListener('click', () => editCollaborator(parseInt(btn.dataset.id)));
            });
            
            document.querySelectorAll('.delete-collaborator').forEach(btn => {
                btn.addEventListener('click', () => showDeleteCollaboratorModal(parseInt(btn.dataset.id)));
            });
            
            document.querySelectorAll('.reactivate-collaborator').forEach(btn => {
                btn.addEventListener('click', () => reactivateCollaborator(parseInt(btn.dataset.id)));
            });
            
            updateStatusButtons(status);
        }
        
        function updateStatusButtons(status) {
            const activeBtn = document.getElementById('showActiveCollaborators');
            const inactiveBtn = document.getElementById('showInactiveCollaborators');
            
            if (status === 'active') {
                activeBtn.classList.add('active');
                inactiveBtn.classList.remove('active');
            } else {
                activeBtn.classList.remove('active');
                inactiveBtn.classList.add('active');
            }
            currentCollaboratorStatus = status;
        }
        
        function showDeleteCollaboratorModal(id) {
            const c = getCollaborators().find(c => c.id === id);
            if (!c) return;
            document.getElementById('deleteCollaboratorName').textContent = c.name;
            document.getElementById('deleteCollaboratorModal').dataset.id = id;
            document.getElementById('deleteCollaboratorModal').classList.add('active');
        }
        
        async function confirmDeleteCollaborator() {
            const id = parseInt(document.getElementById('deleteCollaboratorModal').dataset.id);
            const filtered = getCollaborators().filter(c => c.id !== id);
            await saveCollaborators(filtered);
            closeDeleteCollaboratorModal();
            renderCollaboratorsTable(currentCollaboratorStatus);
            updateCollaboratorSelect();
        }
        
        function closeDeleteCollaboratorModal() {
            document.getElementById('deleteCollaboratorModal').classList.remove('active');
        }
        
        async function reactivateCollaborator(id) {
            if (!confirm('Reativar colaborador?')) return;
            const collaborators = getCollaborators();
            const index = collaborators.findIndex(c => c.id === id);
            if (index === -1) return;
            collaborators[index].active = true;
            collaborators[index].updatedAt = new Date().toISOString();
            await saveCollaborators(collaborators);
            renderCollaboratorsTable(currentCollaboratorStatus);
            updateCollaboratorSelect();
        }
        
        function editCollaborator(id) {
            const c = getCollaborators().find(c => c.id === id);
            if (!c) return;
            
            document.getElementById('collaboratorEditId').value = c.id;
            document.getElementById('collaboratorName').value = c.name;
            document.getElementById('collaboratorDepartment').value = c.department;
            document.getElementById('collaboratorBaseSalary').value = c.baseSalary;
            document.getElementById('collaboratorDivisor').value = c.divisor;
            document.getElementById('collaboratorWorkHours').value = c.workHours || '8';
            document.getElementById('collaboratorPericulosidade').checked = c.periculosidade;
            document.getElementById('collaboratorInsalubridade').checked = c.insalubridade || false;
            
            if (c.active) {
                document.getElementById('collaboratorStatusActive').checked = true;
            } else {
                document.getElementById('collaboratorStatusInactive').checked = true;
            }
            
            document.getElementById('collaboratorModalTitle').textContent = "Editar Colaborador";
            document.getElementById('collaboratorModalButton').textContent = "Atualizar";
            openModal();
        }
        
        async function saveCollaborator(e) {
            e.preventDefault();
            
            const id = document.getElementById('collaboratorEditId').value;
            const name = document.getElementById('collaboratorName').value.trim();
            const department = document.getElementById('collaboratorDepartment').value;
            const baseSalary = document.getElementById('collaboratorBaseSalary').value;
            const divisor = document.getElementById('collaboratorDivisor').value;
            const workHours = document.getElementById('collaboratorWorkHours').value;
            const periculosidade = document.getElementById('collaboratorPericulosidade').checked;
            const insalubridade = document.getElementById('collaboratorInsalubridade').checked;
            
            let active = true;
            const radios = document.getElementsByName('collaboratorStatus');
            for (let r of radios) if (r.checked) active = r.value === 'active';
            
            if (!name || !department || !baseSalary) {
                alert('Preencha Nome, Departamento e Salário.');
                return;
            }
            
            const baseSalaryValue = parseFloat(baseSalary.replace(/\./g, '').replace(',', '.'));
            if (baseSalaryValue <= 0) {
                alert('Salário deve ser maior que zero.');
                return;
            }
            
            const collaborators = getCollaborators();
            const now = new Date().toISOString();
            
            if (id) {
                const index = collaborators.findIndex(c => c.id == id);
                if (index === -1) return;
                collaborators[index] = {
                    ...collaborators[index],
                    name, department, baseSalary, baseSalaryValue, divisor, workHours,
                    periculosidade, insalubridade, active, updatedAt: now
                };
            } else {
                collaborators.push({
                    id: Date.now(),
                    name, department,
                    matricula: `COL${Date.now().toString().slice(-6)}`,
                    baseSalary, baseSalaryValue, divisor, workHours,
                    periculosidade, insalubridade, active,
                    createdAt: now, updatedAt: now
                });
            }
            
            await saveCollaborators(collaborators);
            closeModal();
            renderCollaboratorsTable(currentCollaboratorStatus);
            updateCollaboratorSelect();
        }

        // ============================================
        // FUNÇÕES DE HISTÓRICO
        // ============================================
        
        async function saveCurrentCalculation() {
            if (!currentUserName) {
                alert('Por favor, selecione seu nome no seletor de usuários antes de salvar.');
                return;
            }
            
            const selectedId = document.getElementById('collaboratorSelect').value;
            if (!selectedId) {
                alert('Selecione um colaborador.');
                return;
            }
            
            const collaborators = getCollaborators();
            const collaborator = collaborators.find(c => c.id == selectedId);
            if (!collaborator) return;
            
            const isEditing = currentCalculationDetailId !== null;
            const mesReferencia = document.getElementById('mesReferencia').value;
            
            if (!isEditing && checkDuplicateCalculation(selectedId, mesReferencia)) {
                if (!confirm('Já existe um cálculo para este colaborador neste mês. Deseja salvar mesmo assim?')) return;
            }
            
            const calculation = {
                id: isEditing ? currentCalculationDetailId : Date.now(),
                collaboratorId: selectedId,
                collaboratorName: collaborator.name,
                collaboratorDepartment: collaborator.department,
                collaboratorSalary: collaborator.baseSalary,
                responsavel: currentUserName,
                timestamp: new Date().toLocaleString('pt-BR'),
                timestampISO: new Date().toISOString(),
                mesReferencia,
                pagoFolha: document.getElementById('pagoFolha').checked,
                competenciaPagamento: document.getElementById('competenciaPagamento').value,
                config: { heNormalPorcentagem, heSobreavisoPorcentagem, adicionalNoturnoPorcentagem },
                data: {
                    salarioBase: document.getElementById('salarioBase').value,
                    divisorMensal: document.getElementById('divisorMensal').value,
                    usaPericulosidade: document.getElementById('usaPericulosidade').checked,
                    horasSobreavisoTotal: document.getElementById('horasSobreavisoTotal').value,
                    horasTrabalhadas50: document.getElementById('horasTrabalhadas50').value,
                    horasTrabalhadas100: document.getElementById('horasTrabalhadas100').value,
                    horasNoturnas: document.getElementById('horasNoturnas').value,
                    diasTrabalhados: document.getElementById('diasTrabalhados').value,
                    diasAtestado: document.getElementById('diasAtestado').value,
                    diasFeriado: document.getElementById('diasFeriado').value,
                    diasDomingo: document.getElementById('diasDomingo').value,
                    diasUteis: document.getElementById('diasUteis').value,
                    resultados: {
                        valorPericulosidade: document.getElementById('valorPericulosidade').textContent,
                        valorSobreavisoEspera: document.getElementById('valorSobreavisoEspera').textContent,
                        valorHoraExtraTrabalho50: document.getElementById('valorHoraExtraTrabalho50').textContent,
                        valorHoraExtraTrabalho100: document.getElementById('valorHoraExtraTrabalho100').textContent,
                        valorAdicionalNoturno: document.getElementById('valorAdicionalNoturno').textContent,
                        valorReflexoDSRTotalSum: document.getElementById('valorReflexoDSRTotalSum').textContent,
                        fatorDSR: document.getElementById('fatorDSRDisplay').textContent,
                        valorReflexoSobreavisoEspera: document.getElementById('valorReflexoSobreavisoEspera').textContent,
                        valorReflexoSobreavisoTrabalhado: document.getElementById('valorReflexoSobreavisoTrabalhado').textContent,
                        valorReflexoHorasExtrasNormal: document.getElementById('valorReflexoHorasExtrasNormal').textContent,
                        valorReflexoAdicionalNoturno: document.getElementById('valorReflexoAdicionalNoturno').textContent
                    }
                }
            };
            
            const calculations = getSavedCalculations();
            
            if (isEditing) {
                const index = calculations.findIndex(c => c.id === currentCalculationDetailId);
                if (index === -1) return;
                calculations[index] = calculation;
                alert('Cálculo atualizado!');
                currentCalculationDetailId = null;
            } else {
                calculations.push(calculation);
                alert(`Cálculo salvo (responsável: ${currentUserName})`);
            }
            
            await saveCalculations(calculations);
            
            if (!document.getElementById('historyContent').classList.contains('hidden')) {
                renderHistoryTable();
            }
        }
        
        function checkDuplicateCalculation(collaboratorId, mesReferencia, ignoreId = null) {
            return getSavedCalculations().some(c => 
                c.collaboratorId == collaboratorId && 
                c.mesReferencia === mesReferencia &&
                (ignoreId === null || c.id !== ignoreId)
            );
        }
        
        function renderHistoryTable(filters = {}) {
            const calculations = getSavedCalculations();
            let filtered = [...calculations];
            
            if (filters.collaboratorId) filtered = filtered.filter(c => c.collaboratorId == filters.collaboratorId);
            if (filters.department) filtered = filtered.filter(c => c.collaboratorDepartment === filters.department);
            if (filters.startMonth) filtered = filtered.filter(c => c.mesReferencia >= filters.startMonth);
            if (filters.endMonth) filtered = filtered.filter(c => c.mesReferencia <= filters.endMonth);
            
            filtered.sort((a, b) => new Date(b.timestampISO) - new Date(a.timestampISO));
            
            const container = document.getElementById('historyTableBody');
            
            if (filtered.length === 0) {
                container.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">Nenhum cálculo encontrado.</td></tr>';
                return;
            }
            
            let html = '';
            filtered.forEach(c => {
                html += `
                    <tr>
                        <td>${c.mesReferencia}</td>
                        <td>${c.collaboratorName}</td>
                        <td>${c.collaboratorDepartment}</td>
                        <td>${c.timestamp}</td>
                        <td><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">${c.responsavel || 'N/A'}</span></td>
                        <td class="${c.pagoFolha ? 'text-green-600' : 'text-gray-600'}">${c.pagoFolha ? 'Sim' : 'Não'}${c.competenciaPagamento ? ` (${c.competenciaPagamento})` : ''}</td>
                        <td>
                            <button class="view-calculation-detail text-blue-600 hover:text-blue-800 text-sm mr-2" data-id="${c.id}"><i class="fas fa-eye"></i></button>
                            <button class="delete-calculation text-red-600 hover:text-red-800 text-sm" data-id="${c.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
            
            document.querySelectorAll('.view-calculation-detail').forEach(btn => {
                btn.addEventListener('click', () => viewCalculationDetail(parseInt(btn.dataset.id)));
            });
            
            document.querySelectorAll('.delete-calculation').forEach(btn => {
                btn.addEventListener('click', () => deleteCalculation(parseInt(btn.dataset.id)));
            });
        }
        
        async function deleteCalculation(id) {
            if (!confirm('Excluir cálculo?')) return;
            const filtered = getSavedCalculations().filter(c => c.id !== id);
            await saveCalculations(filtered);
            renderHistoryTable();
        }
        
        function viewCalculationDetail(id) {
            const calc = getSavedCalculations().find(c => c.id === id);
            if (!calc) return;
            
            currentCalculationDetailId = id;
            
            const content = document.getElementById('calculationDetailContent');
            content.innerHTML = `
                <div class="space-y-4 view-mode" id="detailViewMode">
                    <div class="p-4 bg-blue-50 rounded">
                        <h4 class="font-bold text-lg mb-2">${calc.collaboratorName}</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>Depto: ${calc.collaboratorDepartment}</div>
                            <div>Mês: ${calc.mesReferencia}</div>
                            <div>Data: ${calc.timestamp}</div>
                            <div>Resp: <span class="bg-blue-100 px-2 py-1 rounded">${calc.responsavel || 'N/A'}</span></div>
                        </div>
                    </div>
                    
                    <div class="payment-info">
                        <h5>Pagamento</h5>
                        <div class="grid grid-cols-2 gap-2">
                            <div>Pago: ${calc.pagoFolha ? 'Sim' : 'Não'}</div>
                            <div>Competência: ${calc.competenciaPagamento || '-'}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <h3 class="font-bold mb-2">Adicionais</h3>
                            <div class="space-y-2">
                                <div>Periculosidade: ${calc.data.resultados.valorPericulosidade}</div>
                                <div>Sobreaviso: ${calc.data.resultados.valorSobreavisoEspera}</div>
                                <div>Sob. Trabalhado: ${calc.data.resultados.valorHoraExtraTrabalho50}</div>
                                <div>Horas Extras: ${calc.data.resultados.valorHoraExtraTrabalho100}</div>
                                <div>Ad. Noturno: ${calc.data.resultados.valorAdicionalNoturno}</div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold mb-2">Reflexos (fator ${calc.data.resultados.fatorDSR})</h3>
                            <div class="space-y-2">
                                <div>Ref. Sobreaviso: ${calc.data.resultados.valorReflexoSobreavisoEspera}</div>
                                <div>Ref. Sob. Trab.: ${calc.data.resultados.valorReflexoSobreavisoTrabalhado}</div>
                                <div>Ref. Horas Extras: ${calc.data.resultados.valorReflexoHorasExtrasNormal}</div>
                                <div>Ref. Ad. Noturno: ${calc.data.resultados.valorReflexoAdicionalNoturno}</div>
                                <div class="font-bold pt-2 border-t">TOTAL REFLEXOS: ${calc.data.resultados.valorReflexoDSRTotalSum}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('calculationDetailTitle').textContent = `Detalhes - ${calc.collaboratorName}`;
            openCalculationDetailModal();
        }
        
        function openCalculationDetailModal() {
            document.getElementById('calculationDetailModal').classList.add('active');
        }
        
        function closeCalculationDetailModal() {
            document.getElementById('calculationDetailModal').classList.remove('active');
            currentCalculationDetailId = null;
        }

        // ============================================
        // FUNÇÕES DE RELATÓRIOS
        // ============================================
        
        function initializeColumnControls() {
            document.querySelectorAll('.column-toggle-btn').forEach(btn => {
                btn.removeEventListener('click', handleColumnToggle);
                btn.addEventListener('click', handleColumnToggle);
            });
        }
        
        function handleColumnToggle() {
            const col = this.dataset.column;
            if (this.classList.contains('active')) {
                this.classList.remove('active');
                visibleColumns[col] = false;
            } else {
                this.classList.add('active');
                visibleColumns[col] = true;
            }
            
            if (!document.getElementById('reportTableBody').children[0]?.classList.contains('no-results')) {
                updateReportTable();
            }
        }
        
        function generateReport() {
            const calculations = getSavedCalculations();
            if (calculations.length === 0) {
                alert('Nenhum cálculo salvo.');
                return;
            }
            
            const collaboratorId = document.getElementById('reportCollaborator').value;
            const department = document.getElementById('reportDepartment').value;
            const month = document.getElementById('reportMonth').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const responsavel = document.getElementById('reportResponsavel').value;
            
            let filtered = [...calculations];
            activeReportFilters = {};
            
            if (collaboratorId) {
                filtered = filtered.filter(c => c.collaboratorId == collaboratorId);
                activeReportFilters.colaborador = collaboratorId;
            }
            if (department) {
                filtered = filtered.filter(c => c.collaboratorDepartment === department);
                activeReportFilters.departamento = department;
            }
            if (month) {
                filtered = filtered.filter(c => c.mesReferencia === month);
                activeReportFilters.mes = month;
            }
            if (startDate) {
                const start = new Date(startDate);
                filtered = filtered.filter(c => new Date(c.timestampISO) >= start);
                activeReportFilters.dataInicio = startDate;
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23,59,59);
                filtered = filtered.filter(c => new Date(c.timestampISO) <= end);
                activeReportFilters.dataFim = endDate;
            }
            if (responsavel) {
                filtered = filtered.filter(c => c.responsavel === responsavel);
                activeReportFilters.responsavel = responsavel;
            }
            
            if (filtered.length === 0) {
                alert('Nenhum cálculo com os filtros.');
                return;
            }
            
            const reportData = consolidateReportData(filtered);
            updateReportTable(reportData);
        }
        
        function consolidateReportData(calculations) {
            const consolidated = {};
            
            calculations.forEach(c => {
                const key = `${c.collaboratorId}-${c.mesReferencia}`;
                
                if (!consolidated[key]) {
                    consolidated[key] = {
                        colaboradorId: c.collaboratorId,
                        colaborador: c.collaboratorName,
                        departamento: c.collaboratorDepartment,
                        salario: c.collaboratorSalary,
                        mesReferencia: c.mesReferencia,
                        responsavel: c.responsavel || 'N/A',
                        periculosidadeValor: parseFloat(c.data.resultados.valorPericulosidade.replace(/[R$\s.]/g, '').replace(',', '.')) || 0,
                        sobreaviso: parseTime(c.data.horasSobreavisoTotal),
                        sobreavisoDisplay: formatTimeForDisplay(c.data.horasSobreavisoTotal),
                        sobreavisoValor: parseFloat(c.data.resultados.valorSobreavisoEspera.replace(/[R$\s.]/g, '').replace(',', '.')) || 0,
                        sobreavisoTrabalhado: parseTime(c.data.horasTrabalhadas50),
                        sobreavisoTrabalhadoDisplay: formatTimeForDisplay(c.data.horasTrabalhadas50),
                        sobreavisoTrabalhadoValor: parseFloat(c.data.resultados.valorHoraExtraTrabalho50.replace(/[R$\s.]/g, '').replace(',', '.')) || 0,
                        horasExtras: parseTime(c.data.horasTrabalhadas100),
                        horasExtrasDisplay: formatTimeForDisplay(c.data.horasTrabalhadas100),
                        horasExtrasValor: parseFloat(c.data.resultados.valorHoraExtraTrabalho100.replace(/[R$\s.]/g, '').replace(',', '.')) || 0,
                        adicionalNoturno: parseTime(c.data.horasNoturnas),
                        adicionalNoturnoDisplay: formatTimeForDisplay(c.data.horasNoturnas),
                        adicionalNoturnoValor: parseFloat(c.data.resultados.valorAdicionalNoturno.replace(/[R$\s.]/g, '').replace(',', '.')) || 0,
                        reflexosValor: parseFloat(c.data.resultados.valorReflexoDSRTotalSum.replace(/[R$\s.]/g, '').replace(',', '.')) || 0,
                        reflexoSobreavisoValor: parseFloat(c.data.resultados.valorReflexoSobreavisoEspera.replace(/[R$\s.]/g, '').replace(',', '.')) || 0,
                        reflexoSobreavisoTrabalhadoValor: parseFloat(c.data.resultados.valorReflexoSobreavisoTrabalhado.replace(/[R$\s.]/g, '').replace(',', '.')) || 0,
                        reflexoHorasExtrasValor: parseFloat(c.data.resultados.valorReflexoHorasExtrasNormal.replace(/[R$\s.]/g, '').replace(',', '.')) || 0,
                        reflexoAdicionalNoturnoValor: parseFloat(c.data.resultados.valorReflexoAdicionalNoturno.replace(/[R$\s.]/g, '').replace(',', '.')) || 0
                    };
                } else {
                    // Somar valores (simplificado - normalmente não haveria duplicatas)
                }
            });
            
            return Object.values(consolidated);
        }
        
        function formatTimeForDisplay(t) {
            if (!t) return "00:00";
            if (t.includes(':')) {
                const p = t.split(':');
                return `${p[0].padStart(2,'0')}:${(p[1]||'00').padStart(2,'0')}`;
            }
            const hours = Math.floor(parseFloat(t) || 0);
            const mins = Math.round((parseFloat(t) - hours) * 60);
            return `${hours.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}`;
        }
        
        function updateReportTable(data = []) {
            const tbody = document.getElementById('reportTableBody');
            const thead = document.getElementById('reportTableHeader');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="20" class="no-results">Nenhum dado</td></tr>';
                return;
            }
            
            // Cabeçalho
            let headerHtml = '';
            if (visibleColumns.colaborador) headerHtml += '<th>Colaborador</th>';
            if (visibleColumns.departamento) headerHtml += '<th>Depto</th>';
            if (visibleColumns.salario) headerHtml += '<th>Salário</th>';
            if (visibleColumns.responsavel) headerHtml += '<th>Responsável</th>';
            if (visibleColumns.periculosidade) headerHtml += '<th>Periculosidade</th>';
            if (visibleColumns.sobreaviso) headerHtml += '<th>Hrs Sob.</th>';
            if (visibleColumns.sobreaviso) headerHtml += '<th>Valor Sob.</th>';
            if (visibleColumns.sobreaviso_trabalhado) headerHtml += '<th>Hrs Sob.Trab</th>';
            if (visibleColumns.sobreaviso_trabalhado) headerHtml += '<th>Valor Sob.Trab</th>';
            if (visibleColumns.horas_extras) headerHtml += '<th>Hrs Extras</th>';
            if (visibleColumns.horas_extras) headerHtml += '<th>Valor Extras</th>';
            if (visibleColumns.adicional_noturno) headerHtml += '<th>Hrs Not.</th>';
            if (visibleColumns.adicional_noturno) headerHtml += '<th>Valor Not.</th>';
            if (visibleColumns.reflexos) headerHtml += '<th>Reflexos</th>';
            if (visibleColumns.total) headerHtml += '<th>Total</th>';
            thead.innerHTML = headerHtml;
            
            // Linhas
            let html = '';
            let totalGeral = 0;
            
            data.forEach(row => {
                let totalFiltrado = 0;
                if (visibleColumns.periculosidade) totalFiltrado += row.periculosidadeValor;
                if (visibleColumns.sobreaviso) totalFiltrado += row.sobreavisoValor;
                if (visibleColumns.sobreaviso_trabalhado) totalFiltrado += row.sobreavisoTrabalhadoValor;
                if (visibleColumns.horas_extras) totalFiltrado += row.horasExtrasValor;
                if (visibleColumns.adicional_noturno) totalFiltrado += row.adicionalNoturnoValor;
                
                let reflexosFiltrados = 0;
                if (visibleColumns.sobreaviso) reflexosFiltrados += row.reflexoSobreavisoValor;
                if (visibleColumns.sobreaviso_trabalhado) reflexosFiltrados += row.reflexoSobreavisoTrabalhadoValor;
                if (visibleColumns.horas_extras) reflexosFiltrados += row.reflexoHorasExtrasValor;
                if (visibleColumns.adicional_noturno) reflexosFiltrados += row.reflexoAdicionalNoturnoValor;
                
                if (visibleColumns.reflexos) totalFiltrado += reflexosFiltrados;
                totalGeral += totalFiltrado;
                
                html += '<tr>';
                if (visibleColumns.colaborador) html += `<td>${row.colaborador}</td>`;
                if (visibleColumns.departamento) html += `<td>${row.departamento}</td>`;
                if (visibleColumns.salario) html += `<td>R$ ${row.salario}</td>`;
                if (visibleColumns.responsavel) html += `<td><span class="bg-blue-100 px-2 py-1 rounded text-xs">${row.responsavel}</span></td>`;
                if (visibleColumns.periculosidade) html += `<td>${R$.format(row.periculosidadeValor)}</td>`;
                if (visibleColumns.sobreaviso) html += `<td>${row.sobreavisoDisplay}</td>`;
                if (visibleColumns.sobreaviso) html += `<td>${R$.format(row.sobreavisoValor)}</td>`;
                if (visibleColumns.sobreaviso_trabalhado) html += `<td>${row.sobreavisoTrabalhadoDisplay}</td>`;
                if (visibleColumns.sobreaviso_trabalhado) html += `<td>${R$.format(row.sobreavisoTrabalhadoValor)}</td>`;
                if (visibleColumns.horas_extras) html += `<td>${row.horasExtrasDisplay}</td>`;
                if (visibleColumns.horas_extras) html += `<td>${R$.format(row.horasExtrasValor)}</td>`;
                if (visibleColumns.adicional_noturno) html += `<td>${row.adicionalNoturnoDisplay}</td>`;
                if (visibleColumns.adicional_noturno) html += `<td>${R$.format(row.adicionalNoturnoValor)}</td>`;
                if (visibleColumns.reflexos) html += `<td class="reflexo-total">${R$.format(reflexosFiltrados)}</td>`;
                if (visibleColumns.total) html += `<td class="font-bold">${R$.format(totalFiltrado)}</td>`;
                html += '</tr>';
            });
            
            if (visibleColumns.total) {
                html += `<tr class="total-row"><td colspan="${getVisibleColumnCount()-1}" class="text-right font-bold">TOTAL GERAL:</td><td class="font-bold">${R$.format(totalGeral)}</td></tr>`;
            }
            
            tbody.innerHTML = html;
        }
        
        function getVisibleColumnCount() {
            return Object.values(visibleColumns).filter(v => v).length;
        }
        
        function clearReportFilters() {
            document.getElementById('reportCollaborator').value = '';
            document.getElementById('reportDepartment').value = '';
            document.getElementById('reportMonth').value = '';
            document.getElementById('reportStartDate').value = '';
            document.getElementById('reportEndDate').value = '';
            document.getElementById('reportResponsavel').value = '';
            document.getElementById('reportTableBody').innerHTML = '<tr><td colspan="20" class="no-results">Aplique filtros para gerar relatório.</td></tr>';
        }
        
        function exportReportCSV() {
            const tbody = document.getElementById('reportTableBody');
            if (tbody.children.length === 0 || tbody.children[0].classList.contains('no-results')) {
                alert('Sem dados para exportar.');
                return;
            }
            
            let csv = '';
            const headers = [];
            if (visibleColumns.colaborador) headers.push('COLABORADOR');
            if (visibleColumns.departamento) headers.push('DEPARTAMENTO');
            if (visibleColumns.salario) headers.push('SALÁRIO');
            if (visibleColumns.responsavel) headers.push('RESPONSÁVEL');
            if (visibleColumns.periculosidade) headers.push('PERICULOSIDADE');
            if (visibleColumns.sobreaviso) headers.push('HORAS SOBREAVISO');
            if (visibleColumns.sobreaviso) headers.push('VALOR SOBREAVISO');
            if (visibleColumns.sobreaviso_trabalhado) headers.push('HORAS SOB.TRAB');
            if (visibleColumns.sobreaviso_trabalhado) headers.push('VALOR SOB.TRAB');
            if (visibleColumns.horas_extras) headers.push('HORAS EXTRAS');
            if (visibleColumns.horas_extras) headers.push('VALOR EXTRAS');
            if (visibleColumns.adicional_noturno) headers.push('HORAS NOTURNO');
            if (visibleColumns.adicional_noturno) headers.push('VALOR NOTURNO');
            if (visibleColumns.reflexos) headers.push('REFLEXOS');
            if (visibleColumns.total) headers.push('TOTAL');
            csv += headers.join(';') + '\n';
            
            const rows = tbody.querySelectorAll('tr:not(.total-row)');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const data = [];
                cells.forEach(cell => data.push(`"${cell.textContent.trim()}"`));
                csv += data.join(';') + '\n';
            });
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `relatorio_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
        
        function exportReportPDF() {
            alert('Funcionalidade PDF disponível!');
        }

        // ============================================
        // INICIALIZAÇÃO
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            
            const monthInput = document.getElementById('mesReferencia');
            monthInput.value = getCurrentMonthString();
            handleMonthChange();
            
            updateDepartmentSelect();
            updateCollaboratorSelect();
            updateCollaboratorFilterSelect();
            renderUsersList();
            
            // Event listeners
            document.querySelectorAll('#calculatorContent input, #calculatorContent select').forEach(el => {
                if (el.id !== 'salarioBase' && el.id !== 'mesReferencia') {
                    el.addEventListener('input', calcular);
                    el.addEventListener('change', calcular);
                }
            });
            
            document.getElementById('salarioBase').addEventListener('input', function() {
                formatCurrencyInput(this);
                calcular();
            });
            
            document.getElementById('mesReferencia').addEventListener('change', handleMonthChange);
            document.getElementById('diasFeriado').addEventListener('input', calcular);
            document.getElementById('diasAtestado').addEventListener('input', updateDiasTrabalhados);
            document.getElementById('usaPericulosidade').addEventListener('change', calcular);
            document.getElementById('pagoFolha').addEventListener('change', calcular);
            document.getElementById('competenciaPagamento').addEventListener('change', calcular);
            
            document.getElementById('clearButton').addEventListener('click', resetInputs);
            document.getElementById('saveCalculation').addEventListener('click', saveCurrentCalculation);
            
            document.getElementById('refreshCollaborators').addEventListener('click', () => {
                updateCollaboratorSelect();
                updateCollaboratorFilterSelect();
            });
            
            document.getElementById('collaboratorSelect').addEventListener('change', function() {
                if (this.value) loadCollaboratorToCalculator(this.value);
            });
            
            document.getElementById('refreshCollaboratorList').addEventListener('click', () => {
                renderCollaboratorsTable(currentCollaboratorStatus);
            });
            
            document.getElementById('showActiveCollaborators').addEventListener('click', () => renderCollaboratorsTable('active'));
            document.getElementById('showInactiveCollaborators').addEventListener('click', () => renderCollaboratorsTable('inactive'));
            
            document.getElementById('refreshDepartments').addEventListener('click', renderDepartmentsTable);
            document.getElementById('refreshHistory').addEventListener('click', () => {
                renderHistoryTable();
                updateCollaboratorFilterSelect();
            });
            
            document.getElementById('clearHistoryFilters').addEventListener('click', () => {
                document.getElementById('filterCollaborator').value = '';
                document.getElementById('filterDepartment').value = '';
                document.getElementById('filterStartMonth').value = '';
                document.getElementById('filterEndMonth').value = '';
                renderHistoryTable();
            });
            
            document.getElementById('applyFilters').addEventListener('click', () => {
                renderHistoryTable({
                    collaboratorId: document.getElementById('filterCollaborator').value,
                    department: document.getElementById('filterDepartment').value,
                    startMonth: document.getElementById('filterStartMonth').value,
                    endMonth: document.getElementById('filterEndMonth').value
                });
            });
            
            document.getElementById('toggleBases').addEventListener('click', () => {
                const container = document.getElementById('basesContainer');
                const icon = document.getElementById('basesIcon');
                if (container.classList.contains('hidden')) {
                    container.classList.remove('hidden');
                    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                } else {
                    container.classList.add('hidden');
                    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                }
            });
            
            // Menu
            document.getElementById('menuCalculator').addEventListener('click', () => {
                document.querySelectorAll('[id$="Content"]').forEach(el => el.classList.add('hidden'));
                document.getElementById('calculatorContent').classList.remove('hidden');
                document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById('menuCalculator').classList.add('active');
            });
            
            document.getElementById('menuCollaborators').addEventListener('click', () => {
                document.querySelectorAll('[id$="Content"]').forEach(el => el.classList.add('hidden'));
                document.getElementById('collaboratorsContent').classList.remove('hidden');
                document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById('menuCollaborators').classList.add('active');
                showCollaboratorsTab();
            });
            
            document.getElementById('menuHistory').addEventListener('click', () => {
                document.querySelectorAll('[id$="Content"]').forEach(el => el.classList.add('hidden'));
                document.getElementById('historyContent').classList.remove('hidden');
                document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById('menuHistory').classList.add('active');
                renderHistoryTable();
            });
            
            document.getElementById('menuReports').addEventListener('click', () => {
                document.querySelectorAll('[id$="Content"]').forEach(el => el.classList.add('hidden'));
                document.getElementById('reportsContent').classList.remove('hidden');
                document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById('menuReports').classList.add('active');
                initializeColumnControls();
                updateResponsavelFilter();
            });
            
            document.getElementById('menuSettings').addEventListener('click', openSettingsModal);
            document.getElementById('menuAdmin').addEventListener('click', () => {
                renderUsersList();
                document.getElementById('adminModal').classList.add('active');
            });
            
            document.getElementById('tabCollaborators').addEventListener('click', showCollaboratorsTab);
            document.getElementById('tabDepartments').addEventListener('click', showDepartmentsTab);
            
            function showCollaboratorsTab() {
                document.getElementById('collaboratorsTabContent').classList.remove('hidden');
                document.getElementById('departmentsTabContent').classList.add('hidden');
                document.getElementById('tabCollaborators').classList.add('active');
                document.getElementById('tabDepartments').classList.remove('active');
                renderCollaboratorsTable('active');
            }
            
            function showDepartmentsTab() {
                document.getElementById('collaboratorsTabContent').classList.add('hidden');
                document.getElementById('departmentsTabContent').classList.remove('hidden');
                document.getElementById('tabCollaborators').classList.remove('active');
                document.getElementById('tabDepartments').classList.add('active');
                renderDepartmentsTable();
            }
            
            // Modais
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelCollaborator').addEventListener('click', closeModal);
            document.getElementById('collaboratorForm').addEventListener('submit', saveCollaborator);
            
            document.getElementById('addNewCollaborator').addEventListener('click', () => {
                document.getElementById('collaboratorEditId').value = '';
                document.getElementById('collaboratorForm').reset();
                document.getElementById('collaboratorStatusActive').checked = true;
                document.getElementById('collaboratorModalTitle').textContent = "Novo Colaborador";
                document.getElementById('collaboratorModalButton').textContent = "Salvar";
                openModal();
            });
            
            document.getElementById('addDepartmentFromCollaborator').addEventListener('click', (e) => {
                e.preventDefault();
                closeModal();
                openDepartmentModal();
            });
            
            document.getElementById('closeDepartmentModal').addEventListener('click', closeDepartmentModal);
            document.getElementById('cancelDepartment').addEventListener('click', closeDepartmentModal);
            document.getElementById('departmentForm').addEventListener('submit', saveNewDepartment);
            document.getElementById('addNewDepartment').addEventListener('click', openDepartmentModal);
            
            document.getElementById('closeCalculationDetailModal').addEventListener('click', closeCalculationDetailModal);
            document.getElementById('closeCalculationDetail').addEventListener('click', closeCalculationDetailModal);
            document.getElementById('editCalculationBtn').addEventListener('click', () => {
                alert('Edição em desenvolvimento');
            });
            
            document.getElementById('closeDeleteModal').addEventListener('click', closeDeleteCollaboratorModal);
            document.getElementById('cancelDeleteCollaborator').addEventListener('click', closeDeleteCollaboratorModal);
            document.getElementById('confirmDeleteCollaborator').addEventListener('click', confirmDeleteCollaborator);
            
            document.getElementById('closeDeleteUserModal').addEventListener('click', closeDeleteUserModal);
            document.getElementById('cancelDeleteUser').addEventListener('click', closeDeleteUserModal);
            document.getElementById('confirmDeleteUser').addEventListener('click', confirmDeleteUser);
            
            document.getElementById('closeSettingsModal').addEventListener('click', closeSettingsModal);
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            
            document.getElementById('closeAdminModal').addEventListener('click', () => {
                document.getElementById('adminModal').classList.remove('active');
            });
            
            document.getElementById('addUserBtn').addEventListener('click', addUser);
            
            document.getElementById('refreshReports').addEventListener('click', () => {
                updateCollaboratorFilterSelect();
                updateDepartmentSelect();
                updateResponsavelFilter();
            });
            
            document.getElementById('generateReport').addEventListener('click', generateReport);
            document.getElementById('clearReportFilters').addEventListener('click', clearReportFilters);
            document.getElementById('exportReportCSV').addEventListener('click', exportReportCSV);
            document.getElementById('exportReportPDF').addEventListener('click', exportReportPDF);
            
            document.getElementById('printButton').addEventListener('click', () => {
                alert('PDF gerado! (simulado)');
            });
            
            // Importação
            document.getElementById('importCollaboratorsBtn').addEventListener('click', openImportModal);
            document.getElementById('closeImportModal').addEventListener('click', closeImportModal);
            document.getElementById('cancelImport').addEventListener('click', closeImportModal);
            document.getElementById('confirmImport').addEventListener('click', confirmImport);
            document.getElementById('downloadTemplate').addEventListener('click', downloadTemplate);
            
            const fileUpload = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('spreadsheetFile');
            
            fileUpload.addEventListener('click', () => fileInput.click());
            fileUpload.addEventListener('dragover', e => e.preventDefault());
            fileUpload.addEventListener('drop', e => {
                e.preventDefault();
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect({ target: { files: e.dataTransfer.files } });
                }
            });
            
            document.getElementById('selectFileButton').addEventListener('click', (e) => {
                e.stopPropagation();
                fileInput.click();
            });
            
            fileInput.addEventListener('change', handleFileSelect);
            
            // Fechar modais clicando fora
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        if (this.id === 'collaboratorModal') closeModal();
                        if (this.id === 'departmentModal') closeDepartmentModal();
                        if (this.id === 'calculationDetailModal') closeCalculationDetailModal();
                        if (this.id === 'deleteCollaboratorModal') closeDeleteCollaboratorModal();
                        if (this.id === 'deleteUserModal') closeDeleteUserModal();
                        if (this.id === 'settingsModal') closeSettingsModal();
                        if (this.id === 'adminModal') this.classList.remove('active');
                        if (this.id === 'importSpreadsheetModal') closeImportModal();
                    }
                });
            });
            
            calcular();
        });
    </script>
</body>
</html>
