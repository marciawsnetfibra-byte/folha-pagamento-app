<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Adicionais e Reflexos da Folha de Pagamento</title>
    
    <!-- Firebase SDK - Carregamento ASSÍNCRONO -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- SheetJS para importação de planilhas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF para geração de PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Seu CSS existente - mantenha igual */
        :root {
            --cor-titulo: #1800AD;
            --cor-menu: #1800AD;
            --cor-menu-hover: #0d0066;
            --cor-importar: #10B981;
            --cor-importar-hover: #059669;
        }
        .titulo-cor {
            color: var(--cor-titulo) !important;
        }
        .main-menu {
            background-color: var(--cor-menu);
            padding: 0.75rem 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .menu-container {
            max-width: 1100px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .menu-logo {
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
        }
        .menu-logo i {
            margin-right: 8px;
        }
        .menu-items {
            display: flex;
            gap: 1rem;
        }
        .menu-button {
            background-color: transparent;
            color: white;
            border: 1px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .menu-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .menu-button.active {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .btn-importar {
            background-color: var(--cor-importar);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-importar:hover {
            background-color: var(--cor-importar-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9fafb;
            border-radius: 10px 10px 0 0;
        }
        .modal-title {
            font-weight: 600;
            color: var(--cor-titulo);
            font-size: 1.25rem;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        .modal-close:hover {
            color: #374151;
        }
        .modal-body {
            padding: 1.5rem;
        }
        .container {
            max-width: 1100px;
            margin: 40px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        input[type="text"], input[type="number"], select, input[type="month"], input[type="date"], input[type="file"] {
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
            height: 40px !important;
            line-height: normal;
        }
        #printButton, #clearButton, #saveButton, #loadDataButton, #exportDataButton {
            color: var(--cor-titulo);
            border: 1px solid transparent;
            margin-left: 10px;
        }
        #printButton:hover, #clearButton:hover, #saveButton:hover, #loadDataButton:hover, #exportDataButton:hover {
             border: 1px solid var(--cor-titulo);
             background-color: #f0f4ff;
        }
        .save-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .collaborator-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            background-color: white;
            margin-top: 10px;
        }
        .collaborator-item {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .collaborator-item:hover {
            background-color: #f0f4ff;
        }
        .collaborator-item:last-child {
            border-bottom: none;
        }
        .collaborator-name {
            font-weight: 600;
            color: var(--cor-titulo);
        }
        .collaborator-details {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 4px;
        }
        .delete-btn {
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .delete-btn:hover {
            background-color: #fee2e2;
        }
        .collaborator-table, .department-table, .history-table, .import-preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .collaborator-table th, .department-table th, .history-table th, .import-preview-table th {
            background-color: #f3f4f6;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        .collaborator-table td, .department-table td, .history-table td, .import-preview-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .collaborator-table tr:hover, .department-table tr:hover, .history-table tr:hover, .import-preview-table tr:hover {
            background-color: #f9fafb;
        }
        .department-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .import-preview-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .status-toggle-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f3f4f6;
            border-radius: 8px;
        }
        .status-toggle-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .status-toggle-btn.active {
            background-color: var(--cor-titulo);
            color: white;
            border-color: var(--cor-titulo);
        }
        .status-toggle-btn:not(.active) {
            background-color: white;
            color: var(--cor-titulo);
            border-color: #d1d5db;
        }
        .status-toggle-btn:not(.active):hover {
            background-color: #f0f4ff;
        }
        .info-box {
            background-color: #e0f2fe;
            border-left: 4px solid #0369a1;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 4px;
        }
        .firebase-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .firebase-connected {
            background-color: #10B981;
            color: white;
        }
        .firebase-disconnected {
            background-color: #EF4444;
            color: white;
        }
        .firebase-loading {
            background-color: #F59E0B;
            color: white;
        }
        .firebase-offline {
            background-color: #6B7280;
            color: white;
        }
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .login-tabs {
            display: flex;
            gap: 1px;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        .login-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        .login-tab.active {
            background-color: var(--cor-titulo);
            color: white;
        }
        .sync-badge {
            background-color: #3B82F6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 14px;
            margin-left: 20px;
        }
        .login-error {
            display: none;
            background-color: #FEE2E2;
            border: 1px solid #FECACA;
            color: #DC2626;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        .login-error.show {
            display: block;
        }
        .column-toggle-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .column-toggle-btn.active {
            background-color: var(--cor-titulo);
            color: white;
            border-color: var(--cor-titulo);
        }
        .column-toggle-btn:not(.active):hover {
            background-color: #f3f4f6;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 14px;
        }
        .report-table th {
            background-color: var(--cor-titulo);
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .report-table td {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        .report-table tr:hover {
            background-color: #f0f4ff;
        }
        .report-table tr.total-row {
            background-color: #e0f2fe;
            font-weight: bold;
        }
        .report-summary {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .no-results {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        .filter-badge {
            display: inline-flex;
            align-items: center;
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .filter-badge i {
            margin-left: 6px;
            cursor: pointer;
        }
        .reflexo-destaque {
            background-color: #f0f9ff;
            border-left: 4px solid #0369a1;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .reflexo-total {
            font-weight: bold;
            color: #0369a1;
        }
        .view-mode input, .view-mode select {
            background-color: #f3f4f6 !important;
            color: #4b5563 !important;
            border: 1px solid #d1d5db !important;
            cursor: not-allowed;
        }
        .edit-btn {
            background-color: #3B82F6;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .edit-btn:hover {
            background-color: #2563EB;
        }
        .payment-info {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .edit-mode input, .edit-mode select {
            background-color: white !important;
            color: #111827 !important;
            border: 1px solid #d1d5db !important;
            cursor: text !important;
        }
        .edit-mode input[readonly], .edit-mode select[readonly] {
            background-color: #f3f4f6 !important;
        }
        .periculosidade-info {
            background-color: #fef9e7;
            border-left: 4px solid #f39c12;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .periculosidade-detalhe {
            font-size: 0.8rem;
            color: #555;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed #ccc;
        }
        .success-message {
            background-color: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .warning-message {
            background-color: #fffbeb;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .import-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }
        .stat-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--cor-titulo);
        }
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background-color: #f9fafb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .file-upload-area:hover {
            border-color: var(--cor-importar);
            background-color: #f0fdf4;
        }
        .file-upload-area i {
            font-size: 48px;
            color: var(--cor-importar);
            margin-bottom: 12px;
        }
        .moeda-br {
            color: var(--cor-titulo);
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <!-- Status do Firebase -->
    <div id="firebaseStatus" class="firebase-status firebase-loading">
        <i class="fas fa-sync fa-spin"></i>
        <span>Carregando sistema...</span>
    </div>

    <!-- Modal de Login -->
    <div id="loginModal" class="login-modal">
        <div class="login-box">
            <h2 class="text-2xl font-bold titulo-cor mb-2">Acesso ao Sistema</h2>
            <p class="mb-6 text-gray-600 text-sm">Faça login para sincronizar seus dados na nuvem</p>
            
            <div class="login-tabs">
                <button class="login-tab active" id="tabLogin">Entrar</button>
                <button class="login-tab" id="tabSignup">Cadastrar</button>
            </div>
            
            <div id="loginError" class="login-error">
                <i class="fas fa-exclamation-circle mr-1"></i>
                <span id="errorText">Mensagem de erro aparecerá aqui</span>
            </div>
            
            <div id="loginForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="loginEmail" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="seu@email.com" autocomplete="username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                        <input type="password" id="loginPassword" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="••••••••" autocomplete="current-password">
                    </div>
                    <button id="btnLogin" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-medium transition duration-150">
                        <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                    </button>
                </div>
            </div>
            
            <div id="signupForm" style="display: none;">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="signupEmail" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="seu@email.com" autocomplete="username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Senha (mínimo 6 caracteres)</label>
                        <input type="password" id="signupPassword" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="••••••••" autocomplete="new-password">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar Senha</label>
                        <input type="password" id="signupConfirmPassword" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="••••••••" autocomplete="new-password">
                    </div>
                    <button id="btnSignup" class="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 font-medium transition duration-150">
                        <i class="fas fa-user-plus mr-2"></i>Criar Conta
                    </button>
                </div>
            </div>
            
            <div class="mt-6 pt-6 border-t text-center">
                <button id="btnContinueOffline" class="text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fas fa-laptop mr-1"></i>Continuar sem login (apenas local)
                </button>
            </div>
            
            <div class="mt-4 text-xs text-gray-500">
                <p><i class="fas fa-info-circle mr-1"></i> Com login, seus dados serão salvos na nuvem e poderão ser acessados de qualquer dispositivo.</p>
            </div>
        </div>
    </div>

    <!-- MODAL DE IMPORTAÇÃO DE PLANILHA -->
    <div class="modal" id="importSpreadsheetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-excel mr-2 text-green-600"></i>
                    Importar Colaboradores de Planilha
                </h3>
                <button class="modal-close" id="closeImportModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="importMessages"></div>
                
                <div class="info-box mb-6">
                    <strong><i class="fas fa-info-circle mr-2"></i>Formato da Planilha:</strong>
                    <p class="mt-2 text-sm">Sua planilha deve conter as seguintes colunas:</p>
                    <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                        <li><span class="font-medium">Nome</span> - Nome completo do colaborador</li>
                        <li><span class="font-medium">Departamento</span> - Nome do departamento</li>
                        <li><span class="font-medium">Salário</span> - Valor em R$ (ex: R$ 2.500,00 ou 2500,00)</li>
                        <li><span class="font-medium">Periculosidade</span> - "Sim" ou "Não"</li>
                        <li><span class="font-medium">Horas Mensais</span> - 220, 180, 170, etc (opcional - padrão 220)</li>
                    </ul>
                    <p class="mt-2 text-xs text-gray-600">
                        <i class="fas fa-download mr-1"></i> 
                        <a href="#" id="downloadTemplate" class="text-blue-600 hover:underline">Baixar modelo de planilha</a>
                    </p>
                </div>

                <div class="file-upload-area" id="fileUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">
                        Clique para selecionar ou arraste o arquivo
                    </h4>
                    <p class="text-sm text-gray-500 mb-4">
                        Formatos aceitos: .xlsx, .xls, .csv
                    </p>
                    <input type="file" id="spreadsheetFile" accept=".xlsx,.xls,.csv" class="hidden">
                    <button id="selectFileButton" class="btn-importar mx-auto">
                        <i class="fas fa-file-excel mr-2"></i>
                        Selecionar Arquivo
                    </button>
                </div>

                <div id="importPreview" style="display: none;">
                    <h4 class="font-bold text-lg titulo-cor mt-6 mb-3">
                        <i class="fas fa-eye mr-2"></i>
                        Prévia dos Dados
                    </h4>
                    
                    <div id="importStats" class="import-stats"></div>
                    
                    <div class="import-preview-container">
                        <table class="import-preview-table">
                            <thead id="previewTableHeader"></thead>
                            <tbody id="previewTableBody"></tbody>
                        </table>
                    </div>

                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                        <button type="button" id="cancelImport" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="button" id="confirmImport" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            <i class="fas fa-check-circle mr-2"></i>
                            Confirmar Importação
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MENU HORIZONTAL -->
    <nav class="main-menu print-hide">
        <div class="menu-container">
            <div class="menu-logo">
                <i class="fas fa-calculator"></i>
                <span>Folha de Pagamento</span>
                <div id="userInfo" class="user-info" style="display: none;">
                    <i class="fas fa-user-circle"></i>
                    <span id="userEmail"></span>
                </div>
            </div>
            <div class="menu-items">
                <button class="menu-button active" id="menuCalculator">
                    <i class="fas fa-calculator"></i> Calculadora
                </button>
                <button class="menu-button" id="menuCollaborators">
                    <i class="fas fa-users"></i> Colaboradores
                </button>
                <button class="menu-button" id="menuHistory">
                    <i class="fas fa-history"></i> Histórico
                </button>
                <button class="menu-button" id="menuReports">
                    <i class="fas fa-chart-bar"></i> Relatórios
                </button>
                <button class="menu-button" id="btnLogout" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </div>
    </nav>

    <!-- MODAL DE CADASTRO DE COLABORADOR E DEPARTAMENTO -->
    <div class="modal" id="collaboratorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="collaboratorModalTitle">Cadastrar Novo Colaborador</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="collaboratorForm">
                    <input type="hidden" id="collaboratorEditId">
                    <div class="space-y-4">
                        <div>
                            <label for="collaboratorName" class="block text-sm font-medium text-gray-700 mb-1">
                                Nome Completo *
                            </label>
                            <input type="text" id="collaboratorName" required class="w-full" placeholder="Ex: João da Silva">
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label for="collaboratorDepartment" class="block text-sm font-medium text-gray-700">
                                    Departamento *
                                </label>
                                <button type="button" id="addDepartmentFromCollaborator" class="text-blue-600 hover:text-blue-800 text-xs">
                                    <i class="fas fa-plus mr-1"></i> Novo Departamento
                                </button>
                            </div>
                            <select id="collaboratorDepartment" required class="w-full">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div>
                            <label for="collaboratorBaseSalary" class="block text-sm font-medium text-gray-700 mb-1">
                                Salário Base (R$) *
                            </label>
                            <input type="text" id="collaboratorBaseSalary" required class="w-full" placeholder="Ex: R$ 2.500,00">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="collaboratorDivisor" class="block text-sm font-medium text-gray-700 mb-1">
                                    Horas Mensais *
                                </label>
                                <select id="collaboratorDivisor" required class="w-full">
                                    <option value="220" selected>220 horas (Padrão)</option>
                                    <option value="180">180 horas</option>
                                    <option value="170">170 horas (Reduzido)</option>
                                    <option value="200">200 horas</option>
                                </select>
                            </div>
                            <div>
                                <label for="collaboratorWorkHours" class="block text-sm font-medium text-gray-700 mb-1">
                                    Jornada Diária
                                </label>
                                <select id="collaboratorWorkHours" class="w-full">
                                    <option value="8">8 horas</option>
                                    <option value="6">6 horas</option>
                                    <option value="4">4 horas</option>
                                    <option value="12">12x36</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="collaboratorPericulosidade" class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                                <label for="collaboratorPericulosidade" class="text-sm font-medium text-gray-700">
                                    Recebe Periculosidade?
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="collaboratorInsalubridade" class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                                <label for="collaboratorInsalubridade" class="text-sm font-medium text-gray-700">
                                    Recebe Insalubridade?
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                        <button type="button" id="cancelCollaborator" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <span id="collaboratorModalButton">Salvar Colaborador</span>
                            <span id="syncBadge" class="sync-badge ml-2" style="display: none;">Cloud</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL DE CADASTRO/EDIÇÃO DE DEPARTAMENTO -->
    <div class="modal" id="departmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="departmentModalTitle">Cadastrar Novo Departamento</h3>
                <button class="modal-close" id="closeDepartmentModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="departmentForm">
                    <div class="space-y-4">
                        <div>
                            <label for="departmentName" class="block text-sm font-medium text-gray-700 mb-1">
                                Nome do Departamento *
                            </label>
                            <input type="text" id="departmentName" required class="w-full" placeholder="Ex: Produção">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="departmentActive" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                            <label for="departmentActive" class="text-sm font-medium text-gray-700">
                                Departamento Ativo
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                        <button type="button" id="cancelDepartment" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <span id="departmentModalButton">Salvar Departamento</span>
                            <span id="syncBadgeDept" class="sync-badge ml-2" style="display: none;">Cloud</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL DE DETALHES DO CÁLCULO (APENAS LEITURA) -->
    <div class="modal" id="calculationDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="calculationDetailTitle">Detalhes do Cálculo</h3>
                <button class="modal-close" id="closeCalculationDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="calculationDetailContent" class="view-mode">
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t" id="detailButtonsContainer">
                    <button type="button" id="closeCalculationDetail" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                        Fechar
                    </button>
                    <button type="button" id="editCalculationBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        <i class="fas fa-edit mr-1"></i> Editar
                    </button>
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t hidden" id="editButtonsContainer">
                    <button type="button" id="cancelEditBtn" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="button" id="saveEditBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                        <i class="fas fa-save mr-1"></i> Salvar Alterações
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTEÚDO PRINCIPAL (CALCULADORA) -->
    <div class="container" id="calculatorContent">
        <h1 class="text-3xl font-bold titulo-cor text-center mb-6 border-b pb-2">
            Calculadora de Adicionais e Reflexos da Folha de Pagamento
            <span id="cloudStatusBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
        </h1>
        
        <!-- Seletor de Colaborador -->
        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg titulo-cor mb-2">Selecionar Colaborador</h3>
                    <p class="text-sm text-gray-600">Escolha um colaborador cadastrado para preencher os dados automaticamente</p>
                </div>
                <button id="refreshCollaborators" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
            </div>
            <div class="mt-3">
                <select id="collaboratorSelect" class="w-full">
                    <option value="">-- Selecione um colaborador --</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Coluna de Entradas (Inputs) -->
            <div id="input-container">
                <h2 class="text-xl font-semibold mb-4 titulo-cor">Entradas de Dados</h2>

                <div class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Salário e Divisor</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="salarioBase" class="block text-sm font-medium text-gray-700">Salário Base (R$)</label>
                            <input type="text" id="salarioBase" value="" class="mt-1" placeholder="Ex: R$ 1.518,00">
                        </div>
                        <div>
                            <label for="divisorMensal" class="block text-sm font-medium text-gray-700">Horas Mensais</label>
                            <select id="divisorMensal" class="mt-1">
                                <option value="220" selected>220 (Padrão)</option>
                                <option value="180">180 horas</option>
                                <option value="170">170 (Reduzido)</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex items-center mt-4 pt-2 border-t">
                        <input type="checkbox" id="usaPericulosidade" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                        <label for="usaPericulosidade" class="text-sm font-medium text-gray-700">Incluir Adicional de Periculosidade (30%)</label>
                         <span id="valorPericulosidadeInputDisplay" class="ml-auto font-bold titulo-cor">R$ 0,00</span>
                    </div>
                </div>
                
                <div class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Horas de Adicionais</h3>
                    <div class="grid grid-cols-4 gap-4">
                        <div>
                            <label for="horasSobreavisoTotal" class="block text-sm font-medium text-gray-700">Horas de Sobreaviso</label>
                            <input type="text" id="horasSobreavisoTotal" value="00:00" placeholder="HH:MM" class="mt-1 text-center">
                        </div>
                        <div>
                            <label for="horasTrabalhadas50" class="block text-sm font-medium text-gray-700">Horas de Sobreaviso Trabalhado</label>
                            <input type="text" id="horasTrabalhadas50" value="00:00" placeholder="HH:MM" class="mt-1 text-center">
                        </div>
                        <div>
                            <label for="horasTrabalhadas100" class="block text-sm font-medium text-gray-700">Horas Extras 50% (Normal)</label>
                            <input type="text" id="horasTrabalhadas100" value="00:00" placeholder="HH:MM" class="mt-1 text-center">
                        </div>
                         <div>
                            <label for="horasNoturnas" class="block text-sm font-medium text-gray-700">Horas de Adicional Noturno</label>
                            <input type="text" id="horasNoturnas" value="00:00" placeholder="HH:MM" class="mt-1 text-center">
                        </div>
                    </div>
                </div>

                <div class="space-y-4 mb-6 p-4 bg-green-50 rounded-lg border">
                    <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Informações de Pagamento</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="pagoFolha" class="h-4 w-4 text-green-600 border-gray-300 rounded mr-2">
                            <label for="pagoFolha" class="text-sm font-medium text-gray-700">
                                Pago em Folha?
                            </label>
                        </div>
                        <div>
                            <label for="competenciaPagamento" class="block text-sm font-medium text-gray-700">Competência</label>
                            <input type="month" id="competenciaPagamento" class="mt-1">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500">Marque se o valor já foi pago na folha de pagamento e informe a competência</p>
                </div>

                <div class="space-y-4 p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Fator DSR, Dias e Ausências</h3>
                    <div class="grid grid-cols-4 gap-4">
                         <div>
                            <label for="mesReferencia" class="block text-sm font-medium text-gray-700">Mês Ref.</label>
                            <input type="month" id="mesReferencia" class="mt-1">
                        </div>
                        <div>
                            <label for="diasTrabalhados" class="block text-sm font-medium text-gray-700">Dias Normais (Presença)</label>
                            <input type="number" id="diasTrabalhados" min="1" max="30" value="30" class="mt-1 text-center">
                            <p class="text-xs text-blue-600 font-medium">Sempre 30 dias por padrão</p>
                        </div>
                         <div>
                            <label for="diasAtestado" class="block text-sm font-medium text-gray-700">Dias de Atestado</label>
                            <input type="number" id="diasAtestado" value="0" min="0" class="mt-1 text-center">
                            <p class="text-xs text-red-500">Afeta Periculosidade e Dias Normais.</p>
                        </div>
                        <div class="holidays-field-container">
                            <label for="diasFeriado" class="block text-sm font-medium text-gray-700">Feriados (Após Dias Trabalhados)</label>
                            <input type="number" id="diasFeriado" value="0" min="0" class="mt-1 text-center w-full">
                            <p class="text-xs text-gray-500">Feriados após os dias trabalhados</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coluna de Resultados -->
            <div>
                <h2 class="text-xl font-semibold mb-4 titulo-cor">Resultados e Bases</h2>

                <div class="space-y-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200 mb-6">
                    <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Adicionais e Periculosidade</h3>
                    
                    <div id="periculosidadeDetalhada" class="text-xs text-gray-600 mb-2" style="display: none;">
                    </div>
                    
                    <div class="flex justify-between text-base font-semibold">
                        <span>Periculosidade (30%)</span>
                        <span id="valorPericulosidade" class="titulo-cor">R$ 0,00</span>
                    </div>

                    <div class="flex justify-between text-sm">
                        <span>Horas de Sobreaviso (Espera):</span>
                        <span id="valorSobreavisoEspera" class="titulo-cor">R$ 0,00</span>
                    </div>

                    <div class="flex justify-between text-sm">
                        <span>Horas de Sobreaviso Trabalhado (50%):</span>
                        <span id="valorHoraExtraTrabalho50" class="titulo-cor">R$ 0,00</span>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span>Horas Extras 50% (Normal):</span>
                        <span id="valorHoraExtraTrabalho100" class="titulo-cor">R$ 0,00</span>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span>Horas de Adicional Noturno:</span>
                        <span id="valorAdicionalNoturno" class="titulo-cor">R$ 0,00</span>
                    </div>
                </div>

                <div class="space-y-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                    <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Reflexos DSR (Fator: <span id="fatorDSRDisplay" class="font-extrabold">0.0000</span>)</h3>
                    <p class="text-xs text-gray-600 italic mb-2">Fator DSR = (Domingos + Feriados) ÷ (Dias Úteis Base - Feriados)</p>
                    
                    <div class="flex justify-between text-sm">
                        <span>Reflexo Sobreaviso DSR (Espera 1/3):</span>
                        <span id="valorReflexoSobreavisoEspera" class="text-indigo-700 font-semibold">R$ 0,00</span>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span>Reflexo Sob. Trabalhado DSR (HE 50%):</span>
                        <span id="valorReflexoSobreavisoTrabalhado" class="text-indigo-700 font-semibold">R$ 0,00</span>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span>Reflexo Horas Extras DSR (Normal 50%):</span>
                        <span id="valorReflexoHorasExtrasNormal" class="text-indigo-700 font-semibold">R$ 0,00</span>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span>Reflexo Adic. Noturno DSR:</span>
                        <span id="valorReflexoAdicionalNoturno" class="text-indigo-700 font-semibold">R$ 0,00</span>
                    </div>

                    <div class="flex justify-between text-lg font-bold pt-2 border-t border-indigo-300">
                        <span>TOTAL DOS REFLEXOS:</span>
                        <span id="valorReflexoDSRTotalSum" class="titulo-cor">R$ 0,00</span>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button id="toggleBases" class="toggle-bases-btn w-full text-left p-3 bg-indigo-100 hover:bg-indigo-200 rounded-lg border border-indigo-300 transition duration-150 mb-4">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-lg titulo-cor">Base de cálculo por hora</h3>
                            <span class="text-indigo-600">
                                <i class="fas fa-chevron-down" id="basesIcon"></i>
                            </span>
                        </div>
                    </button>
                    
                    <div id="basesContainer" class="p-4 bg-indigo-50 rounded-lg border border-indigo-200 space-y-4 hidden">
                        <div class="grid grid-cols-2 gap-4 mb-4 pb-4 border-b">
                            <div>
                                <label for="diasDomingo" class="block text-sm font-medium text-gray-700 mb-1">Domingos (Total Mês)</label>
                                <input type="number" id="diasDomingo" value="4" min="0" readonly class="mt-1 bg-gray-200 text-center">
                                <p class="text-xs text-gray-500 mt-1">Total de domingos no mês</p>
                            </div>
                            <div>
                                <label for="diasUteis" class="block text-sm font-medium text-gray-700 mb-1">Dias Úteis Base</label>
                                <input type="number" id="diasUteis" value="26" min="1" readonly data-base-value="26" class="mt-1 bg-indigo-100 font-bold text-center">
                                <p class="text-xs text-gray-500 mt-1">Total dias - domingos (base para DSR)</p>
                            </div>
                        </div>
                        
                        <div class="flex justify-between text-sm">
                            <span>Hora Normal:</span>
                            <span id="horaNormal" class="font-semibold titulo-cor">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Hora Sob. (1/3):</span>
                            <span id="horaSobreaviso" class="font-semibold titulo-cor">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Base p/ HE (c/ Peric.):</span>
                            <span id="baseHePeric" class="font-semibold titulo-cor">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Hora Extra (50% c/ Peric.):</span>
                            <span id="horaExtra50" class="font-semibold titulo-cor">R$ 0,00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOTÕES DE AÇÃO NO FINAL DA PÁGINA -->
        <div class="flex flex-wrap justify-end gap-4 mt-12 print-hide border-t pt-6">
            <button id="saveCalculation" class="bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                <i class="fas fa-save mr-1"></i> Salvar Cálculo
                <span id="saveCloudBadge" class="sync-badge ml-2" style="display: none;">Cloud</span>
            </button>
            <button id="clearButton" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                <i class="fas fa-eraser mr-1"></i> Limpar
            </button>
            <button id="printButton" class="text-sm font-semibold py-2 px-4 rounded-lg transition duration-150">
                <i class="fas fa-print mr-1"></i> Salvar em PDF
            </button>
        </div>
    </div>

    <!-- CONTEÚDO DE LISTA DE COLABORADORES (COM DEPARTAMENTOS INTEGRADOS) -->
    <div class="container hidden" id="collaboratorsContent">
        <h1 class="text-3xl font-bold titulo-cor text-center mb-6 border-b pb-2">
            <i class="fas fa-users mr-2"></i> Gerenciar Colaboradores
            <span id="cloudCollaboratorBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
        </h1>
        
        <div class="mb-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tabCollaborators" class="tab-button border-b-2 border-blue-500 text-blue-600 py-4 px-1 text-sm font-medium active">
                        <i class="fas fa-users mr-2"></i> Colaboradores
                    </button>
                    <button id="tabDepartments" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                        <i class="fas fa-building mr-2"></i> Departamentos
                    </button>
                </nav>
            </div>
        </div>
        
        <div id="collaboratorsTabContent">
            <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex flex-wrap gap-2">
                        <button id="addNewCollaborator" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center">
                            <i class="fas fa-user-plus mr-2"></i> Novo Colaborador
                        </button>
                        <button id="importCollaboratorsBtn" class="btn-importar">
                            <i class="fas fa-file-import mr-2"></i> Importar Planilha
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <button id="refreshCollaboratorList" class="text-blue-600 hover:text-blue-800 px-3 py-1">
                            <i class="fas fa-sync-alt mr-1"></i> Atualizar
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="status-toggle-buttons print-hide">
                <button class="status-toggle-btn active" id="showActiveCollaborators">
                    <i class="fas fa-user-check mr-1"></i> Ativos
                </button>
                <button class="status-toggle-btn" id="showInactiveCollaborators">
                    <i class="fas fa-user-slash mr-1"></i> Inativos
                </button>
            </div>
            
            <div id="collaboratorsTableContainer">
            </div>
        </div>
        
        <div id="departmentsTabContent" class="hidden">
            <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg titulo-cor">Gerenciar Departamentos</h3>
                        <p class="text-sm text-gray-600">Adicione, edite ou exclua departamentos da empresa</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="refreshDepartments" class="text-blue-600 hover:text-blue-800 px-3 py-1">
                            <i class="fas fa-sync-alt mr-1"></i> Atualizar
                        </button>
                        <button id="addNewDepartment" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
                            <i class="fas fa-plus mr-1"></i> Novo Departamento
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="departmentsTableContainer">
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-building fa-3x mb-4"></i>
                    <p class="text-lg">Nenhum departamento cadastrado ainda.</p>
                    <p class="text-sm">Clique em "Novo Departamento" para cadastrar seu primeiro departamento.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTEÚDO DE HISTÓRICO DE CÁLCULOS - SIMPLIFICADO -->
    <div class="container hidden" id="historyContent">
        <h1 class="text-3xl font-bold titulo-cor text-center mb-6 border-b pb-2">
            <i class="fas fa-history mr-2"></i> Histórico de Cálculos
            <span id="cloudHistoryBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
        </h1>
        
        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                <div>
                    <h3 class="font-bold text-lg titulo-cor">Histórico de Cálculos</h3>
                    <p class="text-sm text-gray-600">Visualize todos os cálculos salvos em formato de tabela</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button id="refreshHistory" class="text-blue-600 hover:text-blue-800 px-3 py-2">
                        <i class="fas fa-sync-alt mr-1"></i> Atualizar
                    </button>
                    <button id="clearHistoryFilters" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded">
                        <i class="fas fa-filter-circle-xmark mr-1"></i> Limpar Filtros
                    </button>
                </div>
            </div>
            
            <div id="historyFilters" class="mt-4 p-4 bg-white rounded border">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Colaborador</label>
                        <select id="filterCollaborator" class="w-full">
                            <option value="">Todos os colaboradores</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Departamento</label>
                        <select id="filterDepartment" class="w-full">
                            <option value="">Todos os departamentos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Período Início</label>
                        <input type="month" id="filterStartMonth" class="w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Período Fim</label>
                        <input type="month" id="filterEndMonth" class="w-full">
                    </div>
                </div>
                <div class="flex justify-end mt-4">
                    <button id="applyFilters" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Mês Referência</th>
                        <th>Colaborador</th>
                        <th>Departamento</th>
                        <th>Data Cálculo</th>
                        <th>Pago em Folha</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-history fa-3x mb-4"></i>
                            <p class="text-lg">Nenhum cálculo salvo ainda.</p>
                            <p class="text-sm">Faça cálculos na aba "Calculadora" e salve-os para ver o histórico aqui.</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- NOVA ABA: RELATÓRIOS SIMPLIFICADA -->
    <div class="container hidden" id="reportsContent">
        <h1 class="text-3xl font-bold titulo-cor text-center mb-6 border-b pb-2">
            <i class="fas fa-chart-bar mr-2"></i> Relatórios de Cálculos
            <span id="cloudReportsBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
        </h1>
        
        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="font-bold text-lg titulo-cor">Relatórios Personalizados</h3>
                    <p class="text-sm text-gray-600">Gere relatórios com filtros específicos para análise de dados</p>
                </div>
                <button id="refreshReports" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-sync-alt mr-1"></i> Atualizar
                </button>
            </div>
            
            <div class="p-4 bg-white rounded border mb-4">
                <h4 class="font-bold text-md titulo-cor mb-3">Filtros de Relatório</h4>
                
                <div class="mb-4 p-3 bg-gray-50 rounded border">
                    <h5 class="font-medium text-sm text-gray-700 mb-2">Colunas do Relatório</h5>
                    <p class="text-xs text-gray-600 mb-3">Selecione as colunas que deseja exibir. O TOTAL GERAL considerará APENAS as colunas selecionadas, incluindo os REFLEXOS correspondentes!</p>
                    
                    <div class="flex flex-wrap gap-2">
                        <button class="column-toggle-btn active" data-column="colaborador">
                            <i class="fas fa-user mr-1"></i> Colaborador
                        </button>
                        <button class="column-toggle-btn active" data-column="departamento">
                            <i class="fas fa-building mr-1"></i> Departamento
                        </button>
                        <button class="column-toggle-btn active" data-column="salario">
                            <i class="fas fa-money-bill mr-1"></i> Salário
                        </button>
                        <button class="column-toggle-btn active" data-column="periculosidade">
                            <i class="fas fa-exclamation-triangle mr-1"></i> Periculosidade
                        </button>
                        <button class="column-toggle-btn active" data-column="sobreaviso">
                            <i class="fas fa-clock mr-1"></i> Horas Sobreaviso
                        </button>
                        <button class="column-toggle-btn active" data-column="sobreaviso_trabalhado">
                            <i class="fas fa-clock mr-1"></i> Sob. Trabalhado
                        </button>
                        <button class="column-toggle-btn active" data-column="horas_extras">
                            <i class="fas fa-clock mr-1"></i> Horas Extras
                        </button>
                        <button class="column-toggle-btn active" data-column="adicional_noturno">
                            <i class="fas fa-moon mr-1"></i> Ad. Noturno
                        </button>
                        <button class="column-toggle-btn active" data-column="reflexos">
                            <i class="fas fa-calculator mr-1"></i> Reflexos
                        </button>
                        <button class="column-toggle-btn active" data-column="total">
                            <i class="fas fa-calculator mr-1"></i> Total
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Colaborador</label>
                        <select id="reportCollaborator" class="w-full">
                            <option value="">Todos os colaboradores</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Departamento</label>
                        <select id="reportDepartment" class="w-full">
                            <option value="">Todos os departamentos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mês Referência</label>
                        <input type="month" id="reportMonth" class="w-full">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Início</label>
                        <input type="date" id="reportStartDate" class="w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Fim</label>
                        <input type="date" id="reportEndDate" class="w-full">
                    </div>
                </div>
                
                <div id="activeFilters" class="mb-4 hidden">
                    <h5 class="text-sm font-medium text-gray-700 mb-2">Filtros Aplicados:</h5>
                    <div id="filterBadges"></div>
                </div>
                
                <div class="flex justify-between">
                    <button id="clearReportFilters" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded">
                        <i class="fas fa-filter-circle-xmark mr-1"></i> Limpar Filtros
                    </button>
                    <button id="generateReport" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-filter mr-1"></i> Filtrar
                    </button>
                </div>
            </div>
        </div>
        
        <div class="mt-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg titulo-cor">Relatório Detalhado</h3>
                <div class="flex gap-2">
                    <button id="exportReportCSV" class="bg-green-100 hover:bg-green-200 text-green-800 font-semibold py-2 px-4 rounded text-sm">
                        <i class="fas fa-file-csv mr-1"></i> CSV
                    </button>
                    <button id="exportReportPDF" class="bg-red-100 hover:bg-red-200 text-red-800 font-semibold py-2 px-4 rounded text-sm">
                        <i class="fas fa-file-pdf mr-1"></i> PDF
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="report-table" id="reportTable">
                    <thead>
                        <tr id="reportTableHeader">
                            <th>COLABORADOR</th>
                            <th>DEPARTAMENTO</th>
                            <th>SALÁRIO</th>
                            <th>PERICULOSIDADE</th>
                            <th>HORAS DE SOBREAVISO</th>
                            <th>VALOR</th>
                            <th>HORAS DE SOBREAVISO TRABALHADO</th>
                            <th>VALOR</th>
                            <th>HORAS EXTRAS</th>
                            <th>VALOR</th>
                            <th>HORAS DE ADCIONAL NOTURNO</th>
                            <th>VALOR</th>
                            <th>REFLEXOS DSR</th>
                            <th>VALOR TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <tr>
                            <td colspan="14" class="no-results">
                                <i class="fas fa-chart-bar fa-3x mb-4"></i>
                                <p class="text-lg">Nenhum relatório gerado ainda.</p>
                                <p class="text-sm">Configure os filtros acima e clique em "Filtrar".</p>
                            </td>
                        </tr>
                </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURAÇÃO DO FIREBASE - CORRIGIDA
        // ============================================
        (function() {
            // Configuração completa do Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyDUyddWZtEOMYsP2ZoaeJLU2OdgV9E1l94",
                authDomain: "calculadora-folha-pagamento.firebaseapp.com",
                projectId: "calculadora-folha-pagamento",
                storageBucket: "calculadora-folha-pagamento.firebasestorage.app",
                messagingSenderId: "286786547060",
                appId: "1:286786547060:web:74c68fef3dd79fc61a9021",
                measurementId: "G-BHGRTCWWYK",
                databaseURL: "https://calculadora-folha-pagamento-default-rtdb.firebaseio.com" // ADICIONADO
            };

            // Inicializar Firebase APENAS se ainda não foi inicializado
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                try {
                    firebase.initializeApp(firebaseConfig);
                    console.log("✅ Firebase inicializado com sucesso!");
                } catch (error) {
                    console.error("❌ Erro ao inicializar Firebase:", error);
                }
            }
        })();

        // ============================================
        // VARIÁVEIS GLOBAIS
        // ============================================
        let db = null;
        let auth = null;
        let currentUser = null;
        let isOnline = false;
        let userData = null;
        let currentCalculationDetailId = null;
        let importData = null;
        
        // Variáveis para relatórios
        let activeReportFilters = {};
        let visibleColumns = {
            colaborador: true,
            departamento: true,
            salario: true,
            periculosidade: true,
            sobreaviso: true,
            sobreaviso_trabalhado: true,
            horas_extras: true,
            adicional_noturno: true,
            reflexos: true,
            total: true
        };

        // Inicializar Firebase Services
        if (typeof firebase !== 'undefined') {
            try {
                db = firebase.firestore();
                auth = firebase.auth();
                console.log("✅ Firestore e Auth inicializados");
            } catch (error) {
                console.error("❌ Erro ao inicializar Firestore/Auth:", error);
            }
        }

        // Constantes de armazenamento
        const COLLABORATORS_STORAGE_KEY = 'folha_colaboradores_cadastrados';
        const CALCULATIONS_STORAGE_KEY = 'folha_calculos_salvos';
        const DEPARTMENTS_STORAGE_KEY = 'folha_departamentos';
        
        const DEFAULT_DEPARTMENTS = [
            { id: 1, name: "Produção", active: true },
            { id: 2, name: "Manutenção", active: true },
            { id: 3, name: "Administrativo", active: true },
            { id: 4, name: "RH", active: true },
            { id: 5, name: "Financeiro", active: true },
            { id: 6, name: "TI", active: true },
            { id: 7, name: "Comercial", active: true },
            { id: 8, name: "Logística", active: true },
            { id: 9, name: "Qualidade", active: true },
            { id: 10, name: "Segurança", active: true }
        ];

        // Formatação de moeda
        const R$ = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

        // ============================================
        // FUNÇÕES DE ARMAZENAMENTO LOCAL
        // ============================================
        function getDepartmentsFromStorage() {
            try {
                const savedData = localStorage.getItem(DEPARTMENTS_STORAGE_KEY);
                return savedData ? JSON.parse(savedData) : [];
            } catch (e) {
                console.error("Erro ao ler departamentos:", e);
                return [];
            }
        }
        
        function getCollaboratorsFromStorage() {
            try {
                const savedData = localStorage.getItem(COLLABORATORS_STORAGE_KEY);
                return savedData ? JSON.parse(savedData) : [];
            } catch (e) {
                console.error("Erro ao ler colaboradores:", e);
                return [];
            }
        }
        
        function getCalculationsFromStorage() {
            try {
                const savedData = localStorage.getItem(CALCULATIONS_STORAGE_KEY);
                return savedData ? JSON.parse(savedData) : [];
            } catch (e) {
                console.error("Erro ao ler cálculos:", e);
                return [];
            }
        }
        
        function getDepartments() {
            const savedData = localStorage.getItem(DEPARTMENTS_STORAGE_KEY);
            if (!savedData) {
                saveDepartmentsToStorage(DEFAULT_DEPARTMENTS);
                return DEFAULT_DEPARTMENTS;
            }
            try {
                return JSON.parse(savedData);
            } catch (e) {
                console.error("Erro ao parsear departamentos:", e);
                return DEFAULT_DEPARTMENTS;
            }
        }
        
        function getCollaborators() {
            const savedData = localStorage.getItem(COLLABORATORS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        function getSavedCalculations() {
            const savedData = localStorage.getItem(CALCULATIONS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        function saveDepartmentsToStorage(departments) {
            localStorage.setItem(DEPARTMENTS_STORAGE_KEY, JSON.stringify(departments));
        }
        
        function saveCollaboratorsToStorage(collaborators) {
            localStorage.setItem(COLLABORATORS_STORAGE_KEY, JSON.stringify(collaborators));
        }
        
        function saveCalculationsToStorage(calculations) {
            localStorage.setItem(CALCULATIONS_STORAGE_KEY, JSON.stringify(calculations));
        }

        // ============================================
        // FUNÇÕES DE AUTENTICAÇÃO FIREBASE
        // ============================================
        if (auth) {
            auth.onAuthStateChanged((user) => {
                updateAuthUI(user);
                
                if (user) {
                    currentUser = user;
                    isOnline = true;
                    loadUserData();
                } else {
                    currentUser = null;
                    isOnline = false;
                    userData = null;
                }
            });
        }

        function updateAuthUI(user) {
            const statusElement = document.getElementById('firebaseStatus');
            const loginModal = document.getElementById('loginModal');
            const userInfo = document.getElementById('userInfo');
            const userEmail = document.getElementById('userEmail');
            const logoutBtn = document.getElementById('btnLogout');
            
            if (!statusElement || !loginModal) return;
            
            if (user && auth) {
                statusElement.className = 'firebase-status firebase-connected';
                statusElement.innerHTML = '<i class="fas fa-cloud"></i> <span>Sincronizado com a nuvem</span>';
                
                if (userInfo) userInfo.style.display = 'flex';
                if (userEmail) userEmail.textContent = user.email;
                if (logoutBtn) logoutBtn.style.display = 'block';
                
                if (loginModal.style.display === 'flex') {
                    loginModal.style.display = 'none';
                }
                
            } else {
                statusElement.className = 'firebase-status firebase-disconnected';
                statusElement.innerHTML = '<i class="fas fa-laptop"></i> <span>Modo offline (apenas local)</span>';
                
                if (userInfo) userInfo.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'none';
                
                // Verificar se deve mostrar modal de login
                const skipLogin = localStorage.getItem('skipLogin');
                if (auth && !skipLogin && loginModal.style.display !== 'flex') {
                    loginModal.style.display = 'flex';
                }
            }
        }

        async function loadUserData() {
            if (!currentUser || !db) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    console.log("✅ Dados do usuário carregados do Firestore");
                    
                    await syncDataWithFirebase();
                    
                } else {
                    await initializeUserData();
                }
            } catch (error) {
                console.error("❌ Erro ao carregar dados do usuário:", error);
                updateFirebaseStatus('error', 'Erro ao carregar dados da nuvem');
            }
        }

        async function initializeUserData() {
            if (!currentUser || !db) return;
            
            try {
                const initialData = {
                    email: currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    departments: getDepartments(),
                    collaborators: getCollaborators(),
                    calculations: getSavedCalculations(),
                    lastSync: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid).set(initialData);
                userData = initialData;
                console.log("✅ Dados iniciais criados no Firestore");
                
                updateFirebaseStatus('success', 'Dados sincronizados');
                
            } catch (error) {
                console.error("❌ Erro ao inicializar dados do usuário:", error);
            }
        }

        async function syncDataWithFirebase() {
            if (!currentUser || !userData || !db) return;
            
            try {
                const localDepartments = getDepartments();
                await updateFirebaseData('departments', localDepartments);
                
                const localCollaborators = getCollaborators();
                await updateFirebaseData('collaborators', localCollaborators);
                
                const localCalculations = getSavedCalculations();
                await updateFirebaseData('calculations', localCalculations);
                
                console.log("✅ Sincronização concluída");
                updateFirebaseStatus('success', 'Dados sincronizados');
                
            } catch (error) {
                console.error("❌ Erro na sincronização:", error);
                updateFirebaseStatus('error', 'Erro na sincronização');
            }
        }

        async function updateFirebaseData(field, data) {
            if (!currentUser || !db) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    [field]: data,
                    lastSync: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if (userData) {
                    userData[field] = data;
                }
                console.log(`✅ ${field} atualizados no Firebase`);
                
            } catch (error) {
                console.error(`❌ Erro ao atualizar ${field}:`, error);
                throw error;
            }
        }

        function updateFirebaseStatus(type, message) {
            const statusElement = document.getElementById('firebaseStatus');
            if (!statusElement) return;
            
            switch(type) {
                case 'success':
                    statusElement.className = 'firebase-status firebase-connected';
                    statusElement.innerHTML = `<i class="fas fa-check"></i> <span>${message}</span>`;
                    break;
                case 'error':
                    statusElement.className = 'firebase-status firebase-disconnected';
                    statusElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span>${message}</span>`;
                    break;
                case 'loading':
                    statusElement.className = 'firebase-status firebase-loading';
                    statusElement.innerHTML = `<i class="fas fa-sync fa-spin"></i> <span>${message}</span>`;
                    break;
                case 'disconnected':
                    statusElement.className = 'firebase-status firebase-offline';
                    statusElement.innerHTML = `<i class="fas fa-laptop"></i> <span>${message}</span>`;
                    break;
            }
        }

        // ============================================
        // FUNÇÕES DE ARMAZENAMENTO COM SINCRONIZAÇÃO
        // ============================================
        async function saveDepartments(departments) {
            saveDepartmentsToStorage(departments);
            
            if (currentUser && db) {
                try {
                    await updateFirebaseData('departments', departments);
                } catch (error) {
                    console.error("❌ Erro ao sincronizar departamentos:", error);
                    updateFirebaseStatus('error', 'Erro na sincronização');
                }
            }
            
            if (userData) {
                userData.departments = departments;
            }
        }
        
        async function saveCollaborators(collaborators) {
            saveCollaboratorsToStorage(collaborators);
            
            if (currentUser && db) {
                try {
                    await updateFirebaseData('collaborators', collaborators);
                } catch (error) {
                    console.error("❌ Erro ao sincronizar colaboradores:", error);
                    updateFirebaseStatus('error', 'Erro na sincronização');
                }
            }
            
            if (userData) {
                userData.collaborators = collaborators;
            }
        }
        
        async function saveCalculations(calculations) {
            saveCalculationsToStorage(calculations);
            
            if (currentUser && db) {
                try {
                    await updateFirebaseData('calculations', calculations);
                } catch (error) {
                    console.error("❌ Erro ao sincronizar cálculos:", error);
                    updateFirebaseStatus('error', 'Erro na sincronização');
                }
            }
            
            if (userData) {
                userData.calculations = calculations;
            }
        }

        // ============================================
        // FUNÇÕES DE LOGIN/CADASTRO
        // ============================================
        function initAuthEvents() {
            const tabLogin = document.getElementById('tabLogin');
            const tabSignup = document.getElementById('tabSignup');
            const btnLogin = document.getElementById('btnLogin');
            const btnSignup = document.getElementById('btnSignup');
            const btnContinueOffline = document.getElementById('btnContinueOffline');
            const btnLogout = document.getElementById('btnLogout');
            
            if (tabLogin) {
                tabLogin.addEventListener('click', () => {
                    document.getElementById('tabLogin').classList.add('active');
                    document.getElementById('tabSignup').classList.remove('active');
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('signupForm').style.display = 'none';
                    document.getElementById('loginError').classList.remove('show');
                });
            }
            
            if (tabSignup) {
                tabSignup.addEventListener('click', () => {
                    document.getElementById('tabSignup').classList.add('active');
                    document.getElementById('tabLogin').classList.remove('active');
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('signupForm').style.display = 'block';
                    document.getElementById('loginError').classList.remove('show');
                });
            }

            if (btnLogin) {
                btnLogin.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    const errorElement = document.getElementById('loginError');
                    const errorText = document.getElementById('errorText');
                    
                    if (!email || !password) {
                        errorText.textContent = 'Por favor, preencha email e senha.';
                        errorElement.classList.add('show');
                        return;
                    }
                    
                    if (!auth) {
                        errorText.textContent = 'Firebase Auth não disponível. Verifique sua conexão.';
                        errorElement.classList.add('show');
                        return;
                    }
                    
                    updateFirebaseStatus('loading', 'Fazendo login...');
                    
                    try {
                        await auth.signInWithEmailAndPassword(email, password);
                        errorElement.classList.remove('show');
                        localStorage.removeItem('skipLogin');
                        updateFirebaseStatus('success', 'Login realizado!');
                        
                    } catch (error) {
                        console.error('❌ Erro no login:', error);
                        errorText.textContent = getFirebaseErrorMessage(error.code);
                        errorElement.classList.add('show');
                        updateFirebaseStatus('error', 'Erro no login');
                    }
                });
            }

            if (btnSignup) {
                btnSignup.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('signupEmail').value;
                    const password = document.getElementById('signupPassword').value;
                    const confirmPassword = document.getElementById('signupConfirmPassword').value;
                    const errorElement = document.getElementById('loginError');
                    const errorText = document.getElementById('errorText');
                    
                    if (!email || !password || !confirmPassword) {
                        errorText.textContent = 'Por favor, preencha todos os campos.';
                        errorElement.classList.add('show');
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        errorText.textContent = 'As senhas não coincidem.';
                        errorElement.classList.add('show');
                        return;
                    }
                    
                    if (password.length < 6) {
                        errorText.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                        errorElement.classList.add('show');
                        return;
                    }
                    
                    if (!auth) {
                        errorText.textContent = 'Firebase Auth não disponível. Verifique sua conexão.';
                        errorElement.classList.add('show');
                        return;
                    }
                    
                    updateFirebaseStatus('loading', 'Criando conta...');
                    
                    try {
                        await auth.createUserWithEmailAndPassword(email, password);
                        errorElement.classList.remove('show');
                        localStorage.removeItem('skipLogin');
                        updateFirebaseStatus('success', 'Conta criada com sucesso!');
                        
                    } catch (error) {
                        console.error('❌ Erro no cadastro:', error);
                        errorText.textContent = getFirebaseErrorMessage(error.code);
                        errorElement.classList.add('show');
                        updateFirebaseStatus('error', 'Erro no cadastro');
                    }
                });
            }

            if (btnContinueOffline) {
                btnContinueOffline.addEventListener('click', () => {
                    localStorage.setItem('skipLogin', 'true');
                    document.getElementById('loginModal').style.display = 'none';
                    updateFirebaseStatus('disconnected', 'Modo offline ativado');
                });
            }

            if (btnLogout) {
                btnLogout.addEventListener('click', () => {
                    if (auth) {
                        auth.signOut();
                    }
                    localStorage.removeItem('skipLogin');
                    updateFirebaseStatus('disconnected', 'Desconectado');
                });
            }
        }

        function getFirebaseErrorMessage(errorCode) {
            const messages = {
                'auth/user-not-found': 'Usuário não encontrado.',
                'auth/wrong-password': 'Senha incorreta.',
                'auth/email-already-in-use': 'Este email já está em uso.',
                'auth/weak-password': 'A senha é muito fraca.',
                'auth/invalid-email': 'Email inválido.',
                'auth/network-request-failed': 'Erro de conexão. Verifique sua internet.',
                'auth/too-many-requests': 'Muitas tentativas. Tente novamente mais tarde.',
                'auth/user-disabled': 'Esta conta foi desativada.',
                'auth/operation-not-allowed': 'Operação não permitida.',
                'auth/popup-closed-by-user': 'Popup fechado antes de concluir.',
                'auth/cancelled-popup-request': 'Requisição de popup cancelada.',
                'auth/popup-blocked': 'Popup bloqueado pelo navegador.'
            };
            
            return messages[errorCode] || `Ocorreu um erro: ${errorCode || 'Tente novamente.'}`;
        }

        // ============================================
        // FUNÇÕES DE CÁLCULO
        // ============================================
        function getCurrentMonthString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }
        
        function parseTime(timeString) {
            if (!timeString) return 0;
            if (typeof timeString !== 'string') return 0;
            
            const parts = timeString.split(':');
            if (parts.length < 2) return 0;
            
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);

            if (isNaN(hours) || isNaN(minutes) || minutes >= 60 || hours < 0 || minutes < 0) {
                return 0;
            }

            return hours + (minutes / 60);
        }
        
        function formatCurrencyInput(input) {
            if (!input) return;
            let value = input.value.replace(/\D/g, '');
            if (value.length === 0) {
                input.value = '';
                return;
            }

            while (value.length < 3) {
                value = '0' + value;
            }

            let integerPart = value.slice(0, -2);
            let decimalPart = value.slice(-2);

            integerPart = parseInt(integerPart, 10).toString();
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

            input.value = integerPart + ',' + decimalPart;
        }

        function getDSRDays(year, monthIndex) {
            const date = new Date(year, monthIndex, 1);
            let totalDays = 0;
            let sundays = 0;
            
            while (date.getMonth() === monthIndex) {
                totalDays++;
                if (date.getDay() === 0) {
                    sundays++;
                }
                date.setDate(date.getDate() + 1);
            }
            
            const diasUteis = totalDays - sundays;

            return {
                diasDSR: sundays,
                diasUteis: diasUteis,
                totalDaysInMonth: totalDays 
            };
        }
        
        function handleMonthChange(isInitialLoad = false) {
            const monthInput = document.getElementById('mesReferencia');
            if (!monthInput) return;
            
            const monthValue = monthInput.value;
            if (!monthValue) return;

            const [year, month] = monthValue.split('-').map(Number);
            
            const result = getDSRDays(year, month - 1);
            
            const diasTrabalhados = document.getElementById('diasTrabalhados');
            if (diasTrabalhados) diasTrabalhados.value = 30;
            
            const diasDomingo = document.getElementById('diasDomingo');
            if (diasDomingo) diasDomingo.value = result.diasDSR;
            
            const diasUteisInput = document.getElementById('diasUteis');
            if (diasUteisInput) {
                diasUteisInput.setAttribute('data-base-value', result.diasUteis);
                diasUteisInput.value = result.diasUteis;
            }
            
            calcular();
        }

        function calcular() {
            const salarioBaseInput = document.getElementById('salarioBase');
            if (!salarioBaseInput) return;
            
            const salarioBaseValue = salarioBaseInput.value;
            const salarioBaseFormatted = salarioBaseValue.replace(/\./g, '').replace(',', '.'); 
            const salarioBase = parseFloat(salarioBaseFormatted) || 0;

            const divisorMensalInput = document.getElementById('divisorMensal');
            const divisorMensal = divisorMensalInput ? parseFloat(divisorMensalInput.value) || 220 : 220;
            
            const usaPericulosidadeCheck = document.getElementById('usaPericulosidade');
            const usaPericulosidade = usaPericulosidadeCheck ? usaPericulosidadeCheck.checked : false;
            
            const horasSobreavisoTotal = parseTime(document.getElementById('horasSobreavisoTotal')?.value);
            const horasTrabalhadas50 = parseTime(document.getElementById('horasTrabalhadas50')?.value); 
            const horasTrabalhadas100 = parseTime(document.getElementById('horasTrabalhadas100')?.value); 
            const horasNoturnas = parseTime(document.getElementById('horasNoturnas')?.value);

            const diasAtestadoInput = document.getElementById('diasAtestado');
            const diasAtestado = diasAtestadoInput ? parseFloat(diasAtestadoInput.value) || 0 : 0;
            
            const diasTrabalhadosInput = document.getElementById('diasTrabalhados');
            const diasTrabalhados = diasTrabalhadosInput ? parseFloat(diasTrabalhadosInput.value) || 30 : 30;
            
            const diasFeriadoInput = document.getElementById('diasFeriado');
            const diasFeriado = diasFeriadoInput ? parseFloat(diasFeriadoInput.value) || 0 : 0;
            
            const diasUteisInput = document.getElementById('diasUteis');
            const diasUteisBase = diasUteisInput ? parseFloat(diasUteisInput.getAttribute('data-base-value')) || 0 : 0;

            const diasDomingoInput = document.getElementById('diasDomingo');
            const diasDomingoTotal = diasDomingoInput ? parseFloat(diasDomingoInput.value) || 0 : 0;
            
            if (divisorMensal <= 0 || diasUteisBase <= 0 || salarioBase <= 0) {
                const elementos = {
                    horaNormal: 'horaNormal',
                    valorPericulosidade: 'valorPericulosidade',
                    valorPericulosidadeInputDisplay: 'valorPericulosidadeInputDisplay',
                    valorSobreavisoEspera: 'valorSobreavisoEspera',
                    valorHoraExtraTrabalho50: 'valorHoraExtraTrabalho50',
                    valorHoraExtraTrabalho100: 'valorHoraExtraTrabalho100',
                    valorAdicionalNoturno: 'valorAdicionalNoturno',
                    fatorDSRDisplay: 'fatorDSRDisplay',
                    valorReflexoSobreavisoEspera: 'valorReflexoSobreavisoEspera',
                    valorReflexoSobreavisoTrabalhado: 'valorReflexoSobreavisoTrabalhado',
                    valorReflexoHorasExtrasNormal: 'valorReflexoHorasExtrasNormal',
                    valorReflexoAdicionalNoturno: 'valorReflexoAdicionalNoturno',
                    valorReflexoDSRTotalSum: 'valorReflexoDSRTotalSum',
                    horaSobreaviso: 'horaSobreaviso',
                    baseHePeric: 'baseHePeric',
                    horaExtra50: 'horaExtra50'
                };
                
                for (const [id, elementId] of Object.entries(elementos)) {
                    const el = document.getElementById(elementId);
                    if (el) el.textContent = R$.format(0);
                }
                
                const fatorEl = document.getElementById('fatorDSRDisplay');
                if (fatorEl) fatorEl.textContent = "0.0000";
                
                const pericDet = document.getElementById('periculosidadeDetalhada');
                if (pericDet) pericDet.style.display = 'none';
                
                const baseHe = document.getElementById('baseHePeric');
                if (baseHe) baseHe.textContent = R$.format(0) + " (s/ Salário)";
                
                return;
            }
            
            const periculosidadeValorMensal = salarioBase * 0.30;
            const diasBaseMensal = 30;
            const diasTrabalhadosAjustados = Math.max(0, 30 - diasAtestado);
            const periculosidadeValorProRata = usaPericulosidade ? 
                (periculosidadeValorMensal / diasBaseMensal) * diasTrabalhadosAjustados : 0;

            const horaNormal = salarioBase / divisorMensal;
            const periculosidadeHora = periculosidadeValorMensal / divisorMensal; 
            
            let baseHE = horaNormal;
            if (usaPericulosidade) {
                baseHE += periculosidadeHora;
            }
            
            const horasEspera = horasSobreavisoTotal; 
            const horaSobreaviso = horaNormal / 3;
            const valorSobreavisoEspera = horasEspera * horaSobreaviso; 

            const baseHePericRate = baseHE;
            const horaExtra50Valor = baseHE * 1.5;
            
            const valorHoraExtraTrabalho50 = horasTrabalhadas50 * horaExtra50Valor; 
            const valorHoraExtraTrabalho100 = horasTrabalhadas100 * horaExtra50Valor; 
            
            const adicionalNoturnoHora = horaNormal * 0.20;
            const valorAdicionalNoturno = horasNoturnas * adicionalNoturnoHora;

            const diasUteisAjustados = Math.max(0, diasUteisBase - diasFeriado); 
            const diasUteisEl = document.getElementById('diasUteis');
            if (diasUteisEl) diasUteisEl.value = diasUteisAjustados.toFixed(0); 

            const diasDSRParaCalculo = diasDomingoTotal + diasFeriado;
            const fatorDSR = diasUteisAjustados > 0 ? diasDSRParaCalculo / diasUteisAjustados : 0;
            
            const valorReflexoSobreavisoEspera = valorSobreavisoEspera * fatorDSR;
            const valorReflexoSobreavisoTrabalhado = valorHoraExtraTrabalho50 * fatorDSR;
            const valorReflexoHorasExtrasNormal = valorHoraExtraTrabalho100 * fatorDSR;
            const valorReflexoAdicionalNoturno = valorAdicionalNoturno * fatorDSR;

            const valorReflexoDSRTotal = valorReflexoSobreavisoEspera + valorReflexoSobreavisoTrabalhado + 
                                       valorReflexoHorasExtrasNormal + valorReflexoAdicionalNoturno;

            // Atualizar elementos
            const valorPericulosidadeEl = document.getElementById('valorPericulosidade');
            if (valorPericulosidadeEl) valorPericulosidadeEl.textContent = R$.format(periculosidadeValorProRata);
            
            const valorPericulosidadeInputDisplay = document.getElementById('valorPericulosidadeInputDisplay');
            if (valorPericulosidadeInputDisplay) valorPericulosidadeInputDisplay.textContent = R$.format(periculosidadeValorProRata);

            const pericDet = document.getElementById('periculosidadeDetalhada');
            if (pericDet) {
                if (usaPericulosidade && salarioBase > 0) {
                    pericDet.style.display = 'block';
                    pericDet.innerHTML = 
                        `Cálculo: ${R$.format(periculosidadeValorMensal)} mensal ÷ 30 dias × ${diasTrabalhadosAjustados} dias trabalhados = ${R$.format(periculosidadeValorProRata)}`;
                } else {
                    pericDet.style.display = 'none';
                }
            }

            const valorSobreavisoEsperaEl = document.getElementById('valorSobreavisoEspera');
            if (valorSobreavisoEsperaEl) valorSobreavisoEsperaEl.textContent = R$.format(valorSobreavisoEspera);
            
            const valorHoraExtraTrabalho50El = document.getElementById('valorHoraExtraTrabalho50');
            if (valorHoraExtraTrabalho50El) valorHoraExtraTrabalho50El.textContent = R$.format(valorHoraExtraTrabalho50);
            
            const valorHoraExtraTrabalho100El = document.getElementById('valorHoraExtraTrabalho100');
            if (valorHoraExtraTrabalho100El) valorHoraExtraTrabalho100El.textContent = R$.format(valorHoraExtraTrabalho100);
            
            const valorAdicionalNoturnoEl = document.getElementById('valorAdicionalNoturno');
            if (valorAdicionalNoturnoEl) valorAdicionalNoturnoEl.textContent = R$.format(valorAdicionalNoturno);
            
            const fatorDSRDisplay = document.getElementById('fatorDSRDisplay');
            if (fatorDSRDisplay) fatorDSRDisplay.textContent = fatorDSR.toFixed(4);
            
            const valorReflexoSobreavisoEsperaEl = document.getElementById('valorReflexoSobreavisoEspera');
            if (valorReflexoSobreavisoEsperaEl) valorReflexoSobreavisoEsperaEl.textContent = R$.format(valorReflexoSobreavisoEspera);
            
            const valorReflexoSobreavisoTrabalhadoEl = document.getElementById('valorReflexoSobreavisoTrabalhado');
            if (valorReflexoSobreavisoTrabalhadoEl) valorReflexoSobreavisoTrabalhadoEl.textContent = R$.format(valorReflexoSobreavisoTrabalhado);
            
            const valorReflexoHorasExtrasNormalEl = document.getElementById('valorReflexoHorasExtrasNormal');
            if (valorReflexoHorasExtrasNormalEl) valorReflexoHorasExtrasNormalEl.textContent = R$.format(valorReflexoHorasExtrasNormal);
            
            const valorReflexoAdicionalNoturnoEl = document.getElementById('valorReflexoAdicionalNoturno');
            if (valorReflexoAdicionalNoturnoEl) valorReflexoAdicionalNoturnoEl.textContent = R$.format(valorReflexoAdicionalNoturno);
            
            const valorReflexoDSRTotalSum = document.getElementById('valorReflexoDSRTotalSum');
            if (valorReflexoDSRTotalSum) valorReflexoDSRTotalSum.textContent = R$.format(valorReflexoDSRTotal);
            
            const horaNormalEl = document.getElementById('horaNormal');
            if (horaNormalEl) horaNormalEl.textContent = R$.format(horaNormal);
            
            const horaSobreavisoEl = document.getElementById('horaSobreaviso');
            if (horaSobreavisoEl) horaSobreavisoEl.textContent = R$.format(horaSobreaviso);
            
            const baseHePericEl = document.getElementById('baseHePeric');
            if (baseHePericEl) {
                baseHePericEl.textContent = usaPericulosidade 
                    ? R$.format(baseHePericRate) + " (c/ Peric.)" 
                    : R$.format(baseHePericRate) + " (s/ Peric.)";
            }
            
            const horaExtra50El = document.getElementById('horaExtra50');
            if (horaExtra50El) horaExtra50El.textContent = R$.format(horaExtra50Valor);
        }

        function resetInputs() {
            const salarioBase = document.getElementById('salarioBase');
            if (salarioBase) salarioBase.value = "";
            
            const diasFeriado = document.getElementById('diasFeriado');
            if (diasFeriado) diasFeriado.value = "0";
            
            const diasAtestado = document.getElementById('diasAtestado');
            if (diasAtestado) diasAtestado.value = "0";

            const horasSobreavisoTotal = document.getElementById('horasSobreavisoTotal');
            if (horasSobreavisoTotal) horasSobreavisoTotal.value = "00:00";
            
            const horasTrabalhadas50 = document.getElementById('horasTrabalhadas50');
            if (horasTrabalhadas50) horasTrabalhadas50.value = "00:00";
            
            const horasTrabalhadas100 = document.getElementById('horasTrabalhadas100');
            if (horasTrabalhadas100) horasTrabalhadas100.value = "00:00";
            
            const horasNoturnas = document.getElementById('horasNoturnas');
            if (horasNoturnas) horasNoturnas.value = "00:00";

            const divisorMensal = document.getElementById('divisorMensal');
            if (divisorMensal) divisorMensal.value = "220";
            
            const usaPericulosidade = document.getElementById('usaPericulosidade');
            if (usaPericulosidade) usaPericulosidade.checked = true;
            
            const pagoFolha = document.getElementById('pagoFolha');
            if (pagoFolha) pagoFolha.checked = false;
            
            const competenciaPagamento = document.getElementById('competenciaPagamento');
            if (competenciaPagamento) competenciaPagamento.value = "";
            
            handleMonthChange(true);
        }

        // ============================================
        // FUNÇÕES DE DEPARTAMENTOS
        // ============================================
        function updateDepartmentSelect() {
            const departments = getDepartments();
            const select = document.getElementById('collaboratorDepartment');
            const filterDepartment = document.getElementById('filterDepartment');
            const reportDepartment = document.getElementById('reportDepartment');
            
            if (select) {
                select.innerHTML = '<option value="">Selecione...</option>';
            }
            
            if (filterDepartment) {
                filterDepartment.innerHTML = '<option value="">Todos os departamentos</option>';
            }
            
            if (reportDepartment) {
                reportDepartment.innerHTML = '<option value="">Todos os departamentos</option>';
            }
            
            departments
                .filter(dept => dept.active)
                .forEach(department => {
                    if (select) {
                        const option = document.createElement('option');
                        option.value = department.name;
                        option.textContent = department.name;
                        select.appendChild(option);
                    }
                    
                    if (filterDepartment) {
                        const filterOption = document.createElement('option');
                        filterOption.value = department.name;
                        filterOption.textContent = department.name;
                        filterDepartment.appendChild(filterOption);
                    }
                    
                    if (reportDepartment) {
                        const reportOption = document.createElement('option');
                        reportOption.value = department.name;
                        reportOption.textContent = department.name;
                        reportDepartment.appendChild(reportOption);
                    }
                });
        }
        
        function updateCollaboratorSelect() {
            const collaborators = getCollaborators();
            const select = document.getElementById('collaboratorSelect');
            
            if (!select) return;
            
            const currentSelection = select.value;
            select.innerHTML = '<option value="">-- Selecione um colaborador --</option>';
            
            collaborators
                .filter(collaborator => collaborator.active === true)
                .forEach(collaborator => {
                    const option = document.createElement('option');
                    option.value = collaborator.id;
                    option.textContent = `${collaborator.name} - ${collaborator.department} (R$ ${collaborator.baseSalary})`;
                    select.appendChild(option);
                });
            
            if (currentSelection && collaborators.some(c => c.id == currentSelection && c.active === true)) {
                select.value = currentSelection;
            }
        }
        
        function updateCollaboratorFilterSelect() {
            const collaborators = getCollaborators();
            const select = document.getElementById('filterCollaborator');
            const reportSelect = document.getElementById('reportCollaborator');
            
            if (select) {
                select.innerHTML = '<option value="">Todos os colaboradores</option>';
            }
            
            if (reportSelect) {
                reportSelect.innerHTML = '<option value="">Todos os colaboradores</option>';
            }
            
            collaborators
                .filter(collaborator => collaborator.active === true)
                .forEach(collaborator => {
                    if (select) {
                        const option = document.createElement('option');
                        option.value = collaborator.id;
                        option.textContent = `${collaborator.name} - ${collaborator.department}`;
                        select.appendChild(option);
                    }
                    
                    if (reportSelect) {
                        const reportOption = document.createElement('option');
                        reportOption.value = collaborator.id;
                        reportOption.textContent = `${collaborator.name} - ${collaborator.department}`;
                        reportSelect.appendChild(reportOption);
                    }
                });
        }
        
        function renderDepartmentsTable() {
            const departments = getDepartments();
            const container = document.getElementById('departmentsTableContainer');
            
            if (!container) return;
            
            if (departments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-building fa-3x mb-4"></i>
                        <p class="text-lg">Nenhum departamento cadastrado ainda.</p>
                        <p class="text-sm">Clique em "Novo Departamento" para cadastrar seu primeiro departamento.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="overflow-x-auto">
                    <table class="department-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            departments.forEach(department => {
                html += `
                    <tr data-id="${department.id}">
                        <td class="font-medium">${department.name}</td>
                        <td>
                            <span class="px-2 py-1 rounded text-xs ${department.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${department.active ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <button class="edit-department text-green-600 hover:text-green-800 text-sm" data-id="${department.id}">
                                    <i class="fas fa-edit mr-1"></i> Editar
                                </button>
                                <button class="delete-department text-red-600 hover:text-red-800 text-sm" data-id="${department.id}">
                                    <i class="fas fa-trash mr-1"></i> Excluir
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-sm text-gray-500">
                    Total: ${departments.length} departamento(s) cadastrado(s)
                </div>
            `;
            
            container.innerHTML = html;
            
            document.querySelectorAll('.edit-department').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editDepartment(id);
                });
            });
            
            document.querySelectorAll('.delete-department').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteDepartment(id);
                });
            });
        }
        
        function editDepartment(id) {
            const departments = getDepartments();
            const department = departments.find(dept => dept.id === id);
            
            if (!department) {
                alert('Departamento não encontrado!');
                return;
            }
            
            const departmentName = document.getElementById('departmentName');
            const departmentActive = document.getElementById('departmentActive');
            
            if (departmentName) departmentName.value = department.name;
            if (departmentActive) departmentActive.checked = department.active;
            
            const departmentModalTitle = document.getElementById('departmentModalTitle');
            if (departmentModalTitle) departmentModalTitle.textContent = "Editar Departamento";
            
            const departmentModalButton = document.getElementById('departmentModalButton');
            if (departmentModalButton) departmentModalButton.textContent = "Atualizar Departamento";
            
            window.editingDepartmentId = id;
            
            openDepartmentModal();
        }
        
        async function deleteDepartment(id) {
            const departments = getDepartments();
            const department = departments.find(dept => dept.id === id);
            
            if (!department) {
                alert('Departamento não encontrado!');
                return;
            }
            
            const collaborators = getCollaborators();
            const collaboratorsInDepartment = collaborators.filter(collaborator => 
                collaborator.department === department.name && collaborator.active === true
            );
            
            let message = `Tem certeza que deseja excluir o departamento "${department.name}"?`;
            
            if (collaboratorsInDepartment.length > 0) {
                message += `\n\nATENÇÃO: Existem ${collaboratorsInDepartment.length} colaborador(es) ativo(s) vinculados a este departamento. Eles ficarão sem departamento atribuído.`;
            }
            
            if (!confirm(message)) {
                return;
            }
            
            const filteredDepartments = departments.filter(dept => dept.id !== id);
            
            if (collaboratorsInDepartment.length > 0) {
                const updatedCollaborators = collaborators.map(collaborator => {
                    if (collaborator.department === department.name) {
                        return { ...collaborator, department: '' };
                    }
                    return collaborator;
                });
                await saveCollaborators(updatedCollaborators);
            }
            
            await saveDepartments(filteredDepartments);
            
            updateDepartmentSelect();
            renderDepartmentsTable();
            updateCollaboratorFilterSelect();
            
            alert('Departamento excluído com sucesso!');
        }

        async function saveNewDepartment(event) {
            event.preventDefault();
            
            const name = document.getElementById('departmentName').value.trim();
            const active = document.getElementById('departmentActive').checked;
            
            if (!name) {
                alert('Por favor, preencha o nome do departamento.');
                return;
            }
            
            const departments = getDepartments();
            const existingDepartment = departments.find(dept => 
                dept.name.toLowerCase() === name.toLowerCase()
            );
            
            if (existingDepartment && !window.editingDepartmentId) {
                alert(`Já existe um departamento com o nome "${name}".`);
                return;
            }
            
            let newDepartment;
            
            if (window.editingDepartmentId) {
                newDepartment = {
                    id: window.editingDepartmentId,
                    name: name,
                    active: active,
                    updatedAt: new Date().toISOString()
                };
                
                const originalDepartment = departments.find(dept => dept.id === window.editingDepartmentId);
                if (originalDepartment) {
                    newDepartment.createdAt = originalDepartment.createdAt;
                }
                
                const updatedDepartments = departments.map(dept => 
                    dept.id === window.editingDepartmentId ? newDepartment : dept
                );
                
                await saveDepartments(updatedDepartments);
                window.editingDepartmentId = null;
            } else {
                newDepartment = {
                    id: Date.now(),
                    name: name,
                    active: active,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                departments.push(newDepartment);
                await saveDepartments(departments);
            }
            
            closeDepartmentModal();
            updateDepartmentSelect();
            renderDepartmentsTable();
            
            alert(`Departamento ${name} salvo com sucesso! ${currentUser ? '(Sincronizado com a nuvem)' : ''}`);
            
            document.getElementById('departmentForm').reset();
            const departmentModalTitle = document.getElementById('departmentModalTitle');
            if (departmentModalTitle) departmentModalTitle.textContent = "Cadastrar Novo Departamento";
            
            const departmentModalButton = document.getElementById('departmentModalButton');
            if (departmentModalButton) departmentModalButton.textContent = "Salvar Departamento";
        }

        // ============================================
        // FUNÇÕES DE COLABORADORES
        // ============================================
        let currentCollaboratorStatus = 'active';
        
        async function saveCollaborator(event) {
            event.preventDefault();
            
            const id = document.getElementById('collaboratorEditId').value;
            const name = document.getElementById('collaboratorName').value.trim();
            const department = document.getElementById('collaboratorDepartment').value;
            const baseSalary = document.getElementById('collaboratorBaseSalary').value;
            const divisor = document.getElementById('collaboratorDivisor').value;
            const workHours = document.getElementById('collaboratorWorkHours').value;
            const periculosidade = document.getElementById('collaboratorPericulosidade').checked;
            const insalubridade = document.getElementById('collaboratorInsalubridade').checked;
            
            if (!name || !department || !baseSalary) {
                alert('Por favor, preencha os campos obrigatórios (Nome, Departamento e Salário Base).');
                return;
            }
            
            const baseSalaryFormatted = baseSalary.replace(/\./g, '').replace(',', '.');
            const baseSalaryValue = parseFloat(baseSalaryFormatted) || 0;
            
            if (baseSalaryValue <= 0) {
                alert('O salário base deve ser maior que zero.');
                return;
            }
            
            const collaborators = getCollaborators();
            let newCollaborator;
            
            if (id) {
                const existingIndex = collaborators.findIndex(c => c.id == id);
                
                if (existingIndex === -1) {
                    alert('Colaborador não encontrado!');
                    return;
                }
                
                newCollaborator = {
                    ...collaborators[existingIndex],
                    name: name,
                    department: department,
                    baseSalary: baseSalary,
                    baseSalaryValue: baseSalaryValue,
                    divisor: divisor,
                    workHours: workHours,
                    periculosidade: periculosidade,
                    insalubridade: insalubridade,
                    updatedAt: new Date().toISOString()
                };
                
                collaborators[existingIndex] = newCollaborator;
            } else {
                const matricula = `COL${Date.now().toString().slice(-6)}`;
                
                newCollaborator = {
                    id: Date.now(),
                    name: name,
                    department: department,
                    matricula: matricula,
                    baseSalary: baseSalary,
                    baseSalaryValue: baseSalaryValue,
                    divisor: divisor,
                    workHours: workHours,
                    periculosidade: periculosidade,
                    insalubridade: insalubridade,
                    active: true,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                collaborators.push(newCollaborator);
            }
            
            await saveCollaborators(collaborators);
            
            closeModal();
            updateCollaboratorSelect();
            renderCollaboratorsTable(currentCollaboratorStatus);
            updateCollaboratorFilterSelect();
            
            alert(`Colaborador ${name} salvo com sucesso! ${currentUser ? '(Sincronizado com a nuvem)' : ''}`);
            resetCollaboratorForm();
        }
        
        function resetCollaboratorForm() {
            const collaboratorEditId = document.getElementById('collaboratorEditId');
            if (collaboratorEditId) collaboratorEditId.value = '';
            
            const collaboratorName = document.getElementById('collaboratorName');
            if (collaboratorName) collaboratorName.value = '';
            
            const collaboratorDepartment = document.getElementById('collaboratorDepartment');
            if (collaboratorDepartment) collaboratorDepartment.value = '';
            
            const collaboratorBaseSalary = document.getElementById('collaboratorBaseSalary');
            if (collaboratorBaseSalary) collaboratorBaseSalary.value = '';
            
            const collaboratorDivisor = document.getElementById('collaboratorDivisor');
            if (collaboratorDivisor) collaboratorDivisor.value = '220';
            
            const collaboratorWorkHours = document.getElementById('collaboratorWorkHours');
            if (collaboratorWorkHours) collaboratorWorkHours.value = '8';
            
            const collaboratorPericulosidade = document.getElementById('collaboratorPericulosidade');
            if (collaboratorPericulosidade) collaboratorPericulosidade.checked = false;
            
            const collaboratorInsalubridade = document.getElementById('collaboratorInsalubridade');
            if (collaboratorInsalubridade) collaboratorInsalubridade.checked = false;
            
            const collaboratorModalTitle = document.getElementById('collaboratorModalTitle');
            if (collaboratorModalTitle) collaboratorModalTitle.textContent = "Cadastrar Novo Colaborador";
            
            const collaboratorModalButton = document.getElementById('collaboratorModalButton');
            if (collaboratorModalButton) collaboratorModalButton.textContent = "Salvar Colaborador";
        }
        
        function loadCollaboratorToCalculator(collaboratorId) {
            const collaborators = getCollaborators();
            const collaborator = collaborators.find(c => c.id == collaboratorId);
            
            if (!collaborator) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            if (collaborator.active !== true) {
                alert('Este colaborador está inativo. Selecione um colaborador ativo.');
                const collaboratorSelect = document.getElementById('collaboratorSelect');
                if (collaboratorSelect) collaboratorSelect.value = '';
                return;
            }
            
            const salarioBase = document.getElementById('salarioBase');
            if (salarioBase) salarioBase.value = collaborator.baseSalary;
            
            const divisorMensal = document.getElementById('divisorMensal');
            if (divisorMensal) divisorMensal.value = collaborator.divisor;
            
            const usaPericulosidade = document.getElementById('usaPericulosidade');
            if (usaPericulosidade) usaPericulosidade.checked = collaborator.periculosidade;
            
            calcular();
        }
        
        function renderCollaboratorsTable(status = 'active') {
            const collaborators = getCollaborators();
            const container = document.getElementById('collaboratorsTableContainer');
            
            if (!container) return;
            
            const filteredCollaborators = status === 'active' 
                ? collaborators.filter(c => c.active === true)
                : collaborators.filter(c => c.active === false);
            
            if (filteredCollaborators.length === 0) {
                const statusText = status === 'active' ? 'ativo' : 'inativo';
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-users fa-3x mb-4"></i>
                        <p class="text-lg">Nenhum colaborador ${statusText}.</p>
                        <p class="text-sm">${status === 'active' ? 'Clique em "Novo Colaborador" ou importe uma planilha para cadastrar seu primeiro colaborador.' : 'Colaboradores inativados aparecerão aqui.'}</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="overflow-x-auto">
                    <table class="collaborator-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Departamento</th>
                                <th>Salário Base</th>
                                <th>Periculosidade</th>
                                ${status === 'inactive' ? '<th>Data Inativação</th>' : ''}
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredCollaborators.forEach(collaborator => {
                const inactivationDate = status === 'inactive' 
                    ? new Date(collaborator.updatedAt).toLocaleDateString('pt-BR')
                    : '';
                
                html += `
                    <tr data-id="${collaborator.id}">
                        <td class="font-medium">${collaborator.name}</td>
                        <td>${collaborator.department}</td>
                        <td>R$ ${collaborator.baseSalary}</td>
                        <td>
                            <span class="px-2 py-1 rounded text-xs ${collaborator.periculosidade ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                                ${collaborator.periculosidade ? 'Sim' : 'Não'}
                            </span>
                        </td>
                        ${status === 'inactive' ? `<td class="text-sm text-gray-600">${inactivationDate}</td>` : ''}
                        <td>
                            <div class="flex gap-2">
                                ${status === 'active' ? `
                                <button class="edit-collaborator text-green-600 hover:text-green-800 text-sm" data-id="${collaborator.id}">
                                    <i class="fas fa-edit mr-1"></i> Editar
                                </button>
                                <button class="view-collaborator-history text-purple-600 hover:text-purple-800 text-sm" data-id="${collaborator.id}">
                                    <i class="fas fa-history mr-1"></i> Histórico
                                </button>
                                <button class="inactivate-collaborator text-red-600 hover:text-red-800 text-sm" data-id="${collaborator.id}">
                                    <i class="fas fa-user-slash mr-1"></i> Inativar
                                </button>
                                ` : `
                                <button class="reactivate-collaborator text-green-600 hover:text-green-800 text-sm" data-id="${collaborator.id}">
                                    <i class="fas fa-user-check mr-1"></i> Reativar
                                </button>
                                <button class="view-collaborator-history text-purple-600 hover:text-purple-800 text-sm" data-id="${collaborator.id}">
                                    <i class="fas fa-history mr-1"></i> Histórico
                                </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-sm text-gray-500">
                    Total: ${filteredCollaborators.length} colaborador(es) ${status === 'active' ? 'ativo(s)' : 'inativo(s)'}
                </div>
            `;
            
            container.innerHTML = html;
            
            updateStatusButtons(status);
            
            if (status === 'active') {
                document.querySelectorAll('.edit-collaborator').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        editCollaborator(id);
                    });
                });
                
                document.querySelectorAll('.inactivate-collaborator').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        inactivateCollaborator(id);
                    });
                });
            } else {
                document.querySelectorAll('.reactivate-collaborator').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        reactivateCollaborator(id);
                    });
                });
            }
            
            document.querySelectorAll('.view-collaborator-history').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showHistory();
                    const filterCollaborator = document.getElementById('filterCollaborator');
                    if (filterCollaborator) filterCollaborator.value = id;
                    applyHistoryFilters();
                });
            });
        }
        
        function updateStatusButtons(status) {
            const activeBtn = document.getElementById('showActiveCollaborators');
            const inactiveBtn = document.getElementById('showInactiveCollaborators');
            
            if (activeBtn && inactiveBtn) {
                if (status === 'active') {
                    activeBtn.classList.add('active');
                    inactiveBtn.classList.remove('active');
                } else {
                    activeBtn.classList.remove('active');
                    inactiveBtn.classList.add('active');
                }
            }
            
            currentCollaboratorStatus = status;
        }
        
        async function inactivateCollaborator(id) {
            if (!confirm('Tem certeza que deseja inativar este colaborador? Ele não aparecerá mais nas listas de seleção, mas os cálculos históricos serão mantidos.')) {
                return;
            }
            
            const collaborators = getCollaborators();
            const collaboratorIndex = collaborators.findIndex(c => c.id === id);
            
            if (collaboratorIndex === -1) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            collaborators[collaboratorIndex].active = false;
            collaborators[collaboratorIndex].updatedAt = new Date().toISOString();
            
            await saveCollaborators(collaborators);
            
            updateCollaboratorSelect();
            renderCollaboratorsTable(currentCollaboratorStatus);
            updateCollaboratorFilterSelect();
            
            alert('Colaborador inativado com sucesso!');
        }
        
        async function reactivateCollaborator(id) {
            if (!confirm('Tem certeza que deseja reativar este colaborador?')) {
                return;
            }
            
            const collaborators = getCollaborators();
            const collaboratorIndex = collaborators.findIndex(c => c.id === id);
            
            if (collaboratorIndex === -1) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            collaborators[collaboratorIndex].active = true;
            collaborators[collaboratorIndex].updatedAt = new Date().toISOString();
            
            await saveCollaborators(collaborators);
            
            updateCollaboratorSelect();
            renderCollaboratorsTable(currentCollaboratorStatus);
            updateCollaboratorFilterSelect();
            
            alert('Colaborador reativado com sucesso!');
        }
        
        function editCollaborator(id) {
            const collaborators = getCollaborators();
            const collaborator = collaborators.find(c => c.id === id);
            
            if (!collaborator) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            const collaboratorEditId = document.getElementById('collaboratorEditId');
            if (collaboratorEditId) collaboratorEditId.value = collaborator.id;
            
            const collaboratorName = document.getElementById('collaboratorName');
            if (collaboratorName) collaboratorName.value = collaborator.name;
            
            const collaboratorDepartment = document.getElementById('collaboratorDepartment');
            if (collaboratorDepartment) collaboratorDepartment.value = collaborator.department;
            
            const collaboratorBaseSalary = document.getElementById('collaboratorBaseSalary');
            if (collaboratorBaseSalary) collaboratorBaseSalary.value = collaborator.baseSalary;
            
            const collaboratorDivisor = document.getElementById('collaboratorDivisor');
            if (collaboratorDivisor) collaboratorDivisor.value = collaborator.divisor;
            
            const collaboratorWorkHours = document.getElementById('collaboratorWorkHours');
            if (collaboratorWorkHours) collaboratorWorkHours.value = collaborator.workHours || '8';
            
            const collaboratorPericulosidade = document.getElementById('collaboratorPericulosidade');
            if (collaboratorPericulosidade) collaboratorPericulosidade.checked = collaborator.periculosidade;
            
            const collaboratorInsalubridade = document.getElementById('collaboratorInsalubridade');
            if (collaboratorInsalubridade) collaboratorInsalubridade.checked = collaborator.insalubridade;
            
            const collaboratorModalTitle = document.getElementById('collaboratorModalTitle');
            if (collaboratorModalTitle) collaboratorModalTitle.textContent = "Editar Colaborador";
            
            const collaboratorModalButton = document.getElementById('collaboratorModalButton');
            if (collaboratorModalButton) collaboratorModalButton.textContent = "Atualizar Colaborador";
            
            openModal();
        }

        // ============================================
        // FUNÇÕES DE CÁLCULOS E HISTÓRICO
        // ============================================
        async function saveCurrentCalculation() {
            const collaboratorSelect = document.getElementById('collaboratorSelect');
            if (!collaboratorSelect) return;
            
            const selectedCollaboratorId = collaboratorSelect.value;
            
            if (!selectedCollaboratorId) {
                alert('Por favor, selecione um colaborador antes de salvar o cálculo.');
                return;
            }
            
            const collaborators = getCollaborators();
            const collaborator = collaborators.find(c => c.id == selectedCollaboratorId);
            
            if (!collaborator) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            const isEditing = currentCalculationDetailId !== null;
            
            const calculationData = {
                id: isEditing ? currentCalculationDetailId : Date.now(),
                collaboratorId: selectedCollaboratorId,
                collaboratorName: collaborator.name,
                collaboratorDepartment: collaborator.department,
                collaboratorSalary: collaborator.baseSalary,
                timestamp: new Date().toLocaleString('pt-BR'),
                timestampISO: new Date().toISOString(),
                mesReferencia: document.getElementById('mesReferencia')?.value || '',
                pagoFolha: document.getElementById('pagoFolha')?.checked || false,
                competenciaPagamento: document.getElementById('competenciaPagamento')?.value || '',
                data: {
                    salarioBase: document.getElementById('salarioBase')?.value || '',
                    divisorMensal: document.getElementById('divisorMensal')?.value || '220',
                    usaPericulosidade: document.getElementById('usaPericulosidade')?.checked || false,
                    horasSobreavisoTotal: document.getElementById('horasSobreavisoTotal')?.value || '00:00',
                    horasTrabalhadas50: document.getElementById('horasTrabalhadas50')?.value || '00:00',
                    horasTrabalhadas100: document.getElementById('horasTrabalhadas100')?.value || '00:00',
                    horasNoturnas: document.getElementById('horasNoturnas')?.value || '00:00',
                    diasTrabalhados: document.getElementById('diasTrabalhados')?.value || '30',
                    diasAtestado: document.getElementById('diasAtestado')?.value || '0',
                    diasFeriado: document.getElementById('diasFeriado')?.value || '0',
                    diasDomingo: document.getElementById('diasDomingo')?.value || '4',
                    diasUteis: document.getElementById('diasUteis')?.value || '26',
                    resultados: {
                        valorPericulosidade: document.getElementById('valorPericulosidade')?.textContent || 'R$ 0,00',
                        valorSobreavisoEspera: document.getElementById('valorSobreavisoEspera')?.textContent || 'R$ 0,00',
                        valorHoraExtraTrabalho50: document.getElementById('valorHoraExtraTrabalho50')?.textContent || 'R$ 0,00',
                        valorHoraExtraTrabalho100: document.getElementById('valorHoraExtraTrabalho100')?.textContent || 'R$ 0,00',
                        valorAdicionalNoturno: document.getElementById('valorAdicionalNoturno')?.textContent || 'R$ 0,00',
                        valorReflexoDSRTotalSum: document.getElementById('valorReflexoDSRTotalSum')?.textContent || 'R$ 0,00',
                        fatorDSR: document.getElementById('fatorDSRDisplay')?.textContent || '0.0000',
                        valorReflexoSobreavisoEspera: document.getElementById('valorReflexoSobreavisoEspera')?.textContent || 'R$ 0,00',
                        valorReflexoSobreavisoTrabalhado: document.getElementById('valorReflexoSobreavisoTrabalhado')?.textContent || 'R$ 0,00',
                        valorReflexoHorasExtrasNormal: document.getElementById('valorReflexoHorasExtrasNormal')?.textContent || 'R$ 0,00',
                        valorReflexoAdicionalNoturno: document.getElementById('valorReflexoAdicionalNoturno')?.textContent || 'R$ 0,00'
                    }
                }
            };
            
            const calculations = getSavedCalculations();
            
            if (isEditing) {
                const calculationIndex = calculations.findIndex(c => c.id === currentCalculationDetailId);
                
                if (calculationIndex === -1) {
                    alert('Erro: Cálculo não encontrado para edição!');
                    return;
                }
                
                calculations[calculationIndex] = calculationData;
                alert(`Cálculo atualizado com sucesso! ${currentUser ? '(Sincronizado com a nuvem)' : ''}`);
                
                currentCalculationDetailId = null;
            } else {
                calculations.push(calculationData);
                alert(`Cálculo para ${collaborator.name} salvo com sucesso! ${currentUser ? '(Sincronizado com a nuvem)' : ''}`);
            }
            
            await saveCalculations(calculations);
            
            const historyContent = document.getElementById('historyContent');
            if (historyContent && !historyContent.classList.contains('hidden')) {
                renderHistoryTable();
            }
            
            currentCalculationDetailId = null;
        }
        
        function renderHistoryTable(filters = {}) {
            const calculations = getSavedCalculations();
            const container = document.getElementById('historyTableBody');
            
            if (!container) return;
            
            let filteredCalculations = [...calculations];
            
            if (filters.collaboratorId) {
                filteredCalculations = filteredCalculations.filter(c => c.collaboratorId == filters.collaboratorId);
            }
            
            if (filters.department) {
                filteredCalculations = filteredCalculations.filter(c => c.collaboratorDepartment === filters.department);
            }
            
            if (filters.startMonth) {
                filteredCalculations = filteredCalculations.filter(c => c.mesReferencia >= filters.startMonth);
            }
            
            if (filters.endMonth) {
                filteredCalculations = filteredCalculations.filter(c => c.mesReferencia <= filters.endMonth);
            }
            
            filteredCalculations.sort((a, b) => new Date(b.timestampISO) - new Date(a.timestampISO));
            
            if (filteredCalculations.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-history fa-3x mb-4"></i>
                            <p class="text-lg">Nenhum cálculo encontrado.</p>
                            <p class="text-sm">${calculations.length === 0 ? 'Faça cálculos na aba "Calculadora" e salve-os para ver o histórico aqui.' : 'Tente ajustar os filtros.'}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            filteredCalculations.forEach(calculation => {
                const pagoEmFolha = calculation.pagoFolha ? 'Sim' : 'Não';
                const competencia = calculation.competenciaPagamento || '-';
                
                html += `
                    <tr>
                        <td>${calculation.mesReferencia || '-'}</td>
                        <td class="font-medium">${calculation.collaboratorName}</td>
                        <td>${calculation.collaboratorDepartment}</td>
                        <td class="text-sm text-gray-600">${calculation.timestamp}</td>
                        <td class="text-sm ${calculation.pagoFolha ? 'text-green-600 font-medium' : 'text-gray-600'}">
                            ${pagoEmFolha}${competencia !== '-' ? ` (${competencia})` : ''}
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <button class="view-calculation-detail text-blue-600 hover:text-blue-800 text-sm" data-id="${calculation.id}" title="Ver detalhes">
                                    <i class="fas fa-eye"></i> Ver detalhes
                                </button>
                                <button class="delete-calculation text-red-600 hover:text-red-800 text-sm" data-id="${calculation.id}" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
            
            addCalculationActionListeners();
        }
        
        function addCalculationActionListeners() {
            document.querySelectorAll('.view-calculation-detail').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    viewCalculationDetail(id);
                });
            });
            
            document.querySelectorAll('.delete-calculation').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteCalculation(id);
                });
            });
        }
        
        async function deleteCalculation(id) {
            if (!confirm('Tem certeza que deseja excluir este cálculo do histórico?')) {
                return;
            }
            
            const calculations = getSavedCalculations();
            const filteredCalculations = calculations.filter(c => c.id !== id);
            
            await saveCalculations(filteredCalculations);
            renderHistoryTable();
            alert('Cálculo excluído do histórico com sucesso!');
        }

        // ============================================
        // FUNÇÕES DE IMPORTAÇÃO DE PLANILHA
        // ============================================
        function openImportModal() {
            const modal = document.getElementById('importSpreadsheetModal');
            if (modal) {
                modal.classList.add('active');
                const preview = document.getElementById('importPreview');
                if (preview) preview.style.display = 'none';
                
                const messages = document.getElementById('importMessages');
                if (messages) messages.innerHTML = '';
                
                const fileInput = document.getElementById('spreadsheetFile');
                if (fileInput) fileInput.value = '';
                
                importData = null;
            }
        }
        
        function closeImportModal() {
            const modal = document.getElementById('importSpreadsheetModal');
            if (modal) {
                modal.classList.remove('active');
                const preview = document.getElementById('importPreview');
                if (preview) preview.style.display = 'none';
                
                const fileInput = document.getElementById('spreadsheetFile');
                if (fileInput) fileInput.value = '';
                
                importData = null;
            }
        }
        
        function parseCurrencyBR(value) {
            if (value === null || value === undefined) return 0;
            
            if (typeof value !== 'string') {
                value = String(value);
            }
            
            // Remove "R$", espaços e substitui vírgula por ponto
            let cleanValue = value.replace(/R\$\s*/g, '')
                                 .replace(/\./g, '')
                                 .replace(/,/g, '.')
                                 .trim();
            
            // Se começar com ponto, adiciona zero na frente
            if (cleanValue.startsWith('.')) {
                cleanValue = '0' + cleanValue;
            }
            
            const parsed = parseFloat(cleanValue);
            return isNaN(parsed) ? 0 : parsed;
        }
        
        function formatCurrencyForStorage(value) {
            if (typeof value === 'number') {
                return value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }
            
            // Se for string, converte para número e formata
            const numValue = parseCurrencyBR(value);
            return numValue.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        function parseBoolean(value) {
            if (typeof value === 'string') {
                const lower = value.toLowerCase().trim();
                return lower === 'sim' || lower === 's' || lower === 'yes' || lower === 'y' || lower === '1' || lower === 'verdadeiro' || lower === 'true';
            }
            return Boolean(value);
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheet];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    
                    processSpreadsheetData(jsonData);
                } catch (error) {
                    console.error('Erro ao processar planilha:', error);
                    showImportMessage('error', 'Erro ao processar o arquivo. Verifique se o formato é válido.');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processSpreadsheetData(rows) {
            if (rows.length < 2) {
                showImportMessage('error', 'A planilha está vazia ou não contém dados suficientes.');
                return;
            }
            
            const headers = rows[0].map(h => String(h || '').toLowerCase().trim());
            
            // Mapear colunas necessárias
            const nameIndex = headers.findIndex(h => h.includes('nome'));
            const deptIndex = headers.findIndex(h => h.includes('departamento') || h.includes('depto') || h.includes('setor'));
            const salaryIndex = headers.findIndex(h => h.includes('salario') || h.includes('salário') || h.includes('remunera') || h.includes('vencimento'));
            const pericIndex = headers.findIndex(h => h.includes('periculosidade') || h.includes('peric'));
            const hoursIndex = headers.findIndex(h => h.includes('horas') || h.includes('divisor') || h.includes('mensal'));
            
            if (nameIndex === -1 || deptIndex === -1 || salaryIndex === -1) {
                showImportMessage('error', 'A planilha deve conter as colunas: Nome, Departamento e Salário.');
                return;
            }
            
            const importedData = [];
            const errors = [];
            let successCount = 0;
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length === 0) continue;
                
                const name = row[nameIndex]?.toString().trim();
                if (!name) continue;
                
                const department = row[deptIndex]?.toString().trim() || 'Não especificado';
                const salaryRaw = row[salaryIndex];
                const periculosidadeRaw = pericIndex !== -1 ? row[pericIndex] : 'Não';
                const hoursRaw = hoursIndex !== -1 ? row[hoursIndex] : '220';
                
                // Processar salário
                const salaryValue = parseCurrencyBR(salaryRaw);
                if (salaryValue <= 0) {
                    errors.push(`Linha ${i + 1}: Salário inválido para ${name} (${salaryRaw})`);
                    continue;
                }
                
                const salaryFormatted = formatCurrencyForStorage(salaryValue);
                
                // Processar periculosidade
                const hasPericulosidade = pericIndex !== -1 ? parseBoolean(periculosidadeRaw) : false;
                
                // Processar horas
                let divisor = 220;
                if (hoursIndex !== -1) {
                    const hoursStr = String(hoursRaw).replace(/[^\d]/g, '');
                    const parsedHours = parseInt(hoursStr, 10);
                    if (!isNaN(parsedHours) && parsedHours > 0) {
                        divisor = parsedHours;
                    }
                }
                
                importedData.push({
                    name: name,
                    department: department,
                    baseSalary: salaryFormatted,
                    baseSalaryValue: salaryValue,
                    divisor: divisor,
                    periculosidade: hasPericulosidade,
                    insalubridade: false,
                    workHours: '8',
                    active: true,
                    imported: true
                });
                
                successCount++;
            }
            
            if (importedData.length === 0) {
                showImportMessage('error', 'Nenhum colaborador válido encontrado na planilha.');
                return;
            }
            
            importData = importedData;
            showImportPreview(importedData, successCount, errors);
        }
        
        function showImportMessage(type, text) {
            const messagesDiv = document.getElementById('importMessages');
            if (!messagesDiv) return;
            
            const className = type === 'error' ? 'warning-message' : 'success-message';
            const icon = type === 'error' ? 'exclamation-triangle' : 'check-circle';
            
            messagesDiv.innerHTML = `
                <div class="${className}">
                    <i class="fas fa-${icon}"></i>
                    <span>${text}</span>
                </div>
            `;
        }
        
        function showImportPreview(data, successCount, errors) {
            const previewDiv = document.getElementById('importPreview');
            const statsDiv = document.getElementById('importStats');
            const tableHeader = document.getElementById('previewTableHeader');
            const tableBody = document.getElementById('previewTableBody');
            
            if (!previewDiv || !statsDiv || !tableHeader || !tableBody) return;
            
            // Estatísticas
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${successCount}</div>
                    <div class="stat-label">Colaboradores Válidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">R$ ${data.reduce((sum, item) => sum + item.baseSalaryValue, 0).toFixed(2).replace('.', ',')}</div>
                    <div class="stat-label">Total Salários</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.filter(d => d.periculosidade).length}</div>
                    <div class="stat-label">Com Periculosidade</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${errors.length}</div>
                    <div class="stat-label">Erros</div>
                </div>
            `;
            
            // Cabeçalho da tabela
            tableHeader.innerHTML = `
                <tr>
                    <th>Nome</th>
                    <th>Departamento</th>
                    <th>Salário</th>
                    <th>Periculosidade</th>
                    <th>Horas Mensais</th>
                </tr>
            `;
            
            // Corpo da tabela (mostrar apenas os primeiros 10)
            let bodyHtml = '';
            const previewData = data.slice(0, 10);
            
            previewData.forEach(item => {
                bodyHtml += `
                    <tr>
                        <td class="font-medium">${item.name}</td>
                        <td>${item.department}</td>
                        <td class="moeda-br">R$ ${item.baseSalary}</td>
                        <td>
                            <span class="px-2 py-1 rounded text-xs ${item.periculosidade ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                                ${item.periculosidade ? 'Sim' : 'Não'}
                            </span>
                        </td>
                        <td>${item.divisor}h</td>
                    </tr>
                `;
            });
            
            if (data.length > 10) {
                bodyHtml += `
                    <tr>
                        <td colspan="5" class="text-center text-gray-500 py-2">
                            ... e mais ${data.length - 10} colaborador(es)
                        </td>
                    </tr>
                `;
            }
            
            if (errors.length > 0) {
                bodyHtml += `
                    <tr>
                        <td colspan="5" class="text-center text-red-600 py-2">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            ${errors.length} erro(s) encontrados. Verifique o arquivo.
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = bodyHtml;
            previewDiv.style.display = 'block';
        }
        
        async function confirmImport() {
            if (!importData || importData.length === 0) {
                alert('Nenhum dado para importar.');
                return;
            }
            
            const collaborators = getCollaborators();
            const departments = getDepartments();
            let newCollaborators = 0;
            let updatedCollaborators = 0;
            
            // Criar departamentos se não existirem
            const departmentNames = [...new Set(importData.map(item => item.department))];
            
            departmentNames.forEach(deptName => {
                if (deptName && deptName !== 'Não especificado') {
                    const existingDept = departments.find(d => 
                        d.name.toLowerCase() === deptName.toLowerCase()
                    );
                    
                    if (!existingDept) {
                        departments.push({
                            id: Date.now() + Math.random(),
                            name: deptName,
                            active: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    }
                }
            });
            
            // Salvar departamentos atualizados
            await saveDepartments(departments);
            
            // Importar colaboradores
            importData.forEach(item => {
                const existingCollaborator = collaborators.find(c => 
                    c.name.toLowerCase() === item.name.toLowerCase()
                );
                
                if (existingCollaborator) {
                    // Atualizar colaborador existente
                    existingCollaborator.department = item.department;
                    existingCollaborator.baseSalary = item.baseSalary;
                    existingCollaborator.baseSalaryValue = item.baseSalaryValue;
                    existingCollaborator.divisor = item.divisor;
                    existingCollaborator.periculosidade = item.periculosidade;
                    existingCollaborator.updatedAt = new Date().toISOString();
                    existingCollaborator.active = true;
                    updatedCollaborators++;
                } else {
                    // Criar novo colaborador
                    collaborators.push({
                        id: Date.now() + Math.random(),
                        name: item.name,
                        department: item.department,
                        matricula: `COL${Date.now().toString().slice(-6)}${Math.floor(Math.random() * 100)}`,
                        baseSalary: item.baseSalary,
                        baseSalaryValue: item.baseSalaryValue,
                        divisor: item.divisor,
                        workHours: item.workHours || '8',
                        periculosidade: item.periculosidade,
                        insalubridade: false,
                        active: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    newCollaborators++;
                }
            });
            
            await saveCollaborators(collaborators);
            
            // Atualizar selects
            updateDepartmentSelect();
            updateCollaboratorSelect();
            updateCollaboratorFilterSelect();
            renderCollaboratorsTable('active');
            
            // Mensagem de sucesso
            const message = `
                <div class="success-message">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>Importação concluída com sucesso!</strong><br>
                        ${newCollaborators} novo(s) colaborador(es) adicionado(s)<br>
                        ${updatedCollaborators} colaborador(es) atualizado(s)
                    </div>
                </div>
            `;
            
            const importMessages = document.getElementById('importMessages');
            if (importMessages) importMessages.innerHTML = message;
            
            setTimeout(() => {
                closeImportModal();
                alert(`✅ Importação concluída!\n\n${newCollaborators} novo(s) colaborador(es) adicionado(s)\n${updatedCollaborators} colaborador(es) atualizado(s)`);
            }, 2000);
        }
        
        function downloadTemplate() {
            const templateData = [
                ['Nome', 'Departamento', 'Salário', 'Periculosidade', 'Horas Mensais'],
                ['João Silva', 'Produção', 'R$ 2.500,00', 'Sim', '220'],
                ['Maria Santos', 'RH', 'R$ 3.200,50', 'Não', '220'],
                ['Carlos Oliveira', 'TI', 'R$ 4.000,00', 'Sim', '180'],
                ['Ana Costa', 'Financeiro', 'R$ 3.800,75', 'Não', '220'],
                ['Pedro Alves', 'Manutenção', 'R$ 2.850,00', 'Sim', '200']
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            XLSX.utils.book_append_sheet(wb, ws, 'Modelo');
            XLSX.writeFile(wb, 'modelo_importacao_colaboradores.xlsx');
        }

        // ============================================
        // FUNÇÕES DE DETALHES DO CÁLCULO
        // ============================================
        function viewCalculationDetail(id) {
            const calculations = getSavedCalculations();
            const calculation = calculations.find(c => c.id === id);
            
            if (!calculation) {
                alert('Cálculo não encontrado!');
                return;
            }
            
            currentCalculationDetailId = id;
            
            const detailContent = document.getElementById('calculationDetailContent');
            if (!detailContent) return;
            
            detailContent.innerHTML = `
                <div class="space-y-4 view-mode" id="detailViewMode">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-bold text-lg titulo-cor mb-2">${calculation.collaboratorName}</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <span class="text-sm text-gray-600">Departamento:</span>
                                <p class="font-medium">${calculation.collaboratorDepartment}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Mês Referência:</span>
                                <p class="font-medium">${calculation.mesReferencia || '-'}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Data do Cálculo:</span>
                                <p class="font-medium">${calculation.timestamp}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Status:</span>
                                <p class="font-medium">${currentUser ? 'Sincronizado com a nuvem' : 'Salvo localmente'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="payment-info">
                        <h5 class="font-bold text-md titulo-cor mb-2">Informações de Pagamento</h5>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-sm text-gray-600">Pago em Folha:</span>
                                <p class="font-medium ${calculation.pagoFolha ? 'text-green-600' : 'text-gray-600'}">
                                    ${calculation.pagoFolha ? 'Sim' : 'Não'}
                                </p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Competência:</span>
                                <p class="font-medium">${calculation.competenciaPagamento || 'Não informada'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h2 class="text-xl font-semibold mb-4 titulo-cor">Entradas de Dados</h2>
                            
                            <div class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                                <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Salário e Divisor</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Salário Base (R$)</label>
                                        <input type="text" value="${calculation.data?.salarioBase || ''}" readonly class="mt-1" id="detailSalarioBase">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Horas Mensais</label>
                                        <select readonly class="mt-1" id="detailDivisorMensal">
                                            <option ${calculation.data?.divisorMensal === '220' ? 'selected' : ''}>220 (Padrão)</option>
                                            <option ${calculation.data?.divisorMensal === '180' ? 'selected' : ''}>180 horas</option>
                                            <option ${calculation.data?.divisorMensal === '170' ? 'selected' : ''}>170 (Reduzido)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex items-center mt-4 pt-2 border-t">
                                    <input type="checkbox" ${calculation.data?.usaPericulosidade ? 'checked' : ''} disabled class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2" id="detailUsaPericulosidade">
                                    <label class="text-sm font-medium text-gray-700">Incluir Adicional de Periculosidade (30%)</label>
                                </div>
                            </div>
                            
                            <div class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                                <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Horas de Adicionais</h3>
                                <div class="grid grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Horas de Sobreaviso</label>
                                        <input type="text" value="${calculation.data?.horasSobreavisoTotal || '00:00'}" readonly class="mt-1 text-center" id="detailHorasSobreavisoTotal">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Horas de Sobreaviso Trabalhado</label>
                                        <input type="text" value="${calculation.data?.horasTrabalhadas50 || '00:00'}" readonly class="mt-1 text-center" id="detailHorasTrabalhadas50">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Horas Extras 50% (Normal)</label>
                                        <input type="text" value="${calculation.data?.horasTrabalhadas100 || '00:00'}" readonly class="mt-1 text-center" id="detailHorasTrabalhadas100">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Horas de Adicional Noturno</label>
                                        <input type="text" value="${calculation.data?.horasNoturnas || '00:00'}" readonly class="mt-1 text-center" id="detailHorasNoturnas">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4 p-4 bg-gray-50 rounded-lg border">
                                <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Fator DSR, Dias e Ausências</h3>
                                <div class="grid grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Mês Ref.</label>
                                        <input type="text" value="${calculation.mesReferencia || ''}" readonly class="mt-1" id="detailMesReferencia">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Dias Normais</label>
                                        <input type="number" value="${calculation.data?.diasTrabalhados || '30'}" readonly class="mt-1 text-center" id="detailDiasTrabalhados">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Dias de Atestado</label>
                                        <input type="number" value="${calculation.data?.diasAtestado || '0'}" readonly class="mt-1 text-center" id="detailDiasAtestado">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Feriados</label>
                                        <input type="number" value="${calculation.data?.diasFeriado || '0'}" readonly class="mt-1 text-center" id="detailDiasFeriado">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4 mb-6 p-4 bg-green-50 rounded-lg border">
                                <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Informações de Pagamento</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="flex items-center">
                                        <input type="checkbox" ${calculation.pagoFolha ? 'checked' : ''} disabled class="h-4 w-4 text-green-600 border-gray-300 rounded mr-2" id="detailPagoFolha">
                                        <label class="text-sm font-medium text-gray-700">
                                            Pago em Folha?
                                        </label>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Competência</label>
                                        <input type="month" value="${calculation.competenciaPagamento || ''}" readonly class="mt-1" id="detailCompetenciaPagamento">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h2 class="text-xl font-semibold mb-4 titulo-cor">Resultados e Bases</h2>
                            
                            <div class="space-y-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200 mb-6">
                                <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Adicionais e Periculosidade</h3>
                                
                                <div class="flex justify-between text-base font-semibold">
                                    <span>Periculosidade (30%)</span>
                                    <span class="titulo-cor">${calculation.data?.resultados?.valorPericulosidade || 'R$ 0,00'}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Horas de Sobreaviso (Espera):</span>
                                    <span class="titulo-cor">${calculation.data?.resultados?.valorSobreavisoEspera || 'R$ 0,00'}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Horas de Sobreaviso Trabalhado (50%):</span>
                                    <span class="titulo-cor">${calculation.data?.resultados?.valorHoraExtraTrabalho50 || 'R$ 0,00'}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Horas Extras 50% (Normal):</span>
                                    <span class="titulo-cor">${calculation.data?.resultados?.valorHoraExtraTrabalho100 || 'R$ 0,00'}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Horas de Adicional Noturno:</span>
                                    <span class="titulo-cor">${calculation.data?.resultados?.valorAdicionalNoturno || 'R$ 0,00'}</span>
                                </div>
                            </div>
                            
                            <div class="space-y-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                                <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Reflexos DSR (Fator: <span class="font-extrabold">${calculation.data?.resultados?.fatorDSR || '0.0000'}</span>)</h3>
                                
                                <div class="flex justify-between text-sm">
                                    <span>Reflexo Sobreaviso DSR (Espera 1/3):</span>
                                    <span class="text-indigo-700 font-semibold">${calculation.data?.resultados?.valorReflexoSobreavisoEspera || 'R$ 0,00'}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Reflexo Sob. Trabalhado DSR (HE 50%):</span>
                                    <span class="text-indigo-700 font-semibold">${calculation.data?.resultados?.valorReflexoSobreavisoTrabalhado || 'R$ 0,00'}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Reflexo Horas Extras DSR (Normal 50%):</span>
                                    <span class="text-indigo-700 font-semibold">${calculation.data?.resultados?.valorReflexoHorasExtrasNormal || 'R$ 0,00'}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Reflexo Adic. Noturno DSR:</span>
                                    <span class="text-indigo-700 font-semibold">${calculation.data?.resultados?.valorReflexoAdicionalNoturno || 'R$ 0,00'}</span>
                                </div>
                                
                                <div class="flex justify-between text-lg font-bold pt-2 border-t border-indigo-300">
                                    <span>TOTAL DOS REFLEXOS:</span>
                                    <span class="titulo-cor">${calculation.data?.resultados?.valorReflexoDSRTotalSum || 'R$ 0,00'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const calculationDetailTitle = document.getElementById('calculationDetailTitle');
            if (calculationDetailTitle) {
                calculationDetailTitle.textContent = `Detalhes do Cálculo - ${calculation.collaboratorName}`;
            }
            
            const detailButtonsContainer = document.getElementById('detailButtonsContainer');
            const editButtonsContainer = document.getElementById('editButtonsContainer');
            
            if (detailButtonsContainer) detailButtonsContainer.classList.remove('hidden');
            if (editButtonsContainer) editButtonsContainer.classList.add('hidden');
            
            openCalculationDetailModal();
        }
        
        function enableDetailEditMode() {
            const detailView = document.getElementById('detailViewMode');
            if (!detailView) return;
            
            detailView.classList.remove('view-mode');
            detailView.classList.add('edit-mode');
            
            const editFields = [
                'detailSalarioBase',
                'detailDivisorMensal',
                'detailUsaPericulosidade',
                'detailHorasSobreavisoTotal',
                'detailHorasTrabalhadas50',
                'detailHorasTrabalhadas100',
                'detailHorasNoturnas',
                'detailMesReferencia',
                'detailDiasTrabalhados',
                'detailDiasAtestado',
                'detailDiasFeriado',
                'detailPagoFolha',
                'detailCompetenciaPagamento'
            ];
            
            editFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.removeAttribute('readonly');
                    field.removeAttribute('disabled');
                    
                    if (field.type === 'select-one') {
                        field.disabled = false;
                    } else if (field.type === 'checkbox') {
                        field.disabled = false;
                    }
                }
            });
            
            const salarioField = document.getElementById('detailSalarioBase');
            if (salarioField) {
                salarioField.addEventListener('input', function() {
                    formatCurrencyInput(this);
                });
            }
            
            const detailButtonsContainer = document.getElementById('detailButtonsContainer');
            const editButtonsContainer = document.getElementById('editButtonsContainer');
            
            if (detailButtonsContainer) detailButtonsContainer.classList.add('hidden');
            if (editButtonsContainer) editButtonsContainer.classList.remove('hidden');
        }
        
        async function saveDetailEdit() {
            if (!currentCalculationDetailId) {
                alert('Erro: Nenhum cálculo selecionado para edição.');
                return;
            }
            
            const updatedData = {
                salarioBase: document.getElementById('detailSalarioBase')?.value || '',
                divisorMensal: document.getElementById('detailDivisorMensal')?.value || '220',
                usaPericulosidade: document.getElementById('detailUsaPericulosidade')?.checked || false,
                horasSobreavisoTotal: document.getElementById('detailHorasSobreavisoTotal')?.value || '00:00',
                horasTrabalhadas50: document.getElementById('detailHorasTrabalhadas50')?.value || '00:00',
                horasTrabalhadas100: document.getElementById('detailHorasTrabalhadas100')?.value || '00:00',
                horasNoturnas: document.getElementById('detailHorasNoturnas')?.value || '00:00',
                diasTrabalhados: document.getElementById('detailDiasTrabalhados')?.value || '30',
                diasAtestado: document.getElementById('detailDiasAtestado')?.value || '0',
                diasFeriado: document.getElementById('detailDiasFeriado')?.value || '0',
                mesReferencia: document.getElementById('detailMesReferencia')?.value || '',
                pagoFolha: document.getElementById('detailPagoFolha')?.checked || false,
                competenciaPagamento: document.getElementById('detailCompetenciaPagamento')?.value || ''
            };
            
            if (!updatedData.salarioBase || !updatedData.mesReferencia) {
                alert('Por favor, preencha o salário base e o mês de referência.');
                return;
            }
            
            const calculations = getSavedCalculations();
            const calculationIndex = calculations.findIndex(c => c.id === currentCalculationDetailId);
            
            if (calculationIndex === -1) {
                alert('Erro: Cálculo não encontrado!');
                return;
            }
            
            const originalCalculation = calculations[calculationIndex];
            
            const updatedCalculation = {
                ...originalCalculation,
                timestamp: new Date().toLocaleString('pt-BR'),
                timestampISO: new Date().toISOString(),
                mesReferencia: updatedData.mesReferencia,
                pagoFolha: updatedData.pagoFolha,
                competenciaPagamento: updatedData.competenciaPagamento,
                data: {
                    ...originalCalculation.data,
                    salarioBase: updatedData.salarioBase,
                    divisorMensal: updatedData.divisorMensal,
                    usaPericulosidade: updatedData.usaPericulosidade,
                    horasSobreavisoTotal: updatedData.horasSobreavisoTotal,
                    horasTrabalhadas50: updatedData.horasTrabalhadas50,
                    horasTrabalhadas100: updatedData.horasTrabalhadas100,
                    horasNoturnas: updatedData.horasNoturnas,
                    diasTrabalhados: updatedData.diasTrabalhados,
                    diasAtestado: updatedData.diasAtestado,
                    diasFeriado: updatedData.diasFeriado
                }
            };
            
            const salarioBaseFloat = parseFloat(updatedData.salarioBase.replace(/\./g, '').replace(',', '.'));
            const diasAtestadoInt = parseInt(updatedData.diasAtestado) || 0;
            const diasTrabalhadosAjustados = Math.max(0, 30 - diasAtestadoInt);
            
            if (salarioBaseFloat > 0 && updatedData.usaPericulosidade) {
                const periculosidadeMensal = salarioBaseFloat * 0.30;
                const periculosidadeProRata = (periculosidadeMensal / 30) * diasTrabalhadosAjustados;
                
                updatedCalculation.data.resultados = {
                    ...updatedCalculation.data.resultados,
                    valorPericulosidade: R$.format(periculosidadeProRata)
                };
            }
            
            calculations[calculationIndex] = updatedCalculation;
            await saveCalculations(calculations);
            
            alert(`Cálculo atualizado com sucesso! ${currentUser ? '(Sincronizado com a nuvem)' : ''}`);
            
            closeCalculationDetailModal();
            
            const historyContent = document.getElementById('historyContent');
            if (historyContent && !historyContent.classList.contains('hidden')) {
                renderHistoryTable();
            }
        }
        
        function cancelDetailEdit() {
            if (currentCalculationDetailId) {
                viewCalculationDetail(currentCalculationDetailId);
            }
        }

        // ============================================
        // FUNÇÕES DE RELATÓRIOS
        // ============================================
        function showReports() {
            const calculatorContent = document.getElementById('calculatorContent');
            const collaboratorsContent = document.getElementById('collaboratorsContent');
            const historyContent = document.getElementById('historyContent');
            const reportsContent = document.getElementById('reportsContent');
            
            if (calculatorContent) calculatorContent.classList.add('hidden');
            if (collaboratorsContent) collaboratorsContent.classList.add('hidden');
            if (historyContent) historyContent.classList.add('hidden');
            if (reportsContent) reportsContent.classList.remove('hidden');
            
            const menuCalculator = document.getElementById('menuCalculator');
            const menuCollaborators = document.getElementById('menuCollaborators');
            const menuHistory = document.getElementById('menuHistory');
            const menuReports = document.getElementById('menuReports');
            
            if (menuCalculator) menuCalculator.classList.remove('active');
            if (menuCollaborators) menuCollaborators.classList.remove('active');
            if (menuHistory) menuHistory.classList.remove('active');
            if (menuReports) menuReports.classList.add('active');
            
            initializeColumnControls();
        }
        
        function initializeColumnControls() {
            document.querySelectorAll('.column-toggle-btn').forEach(button => {
                button.removeEventListener('click', handleColumnToggle);
                button.addEventListener('click', handleColumnToggle);
            });
        }
        
        function handleColumnToggle() {
            const column = this.getAttribute('data-column');
            const isActive = this.classList.contains('active');
            
            if (isActive) {
                this.classList.remove('active');
                visibleColumns[column] = false;
            } else {
                this.classList.add('active');
                visibleColumns[column] = true;
            }
            
            const reportTableBody = document.getElementById('reportTableBody');
            if (reportTableBody && reportTableBody.children.length > 0 &&
                !reportTableBody.children[0].classList.contains('no-results')) {
                updateReportTable();
            }
        }
        
        function generateReport() {
            const calculations = getSavedCalculations();
            
            if (calculations.length === 0) {
                alert('Não há cálculos salvos para gerar relatório.');
                return;
            }
            
            const collaboratorId = document.getElementById('reportCollaborator')?.value;
            const department = document.getElementById('reportDepartment')?.value;
            const month = document.getElementById('reportMonth')?.value;
            const startDate = document.getElementById('reportStartDate')?.value;
            const endDate = document.getElementById('reportEndDate')?.value;
            
            let filteredCalculations = [...calculations];
            activeReportFilters = {};
            
            if (collaboratorId) {
                filteredCalculations = filteredCalculations.filter(c => c.collaboratorId == collaboratorId);
                activeReportFilters.colaborador = collaboratorId;
            }
            
            if (department) {
                filteredCalculations = filteredCalculations.filter(c => c.collaboratorDepartment === department);
                activeReportFilters.departamento = department;
            }
            
            if (month) {
                filteredCalculations = filteredCalculations.filter(c => c.mesReferencia === month);
                activeReportFilters.mes = month;
            }
            
            if (startDate) {
                const start = new Date(startDate);
                filteredCalculations = filteredCalculations.filter(c => new Date(c.timestampISO) >= start);
                activeReportFilters.dataInicio = startDate;
            }
            
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filteredCalculations = filteredCalculations.filter(c => new Date(c.timestampISO) <= end);
                activeReportFilters.dataFim = endDate;
            }
            
            if (filteredCalculations.length === 0) {
                alert('Nenhum cálculo encontrado com os filtros aplicados.');
                return;
            }
            
            updateActiveFilters();
            
            const reportData = consolidateReportData(filteredCalculations);
            
            updateReportTable(reportData);
        }
        
        function consolidateReportData(calculations) {
            const consolidated = {};
            
            calculations.forEach(calc => {
                const key = `${calc.collaboratorId}-${calc.mesReferencia}`;
                
                if (!consolidated[key]) {
                    consolidated[key] = {
                        colaboradorId: calc.collaboratorId,
                        colaborador: calc.collaboratorName,
                        departamento: calc.collaboratorDepartment,
                        salario: calc.collaboratorSalary,
                        mesReferencia: calc.mesReferencia,
                        periculosidadeValor: parseFloat(calc.data?.resultados?.valorPericulosidade?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0,
                        sobreaviso: parseTime(calc.data?.horasSobreavisoTotal || '00:00'),
                        sobreavisoDisplay: formatTimeForDisplay(calc.data?.horasSobreavisoTotal || '00:00'),
                        sobreavisoValor: parseFloat(calc.data?.resultados?.valorSobreavisoEspera?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0,
                        sobreavisoTrabalhado: parseTime(calc.data?.horasTrabalhadas50 || '00:00'),
                        sobreavisoTrabalhadoDisplay: formatTimeForDisplay(calc.data?.horasTrabalhadas50 || '00:00'),
                        sobreavisoTrabalhadoValor: parseFloat(calc.data?.resultados?.valorHoraExtraTrabalho50?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0,
                        horasExtras: parseTime(calc.data?.horasTrabalhadas100 || '00:00'),
                        horasExtrasDisplay: formatTimeForDisplay(calc.data?.horasTrabalhadas100 || '00:00'),
                        horasExtrasValor: parseFloat(calc.data?.resultados?.valorHoraExtraTrabalho100?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0,
                        adicionalNoturno: parseTime(calc.data?.horasNoturnas || '00:00'),
                        adicionalNoturnoDisplay: formatTimeForDisplay(calc.data?.horasNoturnas || '00:00'),
                        adicionalNoturnoValor: parseFloat(calc.data?.resultados?.valorAdicionalNoturno?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0,
                        reflexosValor: parseFloat(calc.data?.resultados?.valorReflexoDSRTotalSum?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0,
                        // Valores individuais dos reflexos para filtragem
                        reflexoSobreavisoValor: parseFloat(calc.data?.resultados?.valorReflexoSobreavisoEspera?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0,
                        reflexoSobreavisoTrabalhadoValor: parseFloat(calc.data?.resultados?.valorReflexoSobreavisoTrabalhado?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0,
                        reflexoHorasExtrasValor: parseFloat(calc.data?.resultados?.valorReflexoHorasExtrasNormal?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0,
                        reflexoAdicionalNoturnoValor: parseFloat(calc.data?.resultados?.valorReflexoAdicionalNoturno?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0,
                        total: 0
                    };
                } else {
                    consolidated[key].periculosidadeValor += parseFloat(calc.data?.resultados?.valorPericulosidade?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0;
                    consolidated[key].sobreaviso += parseTime(calc.data?.horasSobreavisoTotal || '00:00');
                    consolidated[key].sobreavisoValor += parseFloat(calc.data?.resultados?.valorSobreavisoEspera?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0;
                    consolidated[key].sobreavisoTrabalhado += parseTime(calc.data?.horasTrabalhadas50 || '00:00');
                    consolidated[key].sobreavisoTrabalhadoValor += parseFloat(calc.data?.resultados?.valorHoraExtraTrabalho50?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0;
                    consolidated[key].horasExtras += parseTime(calc.data?.horasTrabalhadas100 || '00:00');
                    consolidated[key].horasExtrasValor += parseFloat(calc.data?.resultados?.valorHoraExtraTrabalho100?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0;
                    consolidated[key].adicionalNoturno += parseTime(calc.data?.horasNoturnas || '00:00');
                    consolidated[key].adicionalNoturnoValor += parseFloat(calc.data?.resultados?.valorAdicionalNoturno?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0;
                    consolidated[key].reflexosValor += parseFloat(calc.data?.resultados?.valorReflexoDSRTotalSum?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0;
                    
                    // Acumular reflexos individuais
                    consolidated[key].reflexoSobreavisoValor += parseFloat(calc.data?.resultados?.valorReflexoSobreavisoEspera?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0;
                    consolidated[key].reflexoSobreavisoTrabalhadoValor += parseFloat(calc.data?.resultados?.valorReflexoSobreavisoTrabalhado?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0;
                    consolidated[key].reflexoHorasExtrasValor += parseFloat(calc.data?.resultados?.valorReflexoHorasExtrasNormal?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0;
                    consolidated[key].reflexoAdicionalNoturnoValor += parseFloat(calc.data?.resultados?.valorReflexoAdicionalNoturno?.replace('R$', '').replace('.', '').replace(',', '.').trim() || '0') || 0;
                }
            });
            
            return Object.values(consolidated);
        }
        
        function formatTimeForDisplay(timeString) {
            if (!timeString) return "00:00";
            
            if (timeString.includes(':')) {
                const parts = timeString.split(':');
                const hours = parts[0].padStart(2, '0');
                const minutes = parts[1] ? parts[1].padStart(2, '0') : '00';
                return `${hours}:${minutes}`;
            }
            
            if (!isNaN(parseFloat(timeString))) {
                const hours = Math.floor(parseFloat(timeString));
                const minutes = Math.round((parseFloat(timeString) - hours) * 60);
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }
            
            return "00:00";
        }
        
        function updateReportTable(reportData = []) {
            const tableBody = document.getElementById('reportTableBody');
            const tableHeader = document.getElementById('reportTableHeader');
            
            if (!tableBody || !tableHeader) return;
            
            if (reportData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="14" class="no-results">
                            <i class="fas fa-chart-bar fa-3x mb-4"></i>
                            <p class="text-lg">Nenhum relatório gerado ainda.</p>
                            <p class="text-sm">Configure os filtros acima e clique em "Filtrar".</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            updateTableHeader(tableHeader);
            
            let html = '';
            let totalGeral = 0;
            
            reportData.forEach((row) => {
                // Calcular o total SOMENTE com as colunas que estão visíveis
                let totalFiltrado = 0;
                
                if (visibleColumns.periculosidade) totalFiltrado += row.periculosidadeValor;
                if (visibleColumns.sobreaviso) totalFiltrado += row.sobreavisoValor;
                if (visibleColumns.sobreaviso_trabalhado) totalFiltrado += row.sobreavisoTrabalhadoValor;
                if (visibleColumns.horas_extras) totalFiltrado += row.horasExtrasValor;
                if (visibleColumns.adicional_noturno) totalFiltrado += row.adicionalNoturnoValor;
                
                // CORREÇÃO CRÍTICA: O valor dos reflexos agora é calculado com base nas colunas selecionadas
                let reflexosFiltrados = 0;
                if (visibleColumns.sobreaviso) reflexosFiltrados += row.reflexoSobreavisoValor;
                if (visibleColumns.sobreaviso_trabalhado) reflexosFiltrados += row.reflexoSobreavisoTrabalhadoValor;
                if (visibleColumns.horas_extras) reflexosFiltrados += row.reflexoHorasExtrasValor;
                if (visibleColumns.adicional_noturno) reflexosFiltrados += row.reflexoAdicionalNoturnoValor;
                
                // Se a coluna de reflexos estiver visível, adicionamos o valor filtrado
                if (visibleColumns.reflexos) totalFiltrado += reflexosFiltrados;
                
                totalGeral += totalFiltrado;
                
                html += `<tr>`;
                if (visibleColumns.colaborador) html += `<td class="font-medium">${row.colaborador}</td>`;
                if (visibleColumns.departamento) html += `<td>${row.departamento}</td>`;
                if (visibleColumns.salario) html += `<td>R$ ${row.salario}</td>`;
                if (visibleColumns.periculosidade) html += `<td>${R$.format(row.periculosidadeValor)}</td>`;
                if (visibleColumns.sobreaviso) html += `<td>${row.sobreavisoDisplay}</td>`;
                if (visibleColumns.sobreaviso) html += `<td>${R$.format(row.sobreavisoValor)}</td>`;
                if (visibleColumns.sobreaviso_trabalhado) html += `<td>${row.sobreavisoTrabalhadoDisplay}</td>`;
                if (visibleColumns.sobreaviso_trabalhado) html += `<td>${R$.format(row.sobreavisoTrabalhadoValor)}</td>`;
                if (visibleColumns.horas_extras) html += `<td>${row.horasExtrasDisplay}</td>`;
                if (visibleColumns.horas_extras) html += `<td>${R$.format(row.horasExtrasValor)}</td>`;
                if (visibleColumns.adicional_noturno) html += `<td>${row.adicionalNoturnoDisplay}</td>`;
                if (visibleColumns.adicional_noturno) html += `<td>${R$.format(row.adicionalNoturnoValor)}</td>`;
                if (visibleColumns.reflexos) html += `<td class="reflexo-total">${R$.format(reflexosFiltrados)}</td>`;
                if (visibleColumns.total) html += `<td class="font-bold titulo-cor">${R$.format(totalFiltrado)}</td>`;
                html += `</tr>`;
            });
            
            if (visibleColumns.total) {
                const colspan = getVisibleColumnCount() - 1;
                html += `
                    <tr class="total-row">
                        <td colspan="${colspan}" class="text-right font-bold">TOTAL GERAL (APENAS COLUNAS SELECIONADAS):</td>
                        <td class="font-bold titulo-cor">${R$.format(totalGeral)}</td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = html;
        }
        
        function updateTableHeader(header) {
            let headerHtml = '';
            
            if (visibleColumns.colaborador) headerHtml += '<th>COLABORADOR</th>';
            if (visibleColumns.departamento) headerHtml += '<th>DEPARTAMENTO</th>';
            if (visibleColumns.salario) headerHtml += '<th>SALÁRIO</th>';
            if (visibleColumns.periculosidade) headerHtml += '<th>PERICULOSIDADE</th>';
            if (visibleColumns.sobreaviso) headerHtml += '<th>HORAS DE SOBREAVISO</th>';
            if (visibleColumns.sobreaviso) headerHtml += '<th>VALOR</th>';
            if (visibleColumns.sobreaviso_trabalhado) headerHtml += '<th>HORAS DE SOBREAVISO TRABALHADO</th>';
            if (visibleColumns.sobreaviso_trabalhado) headerHtml += '<th>VALOR</th>';
            if (visibleColumns.horas_extras) headerHtml += '<th>HORAS EXTRAS</th>';
            if (visibleColumns.horas_extras) headerHtml += '<th>VALOR</th>';
            if (visibleColumns.adicional_noturno) headerHtml += '<th>HORAS DE ADCIONAL NOTURNO</th>';
            if (visibleColumns.adicional_noturno) headerHtml += '<th>VALOR</th>';
            if (visibleColumns.reflexos) headerHtml += '<th>REFLEXOS DSR</th>';
            if (visibleColumns.total) headerHtml += '<th>VALOR TOTAL</th>';
            
            header.innerHTML = headerHtml;
        }
        
        function getVisibleColumnCount() {
            let count = 0;
            Object.values(visibleColumns).forEach(isVisible => {
                if (isVisible) count++;
            });
            return count;
        }
        
        function updateActiveFilters() {
            const activeFiltersDiv = document.getElementById('activeFilters');
            const filterBadgesDiv = document.getElementById('filterBadges');
            
            if (!activeFiltersDiv || !filterBadgesDiv) return;
            
            if (Object.keys(activeReportFilters).length === 0) {
                activeFiltersDiv.classList.add('hidden');
                return;
            }
            
            activeFiltersDiv.classList.remove('hidden');
            
            let badgesHtml = '';
            
            if (activeReportFilters.colaborador) {
                const collaborator = getCollaborators().find(c => c.id == activeReportFilters.colaborador);
                if (collaborator) {
                    badgesHtml += `
                        <span class="filter-badge">
                            Colaborador: ${collaborator.name}
                            <i class="fas fa-times remove-filter" data-filter="colaborador"></i>
                        </span>
                    `;
                }
            }
            
            if (activeReportFilters.departamento) {
                badgesHtml += `
                    <span class="filter-badge">
                        Departamento: ${activeReportFilters.departamento}
                        <i class="fas fa-times remove-filter" data-filter="departamento"></i>
                    </span>
                `;
            }
            
            if (activeReportFilters.mes) {
                badgesHtml += `
                    <span class="filter-badge">
                        Mês: ${activeReportFilters.mes}
                        <i class="fas fa-times remove-filter" data-filter="mes"></i>
                    </span>
                `;
            }
            
            if (activeReportFilters.dataInicio) {
                badgesHtml += `
                    <span class="filter-badge">
                        De: ${activeReportFilters.dataInicio}
                        <i class="fas fa-times remove-filter" data-filter="dataInicio"></i>
                    </span>
                `;
            }
            
            if (activeReportFilters.dataFim) {
                badgesHtml += `
                    <span class="filter-badge">
                        Até: ${activeReportFilters.dataFim}
                        <i class="fas fa-times remove-filter" data-filter="dataFim"></i>
                    </span>
                `;
            }
            
            filterBadgesDiv.innerHTML = badgesHtml;
            
            document.querySelectorAll('.remove-filter').forEach(button => {
                button.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    removeFilter(filter);
                });
            });
        }
        
        function removeFilter(filter) {
            switch(filter) {
                case 'colaborador':
                    const reportCollaborator = document.getElementById('reportCollaborator');
                    if (reportCollaborator) reportCollaborator.value = '';
                    break;
                case 'departamento':
                    const reportDepartment = document.getElementById('reportDepartment');
                    if (reportDepartment) reportDepartment.value = '';
                    break;
                case 'mes':
                    const reportMonth = document.getElementById('reportMonth');
                    if (reportMonth) reportMonth.value = '';
                    break;
                case 'dataInicio':
                    const reportStartDate = document.getElementById('reportStartDate');
                    if (reportStartDate) reportStartDate.value = '';
                    break;
                case 'dataFim':
                    const reportEndDate = document.getElementById('reportEndDate');
                    if (reportEndDate) reportEndDate.value = '';
                    break;
            }
            
            generateReport();
        }
        
        function clearReportFilters() {
            const reportCollaborator = document.getElementById('reportCollaborator');
            if (reportCollaborator) reportCollaborator.value = '';
            
            const reportDepartment = document.getElementById('reportDepartment');
            if (reportDepartment) reportDepartment.value = '';
            
            const reportMonth = document.getElementById('reportMonth');
            if (reportMonth) reportMonth.value = '';
            
            const reportStartDate = document.getElementById('reportStartDate');
            if (reportStartDate) reportStartDate.value = '';
            
            const reportEndDate = document.getElementById('reportEndDate');
            if (reportEndDate) reportEndDate.value = '';
            
            activeReportFilters = {};
            
            const activeFilters = document.getElementById('activeFilters');
            if (activeFilters) activeFilters.classList.add('hidden');
            
            const reportTableBody = document.getElementById('reportTableBody');
            if (reportTableBody) {
                reportTableBody.innerHTML = `
                    <tr>
                        <td colspan="14" class="no-results">
                            <i class="fas fa-chart-bar fa-3x mb-4"></i>
                            <p class="text-lg">Nenhum relatório gerado ainda.</p>
                            <p class="text-sm">Configure os filtros acima e clique em "Filtrar".</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        function exportReportCSV() {
            const tableBody = document.getElementById('reportTableBody');
            
            if (!tableBody) return;
            
            if (tableBody.children.length === 0 || tableBody.children[0].classList.contains('no-results')) {
                alert('Não há dados para exportar. Gere um relatório primeiro.');
                return;
            }
            
            let csv = '';
            
            const headers = [];
            if (visibleColumns.colaborador) headers.push('COLABORADOR');
            if (visibleColumns.departamento) headers.push('DEPARTAMENTO');
            if (visibleColumns.salario) headers.push('SALÁRIO');
            if (visibleColumns.periculosidade) headers.push('PERICULOSIDADE');
            if (visibleColumns.sobreaviso) headers.push('HORAS DE SOBREAVISO');
            if (visibleColumns.sobreaviso) headers.push('VALOR SOBREAVISO');
            if (visibleColumns.sobreaviso_trabalhado) headers.push('HORAS DE SOBREAVISO TRABALHADO');
            if (visibleColumns.sobreaviso_trabalhado) headers.push('VALOR SOBREAVISO TRABALHADO');
            if (visibleColumns.horas_extras) headers.push('HORAS EXTRAS');
            if (visibleColumns.horas_extras) headers.push('VALOR HORAS EXTRAS');
            if (visibleColumns.adicional_noturno) headers.push('HORAS DE ADCIONAL NOTURNO');
            if (visibleColumns.adicional_noturno) headers.push('VALOR ADCIONAL NOTURNO');
            if (visibleColumns.reflexos) headers.push('REFLEXOS DSR');
            if (visibleColumns.total) headers.push('VALOR TOTAL');
            
            csv += headers.join(';') + '\n';
            
            const rows = tableBody.querySelectorAll('tr:not(.total-row)');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                
                cells.forEach(cell => {
                    rowData.push(`"${cell.textContent.trim()}"`);
                });
                
                csv += rowData.join(';') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `relatorio_folha_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            alert('Relatório exportado como CSV com sucesso!');
        }
        
        function exportReportPDF() {
            const tableBody = document.getElementById('reportTableBody');
            
            if (!tableBody) return;
            
            if (tableBody.children.length === 0 || tableBody.children[0].classList.contains('no-results')) {
                alert('Não há dados para exportar. Gere um relatório primeiro.');
                return;
            }
            
            if (typeof window.jspdf === 'undefined') {
                alert('Biblioteca jsPDF não carregada. Tente novamente.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            doc.setFontSize(20);
            doc.setTextColor(24, 0, 173);
            doc.text('Relatório de Cálculos - Folha de Pagamento', 148, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Data de emissão: ${new Date().toLocaleDateString('pt-BR')}`, 20, 25);
            
            if (Object.keys(activeReportFilters).length > 0) {
                let filterText = 'Filtros: ';
                const filters = [];
                
                if (activeReportFilters.colaborador) {
                    const collaborator = getCollaborators().find(c => c.id == activeReportFilters.colaborador);
                    if (collaborator) filters.push(`Colaborador: ${collaborator.name}`);
                }
                
                if (activeReportFilters.departamento) filters.push(`Departamento: ${activeReportFilters.departamento}`);
                if (activeReportFilters.mes) filters.push(`Mês: ${activeReportFilters.mes}`);
                if (activeReportFilters.dataInicio) filters.push(`De: ${activeReportFilters.dataInicio}`);
                if (activeReportFilters.dataFim) filters.push(`Até: ${activeReportFilters.dataFim}`);
                
                filterText += filters.join(', ');
                doc.text(filterText, 20, 30);
            }
            
            const headers = [];
            const rows = [];
            
            if (visibleColumns.colaborador) headers.push('Colaborador');
            if (visibleColumns.departamento) headers.push('Departamento');
            if (visibleColumns.salario) headers.push('Salário');
            if (visibleColumns.periculosidade) headers.push('Periculosidade');
            if (visibleColumns.sobreaviso) headers.push('Hrs Sob.');
            if (visibleColumns.sobreaviso) headers.push('Valor Sob.');
            if (visibleColumns.sobreaviso_trabalhado) headers.push('Hrs Sob. Trab.');
            if (visibleColumns.sobreaviso_trabalhado) headers.push('Valor Sob. Trab.');
            if (visibleColumns.horas_extras) headers.push('Hrs Extras');
            if (visibleColumns.horas_extras) headers.push('Valor Extras');
            if (visibleColumns.adicional_noturno) headers.push('Hrs Not.');
            if (visibleColumns.adicional_noturno) headers.push('Valor Not.');
            if (visibleColumns.reflexos) headers.push('Reflexos');
            if (visibleColumns.total) headers.push('Total');
            
            const tableRows = tableBody.querySelectorAll('tr:not(.total-row)');
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                
                cells.forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                
                rows.push(rowData);
            });
            
            const totalRow = tableBody.querySelector('.total-row');
            if (totalRow) {
                const totalCells = totalRow.querySelectorAll('td');
                const totalData = [];
                
                const numColunas = headers.length;
                
                for (let i = 0; i < numColunas - 1; i++) {
                    totalData.push('');
                }
                
                const totalGeralValor = totalCells[totalCells.length - 1]?.textContent.trim() || '';
                totalData.push(totalGeralValor);
                
                rows.push(totalData);
            }
            
            doc.autoTable({
                startY: 40,
                head: [headers],
                body: rows,
                theme: 'striped',
                headStyles: { fillColor: [24, 0, 173] },
                margin: { left: 20, right: 20 },
                styles: { fontSize: 7 },
                didParseCell: function(data) {
                    if (data.row.index === rows.length - 1 && totalRow) {
                        if (data.column.index === headers.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fillColor = [224, 242, 254];
                            data.cell.styles.textColor = [24, 0, 173];
                            data.cell.styles.halign = 'right';
                        }
                        
                        if (data.column.index === headers.length - 2) {
                            data.cell.text = 'TOTAL GERAL:';
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.halign = 'right';
                        }
                    }
                },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Página ${data.pageNumber} de ${data.pageCount}`, 148, 200, { align: 'center' });
                    doc.text('Sistema de Cálculos de Folha de Pagamento', 148, 205, { align: 'center' });
                }
            });
            
            const fileName = `relatorio_folha_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(fileName);
            
            alert('Relatório exportado como PDF com sucesso! O TOTAL GERAL considera APENAS as colunas selecionadas, incluindo os REFLEXOS correspondentes.');
        }

        // ============================================
        // FUNÇÕES DE INTERFACE E NAVEGAÇÃO
        // ============================================
        function showCalculator() {
            const calculatorContent = document.getElementById('calculatorContent');
            const collaboratorsContent = document.getElementById('collaboratorsContent');
            const historyContent = document.getElementById('historyContent');
            const reportsContent = document.getElementById('reportsContent');
            
            if (calculatorContent) calculatorContent.classList.remove('hidden');
            if (collaboratorsContent) collaboratorsContent.classList.add('hidden');
            if (historyContent) historyContent.classList.add('hidden');
            if (reportsContent) reportsContent.classList.add('hidden');
            
            const menuCalculator = document.getElementById('menuCalculator');
            const menuCollaborators = document.getElementById('menuCollaborators');
            const menuHistory = document.getElementById('menuHistory');
            const menuReports = document.getElementById('menuReports');
            
            if (menuCalculator) menuCalculator.classList.add('active');
            if (menuCollaborators) menuCollaborators.classList.remove('active');
            if (menuHistory) menuHistory.classList.remove('active');
            if (menuReports) menuReports.classList.remove('active');
        }
        
        function showCollaborators() {
            const calculatorContent = document.getElementById('calculatorContent');
            const collaboratorsContent = document.getElementById('collaboratorsContent');
            const historyContent = document.getElementById('historyContent');
            const reportsContent = document.getElementById('reportsContent');
            
            if (calculatorContent) calculatorContent.classList.add('hidden');
            if (collaboratorsContent) collaboratorsContent.classList.remove('hidden');
            if (historyContent) historyContent.classList.add('hidden');
            if (reportsContent) reportsContent.classList.add('hidden');
            
            const menuCalculator = document.getElementById('menuCalculator');
            const menuCollaborators = document.getElementById('menuCollaborators');
            const menuHistory = document.getElementById('menuHistory');
            const menuReports = document.getElementById('menuReports');
            
            if (menuCalculator) menuCalculator.classList.remove('active');
            if (menuCollaborators) menuCollaborators.classList.add('active');
            if (menuHistory) menuHistory.classList.remove('active');
            if (menuReports) menuReports.classList.remove('active');
            
            showCollaboratorsTab();
        }
        
        function showHistory() {
            const calculatorContent = document.getElementById('calculatorContent');
            const collaboratorsContent = document.getElementById('collaboratorsContent');
            const historyContent = document.getElementById('historyContent');
            const reportsContent = document.getElementById('reportsContent');
            
            if (calculatorContent) calculatorContent.classList.add('hidden');
            if (collaboratorsContent) collaboratorsContent.classList.add('hidden');
            if (historyContent) historyContent.classList.remove('hidden');
            if (reportsContent) reportsContent.classList.add('hidden');
            
            const menuCalculator = document.getElementById('menuCalculator');
            const menuCollaborators = document.getElementById('menuCollaborators');
            const menuHistory = document.getElementById('menuHistory');
            const menuReports = document.getElementById('menuReports');
            
            if (menuCalculator) menuCalculator.classList.remove('active');
            if (menuCollaborators) menuCollaborators.classList.remove('active');
            if (menuHistory) menuHistory.classList.add('active');
            if (menuReports) menuReports.classList.remove('active');
            
            renderHistoryTable();
            updateCollaboratorFilterSelect();
        }
        
        function showCollaboratorsTab() {
            const collaboratorsTabContent = document.getElementById('collaboratorsTabContent');
            const departmentsTabContent = document.getElementById('departmentsTabContent');
            const tabCollaborators = document.getElementById('tabCollaborators');
            const tabDepartments = document.getElementById('tabDepartments');
            
            if (collaboratorsTabContent) collaboratorsTabContent.classList.remove('hidden');
            if (departmentsTabContent) departmentsTabContent.classList.add('hidden');
            
            if (tabCollaborators) tabCollaborators.classList.add('active');
            if (tabDepartments) tabDepartments.classList.remove('active');
            
            renderCollaboratorsTable('active');
        }
        
        function showDepartmentsTab() {
            const collaboratorsTabContent = document.getElementById('collaboratorsTabContent');
            const departmentsTabContent = document.getElementById('departmentsTabContent');
            const tabCollaborators = document.getElementById('tabCollaborators');
            const tabDepartments = document.getElementById('tabDepartments');
            
            if (collaboratorsTabContent) collaboratorsTabContent.classList.add('hidden');
            if (departmentsTabContent) departmentsTabContent.classList.remove('hidden');
            
            if (tabCollaborators) tabCollaborators.classList.remove('active');
            if (tabDepartments) tabDepartments.classList.add('active');
            
            renderDepartmentsTable();
        }
        
        function openModal() {
            const modal = document.getElementById('collaboratorModal');
            if (modal) modal.classList.add('active');
        }
        
        function closeModal() {
            const modal = document.getElementById('collaboratorModal');
            if (modal) modal.classList.remove('active');
            resetCollaboratorForm();
        }
        
        function openDepartmentModal() {
            const modal = document.getElementById('departmentModal');
            if (modal) modal.classList.add('active');
        }
        
        function closeDepartmentModal() {
            const modal = document.getElementById('departmentModal');
            if (modal) modal.classList.remove('active');
            
            const form = document.getElementById('departmentForm');
            if (form) form.reset();
            
            const departmentModalTitle = document.getElementById('departmentModalTitle');
            if (departmentModalTitle) departmentModalTitle.textContent = "Cadastrar Novo Departamento";
            
            const departmentModalButton = document.getElementById('departmentModalButton');
            if (departmentModalButton) departmentModalButton.textContent = "Salvar Departamento";
            
            window.editingDepartmentId = null;
        }
        
        function openCalculationDetailModal() {
            const modal = document.getElementById('calculationDetailModal');
            if (modal) modal.classList.add('active');
        }
        
        function closeCalculationDetailModal() {
            const modal = document.getElementById('calculationDetailModal');
            if (modal) modal.classList.remove('active');
            currentCalculationDetailId = null;
        }
        
        function applyHistoryFilters() {
            const filterCollaborator = document.getElementById('filterCollaborator');
            const filterDepartment = document.getElementById('filterDepartment');
            const filterStartMonth = document.getElementById('filterStartMonth');
            const filterEndMonth = document.getElementById('filterEndMonth');
            
            const filters = {
                collaboratorId: filterCollaborator ? filterCollaborator.value : '',
                department: filterDepartment ? filterDepartment.value : '',
                startMonth: filterStartMonth ? filterStartMonth.value : '',
                endMonth: filterEndMonth ? filterEndMonth.value : ''
            };
            
            renderHistoryTable(filters);
        }
        
        function clearHistoryFilters() {
            const filterCollaborator = document.getElementById('filterCollaborator');
            if (filterCollaborator) filterCollaborator.value = '';
            
            const filterDepartment = document.getElementById('filterDepartment');
            if (filterDepartment) filterDepartment.value = '';
            
            const filterStartMonth = document.getElementById('filterStartMonth');
            if (filterStartMonth) filterStartMonth.value = '';
            
            const filterEndMonth = document.getElementById('filterEndMonth');
            if (filterEndMonth) filterEndMonth.value = '';
            
            renderHistoryTable();
        }
        
        function toggleBasesVisibility() {
            const basesContainer = document.getElementById('basesContainer');
            const basesIcon = document.getElementById('basesIcon');
            
            if (basesContainer && basesIcon) {
                if (basesContainer.classList.contains('hidden')) {
                    basesContainer.classList.remove('hidden');
                    basesIcon.classList.remove('fa-chevron-down');
                    basesIcon.classList.add('fa-chevron-up');
                } else {
                    basesContainer.classList.add('hidden');
                    basesIcon.classList.remove('fa-chevron-up');
                    basesIcon.classList.add('fa-chevron-down');
                }
            }
        }

        function updateDiasTrabalhados() {
            const diasAtestado = parseFloat(document.getElementById('diasAtestado')?.value) || 0;
            const diasTrabalhadosInput = document.getElementById('diasTrabalhados');
            
            if (diasTrabalhadosInput) {
                const diasTrabalhadosBase = 30;
                const diasTrabalhadosAjustados = Math.max(0, diasTrabalhadosBase - diasAtestado);
                
                diasTrabalhadosInput.value = diasTrabalhadosAjustados;
                calcular();
            }
        }

        // ============================================
        // INICIALIZAÇÃO - DOMContentLoaded
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("🚀 Aplicação inicializada com sucesso!");
            
            // 1. Inicializar Firebase se disponível
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                console.log("✅ Firebase já inicializado");
            }
            
            // 2. Configurar estado inicial
            updateFirebaseStatus('loading', 'Inicializando...');
            
            // 3. Carregar dados padrão se necessário
            const monthInput = document.getElementById('mesReferencia');
            if (monthInput) {
                monthInput.value = getCurrentMonthString();
            }
            
            // 4. Inicializar departamentos padrão
            getDepartments();
            
            // 5. Atualizar selects
            updateDepartmentSelect();
            updateCollaboratorSelect();
            updateCollaboratorFilterSelect();
            
            // 6. Calcular valores iniciais
            handleMonthChange(true);
            
            // 7. Configurar eventos de input para cálculo
            const inputElements = [
                'salarioBase', 'divisorMensal', 'usaPericulosidade',
                'horasSobreavisoTotal', 'horasTrabalhadas50', 'horasTrabalhadas100', 'horasNoturnas',
                'diasFeriado', 'diasAtestado', 'mesReferencia'
            ];
            
            inputElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', calcular);
                    el.addEventListener('change', calcular);
                }
            });
            
            // 8. Configurar eventos específicos
            const salarioBase = document.getElementById('salarioBase');
            if (salarioBase) {
                salarioBase.addEventListener('input', function() {
                    formatCurrencyInput(this);
                    calcular();
                });
            }
            
            const diasAtestado = document.getElementById('diasAtestado');
            if (diasAtestado) {
                diasAtestado.addEventListener('input', updateDiasTrabalhados);
            }
            
            const pagoFolha = document.getElementById('pagoFolha');
            if (pagoFolha) pagoFolha.addEventListener('change', calcular);
            
            const competenciaPagamento = document.getElementById('competenciaPagamento');
            if (competenciaPagamento) competenciaPagamento.addEventListener('change', calcular);
            
            // 9. Configurar botões principais
            const clearButton = document.getElementById('clearButton');
            if (clearButton) clearButton.addEventListener('click', resetInputs);
            
            const saveCalculation = document.getElementById('saveCalculation');
            if (saveCalculation) saveCalculation.addEventListener('click', saveCurrentCalculation);
            
            const refreshCollaborators = document.getElementById('refreshCollaborators');
            if (refreshCollaborators) {
                refreshCollaborators.addEventListener('click', function() {
                    updateCollaboratorSelect();
                    updateCollaboratorFilterSelect();
                });
            }
            
            const collaboratorSelect = document.getElementById('collaboratorSelect');
            if (collaboratorSelect) {
                collaboratorSelect.addEventListener('change', function() {
                    if (this.value) {
                        loadCollaboratorToCalculator(this.value);
                    }
                });
            }
            
            // 10. Configurar eventos de impressão/PDF
            const printButton = document.getElementById('printButton');
            if (printButton) {
                printButton.addEventListener('click', function() {
                    if (typeof window.jspdf === 'undefined') {
                        alert('Biblioteca jsPDF não carregada. Tente novamente.');
                        return;
                    }
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    // Gerar PDF...
                    doc.setFontSize(20);
                    doc.setTextColor(24, 0, 173);
                    doc.text('Cálculo de Adicionais e Reflexos da Folha', 105, 15, { align: 'center' });
                    
                    const collaboratorSelect = document.getElementById('collaboratorSelect');
                    const collaboratorName = collaboratorSelect.options[collaboratorSelect.selectedIndex]?.text || 'Não selecionado';
                    
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Colaborador: ${collaboratorName}`, 20, 25);
                    doc.text(`Mês Referência: ${document.getElementById('mesReferencia')?.value || 'Não informado'}`, 20, 32);
                    
                    doc.setFontSize(10);
                    doc.text(`Data de emissão: ${new Date().toLocaleDateString('pt-BR')}`, 20, 39);
                    
                    const usaPericulosidade = document.getElementById('usaPericulosidade')?.checked;
                    const valorPericulosidade = document.getElementById('valorPericulosidade')?.textContent || 'R$ 0,00';
                    
                    doc.setFillColor(240, 249, 255);
                    doc.rect(20, 45, 170, 8, 'F');
                    doc.setFontSize(11);
                    doc.setTextColor(24, 0, 173);
                    doc.text(`Periculosidade do Colaborador: ${usaPericulosidade ? 'SIM' : 'NÃO'}`, 22, 51);
                    if (usaPericulosidade) {
                        doc.text(`Valor da Periculosidade: ${valorPericulosidade}`, 120, 51);
                    }
                    
                    const startY = 60;
                    
                    doc.setFontSize(14);
                    doc.setTextColor(24, 0, 173);
                    doc.text('ADICIONAIS E PERICULOSIDADE', 20, startY);
                    
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    let y = startY + 8;
                    
                    if (usaPericulosidade) {
                        doc.text(`Periculosidade (30%): ${valorPericulosidade}`, 25, y);
                        y += 7;
                    }
                    
                    const valorSobreavisoEspera = document.getElementById('valorSobreavisoEspera')?.textContent || 'R$ 0,00';
                    doc.text(`Horas de Sobreaviso (Espera): ${valorSobreavisoEspera}`, 25, y);
                    y += 7;
                    
                    const valorHoraExtraTrabalho50 = document.getElementById('valorHoraExtraTrabalho50')?.textContent || 'R$ 0,00';
                    doc.text(`Horas de Sobreaviso Trabalhado (50%): ${valorHoraExtraTrabalho50}`, 25, y);
                    y += 7;
                    
                    const valorHoraExtraTrabalho100 = document.getElementById('valorHoraExtraTrabalho100')?.textContent || 'R$ 0,00';
                    doc.text(`Horas Extras 50% (Normal): ${valorHoraExtraTrabalho100}`, 25, y);
                    y += 7;
                    
                    const valorAdicionalNoturno = document.getElementById('valorAdicionalNoturno')?.textContent || 'R$ 0,00';
                    doc.text(`Horas de Adicional Noturno: ${valorAdicionalNoturno}`, 25, y);
                    y += 10;
                    
                    const fatorDSRDisplay = document.getElementById('fatorDSRDisplay')?.textContent || '0.0000';
                    doc.setFontSize(14);
                    doc.setTextColor(24, 0, 173);
                    doc.text(`REFLEXOS DSR (Fator: ${fatorDSRDisplay})`, 20, y);
                    
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    y += 8;
                    
                    const valorReflexoSobreavisoEspera = document.getElementById('valorReflexoSobreavisoEspera')?.textContent || 'R$ 0,00';
                    doc.text(`Reflexo Sobreaviso DSR (Espera 1/3): ${valorReflexoSobreavisoEspera}`, 25, y);
                    y += 7;
                    
                    const valorReflexoSobreavisoTrabalhado = document.getElementById('valorReflexoSobreavisoTrabalhado')?.textContent || 'R$ 0,00';
                    doc.text(`Reflexo Sob. Trabalhado DSR (HE 50%): ${valorReflexoSobreavisoTrabalhado}`, 25, y);
                    y += 7;
                    
                    const valorReflexoHorasExtrasNormal = document.getElementById('valorReflexoHorasExtrasNormal')?.textContent || 'R$ 0,00';
                    doc.text(`Reflexo Horas Extras DSR (Normal 50%): ${valorReflexoHorasExtrasNormal}`, 25, y);
                    y += 7;
                    
                    const valorReflexoAdicionalNoturno = document.getElementById('valorReflexoAdicionalNoturno')?.textContent || 'R$ 0,00';
                    doc.text(`Reflexo Adic. Noturno DSR: ${valorReflexoAdicionalNoturno}`, 25, y);
                    y += 10;
                    
                    const valorReflexoDSRTotalSum = document.getElementById('valorReflexoDSRTotalSum')?.textContent || 'R$ 0,00';
                    doc.setFontSize(12);
                    doc.setTextColor(24, 0, 173);
                    doc.text(`TOTAL DOS REFLEXOS: ${valorReflexoDSRTotalSum}`, 20, y);
                    y += 10;
                    
                    doc.setFontSize(14);
                    doc.setTextColor(24, 0, 173);
                    doc.text('INFORMAÇÕES DE ENTRADA', 20, y);
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    y += 8;
                    
                    const salarioBaseValue = document.getElementById('salarioBase')?.value || '0,00';
                    doc.text(`Salário Base: R$ ${salarioBaseValue}`, 25, y);
                    
                    const divisorMensal = document.getElementById('divisorMensal')?.value || '220';
                    doc.text(`Horas Mensais: ${divisorMensal}`, 120, y);
                    y += 6;
                    
                    const diasTrabalhados = document.getElementById('diasTrabalhados')?.value || '30';
                    doc.text(`Dias Normais: ${diasTrabalhados}`, 25, y);
                    
                    const diasAtestadoValor = document.getElementById('diasAtestado')?.value || '0';
                    doc.text(`Dias Atestado: ${diasAtestadoValor}`, 120, y);
                    y += 6;
                    
                    const diasFeriadoValor = document.getElementById('diasFeriado')?.value || '0';
                    doc.text(`Feriados: ${diasFeriadoValor}`, 25, y);
                    y += 6;
                    
                    const horasSobreavisoTotal = document.getElementById('horasSobreavisoTotal')?.value || '00:00';
                    doc.text(`Horas Sobreaviso: ${horasSobreavisoTotal}`, 25, y);
                    
                    const horasTrabalhadas50Valor = document.getElementById('horasTrabalhadas50')?.value || '00:00';
                    doc.text(`Horas Sob. Trabalhado: ${horasTrabalhadas50Valor}`, 120, y);
                    y += 6;
                    
                    const horasTrabalhadas100Valor = document.getElementById('horasTrabalhadas100')?.value || '00:00';
                    doc.text(`Horas Extras: ${horasTrabalhadas100Valor}`, 25, y);
                    
                    const horasNoturnasValor = document.getElementById('horasNoturnas')?.value || '00:00';
                    doc.text(`Horas Noturnas: ${horasNoturnasValor}`, 120, y);
                    y += 10;
                    
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Sistema de Cálculos de Folha de Pagamento', 105, 280, { align: 'center' });
                    doc.text('Este documento foi gerado automaticamente pelo sistema.', 105, 285, { align: 'center' });
                    
                    const fileName = `calculo_folha_${collaboratorName.split(' - ')[0] || 'colaborador'}_${new Date().toISOString().slice(0,10)}.pdf`;
                    doc.save(fileName);
                    
                    alert('PDF gerado com sucesso!');
                });
            }
            
            // 11. Configurar eventos de navegação
            const menuCalculator = document.getElementById('menuCalculator');
            if (menuCalculator) menuCalculator.addEventListener('click', showCalculator);
            
            const menuCollaborators = document.getElementById('menuCollaborators');
            if (menuCollaborators) menuCollaborators.addEventListener('click', showCollaborators);
            
            const menuHistory = document.getElementById('menuHistory');
            if (menuHistory) menuHistory.addEventListener('click', showHistory);
            
            const menuReports = document.getElementById('menuReports');
            if (menuReports) menuReports.addEventListener('click', showReports);
            
            // 12. Configurar eventos de abas
            const tabCollaborators = document.getElementById('tabCollaborators');
            if (tabCollaborators) tabCollaborators.addEventListener('click', showCollaboratorsTab);
            
            const tabDepartments = document.getElementById('tabDepartments');
            if (tabDepartments) tabDepartments.addEventListener('click', showDepartmentsTab);
            
            // 13. Configurar eventos de modais
            const closeModalBtn = document.getElementById('closeModal');
            if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
            
            const cancelCollaborator = document.getElementById('cancelCollaborator');
            if (cancelCollaborator) cancelCollaborator.addEventListener('click', closeModal);
            
            const collaboratorForm = document.getElementById('collaboratorForm');
            if (collaboratorForm) collaboratorForm.addEventListener('submit', saveCollaborator);
            
            const addNewCollaborator = document.getElementById('addNewCollaborator');
            if (addNewCollaborator) {
                addNewCollaborator.addEventListener('click', function() {
                    resetCollaboratorForm();
                    openModal();
                });
            }
            
            const addDepartmentFromCollaborator = document.getElementById('addDepartmentFromCollaborator');
            if (addDepartmentFromCollaborator) {
                addDepartmentFromCollaborator.addEventListener('click', function(e) {
                    e.preventDefault();
                    closeModal();
                    openDepartmentModal();
                });
            }
            
            // 14. Configurar eventos de departamentos
            const closeDepartmentModalBtn = document.getElementById('closeDepartmentModal');
            if (closeDepartmentModalBtn) closeDepartmentModalBtn.addEventListener('click', closeDepartmentModal);
            
            const cancelDepartment = document.getElementById('cancelDepartment');
            if (cancelDepartment) cancelDepartment.addEventListener('click', closeDepartmentModal);
            
            const departmentForm = document.getElementById('departmentForm');
            if (departmentForm) departmentForm.addEventListener('submit', saveNewDepartment);
            
            const addNewDepartment = document.getElementById('addNewDepartment');
            if (addNewDepartment) addNewDepartment.addEventListener('click', openDepartmentModal);
            
            // 15. Configurar eventos de histórico
            const refreshHistory = document.getElementById('refreshHistory');
            if (refreshHistory) {
                refreshHistory.addEventListener('click', function() {
                    renderHistoryTable();
                    updateCollaboratorFilterSelect();
                });
            }
            
            const clearHistoryFiltersBtn = document.getElementById('clearHistoryFilters');
            if (clearHistoryFiltersBtn) clearHistoryFiltersBtn.addEventListener('click', clearHistoryFilters);
            
            const applyFiltersBtn = document.getElementById('applyFilters');
            if (applyFiltersBtn) applyFiltersBtn.addEventListener('click', applyHistoryFilters);
            
            // 16. Configurar eventos de detalhes do cálculo
            const closeCalculationDetailModalBtn = document.getElementById('closeCalculationDetailModal');
            if (closeCalculationDetailModalBtn) closeCalculationDetailModalBtn.addEventListener('click', closeCalculationDetailModal);
            
            const closeCalculationDetail = document.getElementById('closeCalculationDetail');
            if (closeCalculationDetail) closeCalculationDetail.addEventListener('click', closeCalculationDetailModal);
            
            const editCalculationBtn = document.getElementById('editCalculationBtn');
            if (editCalculationBtn) editCalculationBtn.addEventListener('click', enableDetailEditMode);
            
            const saveEditBtn = document.getElementById('saveEditBtn');
            if (saveEditBtn) saveEditBtn.addEventListener('click', saveDetailEdit);
            
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            if (cancelEditBtn) cancelEditBtn.addEventListener('click', cancelDetailEdit);
            
            // 17. Configurar eventos de colaboradores na tabela
            const refreshCollaboratorList = document.getElementById('refreshCollaboratorList');
            if (refreshCollaboratorList) {
                refreshCollaboratorList.addEventListener('click', function() {
                    renderCollaboratorsTable(currentCollaboratorStatus);
                });
            }
            
            const showActiveCollaborators = document.getElementById('showActiveCollaborators');
            if (showActiveCollaborators) {
                showActiveCollaborators.addEventListener('click', function() {
                    renderCollaboratorsTable('active');
                });
            }
            
            const showInactiveCollaborators = document.getElementById('showInactiveCollaborators');
            if (showInactiveCollaborators) {
                showInactiveCollaborators.addEventListener('click', function() {
                    renderCollaboratorsTable('inactive');
                });
            }
            
            // 18. Configurar eventos de relatórios
            const refreshReports = document.getElementById('refreshReports');
            if (refreshReports) {
                refreshReports.addEventListener('click', function() {
                    updateCollaboratorFilterSelect();
                    updateDepartmentSelect();
                });
            }
            
            const generateReportBtn = document.getElementById('generateReport');
            if (generateReportBtn) generateReportBtn.addEventListener('click', generateReport);
            
            const clearReportFiltersBtn = document.getElementById('clearReportFilters');
            if (clearReportFiltersBtn) clearReportFiltersBtn.addEventListener('click', clearReportFilters);
            
            const exportReportCSVBtn = document.getElementById('exportReportCSV');
            if (exportReportCSVBtn) exportReportCSVBtn.addEventListener('click', exportReportCSV);
            
            const exportReportPDFBtn = document.getElementById('exportReportPDF');
            if (exportReportPDFBtn) exportReportPDFBtn.addEventListener('click', exportReportPDF);
            
            // 19. Configurar eventos de formatação de moeda
            const collaboratorBaseSalary = document.getElementById('collaboratorBaseSalary');
            if (collaboratorBaseSalary) {
                collaboratorBaseSalary.addEventListener('input', function() {
                    formatCurrencyInput(this);
                });
            }
            
            // 20. Configurar eventos de importação de planilha
            const importCollaboratorsBtn = document.getElementById('importCollaboratorsBtn');
            if (importCollaboratorsBtn) importCollaboratorsBtn.addEventListener('click', openImportModal);
            
            const closeImportModalBtn = document.getElementById('closeImportModal');
            if (closeImportModalBtn) closeImportModalBtn.addEventListener('click', closeImportModal);
            
            const cancelImport = document.getElementById('cancelImport');
            if (cancelImport) cancelImport.addEventListener('click', closeImportModal);
            
            const confirmImportBtn = document.getElementById('confirmImport');
            if (confirmImportBtn) confirmImportBtn.addEventListener('click', confirmImport);
            
            const downloadTemplateLink = document.getElementById('downloadTemplate');
            if (downloadTemplateLink) {
                downloadTemplateLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    downloadTemplate();
                });
            }
            
            // 21. Configurar área de upload de arquivos
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('spreadsheetFile');
            const selectFileButton = document.getElementById('selectFileButton');
            
            if (fileUploadArea) {
                fileUploadArea.addEventListener('click', function() {
                    if (fileInput) fileInput.click();
                });
                
                fileUploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('border-green-500', 'bg-green-50');
                });
                
                fileUploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('border-green-500', 'bg-green-50');
                });
                
                fileUploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('border-green-500', 'bg-green-50');
                    
                    if (e.dataTransfer.files.length && fileInput) {
                        fileInput.files = e.dataTransfer.files;
                        handleFileSelect({ target: { files: e.dataTransfer.files } });
                    }
                });
            }
            
            if (selectFileButton && fileInput) {
                selectFileButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    fileInput.click();
                });
            }
            
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            // 22. Configurar fechamento de modais ao clicar fora
            const importSpreadsheetModal = document.getElementById('importSpreadsheetModal');
            if (importSpreadsheetModal) {
                importSpreadsheetModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeImportModal();
                    }
                });
            }
            
            const collaboratorModal = document.getElementById('collaboratorModal');
            if (collaboratorModal) {
                collaboratorModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeModal();
                    }
                });
            }
            
            const departmentModal = document.getElementById('departmentModal');
            if (departmentModal) {
                departmentModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeDepartmentModal();
                    }
                });
            }
            
            const calculationDetailModal = document.getElementById('calculationDetailModal');
            if (calculationDetailModal) {
                calculationDetailModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeCalculationDetailModal();
                    }
                });
            }
            
            // 23. Configurar toggle de bases
            const toggleBases = document.getElementById('toggleBases');
            if (toggleBases) toggleBases.addEventListener('click', toggleBasesVisibility);
            
            // 24. Inicializar autenticação
            initAuthEvents();
            
            // 25. Realizar cálculo inicial
            calcular();
            
            // 26. Garantir que diasTrabalhados seja 30
            const diasTrabalhadosInput = document.getElementById('diasTrabalhados');
            if (diasTrabalhadosInput) diasTrabalhadosInput.value = 30;
            
            // 27. Ocultar bases container inicialmente
            const basesContainer = document.getElementById('basesContainer');
            if (basesContainer) basesContainer.classList.add('hidden');
            
            const basesIcon = document.getElementById('basesIcon');
            if (basesIcon) {
                basesIcon.classList.remove('fa-chevron-up');
                basesIcon.classList.add('fa-chevron-down');
            }
            
            // 28. Atualizar status do Firebase
            setTimeout(() => {
                if (!currentUser) {
                    updateFirebaseStatus('disconnected', 'Modo offline (apenas local)');
                }
            }, 2000);
            
            // 29. Verificar se deve mostrar modal de login
            if (!currentUser && !localStorage.getItem('skipLogin') && auth) {
                const loginModal = document.getElementById('loginModal');
                if (loginModal) loginModal.style.display = 'flex';
            }
        });
    </script>
</body>
</html>
